Config Usage Documentation
==========================

Overview
--------

This module provides a high-level configuration system for running prognostic simulations using the FV3 model framework. It integrates various configuration aspects including runtime settings, initial conditions, physics parameters, and machine learning emulation settings into a unified dataclass-based interface.

Key Classes and Functions
-------------------------

### FV3Config

A dataclass representing the core FV3 configuration fields that are not overridden by higher-level configurations. It includes:

- `namelist`: Dictionary containing namelist parameters, with a default coupler namelist specifying the atmospheric timestep.
- `experiment_name`: Name of the experiment.
- `data_table`: Data table path or identifier.
- `field_table`: Optional field table path.
- `forcing`: Forcing configuration.
- `orographic_forcing`: Orographic forcing configuration.
- `gfs_analysis_data`: GFS analysis data configuration.

The `asdict()` method returns a dictionary representation excluding any fields set to `None`.

### InitialCondition

Represents an initial condition for the model run, specified by a base URL and a timestamp. It supports optional restart category mappings to customize how restart files are handled.

Attributes:

- `base_url`: Location of initial condition data (e.g., Google Cloud Storage or local path).
- `timestep`: Timestamp string in `YYYYMMDD.HHMMSS` format.
- `restart_categories`: Optional mapping of FV3GFS restart categories to stored restart category names.

The `overlay` property generates an overlay dictionary suitable for merging into the FV3 configuration, using the `fv3kube` utilities.

### HighLevelConfig

A comprehensive configuration dataclass that combines `UserConfig` (runtime settings) and `FV3Config` with additional conveniences for prognostic runs.

Attributes:

- `base_version`: Specifies the default physics configuration version (default `"v0.5"`).
- `initial_conditions`: Specifies the initial conditions, either as an `InitialCondition` instance or another compatible format.
- `duration`: Duration of each simulation segment, expressed as a string compatible with `pandas.Timedelta` (e.g., `"3h"`). Overrides the timestep duration in the namelist if provided.
- `zhao_carr_emulation`: Configuration for Zhao-Carr machine learning emulation.

Key Methods:

- `_initial_condition_overlay()`: Returns the initial condition overlay dictionary.
- `_to_fv3config_specific()`: Extracts the FV3Config-specific fields from the high-level config.
- `to_runtime_config()`: Extracts runtime-only configuration as a `UserConfig` instance.
- `_physics_timestep()`: Computes the physics timestep as a `timedelta` based on the merged FV3 configuration.
- `_duration`: Returns the duration as an optional `timedelta`.
- `to_fv3config()`: Produces a fully merged FV3 configuration dictionary by combining base configurations, overlays, diagnostics, and emulation settings. Applies run duration if specified.

Utility Functions
-----------------

### instantiate_dataclass_from(cls, instance)

Creates an instance of the dataclass `cls` by copying matching attributes from another instance. Useful for converting between related dataclasses.

### default_coupler_nml()

Returns a default coupler namelist dictionary with a 900-second atmospheric timestep.

Command Line Interface
----------------------

The module includes an argument parser factory function `_create_arg_parser()` which defines command line arguments for specifying user configuration YAML files and optional machine learning model URLs.

- `user_config`: Path to a YAML file specifying configuration updates relative to the base FV3 configuration.
- `--model_url`: Optional argument(s) specifying remote URLs to trained machine learning models. If omitted, no ML updating is performed.

Usage Notes
-----------

- The configuration system is designed to be flexible and composable, allowing overlays and updates to be merged cleanly.
- Initial conditions can be specified with detailed restart category mappings to control model restarts.
- The `HighLevelConfig` class provides a convenient interface to generate complete FV3 configuration dictionaries ready for simulation runs.
- Machine learning emulation settings are integrated and can be configured via the `zhao_carr_emulation` attribute.
- Duration settings override default timestep durations and are parsed using pandas time delta utilities.

Logging
-------

The module uses Python's standard `logging` library to provide debug and informational messages during configuration processing.

Dependencies
------------

This configuration system depends on several external packages and modules:

- `dataclasses` for structured configuration objects.
- `argparse` for command line argument parsing.
- `fv3config` and `fv3kube` for FV3 configuration utilities.
- `runtime.config` and related runtime modules for user configuration and diagnostics.
- `emulation` for machine learning emulation configuration.
- `pandas` for time duration parsing.
- `dacite` for dataclass instantiation from dictionaries.

This modular design facilitates integration into larger FV3 workflow systems and supports extensible configuration management for atmospheric model prognostic runs.