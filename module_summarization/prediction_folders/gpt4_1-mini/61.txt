Generate documentation for this module
======================================

The `instrumentation.py` module is a core component of SQLAlchemy's Object Relational Mapper (ORM) that defines the system of class instrumentation. This system is responsible for tracking the state of ORM-mapped classes and their instances, enabling the ORM's rich interactivity and state management features.

Overview
--------

This module primarily handles the registration and instrumentation of user-defined classes for state tracking. It works closely with related modules such as `state.py` and `attributes.py`, which manage per-instance and per-class-attribute instrumentation respectively.

The instrumentation system allows SQLAlchemy to monitor changes to object attributes, manage lazy loading of data, and coordinate the lifecycle of ORM objects. It is typically not used directly by application developers but forms the foundation for many higher-level ORM features.

Key Components
--------------

### ClassManager

The central class in this module is `ClassManager`, which tracks state information at the class level. It manages the instrumentation of a particular class, including:

- Maintaining a registry of instrumented attributes.
- Managing event dispatching related to class instrumentation.
- Handling the initialization and finalization of instrumentation on the class.
- Coordinating with base classes' instrumentation to support inheritance.

`ClassManager` also supports customization through the `expired_attribute_loader` (formerly known as `deferred_scalar_loader`), which is responsible for loading expired or deferred attributes on instances.

### Instrumentation Extension

The module supports an extension system that allows customization of the instrumentation process on a per-class or global basis. This extension system was moved to the external `sqlalchemy.ext.instrumentation` package starting with version 0.8, which integrates with the ORM to provide more comprehensive instrumentation mechanics.

Usage Notes
-----------

- The instrumentation system is automatically applied to ORM-mapped classes and is generally transparent to end users.
- Defining a `__del__` method on instrumented classes is discouraged, as it can cause reference cycles and memory leaks due to the internal instrumentation references.
- The module uses weak references and memoization to efficiently manage instrumentation state and avoid memory leaks.

Version Changes
---------------

- **Since version 0.8**: The instrumentation extension system was moved out of the ORM core into the external `sqlalchemy.ext.instrumentation` package.
- **Since version 1.4**: The attribute loader previously named `deferred_scalar_loader` was renamed to `expired_attribute_loader`.

Summary
-------

The `instrumentation.py` module is a foundational part of SQLAlchemy's ORM, enabling the tracking and management of class and instance state. It provides the mechanisms by which SQLAlchemy instruments user-defined classes to support features such as change tracking, lazy loading, and event dispatching, all critical to the ORM's operation.