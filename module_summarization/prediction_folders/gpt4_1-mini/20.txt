w_direct Command
================

Overview
--------

The `w_direct` command is a suite of tools designed to calculate state-to-state kinetics, rates, fluxes, and transition event durations by tracing trajectories in weighted ensemble simulations. It operates on bin assignment files (typically `assign.h5`) and kinetics data files (typically `direct.h5`) generated during the simulation.

The command consists of multiple subcommands, each serving a specific purpose in the analysis of kinetic data:

- `w_direct init`: Initializes and calculates state-to-state kinetics by tracing trajectories.
- `w_direct kinetics`: Processes the flux data to generate average rates, fluxes, and populations with confidence intervals.

These tools enable detailed kinetic analysis, including the calculation of transition rates, fluxes, and event durations, with statistical rigor and error estimation.

Subcommands
-----------

### w_direct init

This subcommand calculates state-to-state rates and transition event durations by tracing trajectories through the simulation data.

**Input Requirements:**

- A bin assignment file (usually `assign.h5`) containing trajectory labeling information.
- Simulation data spanning the requested iteration range.

**Output:**

The output is stored in an HDF5 file (default: `direct.h5`) containing the following datasets:

- `/conditional_fluxes` [iteration][state][state]  
  Floating-point macrostate-to-macrostate fluxes. These fluxes are **not** normalized by the population of the initial macrostate.

- `/conditional_arrivals` [iteration][stateA][stateB]  
  Integer counts of trajectories arriving at state *stateB* in a given iteration, having departed from *stateA*.

- `/total_fluxes` [iteration][state]  
  Floating-point total flux into a given macrostate.

- `/arrivals` [iteration][state]  
  Integer counts of trajectories arriving at a given state in a given iteration, regardless of origin.

- `/duration_count` [iteration]  
  Integer number of event durations recorded in each iteration.

- `/durations` [iteration][event duration]  
  Structured array of event durations for transition events ending during a given iteration, with fields:
  - `istate` (Integer): Initial state of the transition event.
  - `fstate` (Integer): Final state of the transition event.
  - `duration` (Floating-point): Duration of the transition, in units of tau.
  - `weight` (Floating-point): Weight of the trajectory at the end of the transition, **not** normalized by initial state population.

**Notes:**

Because the state-to-state fluxes stored in this file are not normalized by the initial macrostate population, they cannot be directly used as rates without further processing. The `w_direct kinetics` subcommand performs this normalization while accounting for statistical fluctuations and correlations.

### w_direct kinetics

This subcommand generates average rates, fluxes, and associated errors from weighted ensemble data by processing the kinetics data generated by `w_direct init`.

**Input Requirements:**

- Bin assignment file (usually `assign.h5`).
- Kinetics data file (usually `direct.h5`).

**Output:**

The output file (default: `direct.h5`) contains the following datasets:

- `/avg_rates` [state,state]  
  Structured array of state-to-state rates based on the entire selected iteration window.

- `/avg_total_fluxes` [state]  
  Structured array of total fluxes into each state based on the entire selected iteration window.

- `/avg_conditional_fluxes` [state,state]  
  Structured array of state-to-state fluxes based on the entire selected iteration window.

If the `--evolution-mode` option is specified, additional datasets are available to track the evolution of rates and fluxes over time:

- `/rate_evolution` [window][state][state]  
  Structured array showing the evolution of rates over sliding windows of iterations.

(Additional evolution datasets may be present but are not fully detailed here.)

Methodology
-----------

The `w_direct` tools use a bootstrapping approach with correlation correction to estimate rates and fluxes. The rate estimator considers all pairs of states `(i, j)` where `i != j`, and uses the entire population dataset to properly normalize and avoid biases from indirect transitions involving third states.

The bootstrapping procedure employs parameters such as:

- `mcbs_alpha`: The confidence level for confidence intervals.
- `mcbs_nsets`: Number of bootstrap sets.
- `mcbs_acalpha`: Autocorrelation alpha parameter.
- `do_correl`: Whether to perform correlation correction.
- `mcbs_enable`: Enable or disable the bootstrapping procedure.

These parameters control the statistical rigor and error estimation in the rate calculations.

Usage Notes
-----------

- The `w_direct init` subcommand must be run first to generate the raw kinetics data.
- The `w_direct kinetics` subcommand processes this data to produce normalized rates and fluxes with confidence intervals.
- Bin assignment files must cover the iteration range of interest.
- The output files are HDF5 format and can be inspected with standard HDF5 tools.

Command-Line Options
--------------------

Each subcommand provides its own set of command-line options. Common options include specifying input and output files, iteration ranges, and bootstrapping parameters.

For detailed usage of each subcommand, run:

```bash
w_direct init --help
w_direct kinetics --help
```

Summary
-------

The `w_direct` command provides a comprehensive framework for analyzing weighted ensemble simulation data to extract kinetic information. By tracing trajectories and applying rigorous statistical methods, it enables accurate calculation of state-to-state rates, fluxes, and transition event durations, facilitating detailed kinetic modeling and understanding of complex systems.