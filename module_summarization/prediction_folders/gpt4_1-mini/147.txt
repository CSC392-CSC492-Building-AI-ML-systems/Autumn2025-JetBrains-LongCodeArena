# Fleur Input/Output Parsers

This module provides functionality to parse and extract relevant information from Fleur XML input and output files. Fleur is a software package used for electronic structure calculations, and its XML files contain detailed information about the calculation setup and results. The parsers facilitate easy access to distinct parts of these XML files for versioning, analysis, and reuse.

## Overview

The parsers are designed to work with different versions of Fleur XML files by utilizing schema dictionaries that correspond to the file versions. They provide structured access to key calculation parameters and modes, enabling users to programmatically inspect and manipulate Fleur input and output data.

## Key Functions

### `get_fleur_modes(xmltree, schema_dict, logger=None)`

Determines the calculation modes of a Fleur calculation from the given XML tree. Calculation modes are parameters or flags that influence the produced files or the output content in the `out.xml` files.

#### Parameters

- `xmltree` (`XMLLike`): An XML tree representing the Fleur XML file.
- `schema_dict` (`InputSchemaDict` or `OutputSchemaDict`): The schema dictionary corresponding to the version of the XML file.
- `logger` (`Logger`, optional): Logger object for logging warnings or errors.

#### Returns

- `dict[str, Any]`: A dictionary containing the extracted calculation modes.

#### Extracted Modes

- `jspin`: Number of spins considered in the calculation.
- `noco`: Boolean indicating if the calculation is non-collinear.
- `soc`: Boolean indicating if spin-orbit coupling is included.
- `relax`: Boolean indicating if the calculation is a structure relaxation.
- `spex`: Integer flag for special GW/Spex calculations.
- `force_theorem`: Boolean indicating if a Force theorem calculation is performed.
- `cf_coeff`: Boolean indicating if crystal field coefficients are used.
- `plot`: Boolean indicating if plotting is enabled.
- `film`: Boolean indicating if the structure is a film system.
- `ldau`: Boolean indicating if LDA+U is included.
- `dos`: Boolean indicating if it is a density of states calculation.
- `band`: Boolean indicating if it is a bandstructure calculation.
- `bz_integration`: Mode of integration over the Brillouin zone.
- `greensf`: Boolean indicating if a Green's function calculation is performed.
- `ldahia`: Boolean indicating if LDA+HIA is included.

The function uses the `FleurXMLContext` to navigate the XML tree safely and extract attributes and tags based on the schema version.

---

### `get_nkpts(xmltree, schema_dict, logger=None)`

Retrieves the number of k-points used in the calculation specified in the given Fleur XML file.

#### Parameters

- `xmltree` (`XMLLike`): An XML tree representing the Fleur XML file.
- `schema_dict` (`InputSchemaDict` or `OutputSchemaDict`): The schema dictionary corresponding to the version of the XML file.
- `logger` (`Logger`, optional): Logger object for logging warnings or errors.

#### Returns

- `int`: The number of k-points used in the calculation.

#### Notes

- For file versions before Max5, only `kPointList` or `kPointCount` tags are supported.
- The `kPointCount` tag may not always reliably represent the number of k-points, so a warning is issued if used.
- The function verifies that the selected k-point list exists in the XML and raises an error if it does not.

---

## Implementation Details

- The parsers rely on the `FleurXMLContext` class to provide a context manager interface for XML tree traversal, ensuring safe access to elements and attributes.
- The module uses schema dictionaries (`InputSchemaDict` and `OutputSchemaDict`) to handle differences between Fleur XML versions.
- Logging support is integrated to provide warnings and error messages during parsing.
- The parsers handle optional tags and attributes gracefully, providing default values or raising informative errors when necessary.

---

## Usage Example

```python
from lxml import etree
from masci_tools.io.parsers import fleur_parser
from masci_tools.io.parsers.fleur_schema import get_schema_dict

# Load XML file
xmltree = etree.parse('path_to_fleur_input.xml')

# Get schema dictionary for the input file version
schema_dict = get_schema_dict(xmltree)

# Extract calculation modes
modes = fleur_parser.get_fleur_modes(xmltree, schema_dict)

# Get number of k-points
nkpts = fleur_parser.get_nkpts(xmltree, schema_dict)

print("Calculation modes:", modes)
print("Number of k-points:", nkpts)
```

---

## License and Source

This module is part of the Masci-tools package (Material Science Tools) developed at Forschungszentrum JÃ¼lich GmbH, IAS-1/PGI-1, Germany. The code is hosted on GitHub at [https://github.com/judftteam/masci-tools](https://github.com/judftteam/masci-tools).

For license details, please refer to the LICENSE.txt file in the repository.

---

## References

- Fleur software documentation: [http://judft.de/](http://judft.de/)
- Masci-tools GitHub repository: [https://github.com/judftteam/masci-tools](https://github.com/judftteam/masci-tools)