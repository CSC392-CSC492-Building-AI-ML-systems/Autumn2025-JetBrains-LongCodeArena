Search Utilities for ASDF Trees
===============================

This module provides utilities for searching and manipulating nodes within ASDF (Advanced Scientific Data Format) trees. It includes the `AsdfSearchResult` class, which encapsulates the results of a search operation on an ASDF tree and provides methods for refining searches, formatting output, and modifying node values.

AsdfSearchResult Class
----------------------

The `AsdfSearchResult` class represents the outcome of a search performed on an ASDF tree. It allows further filtering of search results, formatting of the displayed tree structure, and replacement of node values.

### Initialization

```python
AsdfSearchResult(
    identifiers,
    node,
    filters=[],
    parent_node=None,
    max_rows=DEFAULT_MAX_ROWS,
    max_cols=DEFAULT_MAX_COLS,
    show_values=DEFAULT_SHOW_VALUES,
)
```

- **identifiers**: Identifiers of nodes in the ASDF tree.
- **node**: The root node or subtree where the search is performed.
- **filters**: A list of filter functions applied to nodes.
- **parent_node**: The parent node of the current node.
- **max_rows**: Maximum number of rows to display when rendering the tree.
- **max_cols**: Maximum number of columns (line length) to display.
- **show_values**: Boolean flag to control whether primitive values are shown in the rendered tree.

### Methods

#### format(max_rows=NotSet, max_cols=NotSet, show_values=NotSet)

Adjusts the formatting parameters for rendering the search result tree.

- **max_rows**: Limits the number of lines displayed. Can be an integer, tuple (per depth), None (unlimited), or NotSet (retain current).
- **max_cols**: Limits the length of each line. Can be an integer, None (unlimited), or NotSet.
- **show_values**: Boolean to enable or disable display of primitive values, or NotSet to retain current setting.

Returns a new `AsdfSearchResult` instance with updated formatting.

#### search(key=NotSet, type=NotSet, value=NotSet, filter=None)

Refines the current search by applying additional constraints on node keys, types, values, or custom filters.

- **key**: Select nodes by dictionary key or list index. Can be:
  - `NotSet`: no constraint
  - `str`: interpreted as a regular expression pattern
  - any other object: exact equality match
- **type**: Select nodes by type. Can be:
  - `NotSet`: no constraint
  - `str`: regular expression pattern matching fully qualified type names
  - `builtins.type`: node must be an instance of this type
- **value**: Select nodes by value. Can be:
  - `NotSet`: no constraint
  - `str`: regular expression pattern matching string representation of values
  - any other object: exact equality match
- **filter**: A callable accepting one or two arguments (node, and optionally the node's key or index) that returns `True` to keep the node or `False` to exclude it.

Returns a new `AsdfSearchResult` instance representing the filtered search results.

#### replace(value)

Replaces the values of all leaf nodes in the current search results with the specified `value`.

- **value**: The new value to assign to matched leaf nodes.

#### node (property)

Retrieves the leaf node of a tree when the search result contains exactly one node.

Usage Example
-------------

```python
# Perform an initial search on an ASDF tree
search_result = asdf_file.search(key="some_key")

# Further refine the search by node type and value pattern
refined_result = search_result.search(type="^numpy.ndarray$", value="^array_data")

# Format the output to limit rows and columns
formatted_result = refined_result.format(max_rows=20, max_cols=80, show_values=True)

# Replace all matched leaf nodes with a new value
formatted_result.replace(new_value)

# Access the single node if only one result exists
single_node = formatted_result.node
```

Notes
-----

- The search supports regular expression patterns for flexible matching of keys, types, and values.
- Filters can be combined to narrow down search results effectively.
- Formatting options help control the display of large or complex ASDF trees.
- Replacement operations modify the ASDF tree in place based on search results.

This utility is designed to facilitate powerful and flexible querying and manipulation of ASDF data structures.