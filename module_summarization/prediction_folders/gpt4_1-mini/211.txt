Generalized Linear Mixed Effects Models
========================================

Overview
--------

Bayesian inference for generalized linear mixed models (GLMMs) is implemented with support currently limited to families without additional scale or shape parameters, specifically binomial and Poisson families.

Two estimation approaches are available:

- **Laplace approximation** (maximum a posteriori estimation)
- **Variational Bayes** (mean field approximation to the posterior distribution)

In this implementation, all realizations of random effects are modeled as mutually independent.

Random Effects Design Matrix
----------------------------

The `exog_vc` matrix serves as the design matrix for the random effects. Each column of `exog_vc` corresponds to an independent realization of a random effect. These random effects are assumed to have mean zero and an unknown standard deviation.

The standard deviation parameters are constrained to be equal within subsets of the columns. When formulas are not used, these subsets are specified through the parameter `ident`. The `ident` array must have the same length as the number of columns in `exog_vc`, and columns with equal `ident` values share the same standard deviation. When formulas are used, columns of `exog_vc` derived from a common formula share the same standard deviation.

In many applications, `exog_vc` is sparse. A sparse matrix may be passed when constructing the model class. If a dense matrix is passed, it will be internally converted to a sparse matrix. Currently, there is no way to avoid creating a temporary dense version of `exog_vc` when using formulas.

Model and Parameterization
---------------------------

The joint density of data and parameters factors as:

.. math::

    p(y \mid vc, fep) \, p(vc \mid vcp) \, p(vcp) \, p(fe)

where:

- :math:`p(y \mid vc, fep)` is the likelihood of the data given random effects (`vc`) and fixed effects parameters (`fep`).
- :math:`p(vc \mid vcp)` is the distribution of random effects given variance component parameters (`vcp`).
- :math:`p(vcp)` and :math:`p(fe)` are Gaussian prior distributions on variance components and fixed effects parameters, respectively.

The variance component parameters (`vcp`) are log standard deviations, so their priors correspond to log-normal distributions on the standard deviations. The random effects distribution :math:`p(vc \mid vcp)` assumes independent Gaussian random effects, independent both within and between groups defined by the `ident` array. The model likelihood depends on the specific GLM family being fit.

Fitting Methods
---------------

Two fitting methods are implemented:

- **fit_map**: Fits the model using the Laplace approximation to the posterior distribution, yielding the maximum a posteriori estimates.
- **fit_vb**: Fits the model using a variational Bayes approximation, providing a mean field approximation to the posterior distribution.

Model Parameters
----------------

There are three types of parameters in the posterior distribution:

- **Fixed effects parameters (fep)**: Correspond to the columns of the fixed effects design matrix `exog`.
- **Random effects realizations (vc)**: Correspond to the columns of the random effects design matrix `exog_vc`.
- **Variance component parameters (vcp)**: Correspond to the unique integer labels in `ident` and represent the standard deviations of the random effects.

All random effects are modeled as independent Gaussian variables given the variance structure parameters. The `ident` array determines which random effects share the same variance.

Priors
------

- The random effect standard deviation parameters (`vcp`) have log-normal prior distributions with mean zero and standard deviation `vcp_p`.
- The fixed effects parameters have Gaussian priors with mean zero and standard deviation `fe_p`.

Note that for some families, such as Binomial, the posterior mode may be difficult to find numerically if `vcp_p` is set too large. A value of `vcp_p = 0.5` is often effective.

Usage
-----

The model is initialized with the following key parameters:

- `endog`: Vector of response values.
- `exog`: Covariates for the fixed effects.
- `exog_vc`: Covariates for the random effects (can be sparse).
- `ident`: Integer labels indicating which random effects share variance.
- `vcp_p`: Prior standard deviation for variance component parameters.
- `fe_p`: Prior standard deviation for fixed effects parameters.
- `family`: The GLM family (e.g., binomial, Poisson).
- `fep_names`, `vcp_names`, `vc_names`: Optional names for fixed effects, variance components, and random effect realizations.

References
----------

- Introduction to generalized linear mixed models:  
  https://stats.idre.ucla.edu/other/mult-pkg/introduction-to-generalized-linear-mixed-models

- SAS documentation on mixed models:  
  https://support.sas.com/documentation/cdl/en/statug/63033/HTML/default/viewer.htm#statug_intromix_a0000000215.htm

- An assessment of estimation methods for generalized linear mixed models with binary outcomes:  
  https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3866838/