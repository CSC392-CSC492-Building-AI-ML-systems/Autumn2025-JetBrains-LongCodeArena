# General HDF5 File Reader

This document provides an overview of the general HDF5 file reader functionality implemented in the Masci-tools package, specifically focusing on the `HDF5Reader` class and its associated transformation utilities.

---

## Overview

The `HDF5Reader` class is designed to facilitate reading and processing of HDF5 files. It supports flexible data extraction and transformation through a collection of predefined transformation functions. These transformations enable users to manipulate datasets within HDF5 files efficiently and consistently.

---

## Transformations

Transformations are functions that operate on datasets extracted from HDF5 files. They are designed to handle three primary cases gracefully:

1. The dataset is an `h5py.Dataset` object and may need conversion to a NumPy array.
2. The dataset is already a NumPy array.
3. The dataset is a dictionary of datasets, allowing for operations on arbitrary child datasets where not all keys are known in advance.

Transformations can be applied either to individual datasets or to all datasets within a dictionary, depending on the use case.

---

## Transformation Registration

Transformation functions are registered using the `@hdf5_transformation` decorator. This decorator manages the registration process and error handling for transformations. It accepts a parameter `attribute_needed` which indicates whether the transformation requires a previously processed attribute value. Transformations that require this are only available for entries in datasets.

Example usage of the decorator:

```python
@hdf5_transformation(attribute_needed=False)
def example_transformation(dataset):
    # transformation logic here
    return transformed_dataset
```

---

## Predefined Transformations

The following transformations are provided out-of-the-box:

### `get_first_element(dataset)`

Returns the first element of the dataset.

- **Parameters:**
  - `dataset`: The dataset to transform.
- **Returns:** The first element of the dataset.

### `index_dataset(dataset, index)`

Returns the element at the specified index from the dataset.

- **Parameters:**
  - `dataset`: The dataset to transform.
  - `index`: The index of the element to retrieve.
- **Returns:** The element at the specified index.

### `slice_dataset(dataset, slice_arg)`

Slices the dataset using the provided slice argument.

- **Parameters:**
  - `dataset`: The dataset to transform.
  - `slice_arg`: The slice to apply.
- **Returns:** The sliced dataset.

### `get_shape(dataset)`

Retrieves the shape of the dataset.

- **Parameters:**
  - `dataset`: The dataset to query.
- **Returns:** The shape of the dataset.

### `get_name(dataset, full_path=False)`

Retrieves the name of the dataset. Can return either the full path or just the dataset name.

- **Parameters:**
  - `dataset`: The dataset to query.
  - `full_path` (bool): If `True`, returns the full path; otherwise, returns only the dataset name.
- **Returns:** The name or full path of the dataset.

### `tile_array(dataset, n_repeats)`

Repeats the dataset array `n_repeats` times using `numpy.tile`.

- **Parameters:**
  - `dataset`: The dataset to transform.
  - `n_repeats`: Number of times to repeat the array.
- **Returns:** The tiled dataset.

### `repeat_array(dataset, n_repeats)`

Repeats each element in the dataset array `n_repeats` times using `numpy.repeat`.

- **Parameters:**
  - `dataset`: The dataset to transform.
  - `n_repeats`: Number of times to repeat each element.
- **Returns:** The dataset with repeated elements.

### `get_all_child_datasets(group, ignore=None, contains=None)`

Retrieves all datasets contained within a given HDF5 group, with options to ignore certain keys or filter by key content.

- **Parameters:**
  - `group`: The HDF5 group object to extract datasets from.
  - `ignore` (optional): A string or iterable of strings specifying keys to ignore.
  - `contains` (optional): A string or iterable of strings that must be contained in the key.
- **Returns:** A dictionary mapping dataset names to their corresponding datasets.

---

## Error Handling

All transformation functions are wrapped to catch exceptions and raise a `HDF5TransformationError` with a clear message indicating which transformation failed and why. This ensures that errors during data processing are informative and traceable.

---

## Usage Notes

- Transformations can be applied to datasets directly or to dictionaries of datasets.
- When working with dictionaries, transformations are applied to each dataset individually.
- The `HDF5Reader` class maintains a registry of all available transformations, allowing for dynamic application of transformations based on user needs.
- Some transformations require access to previously processed attribute values and are marked accordingly.

---

## License and Source

This functionality is part of the Masci-tools package, developed by Forschungszentrum JÃ¼lich GmbH, IAS-1/PGI-1, Germany. The source code is hosted on GitHub at [https://github.com/judftteam/masci-tools](https://github.com/judftteam/masci-tools).

For license details, please refer to the LICENSE.txt file included in the package.

---

This documentation provides a general introduction to the HDF5 file reader and its transformation capabilities within the Masci-tools package. For detailed usage and advanced features, please consult the source code and additional documentation provided in the repository.