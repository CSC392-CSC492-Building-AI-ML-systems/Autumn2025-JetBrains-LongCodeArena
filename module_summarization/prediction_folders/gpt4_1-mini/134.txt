Alchemical Transformations
==========================

Overview
--------

Alchemical transformations are a powerful technique used in molecular simulations to compute free energy differences between two states, such as different molecular species or conformations. This approach involves gradually transforming one molecular system into another by modifying the system's Hamiltonian through a coupling parameter, commonly denoted as λ (lambda), which varies continuously from 0 to 1.

Hybrid Topology Factory
-----------------------

The core component enabling alchemical transformations in this framework is the **HybridTopologyFactory** class. This class constructs a hybrid topology and system that smoothly interpolates between the "old" and "new" molecular systems, facilitating the calculation of relative free energies.

Atom Classification
~~~~~~~~~~~~~~~~~~~

Atoms in the hybrid system are categorized into four distinct groups, each treated differently during the alchemical transformation:

- **unique_old_atom**: Atoms present only in the old system and not mapped to the new system. Their interactions are fully active at λ=0 and turned off at λ=1.

- **unique_new_atom**: Atoms present only in the new system and not mapped to the old system. Their interactions are off at λ=0 and fully active at λ=1.

- **core_atom**: Atoms that are mapped between the old and new systems and belong to residues undergoing change. Their interactions interpolate between the old system at λ=0 and the new system at λ=1.

- **environment_atom**: Atoms mapped between systems but not part of changing residues. Their interactions remain constant and are not modified alchemically.

Key Properties
~~~~~~~~~~~~~~

- **hybrid_system** (`openmm.System`): The combined system representing both old and new states.

- **new_to_hybrid_atom_map** (`dict`): Maps atom indices from the new system to the hybrid system.

- **old_to_hybrid_atom_map** (`dict`): Maps atom indices from the old system to the hybrid system.

- **hybrid_positions** (`np.ndarray`): The atomic positions in the hybrid system.

- **hybrid_topology** (`mdtraj.Topology`): The topology of the hybrid system.

- **omm_hybrid_topology** (`openmm.app.Topology`): The OpenMM topology object corresponding to the hybrid system.

Alchemical Scaling and Softcore Potentials
------------------------------------------

The HybridTopologyFactory supports advanced alchemical scaling techniques to ensure smooth transformations and avoid singularities:

- **Softcore Potentials**: Softcore Lennard-Jones and electrostatic potentials are implemented to prevent numerical instabilities when atoms appear or disappear during the transformation. Parameters such as `softcore_alpha`, `softcore_LJ_v2_alpha`, and `softcore_electrostatics_alpha` control the softness of these potentials.

- **Force Softening**: Bond and angle force constants involving unique atoms can be softened to reduce artifacts during the transformation.

- **Selective Scaling**: Specific terms such as bonds, angles, torsions, sterics, and electrostatics can be scaled independently using customizable lambda-dependent functions.

- **Neglected Terms**: The framework allows for the inclusion or exclusion of certain angle terms that may be neglected by the geometry engine, ensuring accurate treatment of unique atoms.

Additional Features
-------------------

- **Dispersion Correction**: Optionally includes long-range dispersion corrections in the sterics force, though this can be computationally expensive.

- **RMSD Restraints**: Supports imposing RMSD restraints between core heavy atoms and protein alpha carbons to maintain structural integrity during transformations.

- **Torsion Flattening**: Allows flattening of torsion potentials involving unique new atoms to facilitate smoother transitions.

- **Exception Handling**: Provides options to interpolate or exclude 1-4 nonbonded interactions (exceptions) between old and new states.

Usage Notes
-----------

- The HybridTopologyFactory is designed to be flexible and extensible, supporting a wide range of alchemical protocols.

- The API is experimental and subject to change.

- Proper mapping between old and new topologies is critical for accurate free energy calculations.

References
----------

- Gapsys, Vytautas, Daniel Seeliger, and Bert L. de Groot. "New soft-core potential function for molecular dynamics based alchemical free energy calculations." *Journal of Chemical Theory and Computation* 8.7 (2012): 2373-2382.

This work introduces the softcore potential functions implemented here to improve the stability and efficiency of alchemical free energy calculations.

Summary
-------

Alchemical transformations facilitated by the HybridTopologyFactory enable rigorous and efficient computation of relative free energies by smoothly morphing one molecular system into another. Through careful atom classification, force scaling, and the use of softcore potentials, this approach addresses the challenges inherent in simulating disappearing and appearing atoms, making it a valuable tool in computational chemistry and drug design.