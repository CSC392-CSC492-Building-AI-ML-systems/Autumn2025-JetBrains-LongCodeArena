==========================
ASAB Storage Module
==========================

Overview
--------

This module provides a MongoDB-backed storage service for ASAB applications. It leverages the `motor` library for asynchronous MongoDB operations and `pymongo` for some synchronous utilities. The storage service supports basic CRUD operations, upsert functionality, and integration with ASAB's configuration system.

Configuration
-------------

The module uses the following default configuration parameters under the `asab:storage` section:

- `mongodb_uri` (default: `mongodb://localhost:27017`): The MongoDB connection URI.
- `mongodb_database` (default: `asabdb`): The name of the MongoDB database to use.

These can be overridden in the ASAB configuration to point to a different MongoDB instance or database.

Classes
-------

StorageService
~~~~~~~~~~~~~~

`StorageService` is the main class providing asynchronous access to MongoDB collections.

**Constructor:**

```python
StorageService(app, service_name, config_section_name='asab:storage')
```

- `app`: The ASAB application instance.
- `service_name`: The name of the service.
- `config_section_name`: The configuration section name to read MongoDB settings from (default is `'asab:storage'`).

**Attributes:**

- `Client`: An instance of `motor.motor_asyncio.AsyncIOMotorClient` connected to the configured MongoDB URI.
- `Database`: The MongoDB database instance with timezone-aware codec options.

**Methods:**

- `upsertor(collection: str, obj_id=None, version=0) -> MongoDBUpsertor`  
  Returns an upsertor object for the specified collection and object ID.

- `async get(collection: str, obj_id, decrypt=None) -> dict`  
  Retrieves a document by its `_id` from the specified collection.  
  Raises `KeyError` if the document is not found.  
  Optionally decrypts specified fields if `decrypt` is provided.

- `async get_by(collection: str, key: str, value, decrypt=None) -> dict`  
  Retrieves a document by an arbitrary key-value pair from the specified collection.  
  Raises `KeyError` if the document is not found.  
  Optionally decrypts specified fields if `decrypt` is provided.

- `async collection(collection: str) -> AsyncIOMotorCollection`  
  Returns the raw Motor collection object for advanced operations.  
  Example usage:

  ```python
  coll = await storage.collection("test-collection")
  cursor = coll.find({})
  while await cursor.fetch_next:
      obj = cursor.next_object()
      pprint.pprint(obj)
  ```

- `async delete(collection: str, obj_id)`  
  Deletes a document by its `_id` from the specified collection.  
  Raises `KeyError` if the document is not found.  
  Returns the deleted document's `_id`.

MongoDBUpsertor
~~~~~~~~~~~~~~~

`MongoDBUpsertor` is an upsert helper class implementing the `UpsertorABC` interface for MongoDB.

**Class Methods:**

- `generate_id()`  
  Generates a new MongoDB ObjectId.

**Instance Methods:**

- `async execute(custom_data: Optional[dict] = None, event_type: Optional[str] = None)`  
  Executes the upsert operation with the accumulated modifications.  
  Supports `$set`, `$inc`, `$push`, and `$unset` update operators.  
  Handles optimistic concurrency control via versioning.  
  Raises `DuplicateError` on duplicate key errors.  
  Raises `KeyError` if the document to update is not found (e.g., version conflict).  
  Optionally sends webhook notifications if configured.

Usage Example
-------------

```python
storage = StorageService(app, "storage")

# Insert or update a document
upsertor = storage.upsertor("mycollection", obj_id=None, version=0)
upsertor.set("field1", "value1")
await upsertor.execute()

# Retrieve a document by ID
doc = await storage.get("mycollection", obj_id)

# Delete a document
await storage.delete("mycollection", obj_id)
```

Dependencies
------------

- `motor` - Asynchronous MongoDB driver.
- `pymongo` - MongoDB driver used for some synchronous operations and error handling.
- `bson` - For BSON types such as `ObjectId`.
- `asab` - ASAB framework for configuration and service management.

Exceptions
----------

- `DuplicateError`  
  Raised when a duplicate key error occurs during an upsert operation.

Notes
-----

- The storage service uses UTC timezone-aware datetime objects.
- The upsertor supports optimistic concurrency control via a version field (`_v`).
- Webhook integration is supported for notifying external systems about data changes.

This module is designed to be used as part of an ASAB application to provide robust, asynchronous MongoDB storage capabilities with support for common data manipulation patterns.