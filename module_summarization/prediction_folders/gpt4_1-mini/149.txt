# FleurXMLModifier

The `FleurXMLModifier` class provides a structured and robust way to organize and group modifications to a `inp.xml` input file used by Fleur. It acts as a low-level interface for applying changes to Fleur input files, leveraging XML setting methods from the `masci_tools.util.xml` modules.

---

## Overview

`FleurXMLModifier` collects a series of modification tasks without immediately applying them to the input file. Instead, it stores these tasks and applies all changes in a single operation when requested. This approach allows for better control, undo functionality, and batch processing of input modifications.

The class supports various types of XML modification methods, including those based on XPath expressions, schema dictionaries, and NMMPMAT lines, by internally managing corresponding setter functions.

---

## Usage Example

```python
from masci_tools.io.fleurxmlmodifier import FleurXMLModifier

# Create a modifier instance
fmode = FleurXMLModifier()

# Add changes by calling setter methods (names correspond to xml_setters modules)
# These calls do not modify the input file immediately but queue the changes

fmode.set_inpchanges({'Kmax': 4.0})  # Set Kmax to 4.0
fmode.shift_value({'Gmax': 5.0})     # Add 5 to the current value of Gmax

# Set the local orbital configuration on all iron atoms to '3s 3p'
fmode.set_species('all-Fe', {'lo': [{'n': 3, 'l': 's', 'type': 'SCLO'},
                                    {'n': 3, 'l': 'p', 'type': 'SCLO'}]})

# Undo the last change
fmode.undo()

# Undo all changes
fmode.undo(revert_all=True)

# Apply all queued changes to an input file
new_xmltree, additional_files = fmode.modify_xmlfile('/path/to/input/file/inp.xml')
```

---

## Key Features

- **Task Management:** Collects modification tasks as named operations with arguments, allowing batch processing.
- **Undo Support:** Supports undoing the last change or all changes.
- **Multiple Setter Types:** Supports XPath-based, schema dictionary-based, and NMMPMAT-based XML setters.
- **Validation:** Optionally validates method signatures and arguments.
- **Flexible Instantiation:** Can be instantiated from a list of tasks for easy reuse or scripting.

---

## Constructor

```python
FleurXMLModifier(validate_signatures: bool = True)
```

- `validate_signatures`: If `True`, validates the signatures of setter methods when adding tasks.

---

## Class Methods

### `fromList`

```python
fromList(task_list: list[tuple[str, dict[str, Any]]], *args, **kwargs) -> FleurXMLModifier
```

Creates a `FleurXMLModifier` instance and immediately adds a list of modification tasks.

- `task_list`: A list of tuples where the first element is the name of the setter method and the second is a dictionary of keyword arguments for that method.
- Additional arguments are passed to the constructor.

Returns a `FleurXMLModifier` instance with the tasks added.

---

## Instance Methods

### `add_task_list`

```python
add_task_list(task_list: list[tuple[str, dict[str, Any]]]) -> None
```

Adds multiple modification tasks to the current modifier instance.

- `task_list`: List of tuples with method names and keyword argument dictionaries.

Raises `ValueError` if an unknown modification method is specified.

### `undo`

Reverts the last added modification task or all tasks if `revert_all=True` is specified.

### `modify_xmlfile`

Applies all collected modification tasks to a given Fleur input XML file.

- Accepts a file path or file-like object pointing to the `inp.xml` file.
- Returns the modified XML tree and any additional files generated during modification.

---

## Internal Details

- The class maintains dictionaries of setter functions categorized by their method of modification:
  - `_xpath_functions`
  - `_schema_dict_functions`
  - `_nmmpmat_functions`
- These are combined with any extra functions provided via `_extra_functions`.
- Setter functions are called with appropriate arguments depending on their category.
- The class uses `ModifierTask` named tuples internally to store tasks with their method name and arguments.

---

## Notes

- The docstrings for the setter methods are automatically generated from their implementations in the `masci_tools.util.xml` modules.
- Changes to setter method docstrings in this class will be overwritten by a pre-commit hook.
- This class is a low-level tool intended for users who need fine-grained control over Fleur input modifications.

---

## License and Source

- This class is part of the Masci-tools package (Material Science Tools).
- Source code is hosted on GitHub: https://github.com/judftteam/masci-tools
- For license details, see the LICENSE.txt file in the repository.

---

For more detailed usage and examples, refer to the Masci-tools documentation and the source code of the `masci_tools.util.xml` modules.