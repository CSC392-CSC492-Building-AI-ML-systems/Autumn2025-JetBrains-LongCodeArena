# Supporting Data to Plotting Functions in Multiple Ways

This module provides flexible support for supplying data to plotting functions, enabling them to handle a variety of data formats and structures seamlessly. The core idea is to allow plotting functions to accept data in multiple forms—such as dictionaries, pandas DataFrames, or even Bokeh's `ColumnDataSource`—and to specify which keys or columns to use for plotting. This flexibility simplifies the interface for plotting functions and enhances their usability in different contexts.

## Overview

Plotting functions often require data in specific formats or structures, which can limit their applicability or require cumbersome data preprocessing. This module addresses these challenges by introducing the `PlotData` class and utility functions that facilitate:

- Using different data containers (e.g., dicts, DataFrames, Bokeh ColumnDataSource).
- Specifying columns or keys to extract data for plotting.
- Iterating over multiple sets of data defined by different keys.
- Ensuring consistent data lengths and handling missing or mismatched data gracefully.
- Copying data sources safely, including special handling for Bokeh data sources.

## Key Features

### 1. Support for Multiple Data Containers

The module supports common data containers used in scientific plotting:

- **Dictionaries**: Simple key-value mappings.
- **Pandas DataFrames**: Tabular data with labeled columns.
- **Bokeh ColumnDataSource**: Specialized data source for interactive plotting with Bokeh (if Bokeh is installed).

This is automatically detected and handled internally, allowing the user to pass any of these data types directly to plotting functions.

### 2. Flexible Column Specification

When creating a `PlotData` instance, users specify which columns or keys correspond to the axes or other plot attributes (e.g., `x`, `y`, `z`, `color`, `size`). These can be provided as:

- Single keys (e.g., `x='energy'`).
- Lists of keys (e.g., `y=['temperature', 'pressure']`), allowing iteration over multiple data series.

The class automatically expands these specifications into a list of named tuples, each representing a set of columns to be used together for plotting.

### 3. Iteration Over Multiple Plot Sets

`PlotData` objects are iterable, yielding named tuples containing the data for each plot set. For example, if multiple `y` columns are specified, iterating over the `PlotData` instance will yield data for each `y` column paired with the corresponding `x` data.

This design enables plotting functions to loop over the data sets easily without manual indexing or data extraction.

### 4. Data Consistency and Copying

- **Same Length Enforcement**: When requested, the class checks that all entries in dictionary data sources have the same length, ensuring consistent plotting.
- **Data Copying**: Optionally, data sources can be copied to avoid side effects during plotting, with special handling for Bokeh's `ColumnDataSource` to ensure a proper deep copy.

### 5. Extensibility

Users can add new data keys dynamically (unless strict mode is enabled), allowing for flexible extension of the data columns used in plotting.

## Usage Example

```python
from masci_tools.vis.data import PlotData
import numpy as np

# Define an energy grid and multiple functions on this grid
x = np.linspace(-10, 10, 100)
data = {'x': x, 'y1': np.sin(x), 'y2': np.cos(x), 'y3': x**2}

# Create a PlotData instance specifying x and multiple y columns
p = PlotData(data, x='x', y=['y1', 'y2', 'y3'])

# Iterate over the PlotData object to access each y data series with the x data
for entry in p:
    print(entry.x)  # x data
    print(entry.y)  # y1, then y2, then y3 data
```

This example demonstrates how `PlotData` allows plotting functions to handle multiple y-series easily, iterating over them while keeping the x-axis data fixed.

## Internal Utilities

- `_is_bokeh_cds(data)`: Checks if the data is a Bokeh `ColumnDataSource`.
- `_copy_bokeh_cds(data)`: Creates a copy of a Bokeh `ColumnDataSource`.

These utilities ensure that Bokeh data sources are handled correctly when copying or checking data types.

## Summary

The `PlotData` class and associated utilities provide a robust and flexible framework for supporting data input to plotting functions in multiple ways. By abstracting the data container and column specification details, plotting functions can be written more generically and used more broadly, improving code reuse and user experience in scientific visualization workflows.