BaseUser Module
===============

Overview
--------
This module provides the `BaseUser` class, a foundational user model designed for authentication purposes within the Piccolo ORM framework. It includes fields commonly required for user management, such as username, password, email, and flags for user status and permissions. The class also implements secure password handling, validation, and login functionality.

BaseUser Class
--------------

The `BaseUser` class inherits from `piccolo.table.Table` and represents a user table named `piccolo_user`. It provides a basic user model with authentication support and includes the following key features:

### Fields

- **id** (`Serial`): Primary key for the user.
- **username** (`Varchar`): Unique username with a maximum length of 100 characters.
- **password** (`Secret`): Hashed password stored securely.
- **first_name** (`Varchar`): Optional first name.
- **last_name** (`Varchar`): Optional last name.
- **email** (`Varchar`): Unique email address with a maximum length of 255 characters.
- **active** (`Boolean`): Indicates if the user account is active. Defaults to `False`.
- **admin** (`Boolean`): Indicates if the user can log into the Piccolo admin GUI. Defaults to `False`.
- **superuser** (`Boolean`): Indicates if the user can manage other users' passwords in the admin GUI. Defaults to `False`.
- **last_login** (`Timestamp`): Records the last login time of the user. Optional.

### Password Handling

- Passwords are hashed using PBKDF2 with SHA-256, following OWASP recommendations with 600,000 iterations by default.
- Passwords must be between 6 and 128 characters in length.
- Passwords are automatically hashed when set or updated.
- The class provides methods to validate, hash, and update passwords securely.

### Methods

#### Initialization

- `__init__(**kwargs)`: Initializes a user instance. If a raw password is provided, it is hashed automatically.

#### Password Utilities

- `get_salt() -> str`: Generates a random salt for password hashing.
- `_validate_password(password: str)`: Validates the raw password against length and format requirements.
- `hash_password(password: str, salt: str = "", iterations: Optional[int] = None) -> str`: Hashes a raw password with an optional salt and iteration count.
- `split_stored_password(password: str) -> List[str]`: Splits a stored hashed password into its components (algorithm, iterations, salt, hash).
- `update_password(user: Union[str, int], password: str)`: Asynchronously updates the password for a user identified by username or ID.
- `update_password_sync(user: Union[str, int], password: str)`: Synchronous wrapper for `update_password`.

#### Authentication

- `login(username: str, password: str) -> Optional[int]`: Asynchronously verifies user credentials. Returns the user ID if successful, otherwise `None`. Updates the `last_login` timestamp on success.
- `login_sync(username: str, password: str) -> Optional[int]`: Synchronous wrapper for `login`.

#### Representation

- `get_readable() -> Readable`: Returns a human-readable representation of the user, typically the username.

Usage Notes
-----------

- Passwords should never be passed already hashed; the class handles hashing internally.
- The class uses asynchronous methods for database operations but provides synchronous wrappers for convenience.
- The `admin` and `superuser` flags control access to administrative features within the Piccolo admin GUI.
- The `last_login` field is updated automatically upon successful login.

Security Considerations
-----------------------

- Password hashing uses a strong algorithm (PBKDF2 with SHA-256) and a high iteration count to resist brute-force attacks.
- Passwords are stored as secrets and never in plain text.
- The class enforces password length constraints and rejects already hashed passwords during creation or update to prevent double hashing.

Logging
-------

- The module uses Python's `logging` library to warn about potential security issues, such as excessively long passwords or usernames, and attempts to use hashed passwords improperly.

Summary
-------

The `BaseUser` class provides a robust and secure foundation for user authentication in Piccolo-based applications. It handles user data, password security, and login management with best practices and ease of integration.