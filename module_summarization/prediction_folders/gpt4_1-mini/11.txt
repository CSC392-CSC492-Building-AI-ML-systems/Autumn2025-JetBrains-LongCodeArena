Working with Entities
=====================

Overview
--------

Entities are the fundamental building blocks within the ftrack API, representing various objects such as projects, tasks, assets, and users. The API provides a structured and efficient way to interact with these entities through sessions, enabling querying, creation, modification, and deletion of entities on the ftrack server.

Session
-------

A `Session` object represents an isolated connection to an ftrack server. It manages authentication, caching, event handling, and plugin integration, providing a context for working with entities.

### Creating a Session

To start working with entities, you first need to create a `Session`:

```python
import ftrack_api

session = ftrack_api.Session(
    server_url='https://your.ftrack.server',
    api_key='your_api_key',
    api_user='your_username'
)
```

- `server_url`: URL of the ftrack server.
- `api_key`: API key for authentication.
- `api_user`: Username of the ftrack user.

If these parameters are not provided explicitly, the session will attempt to retrieve them from environment variables:

- `FTRACK_SERVER`
- `FTRACK_API_KEY`
- `FTRACK_API_USER`

### Session Features

- **Auto-populate**: By default, entity attributes are automatically fetched from the server when accessed if not already loaded.
- **Caching**: Sessions support caching mechanisms to improve performance by reducing redundant server requests.
- **Event Hub**: Sessions can connect to an event hub to publish and subscribe to events.
- **Plugin Support**: Sessions can load plugins from specified paths to extend functionality.

Working with Entities
---------------------

Once a session is established, entities can be accessed, queried, and manipulated.

### Accessing Entities

Entities are accessed through the sessionâ€™s querying interface. For example, to retrieve all projects:

```python
projects = session.query('Project').all()
for project in projects:
    print(project['name'])
```

### Querying Entities

The session supports a powerful query language to filter entities:

```python
tasks = session.query('Task where status is "in progress"').all()
```

### Creating Entities

New entities can be created by instantiating them and setting their attributes:

```python
new_task = session.create('Task', {
    'name': 'New Task',
    'project': some_project_entity
})
session.commit()
```

### Modifying Entities

Entity attributes can be modified directly:

```python
task = session.query('Task where id is "some_id"').one()
task['status'] = 'completed'
session.commit()
```

### Deleting Entities

Entities can be deleted via the session:

```python
task = session.query('Task where id is "some_id"').one()
session.delete(task)
session.commit()
```

Caching
-------

The session supports caching to optimize performance. You can provide a custom cache or use the default memory cache. The cache stores entity data to minimize server requests.

Event Hub
---------

The session can connect to an event hub to handle real-time events. This allows subscribing to changes and publishing custom events.

```python
event_hub = session.event_hub
event_hub.connect()
event_hub.subscribe('topic', callback_function)
```

Authentication
--------------

Authentication is handled via API key and user credentials. The `SessionAuthentication` class attaches the necessary headers to HTTP requests to authenticate with the ftrack server.

```python
auth = SessionAuthentication(api_key='your_api_key', api_user='your_username')
```

This is managed internally by the `Session` class.

Best Practices
--------------

- Always commit changes after creating, modifying, or deleting entities using `session.commit()`.
- Use queries to efficiently retrieve only the entities you need.
- Utilize caching to improve performance, especially when working with large datasets.
- Handle exceptions such as `ftrack_api.exception` to manage errors gracefully.
- Use the event hub for real-time updates and integrations.

Summary
-------

Working with entities in the ftrack API involves creating a session, querying and manipulating entities, and optionally using caching and event handling to optimize and extend functionality. The API is designed to be intuitive and flexible, enabling efficient interaction with the ftrack server and its data.