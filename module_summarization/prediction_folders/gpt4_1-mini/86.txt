Postgres Engine
===============

The `PostgresEngine` module provides an asynchronous interface for interacting with a PostgreSQL database using the `asyncpg` driver. It includes support for transactions, batching, savepoints, and atomic operations, enabling efficient and safe execution of SQL queries.

Key Components
--------------

AsyncBatch
~~~~~~~~~~

`AsyncBatch` is a dataclass that extends the `Batch` base class to support asynchronous batch processing of query results.

- **Attributes:**
  - `connection`: An active `asyncpg.Connection` instance.
  - `query`: The `Query` object representing the SQL query to execute.
  - `batch_size`: Number of rows to fetch per batch.
  - `_transaction`: Internal transaction object.
  - `_cursor`: Optional `asyncpg.Cursor` used to fetch results.

- **Methods:**
  - `cursor`: Property to access the internal cursor; raises an error if not set.
  - `next()`: Asynchronously fetches the next batch of results and processes them.
  - `__aiter__()`, `__anext__()`: Support asynchronous iteration over batches.
  - `__aenter__()`, `__aexit__()`: Manage transaction lifecycle and cursor creation/cleanup.

Atomic
~~~~~~

`Atomic` provides a programmatic way to build and run a transaction by adding multiple queries before executing them together.

- **Usage:**

  ```python
  transaction = engine.atomic()
  transaction.add(Foo.create_table())
  await transaction.run()
  ```

- **Methods:**
  - `add(*query)`: Add one or more queries to the transaction.
  - `run()`: Asynchronously runs all added queries within a transaction.
  - `run_sync()`: Synchronous wrapper around `run()`.
  - `__await__()`: Allows `Atomic` instances to be awaited directly.

Savepoint
~~~~~~~~~

`Savepoint` represents a database savepoint within a transaction, allowing partial rollbacks.

- **Methods:**
  - `rollback_to()`: Rolls back the transaction to this savepoint.
  - `release()`: Releases the savepoint.

PostgresTransaction
~~~~~~~~~~~~~~~~~~~

`PostgresTransaction` manages PostgreSQL transactions using an asynchronous context manager.

- **Features:**
  - Supports nested transactions with optional enforcement.
  - Manages connection acquisition and release from a connection pool or direct connection.
  - Provides savepoint creation and rollback functionality.
  - Automatically commits or rolls back on context exit depending on exceptions.

- **Usage:**

  ```python
  async with engine.transaction():
      await Band.select().run()
  ```

- **Constructor Parameters:**
  - `engine`: The `PostgresEngine` instance.
  - `allow_nested`: If `True` (default), nested transactions are treated as no-ops; otherwise, raises `TransactionError`.

- **Methods:**
  - `get_connection()`: Acquires a connection from the pool or creates a new one.
  - `begin()`: Starts the transaction.
  - `commit()`: Commits the transaction.
  - `rollback()`: Rolls back the transaction.
  - `rollback_to(savepoint_name)`: Rolls back to a named savepoint.
  - `get_savepoint_id()`: Generates a unique savepoint ID.
  - `savepoint(name)`: Creates a new savepoint with an optional name.
  - `__aenter__()`, `__aexit__()`: Manage transaction lifecycle and connection handling.

PostgresEngine
--------------

`PostgresEngine` is the main engine class used to connect to and interact with a PostgreSQL database asynchronously.

- It extends the generic `Engine` base class, parameterized with an optional `PostgresTransaction`.
- Supports connection pooling and transaction management.
- Provides methods to create transactions, execute queries, and manage database connections.

Summary
-------

This module offers a comprehensive asynchronous PostgreSQL engine built on top of `asyncpg`, designed for use with the Piccolo ORM framework. It facilitates efficient batch processing, robust transaction management including nested transactions and savepoints, and atomic execution of multiple queries. The abstractions provided help ensure safe and performant database interactions in asynchronous Python applications.