How Mitogen Works
=================

Mitogen is a Python library designed to provide fast, transparent, and flexible remote code execution and communication. It achieves this by creating lightweight, isolated execution contexts called "slave contexts" and managing communication between them efficiently. This document provides an overview of how Mitogen works internally, explaining its core concepts and mechanisms.

Overview
--------

Mitogen operates by spawning new execution contexts (slaves) that run Python code independently but remain connected to the parent process. These slave contexts are bootstrapped with a minimal implementation of the Mitogen core, which is designed to be as small and efficient as possible to reduce startup overhead.

The core functionality is implemented in a dedicated module that is sent to every new slave context. This module handles message passing, module loading, function calls, and routing of communication between contexts.

Key Concepts
------------

- **Slave Contexts**: Independent Python interpreters spawned by the parent process. Each slave runs a minimal Mitogen bootstrap module that enables it to communicate with the parent and other slaves.

- **Message Passing**: Communication between contexts is done via messages. Messages can request module loading, function calls, logging forwarding, routing updates, and more.

- **Routing**: Mitogen maintains routes between contexts to enable message delivery. Routes can be added or removed dynamically as contexts are created or destroyed.

- **Channels**: Logical communication endpoints used to send and receive messages. Channels abstract the underlying transport mechanism.

- **Broker**: The central event loop that manages IO and message dispatching for all active channels.

Core Components and Mechanisms
------------------------------

### Bootstrap Module

Each slave context receives a bootstrap module that contains the essential Mitogen functionality. This module is kept minimal to reduce the size of the code sent over the wire and to speed up context startup.

### Message Types

Mitogen defines several message types, each identified by a unique integer code:

- `GET_MODULE (100)`: Request to load a Python module.
- `CALL_FUNCTION (101)`: Request to call a function remotely.
- `FORWARD_LOG (102)`: Forward log messages from slaves to the parent.
- `ADD_ROUTE (103)`: Add a new route for message delivery.
- `DEL_ROUTE (104)`: Remove an existing route.
- `ALLOCATE_ID (105)`: Allocate a unique identifier for a new context or channel.
- `SHUTDOWN (106)`: Signal to shut down a context or channel.
- `LOAD_MODULE (107)`: Load a module in a slave context.
- `FORWARD_MODULE (108)`: Forward a module to another context.
- `DETACHING (109)`: Indicate a context is detaching.
- `CALL_SERVICE (110)`: Call a service function.
- `STUB_CALL_SERVICE (111)`: Call a stub service function.

### Special Values

- `IS_DEAD (999)`: A sentinel value used in the `reply_to` field of messages to indicate that the receiver is disconnected or unreachable. Receiving this value typically raises a `ChannelError`.

### Data Encoding and Compatibility

Mitogen handles compatibility across Python versions by abstracting differences in string and byte handling, exception classes, and module imports. It uses codecs like Latin-1 for encoding to avoid deadlocks caused by import locks during string encoding.

### Buffer Sizes and Performance

Mitogen uses a default buffer size of 128 KiB for socket communication, which balances CPU usage and memory consumption. This size is chosen to optimize throughput while minimizing overhead from system calls and memory allocation.

### Logging

Mitogen uses Python's logging module to provide detailed logs for debugging and monitoring. It defines separate loggers for general Mitogen operations (`mitogen`) and IO-specific events (`mitogen.io`).

### Platform Considerations

Mitogen detects specific platform characteristics, such as whether it is running under Windows Subsystem for Linux (WSL), to adjust its behavior accordingly.

How It All Fits Together
------------------------

1. **Initialization**: The parent process starts and initializes the Mitogen broker and routing tables.

2. **Spawning Slaves**: When a new slave context is needed, the parent spawns a new Python interpreter and sends the bootstrap module to it.

3. **Establishing Communication**: The parent and slave establish a communication channel, typically a socketpair, configured with optimized buffer sizes.

4. **Message Exchange**: The parent and slave exchange messages to load modules, execute functions, and forward logs.

5. **Routing and Forwarding**: Messages are routed through the broker to their intended destinations, with routes added or removed dynamically as contexts come and go.

6. **Shutdown**: When a context is no longer needed, a shutdown message is sent, and resources are cleaned up.

Conclusion
----------

Mitogen's design focuses on efficient, transparent remote execution by leveraging lightweight slave contexts, a minimal bootstrap module, and a robust message-passing infrastructure. Its careful handling of Python version differences, buffer sizes, and platform quirks ensures reliable and performant operation across diverse environments.

For more detailed information, refer to the API documentation and source code comments within the Mitogen project.