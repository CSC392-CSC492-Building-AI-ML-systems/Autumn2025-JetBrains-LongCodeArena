Image Pixel-wise fit for Atmospheric Cherenkov Telescopes (ImPACT)
====================================================================

Overview
--------

The ImPACT (Image Pixel-wise fit for Atmospheric Cherenkov Telescopes) reconstruction method is a Monte Carlo template-based image fitting technique designed for the analysis of atmospheric Cherenkov telescope data. It performs a maximum likelihood fit of the recorded shower images against a library of simulated image templates to reconstruct key shower parameters such as the shower axis, energy, and height of the shower maximum.

This approach was introduced by Parsons & Hinton (2014) and is particularly suited for gamma-ray shower reconstruction in Cherenkov telescope arrays. Due to the computational intensity of the method, certain optimizations are applied, including fixed internal units and precomputed template interpolations.

Key Features
------------

- **Template-based fitting:** Uses a library of precomputed image templates generated from Monte Carlo simulations to predict the expected camera images for given shower parameters.
- **Maximum likelihood estimation:** Fits the observed pixel amplitudes to the predicted templates by maximizing the likelihood, accounting for noise and pedestal distributions.
- **Multi-parameter reconstruction:** Simultaneously reconstructs shower direction, energy, and depth of shower maximum (Xmax).
- **Support for multiple telescope types:** Includes templates and fitting procedures for various telescope cameras such as LSTCam, NectarCam, FlashCam, and CHEC.
- **Incorporation of time gradients:** Optionally uses time gradient information across the camera pixels to improve reconstruction accuracy.
- **Use of atmospheric profiles:** Converts height above ground to atmospheric depth using site-specific atmospheric profiles (e.g., Paranal).

Methodology
-----------

### Shower Depth Estimation

A simple prior estimate of the depth of shower maximum (Xmax) is computed based on the shower energy using the elongation rate formula:

.. math::

    X_{max} = 300 + 93 \times \log_{10}(E)

where :math:`E` is the shower energy in TeV.

### Priors

Priors can be applied on energy and Xmax to guide the fitting process:

- **Energy prior:** A power-law prior on energy with adjustable spectral index.
- **Xmax prior:** A Gaussian prior centered on the expected Xmax with a configurable width.

### Template Interpolation

For each telescope type, image templates are loaded and interpolated using the `TemplateNetworkInterpolator`. Time gradient templates can also be loaded if enabled.

### Likelihood Calculation

The likelihood function compares the observed pixel amplitudes to the predicted template amplitudes, incorporating the pedestal noise and single photoelectron resolution. The pedestal widths are hardcoded per camera type due to calibration data limitations.

### Reconstruction Workflow

1. **Initialization:** Load templates and atmospheric profiles.
2. **Data Preparation:** Extract pixel positions, amplitudes, and timing information from the event.
3. **Peak Finding:** Determine the peak position in each camera image by averaging the positions of the brightest pixels.
4. **Fitting:** Use a minimizer (e.g., Minuit) to maximize the likelihood by adjusting shower parameters.
5. **Output:** Provide reconstructed shower geometry, energy, and Xmax.

Usage
-----

The `ImPACTReconstructor` class encapsulates the reconstruction algorithm. Key parameters include:

- `root_dir`: Directory containing template files.
- `minimiser`: Choice of minimization algorithm (default is "minuit").
- `prior`: Type of prior to apply.
- `template_scale`: Scaling factor for template amplitudes.
- `xmax_offset`: Offset applied to Xmax prior.
- `use_time_gradient`: Enable or disable time gradient fitting.

Example instantiation:

```python
reconstructor = ImPACTReconstructor(
    root_dir="/path/to/templates",
    minimiser="minuit",
    prior="",
    template_scale=1.0,
    xmax_offset=0,
    use_time_gradient=True,
)
```

References
----------

- Parsons, R. D., & Hinton, J. A. (2014). A Monte Carlo template based analysis for air-Cherenkov arrays. *Astroparticle Physics*, 56, 26-34. https://doi.org/10.1016/j.astropartphys.2014.03.002

Notes
-----

- Units within the class are fixed for performance reasons:
  - Angular units: radians
  - Distance units: meters
  - Energy units: TeV
- Pedestal widths and single photoelectron resolution are currently hardcoded due to calibration data availability.
- The method is computationally intensive and may require optimization or parallelization for large datasets.

This reconstruction technique provides a powerful and precise method for analyzing Cherenkov telescope data by leveraging detailed Monte Carlo simulations and advanced statistical fitting.