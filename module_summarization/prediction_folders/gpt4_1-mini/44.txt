Azure Storage Library Provider
==============================

The `AzureStorageLibraryProvider` class provides an interface to access and read libraries stored in a Microsoft Azure Storage container. It implements the `LibraryProviderABC` abstract base class.

Overview
--------

`AzureStorageLibraryProvider` allows you to connect to an Azure Blob Storage container and interact with its contents as a library. It supports listing directory contents and reading files asynchronously.

Configuration
-------------

To configure the provider, use a URL with the following format:

```
azure+https://ACCOUNT-NAME.blob.core.windows.net/BLOB-CONTAINER
```

If the container's Public Access Level is not set to "Public access", you must create an Access Policy with "Read" and "List" permissions and append a Shared Access Signature (SAS) query string to the URL, for example:

```
azure+https://ACCOUNT-NAME.blob.core.windows.net/BLOB-CONTAINER?sv=2020-10-02&si=XXXX&sr=c&sig=XXXXXXXXXXXXXX
```

Initialization
--------------

The constructor takes the following parameters:

- `library`: The library instance this provider is associated with.
- `path`: The Azure Storage URL as described above.
- `layer`: The layer this provider belongs to.

It initializes internal state, including cache directory setup if enabled via configuration.

Key Methods
-----------

### `_start()`

An asynchronous method that loads the model representing the container's directory structure and marks the provider as ready.

### `_load_model()`

An asynchronous method that fetches the list of blobs from the Azure container, parses the XML response, and builds an internal directory and file model.

### `list(path: str) -> list`

Asynchronously lists the contents of the directory at the given path.

- `path`: A string representing the directory path starting with `/`.
- Returns: A list of `LibraryItem` instances representing files and directories.

Raises `RuntimeError` if the provider is not ready, or `KeyError` if the path does not exist or is not a directory.

### `read(path: str) -> typing.IO`

Asynchronously reads the content of the file at the specified path.

- `path`: A string representing the file path starting with `/`.
- Returns: A file-like object (`typing.IO`) for reading the file content.

Supports caching of files locally if caching is enabled in the configuration. Uses ETag headers to validate cache freshness.

Logging
-------

The provider uses Python's standard logging module to log warnings and informational messages, including connection status and errors during blob listing.

Caching
-------

Caching behavior is controlled by the `azure_cache` configuration option:

- `'false'`: Caching is disabled.
- `'true'`: Caching is enabled and uses a temporary directory based on a hash of the Azure Storage URL.
- Any other string: Used as the path to the cache directory.

The cache stores downloaded files and their ETag values to avoid unnecessary downloads.

Notes
-----

- The provider currently does not implement periodic refreshing of the model.
- Cache invalidation based on blob list changes and ETag differences is planned but not yet implemented.
- The class depends on external modules such as `aiohttp` for asynchronous HTTP requests and `xml.dom.minidom` for XML parsing.

Example Usage
-------------

```python
provider = AzureStorageLibraryProvider(library, "azure+https://myaccount.blob.core.windows.net/mycontainer", layer)
await provider._start()

items = await provider.list("/")
for item in items:
    print(item.name, item.type)

file_stream = await provider.read("/path/to/file.txt")
content = file_stream.read()
file_stream.close()
```

This provider enables seamless integration of Azure Blob Storage as a source of library items in applications supporting asynchronous operations.