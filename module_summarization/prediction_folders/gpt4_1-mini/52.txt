Generalized Method of Moments (GMM) and Two-Stage Least Squares (2SLS) Instrumental Variables Estimation
==========================================================================================================

Overview
--------

This module provides implementations for Generalized Method of Moments (GMM) and Two-Stage Least Squares (2SLS) estimation techniques, primarily used for instrumental variables (IV) regression models. These methods are essential for dealing with endogeneity in regression analysis by using instruments that are correlated with the endogenous regressors but uncorrelated with the error terms.

Key Features
------------

- **IV2SLS Class**: Implements the Two-Stage Least Squares (2SLS) estimator for instrumental variables regression. It allows estimation of models where some explanatory variables are endogenous and instruments are available.

- **IVRegressionResults Class**: Encapsulates the results of the IV regression, extending the standard OLS regression results with IV-specific attributes.

- **Support for Instrumental Variables**: The module handles the inclusion of instruments that may include both exogenous regressors and additional instrumental variables.

- **Integration with Statsmodels**: The classes inherit from statsmodels base classes, enabling compatibility with the broader statsmodels ecosystem, including access to regression diagnostics and result summaries.

Usage
-----

### IV2SLS

The `IV2SLS` class estimates a linear model using instrumental variables via the two-stage least squares method.

**Parameters:**

- `endog` : array-like  
  The endogenous dependent variable (nobs by 1).

- `exog` : array-like  
  The explanatory variables (nobs by k). All variables in `exog` are treated as endogenous and instrumented.

- `instrument` : array-like  
  The instrument variables matrix, which must include all exogenous regressors and additional instruments.

**Notes:**

- If some variables in `exog` are not to be instrumented, they must also be included in the `instrument` array.

- Degrees of freedom for standard error calculations use `df_resid = nobs - k_vars`, consistent with the "small" option in Stata's `ivreg2`.

**Methods:**

- `fit()`  
  Performs the 2SLS estimation and returns a results instance containing parameter estimates and covariance matrices.

- `predict(params, exog=None)`  
  Generates predicted values given parameters and optional exogenous data.

Limitations and Issues
----------------------

- The module currently does not handle the specification of the number of parameters (`nparams`) and starting values for parameters in GMM estimation robustly; initial values were previously taken from the global scope, which was a bug.

- When the optimal weighting matrix cannot be calculated numerically (e.g., in cases with a single moment condition), the covariance matrix calculation breaks down. A workaround using an identity matrix as the weighting matrix is implemented in some cases, but further development is needed.

- The GMM implementation does not inherently understand the underlying model structure (e.g., linear regression, panel data). Integration with regression model methods such as prediction, fitted values, and error term calculation is under consideration, possibly via multiple inheritance or delegation.

- Some statistical tests and diagnostics (e.g., Hausman test degrees of freedom, J-test normalization) require further validation and clarification.

- Standard errors computed without an optimal weighting matrix may be inaccurate due to confusion between weights and covariance matrices.

Author and License
------------------

**Author:** Josef Perktold  
**License:** BSD (3-clause)

References
----------

- Greene, W. H. (5th Edition). *Econometric Analysis*.  
- StataCorp. *ivreg2* documentation.

This module is part of the statsmodels library and leverages numpy and scipy for numerical computations.