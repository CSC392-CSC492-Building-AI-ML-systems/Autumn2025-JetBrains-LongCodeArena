w_fork Command
==============

Overview
--------
The `w_fork` command prepares a new weighted ensemble simulation from an existing one at a specified iteration. It generates a new HDF5 file representing the new simulation. This tool is useful for branching or restarting simulations from a particular point in a previous simulation.

When using executable propagation, it is the user's responsibility to prepare the new simulation directory appropriately. This includes making the old simulation's restart data from the specified iteration available as the new simulation's initial state data. The command creates a mapping of old simulation segments to new simulation initial states, which is saved both in the new HDF5 file and as a flat text file to assist in this process.

The target states and basis states for the new simulation are copied from those in the original simulation.

Usage
-----
```
w_fork [OPTIONS]
```

Options
-------
- `-i, --input INPUT_H5FILE`  
  Specify the input HDF5 file from which to create the new simulation. If not provided, the input file is read from the configuration file.

- `-I, --iteration N_ITER`  
  Take the initial distribution for the new simulation from iteration `N_ITER` of the original simulation. If not specified, the last complete iteration is used by default.

- `-o, --output OUTPUT_H5FILE`  
  Save the new simulation HDF5 file as `OUTPUT_H5FILE`. The default output filename is `forked.h5`.

- `--istate-map ISTATE_MAP`  
  Write a text file describing the mapping of existing segments to new initial states. The default filename is `istate_map.txt`.

- `--no-headers`  
  Do not write header lines to the initial state mapping text file.

Description
-----------
`w_fork` reads the specified iteration from an existing weighted ensemble simulation HDF5 file and creates a new simulation HDF5 file initialized at that iteration. The new simulation contains one initial state and one corresponding new segment for each segment in the original simulation at the chosen iteration.

The command performs the following steps:

1. Opens the original simulation HDF5 file in read mode.

2. Determines the iteration to fork from (defaulting to the last complete iteration if not specified).

3. Creates and opens a new HDF5 file for the forked simulation.

4. Copies target states and basis states from the original simulation at the chosen iteration to the new simulation.

5. Converts each segment from the original simulation at the chosen iteration into an initial state and a new segment in the new simulation. Each initial state is marked as a restart state and prepared for use.

6. Updates the new simulation's iteration count to 1 and closes both the original and new HDF5 files.

7. Writes a text file mapping old simulation segments to new initial state IDs to assist with managing restart data.

Output
------
- A new HDF5 file containing the forked simulation, with initial states and segments corresponding to the specified iteration of the original simulation.

- A text file (default `istate_map.txt`) mapping old simulation iteration and segment IDs to new simulation initial state IDs. This file can be used to link restart data from the old simulation to the new simulation.

Notes
-----
- The user must ensure that the restart data from the original simulation at the specified iteration is available and correctly linked to the new simulation's initial states when using executable propagation.

- Further adjustment of the new simulation's initial states and segments can be performed using other tools such as `w_binning`.

Example
-------
Fork a new simulation from iteration 10 of an existing simulation stored in `old_sim.h5`, saving the new simulation to `new_sim.h5` and writing the initial state map to `map.txt` without headers:

```
w_fork -i old_sim.h5 -I 10 -o new_sim.h5 --istate-map map.txt --no-headers
```

Logging
-------
The command logs its progress and any issues under the logger name `w_fork`.