w_assign command
================

Overview
--------

The `w_assign` command assigns walkers to bins, producing an output file (by default named `assign.h5`) that can be used in subsequent analysis. This assignment is essential for consistency in downstream analyses, ensuring that the entire dataset is assigned even if only a subset of the data will be used. This allows analyses that rely on tracing trajectories to always know the originating bin of each trajectory.

Source Data
-----------

Source data for assignment can be provided in one of two ways:

1. **User-specified function** (`--construct-dataset`):  
   Specify a Python function in `MODULE.FUNCTION` syntax that will be called as `function(n_iter, iter_group)`, where `n_iter` is the iteration number and `iter_group` is the corresponding group in the main WEST HDF5 file (`west.h5`). The function must return data indexable as `[segment][timepoint][dimension]`.

2. **List of data set specifications** (`--dsspecs`):  
   Provide a list of dataset specifications formatted as `NAME[,file=FILENAME,slice=SLICE]`. This uses the dataset called `NAME` in the HDF5 file `FILENAME` (defaulting to `west.h5`), optionally slicing it with the Python slice expression `SLICE` (e.g., `[0:2]` to select the first two elements along the first axis). This is useful for selecting specific columns from multi-dimensional datasets such as multi-dimensional progress coordinates.

If neither option is provided, the default progress coordinate dataset `pcoord` is used.

Specifying Macrostates
----------------------

Kinetic macrostates may be optionally defined as sets of bins. Each trajectory will be labeled with the kinetic macrostate it was most recently in at each timepoint. This labeling is required for kinetic analyses such as `w_kintrace` and `w_kinmat`.

There are three ways to specify macrostates:

1. **Single-bin states via command line (`--states`)**:  
   Specify multiple states as coordinate tuples, optionally prepended with a label, e.g., `bound:1.0` or `unbound:(2.5,2.5)`. Unlabeled states are named `stateN` where `N` is the zero-based index in the list.

2. **Multi-bin states via YAML file (`--states-from-file`)**:  
   Provide a YAML file defining a list of states, each with a `label` and a list of coordinate tuples under `coords`. Bins containing these coordinates are mapped to the corresponding state. Example YAML file:

   ```yaml
   ---
   states:
     - label: unbound
       coords:
         - [9.0, 1.0]
         - [9.0, 2.0]
     - label: bound
       coords:
         - [0.1, 0.0]
   ```

3. **Arbitrary state definitions via user function (`--states-from-function=MODULE.FUNCTION`)**:  
   Specify a Python function that takes the bin mapper as an argument (`function(mapper)`) and returns a list of dictionaries, one per state. Each dictionary must contain a vector of coordinate tuples with key `"coords"` defining the bins for that state, and may optionally include a `"label"` key for the state name.

Output Format
-------------

The output file (specified with `-o/--output`, default `assign.h5`) contains the following attributes and datasets:

- **Attributes:**

  - `nbins` *(Integer)*: Number of valid bins. Bin assignments range from `0` to `nbins - 1`.

  - `nstates` *(Integer)*: Number of valid macrostates (may be zero if none are specified). Trajectory ensemble assignments range from `0` to `nstates - 1` when states are defined.

- **Datasets:**

  - `/assignments` `[iteration][segment][timepoint]` *(Integer)*: Per-segment and per-timepoint bin assignments.

  - `/npts` `[iteration]` *(Integer)*: Number of timepoints in each iteration.

  - `/nsegs` `[iteration]` *(Integer)*: Number of segments in each iteration.

  - `/labeled_populations` `[iteration][state][bin]` *(Floating-point)*: Per-iteration and per-timepoint bin populations labeled by the most recently visited macrostate. The last state entry (`nstates - 1`) corresponds to trajectories initiated outside of any defined macrostate.

  - `/bin_labels` `[bin]`: Labels for bins (if provided).

Usage Notes
-----------

- The entire dataset must be assigned to maintain consistency in analyses that trace trajectories.

- Macrostates are essential for kinetic analyses and must be defined if such analyses are planned.

- Custom dataset construction and macrostate definitions provide flexibility for complex or non-standard progress coordinate schemes.

Logging
-------

The `w_assign` tool logs its progress and any issues encountered during assignment under the logger named `w_assign`.

---

This documentation provides a comprehensive overview of the `w_assign` command, its inputs, options for defining macrostates, and the structure of its output file for use in WESTPA workflows.