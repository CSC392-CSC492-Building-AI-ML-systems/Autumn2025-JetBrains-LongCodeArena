Generate Documentation for Code
===============================

This document provides an overview and detailed description of the key functions defined in the provided code. The code primarily deals with scanning and counting operations using detectors and motors, commonly used in experimental control and data acquisition systems.

Modules and Imports
-------------------
The code imports several standard and third-party modules including:

- `sys`, `inspect`, `itertools`, `functools`, `collections`, `time`
- `numpy` as `np`
- `cytools` or fallback to `toolz` for the `partition` function
- Internal modules: `plan_patterns`, `utils`, `preprocessors` (aliased as `bpp`), and `plan_stubs` (aliased as `bps`)

Key Functions
-------------

count(detectors, num=1, delay=None, *, per_shot=None, md=None)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Take one or more readings from detectors.

**Parameters:**

- `detectors` (list): List of 'readable' objects (detectors).
- `num` (int, optional): Number of readings to take; default is 1. If `None`, capture data until canceled.
- `delay` (iterable or scalar, optional): Time delay in seconds between successive readings; default is 0.
- `per_shot` (callable, optional): Hook for customizing action of inner loop (messages per step). Expected signature:
  
  ```python
  def f(detectors: Iterable[OphydObj]) -> Generator[Msg]:
      ...
  ```
- `md` (dict, optional): Metadata dictionary.

**Notes:**

- If `delay` is an iterable, it must have at least `num - 1` entries or the plan will raise a `ValueError` during iteration.

**Description:**

This function yields a plan that takes readings from the specified detectors. It stages the detectors, runs the counting plan with the specified number of readings and delay, and supports customization via the `per_shot` callable.

list_scan(detectors, *args, per_step=None, md=None)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Scan over one or more variables in steps simultaneously (inner product).

**Parameters:**

- `detectors` (list): List of 'readable' objects.
- `*args`: Variable length argument list specifying motors and their positions. For one dimension, the format is:
  
  ```python
  motor, [point1, point2, ...]
  ```
  
  For multiple dimensions:
  
  ```python
  motor1, [point1, point2, ...],
  motor2, [point1, point2, ...],
  ...,
  motorN, [point1, point2, ...]
  ```
  
  Motors can be any 'settable' object (motor, temperature controller, etc.).
  
- `per_step` (callable, optional): Hook for customizing action of inner loop (messages per step). Expected signature:
  
  ```python
  f(detectors, motor, step) -> plan (a generator)
  ```
  
- `md` (dict, optional): Metadata dictionary.

**Raises:**

- `ValueError`: If the lengths of all position lists are not the same or if the argument list is malformed.

**See Also:**

- `bluesky.plans.rel_list_scan`
- `bluesky.plans.list_grid_scan`
- `bluesky.plans.rel_list_grid_scan`

**Description:**

This function performs a scan over multiple motors simultaneously, stepping through the provided position lists in an inner product fashion. It validates input lengths, constructs metadata, and yields a plan that executes the scan using a full cycler generated by `plan_patterns.inner_list_product`.

rel_list_scan(detectors, *args, per_step=None, md=None)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Scan over one variable in steps relative to current position.

**Parameters:**

- `detectors` (list): List of 'readable' objects.
- `*args`: Variable length argument list specifying motors and relative positions. For one dimension, the format is:
  
  ```python
  motor, [point1, point2, ...]
  ```
  
  where points are relative to the current motor position.
  
- `per_step` (callable, optional): Hook for customizing action of inner loop (messages per step). Expected signature:
  
  ```python
  f(detectors, motor, step)
  ```
  
- `md` (dict, optional): Metadata dictionary.

**See Also:**

- `bluesky.plans.list_scan`
- `bluesky.plans.list_grid_scan`
- `bluesky.plans.rel_list_grid_scan`

**Description:**

This function is intended to perform scans over motors with positions specified relative to their current positions. The implementation is marked as TODO in the current code.

Additional Notes
----------------
- The code uses decorators from the `preprocessors` module (`bpp`) to stage devices and run plans with metadata.
- The `plan_stubs` module (`bps`) provides plan building blocks such as `repeat` and `one_shot`.
- Metadata dictionaries (`md`) are used extensively to provide context and hints for the scanning plans.
- The `partition` function from `cytools` or `toolz` is used to group arguments conveniently.
- The code is structured to support extensibility and customization via hooks (`per_shot`, `per_step`).

This documentation covers the main scanning and counting functions provided in the code and their usage patterns.