How to Generate Pydantic Models from Tortoise Models
=====================================================

This document explains how to generate Pydantic models from Tortoise ORM models using the utilities provided by `tortoise.contrib.pydantic`. This allows you to leverage Pydantic's powerful data validation and serialization features seamlessly with your Tortoise models.

PydanticMeta Configuration
--------------------------

To customize the generation of Pydantic models from your Tortoise models, you can define an inner class `PydanticMeta` inside your Tortoise model. This class allows you to specify metadata that controls which fields are included, excluded, or computed in the generated Pydantic model.

Example usage:

.. code-block:: python3

    from tortoise import Model, fields

    class Foo(Model):
        foo = fields.CharField(max_length=50)
        baa = fields.IntField()
        count_peanuts = fields.IntField()

        class PydanticMeta:
            exclude = ("foo", "baa")
            computed = ("count_peanuts", )

The available options in `PydanticMeta` are:

- **include** (`Tuple[str, ...]`): If set, only the fields listed here will be included in the Pydantic model.
- **exclude** (`Tuple[str, ...]`): Fields listed here will be excluded from the Pydantic model.
- **computed** (`Tuple[str, ...]`): Computed fields to include in the Pydantic model.
- **backward_relations** (`bool`): Whether to include backward relations without annotations. This is not recommended as it can result in very large data.
- **max_recursion** (`int`): Maximum recursion depth allowed when generating nested models.
- **allow_cycles** (`bool`): Whether to allow cycles in recursion. Use with caution as this can lead to very large data structures.
- **exclude_raw_fields** (`bool`): Whether to exclude raw fields (fields with `_id` suffixes) of relations.
- **sort_alphabetically** (`bool`): Whether to sort fields alphabetically in the generated model. If `False`, fields retain their declaration order.

Generating Pydantic Models
--------------------------

The main function to generate a Pydantic model from a Tortoise model is `pydantic_model_creator`. It creates a Pydantic model class that corresponds to the Tortoise model, respecting the options specified in `PydanticMeta` or those passed explicitly.

Function signature:

.. code-block:: python3

    pydantic_model_creator(
        cls: Type[Model],
        *,
        name: Optional[str] = None,
        exclude: Tuple[str, ...] = (),
        include: Tuple[str, ...] = (),
        computed: Tuple[str, ...] = (),
        allow_cycles: Optional[bool] = None,
        sort_alphabetically: Optional[bool] = None,
        exclude_readonly: bool = False,
    ) -> Type[PydanticModel]

Parameters:

- **cls**: The Tortoise model class to generate the Pydantic model from.
- **name**: Optional custom name for the generated Pydantic model class.
- **exclude**: Additional fields to exclude from the generated model.
- **include**: Additional fields to include in the generated model.
- **computed**: Additional computed fields to include.
- **allow_cycles**: Whether to allow cycles in the generated model (useful for recursive/self-referential models). Defaults to `False`.
- **sort_alphabetically**: Whether to sort fields alphabetically instead of using the field definition order.
- **exclude_readonly**: If `True`, excludes any readonly fields from the generated model.

Example usage:

.. code-block:: python3

    from tortoise.contrib.pydantic import pydantic_model_creator
    from myapp.models import Foo

    FooPydantic = pydantic_model_creator(Foo, exclude=("foo",), computed=("count_peanuts",))

Recursion and Cycles
--------------------

When generating nested Pydantic models for related fields, recursion can occur. To prevent infinite recursion, the generation process respects the `max_recursion` and `allow_cycles` settings from `PydanticMeta` or the parameters passed to `pydantic_model_creator`.

- If `allow_cycles` is `False` (default), the generator will avoid creating models that would cause cyclic references.
- The `max_recursion` setting limits the depth of nested model generation.
- Use these settings carefully to avoid generating excessively large or infinite models.

Computed Fields
---------------

Computed fields are properties or methods on your Tortoise model that you want to include in the Pydantic model output. You can specify these fields in the `computed` tuple in `PydanticMeta` or pass them explicitly to `pydantic_model_creator`.

Backward Relations
------------------

By default, backward relations (reverse foreign key relations) are included if `backward_relations` is set to `True` in `PydanticMeta`. However, including backward relations without annotations can result in very large data structures and is generally not recommended unless you have a specific use case.

Sorting Fields
--------------

By default, fields in the generated Pydantic model retain the order in which they are defined in the Tortoise model. You can override this behavior by setting `sort_alphabetically` to `True` in `PydanticMeta` or passing it as a parameter to `pydantic_model_creator`. This will sort the fields alphabetically in the generated model.

Summary
-------

- Define a `PydanticMeta` inner class in your Tortoise model to customize Pydantic model generation.
- Use `pydantic_model_creator` to generate Pydantic models from Tortoise models.
- Control recursion, cycles, included/excluded fields, computed fields, and field ordering via parameters or `PydanticMeta`.
- Be cautious with cycles and backward relations to avoid generating very large or infinite models.

For more details on Pydantic models, refer to the official Pydantic documentation:  
https://pydantic-docs.helpmanual.io/usage/models/