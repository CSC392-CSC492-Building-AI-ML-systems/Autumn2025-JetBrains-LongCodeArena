Managers Module
===============

Overview
--------
This module provides classes and mixins to manage JSON-RPC requests and transactions in an Ethereum-like environment. It includes synchronous and asynchronous request handling, provider management, and transaction nonce tracking and signing.

Classes
-------

RequestManager
--------------
Manages JSON-RPC requests to a given provider.

- **Initialization**:  
  `RequestManager(provider)`  
  Initializes with a provider object responsible for making the actual requests.

- **Methods**:  
  - `setProvider(provider)`  
    Sets or updates the provider used for requests.

  - `request_blocking(method, params)`  
    Makes a synchronous JSON-RPC request using the provider.  
    Raises `ValueError` if the response contains an error.

  - `request_async(method, params)`  
    Initiates an asynchronous request using gevent greenlets. Returns a unique request ID.

  - `receive_blocking(request_id, timeout=None)`  
    Waits for the asynchronous request identified by `request_id` to complete, with an optional timeout. Returns the result or raises errors if the request failed or was not found.

  - `receive_async(request_id, *args, **kwargs)`  
    Not implemented. Intended for callback-based asynchronous handling.

ManagerWrapper
--------------
A wrapper class that delegates all calls to an underlying manager instance.

- **Initialization**:  
  `ManagerWrapper(wrapped_manager)`  
  Wraps an existing manager instance.

- **Properties**:  
  - `provider`  
  - `pending_requests`

- **Methods**:  
  Delegates `setProvider`, `request_blocking`, `request_async`, `receive_blocking`, and `receive_async` to the wrapped manager.

BaseSendRawTransactionMixin
---------------------------
A mixin class extending `ManagerWrapper` to add functionality for sending raw signed transactions and managing transaction nonces.

- **Initialization**:  
  Initializes internal tracking dictionaries for known transactions and nonces.

- **Internal Methods**:  
  - `_get_nonces_and_cleanup(addr, chain_nonce)`  
    Retrieves and cleans up known transaction nonces for a given address, removing those that are below the current chain nonce.

- **Nonce Management**:  
  - `get_chain_nonce(addr)`  
    Retrieves the current transaction count (nonce) for an address from the blockchain.

  - `get_nonce(addr)`  
    Returns the next nonce to use for a transaction from the given address, considering both the chain nonce and locally tracked nonces.

- **Transaction Signing**:  
  - `get_transaction_signature(serialized_txn)`  
    Abstract method to be implemented by subclasses to provide the signature for a serialized transaction.

  - `sign_and_serialize_transaction(transaction)`  
    Serializes and signs a transaction, returning the RLP-encoded signed transaction bytes.

- **Transaction Construction**:  
  - `construct_full_transaction(base_transaction)`  
    Completes a base transaction dictionary by setting default values for nonce, gas price, gas limit, value, recipient, and data fields.

- **Request Handling Override**:  
  Overrides `request_blocking` to intercept transaction sending methods (`eth_sendTransaction`, `eth_sendRawTransaction`, `personal_signAndSendTransaction`, `personal_sendTransaction`).  
  For `eth_sendTransaction`, it constructs a fully signed raw transaction and sends it via `eth_sendRawTransaction`.  
  For other methods, it delegates to the superclass implementation.

Constants
---------
- `TXN_SENDING_METHODS`  
  A set of JSON-RPC method names related to sending transactions that are specially handled by the mixin.

Usage Notes
-----------
- The `RequestManager` class is suitable for managing synchronous and asynchronous JSON-RPC requests with error handling.
- The `ManagerWrapper` allows extending or modifying behavior of existing managers without altering their interface.
- The `BaseSendRawTransactionMixin` provides essential functionality for managing Ethereum transaction nonces and signing, intended to be combined with a manager class that implements the `get_transaction_signature` method.
- Asynchronous request handling uses `gevent` greenlets for concurrency.
- Transaction serialization and signing rely on RLP encoding and utility functions from the `web3` library.

Dependencies
------------
- `uuid` for generating unique request IDs.
- `json` for parsing JSON responses.
- `collections` for default dictionary usage.
- `gevent` for asynchronous concurrency.
- `rlp` for encoding and decoding transactions.
- `web3.utils` modules for cryptographic and encoding utilities.

Exceptions
----------
- Raises `ValueError` when JSON-RPC responses contain errors.
- Raises `KeyError` if an asynchronous request ID is not found.
- Raises `NotImplementedError` for unimplemented asynchronous callback handling and abstract methods.

This module is designed to be part of a larger Ethereum client or library, facilitating interaction with Ethereum nodes via JSON-RPC and managing transaction lifecycle details such as nonce tracking and signing.