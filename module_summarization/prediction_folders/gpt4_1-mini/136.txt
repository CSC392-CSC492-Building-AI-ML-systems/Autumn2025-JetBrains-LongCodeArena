Image Extraction
================

This module provides a collection of charge extraction algorithms designed to reduce camera waveforms to a single value per pixel, representing the extracted charge and associated pulse timing. These algorithms are essential for processing raw waveform data from Cherenkov telescopes, enabling subsequent analysis steps such as image cleaning, parameterization, and event reconstruction.

Overview
--------

Charge extraction involves integrating the signal over a defined time window within the waveform of each pixel. The goal is to accurately estimate the total charge (signal) and the pulse time, which are critical for reconstructing the properties of the detected air shower.

The extraction methods implemented here include fixed and dynamic window integration techniques, peak finding algorithms, and baseline subtraction methods. They are optimized for performance using Numba's just-in-time compilation and support vectorized operations over multiple pixels and waveforms.

Key Components and Functions
----------------------------

### extract_around_peak

```python
extract_around_peak(waveforms, peak_index, width, shift, sampling_rate_ghz)
```

- **Description**: Integrates the waveform samples around a specified peak position using a window defined by `width` and `shift`. It also computes the pulse time as a weighted average of the samples within the integration window.
- **Parameters**:
  - `waveforms` (ndarray): The waveform data for each pixel, shape `(n_pix, n_samples)`.
  - `peak_index` (int or ndarray): The index of the peak sample for each pixel.
  - `width` (int or ndarray): The size of the integration window.
  - `shift` (int or ndarray): The shift of the integration window relative to the peak.
  - `sampling_rate_ghz` (float): The camera sampling rate in GHz.
- **Returns**:
  - `charge` (ndarray): The integrated charge per pixel.
  - `peak_time` (ndarray): The pulse time in nanoseconds.

This function is implemented as a Numba guvectorize ufunc, allowing efficient application over arrays of waveforms.

### extract_sliding_window

```python
extract_sliding_window(waveforms, width, sampling_rate_ghz)
```

- **Description**: Finds the window of consecutive samples of size `width` with the largest sum within each waveform and integrates over this window. The pulse time is computed as the weighted average of the samples in this window.
- **Parameters**:
  - `waveforms` (ndarray): The waveform data for each pixel, shape `(n_pix, n_samples)`.
  - `width` (int or ndarray): The size of the sliding integration window.
  - `sampling_rate_ghz` (float): The camera sampling rate in GHz.
- **Returns**:
  - `charge` (ndarray): The integrated charge per pixel.
  - `peak_time` (ndarray): The pulse time in nanoseconds.

This method is useful when the peak position is not known a priori and the integration window is dynamically positioned to maximize the signal.

Additional Extractors and Utilities
-----------------------------------

The module also includes a variety of other extraction classes and functions, such as:

- **ImageExtractor**: Base class for image extraction algorithms.
- **FlashCamExtractor**: Specialized extractor for FlashCam camera data.
- **FullWaveformSum**: Integrates the full waveform without windowing.
- **FixedWindowSum**: Integrates a fixed window of samples.
- **GlobalPeakWindowSum**: Uses a global peak position for all pixels.
- **LocalPeakWindowSum**: Uses local peak positions per pixel.
- **SlidingWindowMaxSum**: Implements the sliding window maximum sum method.
- **NeighborPeakWindowSum**: Incorporates neighboring pixel information for peak finding.
- **BaselineSubtractedNeighborPeakWindowSum**: Extends neighbor peak window sum with baseline subtraction.
- **TwoPassWindowSum**: Performs a two-pass integration for improved accuracy.

Supporting functions include:

- `neighbor_average_maximum`: Computes the average maximum signal among neighboring pixels.
- `subtract_baseline`: Removes baseline offsets from waveforms.
- `integration_correction`: Applies corrections to the integrated charge values.

Usage Notes
-----------

- The extraction functions expect waveforms as numpy arrays with shape `(n_pixels, n_samples)`.
- Sampling rates must be provided in GHz (or converted accordingly).
- The output charge values are typically used as input for image cleaning and parameterization steps.
- Many functions are optimized with Numba for high performance on large datasets.

Summary
-------

This module provides a comprehensive suite of tools for extracting charge and timing information from camera waveforms in Cherenkov telescope data. By offering multiple extraction strategies, it allows users to select the most appropriate method for their camera type and analysis goals, ensuring accurate and efficient image reconstruction.