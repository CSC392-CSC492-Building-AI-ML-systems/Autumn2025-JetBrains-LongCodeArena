Running Migrations Backwards
============================

This module provides functionality to reverse (undo) database migrations for Piccolo ORM applications. It allows you to rollback migrations either for a specific app or for all apps, with options to preview the SQL commands, automatically agree to prompts, and clean up migration files after reversal.

BackwardsMigrationManager
-------------------------

The `BackwardsMigrationManager` class is responsible for managing the process of running migrations backwards for a given app.

### Initialization

```python
BackwardsMigrationManager(
    app_name: str,
    migration_id: str,
    auto_agree: bool = False,
    clean: bool = False,
    preview: bool = False,
)
```

- `app_name`: The name of the app whose migrations are to be reversed.
- `migration_id`: The migration ID up to which migrations should be reversed. Special values:
  - `"all"`: Reverse all migrations.
  - `"1"`: Reverse only the most recent migration.
- `auto_agree`: If `True`, automatically agree to any confirmation prompts.
- `clean`: If `True`, delete migration files from disk after reversing.
- `preview`: If `True`, do not execute the migrations, only print the SQL queries.

### Methods

- `run_migrations_backwards(app_config: AppConfig) -> MigrationResult`  
  Runs the migrations backwards for the specified app configuration. It handles user confirmation, determines the subset of migrations to reverse, and executes them in reverse order.

- `run() -> MigrationResult`  
  Creates the migration table if necessary, retrieves the app configuration, and runs the backwards migrations.

Functions
---------

### run_backwards

```python
async def run_backwards(
    app_name: str,
    migration_id: str = "1",
    auto_agree: bool = False,
    clean: bool = False,
    preview: bool = False,
) -> MigrationResult
```

Runs migrations backwards for the specified app or for all apps.

- `app_name`: The app to reverse migrations for. Use `"all"` to reverse migrations for all apps.
- `migration_id`: Migrations will be reversed up to and including this migration ID. Use `"all"` to undo all migrations, or `"1"` to undo the most recent migration.
- `auto_agree`: Automatically agree to any input prompts if `True`.
- `clean`: Delete migration files after reversing if `True`.
- `preview`: Only print SQL queries without executing if `True`.

If reversing migrations for all apps, the apps are processed in reverse order. User confirmation is requested unless `auto_agree` is `True`.

### backwards

```python
async def backwards(
    app_name: str,
    migration_id: str = "1",
    auto_agree: bool = False,
    clean: bool = False,
    preview: bool = False,
)
```

A convenience async function to undo migrations up to a specific migration. It calls `run_backwards` internally and exits the program with status code 1 if the operation fails.

Parameters are the same as for `run_backwards`.

MigrationStatus and CheckMigrationManager
-----------------------------------------

The module also defines a `MigrationStatus` dataclass and a `CheckMigrationManager` class (incomplete in this snippet) intended for checking the status of migrations for a given app.

- `MigrationStatus` holds information about a migration, including:
  - `app_name`: The name of the app.
  - `migration_id`: The migration identifier.
  - `description`: A description of the migration.
  - `has_ran`: Boolean indicating if the migration has been applied.

- `CheckMigrationManager` is initialized with an app name and is designed to retrieve migration statuses asynchronously.

Summary
-------

This module is primarily focused on safely reversing migrations in Piccolo ORM projects, providing user interaction, preview capabilities, and cleanup options. It supports reversing migrations for individual apps or all apps in a controlled manner.