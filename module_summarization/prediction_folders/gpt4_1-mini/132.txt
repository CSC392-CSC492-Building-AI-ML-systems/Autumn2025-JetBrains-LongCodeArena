Markov Chain Monte Carlo (MCMC) Framework
=========================================

Overview
--------

This module provides a comprehensive framework for performing equilibrium sampling from a specified thermodynamic state of a biomolecular system using Markov chain Monte Carlo (MCMC) methods. It supports a variety of MCMC moves and allows flexible composition of these moves to efficiently explore the conformational space.

Supported Moves
---------------

The framework currently supports the following types of moves:

- **Langevin Dynamics Move**  
  Performs Langevin dynamics integration steps, assuming negligible integration error.

- **Hybrid Monte Carlo (HMC) Move**  
  Combines molecular dynamics trajectories with a Metropolis acceptance criterion to generate proposals.

- **Generalized Hybrid Monte Carlo (GHMC) Move**  
  An extension of HMC that includes momentum randomization for improved sampling.

- **Monte Carlo Barostat Moves**  
  Allows volume changes to sample the isobaric-isothermal ensemble.

These moves can be combined using the following composite move classes:

- **SequenceMove**  
  Executes a sequence of moves in a specified order at each iteration.

- **WeightedMove**  
  Selects one move at random at each iteration according to specified probabilities.

Key Features
------------

- **Context Caching**  
  By default, MCMC moves utilize a global `ContextCache` that manages OpenMM Contexts on the fastest available platform, minimizing overhead from context creation and reinitialization.

- **Flexible Platform Selection**  
  Users can configure the OpenMM platform used for simulations, including switching to reference or CPU platforms for debugging or compatibility.

- **Customizable Context Caches**  
  Local context caches with user-defined capacities and lifetimes can be created for specialized use cases. A `DummyContextCache` is also available for scenarios where context caching is not desired.

- **Statistics Tracking**  
  MCMC move classes can maintain internal statistics such as the number of attempted moves and acceptance rates, facilitating performance monitoring and tuning.

Usage Example
-------------

The following example demonstrates how to set up and run an MCMC simulation for alanine dipeptide in vacuum:

```python
from simtk import unit
from openmmtools import testsystems, cache
from openmmtools.states import ThermodynamicState, SamplerState

# Create the initial thermodynamic and sampler states
test = testsystems.AlanineDipeptideVacuum()
thermodynamic_state = ThermodynamicState(system=test.system, temperature=298*unit.kelvin)
sampler_state = SamplerState(positions=test.positions)

# Define MCMC moves
ghmc_move = GHMCMove(timestep=1.0*unit.femtosecond, n_steps=50)
langevin_move = LangevinDynamicsMove(n_steps=10)

# Create a sampler with a single move
sampler = MCMCSampler(thermodynamic_state, sampler_state, move=ghmc_move)

# Combine moves into a sequence
sequence_move = SequenceMove([ghmc_move, langevin_move])
sampler = MCMCSampler(thermodynamic_state, sampler_state, move=sequence_move)

# Or create a weighted move to select moves probabilistically
weighted_move = WeightedMove([(ghmc_move, 0.5), (langevin_move, 0.5)])
sampler = MCMCSampler(thermodynamic_state, sampler_state, move=weighted_move)

# Configure the global context cache platform if desired
import openmm
reference_platform = openmm.Platform.getPlatformByName('Reference')
cache.global_context_cache.platform = reference_platform
cache.global_context_cache.time_to_live = 10  # number of read/write operations

# Minimize and run the sampler
sampler.minimize()
sampler.run(n_iterations=2)
```

Advanced Configuration
----------------------

- **Local Context Caches**

  To avoid using the global cache, create local caches with specific capacities and lifetimes:

  ```python
  local_cache1 = cache.ContextCache(capacity=5, time_to_live=50)
  local_cache2 = cache.ContextCache(platform=reference_platform, capacity=1)

  sequence_move = SequenceMove([HMCMove(), LangevinDynamicsMove()], context_cache=local_cache1)
  ghmc_move = GHMCMove(context_cache=local_cache2)
  ```

- **No Context Caching**

  To disable context caching entirely and create a new context for each move:

  ```python
  dummy_cache = cache.DummyContextCache(platform=reference_platform)
  ghmc_move = GHMCMove(context_cache=dummy_cache)
  ```

References
----------

Jun S. Liu. *Monte Carlo Strategies in Scientific Computing*. Springer, 2008.

License
-------

All code in this framework is released under the MIT License. This software is provided "as is", without warranty of any kind.

---

This framework enables flexible and efficient MCMC sampling for biomolecular simulations, leveraging OpenMM's capabilities and providing extensible abstractions for custom move implementations.