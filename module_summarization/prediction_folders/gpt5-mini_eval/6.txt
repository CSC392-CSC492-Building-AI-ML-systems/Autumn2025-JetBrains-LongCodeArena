Working with user security roles
===============================

This document describes how to inspect, create, update, assign and remove security roles using the ftrack Python API. All examples assume you have an active Session instance available as ``session``.

Overview
--------
Security roles (SecurityRole entities) control permissions assigned to users and groups. You can query, create, update and delete roles through the normal ftrack entity API and assign roles to Users or Groups.

Querying roles
--------------
Find roles by name or list all roles:

Example — find role by name
::
    role = next(session.query("select SecurityRole where name is 'Artist'"), None)

Example — list all roles
::
    for role in session.query("select SecurityRole"):
        print(role['name'], role['id'])

Get role by id
::
    role = session.get('SecurityRole', 'ROLE_ID')

Creating, updating and deleting roles
-------------------------------------
Create a new role:
::
    role = session.create('SecurityRole', {
        'name': 'My Role',
        'description': 'Role used for X'
    })
    session.commit()

Update an existing role (change attributes and commit):
::
    role['description'] = 'Updated description'
    session.commit()

Delete a role:
::
    session.delete(role)
    session.commit()

Assigning roles to users and groups
----------------------------------
Users and Groups hold relationships to security roles. When assigning, read the current relationship, modify, assign back and commit.

Example — assign role to a user:
::
    user = session.get('User', 'USER_ID')  # or query for the user
    current = list(user.get('security_roles') or [])
    if role not in current:
        current.append(role)
        user['security_roles'] = current
        session.commit()

Example — remove role from a user:
::
    current = list(user.get('security_roles') or [])
    if role in current:
        current.remove(role)
        user['security_roles'] = current
        session.commit()

Example — assign role to a group:
::
    group = session.get('Group', 'GROUP_ID')
    current = list(group.get('security_roles') or [])
    if role not in current:
        current.append(role)
        group['security_roles'] = current
        session.commit()

Listing users assigned to a role
-------------------------------
You can query Users that have a specific role:

Example — list users in a role (by role id or name)
::
    for user in session.query(
        "select User where security_roles.id is '{0}'".format(role['id'])
    ):
        print(user['username'], user['id'])

Or by role name:
::
    for user in session.query(
        "select User where security_roles.name is 'Artist'"
    ):
        print(user['username'])

Permissions and role details
----------------------------
Role entities contain the role definition and its permissions. The exact shape and editable permission fields depend on your ftrack server schema and version. Inspect a role to view available permission-related attributes:
::
    for key, value in role.items():
        print(key, value)

Modify permission-related fields only when you understand the server schema and the permission model your installation uses. Changes should always be followed by a commit:
::
    role['some_permission_field'] = <new-value>
    session.commit()

Best practices
--------------
- Use explicit commits to persist changes (``session.commit()``).
- Read relationships (``user.get('security_roles')``) into a Python list before modifying and reassigning.
- Avoid manipulating low-level internals; prefer the documented entity attributes.
- Use queries to find roles and members by name or id rather than hard-coding ids where possible.
- Test role changes in a non-production environment before applying to production.

Troubleshooting
---------------
- If a change doesn't appear immediately in other clients, consider cache and session consistency (refresh or re-query).
- Ensure the account you use for API requests has sufficient permissions to modify roles or assign them to users/groups.

Further information
-------------------
Refer to your ftrack server documentation and schema for details on role permission structures and server-specific fields.