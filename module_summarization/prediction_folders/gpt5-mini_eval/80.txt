cubes.mapplot — Map plotting and interactive cube↔spectrum viewer
================================================================

Module overview
---------------
This module provides an interactive map plotting helper that links 2D map
positions in a data cube to spectra. It is intended for interactive
exploration rather than publication-ready plotting, though it can produce
high-quality output when used with APLpy.

Key features
- Display a 2D plane extracted from a cube (selected with the module's
  plane-making functionality).
- Interactive clicks:
  - Button 1 or key '1': open a spectrum window for the selected pixel
    and mark the clicked pixel with an 'x'.
  - Button 2 or key 'o': overplot additional spectra on the external
    spectrum window.
  - Button 3: disconnect the interactive viewer.
- Click-and-drag or use keys to average over circular regions.
- Optional use of APLpy for FITS/WCS-aware plotting and colorbars.

Dependencies
------------
- Python standard library: copy, itertools
- matplotlib (figure and pyplot)
- numpy
- six
- Optional / recommended:
  - astropy.wcs (or legacy pywcs) and astropy.io.fits (or pyfits) for WCS
    support and FITS headers.
  - aplpy for FITS- and WCS-aware plotting with colorbars.

Primary class: MapPlotter
-------------------------
Class purpose
    Create and display a map (2D plane) derived from a cube and provide
    interactive linking to spectrum plotting windows.

Instantiation
    MapPlotter(Cube=None, figure=None, doplot=False, **kwargs)

Parameters
- Cube: cube-like object (expected to have a header and data). If provided,
  the MapPlotter will extract and flatten the header for WCS use.
- figure: matplotlib.figure.Figure instance or integer figure number.
  If omitted the MapPlotter will create a new figure when plotting.
- doplot: if True, call mapplot during initialization.
- kwargs: passed on to mapplot or used by internal plane-making routine.

Attributes (selected)
- figure: the matplotlib Figure used for plotting.
- axis: matplotlib/Aplpy axes used to display the image.
- FITSFigure: APLpy FITSFigure instance when APLpy is used.
- Cube: the input cube.
- header: flattened FITS header extracted from Cube (if Cube provided).
- wcs: astropy.wcs.WCS instance when WCS available.
- plane: the 2D data plane chosen for display (created by makeplane()).
- _origin: origin convention used for display (0 for FITS/Aplpy by default).
- canvas: the matplotlib canvas associated with the display.
- _click_marks, _circles: bookkeeping for on-figure markers.

Usage
- Call the instance like a function to show the map:
    mp = MapPlotter(Cube=mycube)
    mp()                       # uses default mapplot parameters
    mp.mapplot(estimator='mean', cmap='gray')

- Typical pattern:
    1. Construct MapPlotter with a Cube (or pass Cube to mapplot).
    2. Call mapplot to render a plane and enable interactivity.
    3. Use mouse buttons / keys to inspect spectra for pixels or regions.

mapplot method
--------------
Signature
    mapplot(convention='calabretta', colorbar=True, useaplpy=True,
            vmin=None, vmax=None, cmap=None, plotkwargs={}, **kwargs)

Description
- Render the selected 2D plane in a figure, using APLpy when available and
  requested. If APLpy is not available, matplotlib.imshow is used.
- The plane is produced by an internal makeplane(...) call (kwargs passed
  through), which supports selection and simple estimators (e.g. mean,
  median). Any 'estimator' argument is forwarded to makeplane.

Parameters
- convention: projection convention for APLpy (default: 'calabretta').
- colorbar: show a colorbar if True.
- useaplpy: prefer APLpy when a FITS header/WCS is available.
- vmin, vmax: manual min/max for display scaling; if None they are chosen
  from the plane data.
- cmap: colormap name or object for the display.
- plotkwargs: additional kwargs forwarded to APLpy.show_colorscale or
  matplotlib.axes.Axes.imshow.
- **kwargs: forwarded to the internal plane-selection routine (e.g.
  estimator).

Interactive controls
--------------------
- Mouse and keyboard events are connected when a map is drawn:
  - button_press_event -> click()
  - button_release_event -> plot_spectrum()
  - key_press_event -> plot_spectrum()
- Click-and-drag with button 1 averages over a circular region.
- Keys:
  - '1': plot the selected pixel spectrum in a new window.
  - 'o': overplot additional spectra in the external spectrum window.
  - 'c': set circle center (for averaging).
  - 'r': set circle radius (for averaging).
- The object maintains internal markers on the figure to indicate clicked
  positions and circles.

Notes and behavior details
--------------------------
- If APLpy is available and used, a FITS PrimaryHDU is created from the
  plane and header; APLpy's FITSFigure.show_colorscale is used for display.
- Error handling: attempts to add a colorbar or APLpy elements are wrapped
  to avoid exceptions stopping interactive use; errors are printed.
- The module assumes the cube object provides a header attribute and that
  cubes.flatten_header can produce a flattened FITS header suitable for
  astropy.wcs.WCS.

Example
-------
from cubes.mapplot import MapPlotter

mp = MapPlotter(Cube=my_cube)      # create the plotter
mp.mapplot(estimator='median')     # display a median plane and enable interactivity

See also
--------
- APLpy (optional): for FITS/WCS-aware plotting and aesthetically-enhanced
  maps.
- astropy.wcs / pywcs and astropy.io.fits / pyfits: required for WCS
  handling when working with FITS headers.

API summary
-----------
Classes
- MapPlotter — create interactive map displays linked to spectra.

Methods (selected)
- MapPlotter.__init__(Cube=None, figure=None, doplot=False, **kwargs)
- MapPlotter.__call__(**kwargs) -> alias for mapplot
- MapPlotter.mapplot(convention='calabretta', colorbar=True, useaplpy=True,
                     vmin=None, vmax=None, cmap=None, plotkwargs={}, **kwargs)
- MapPlotter._connect() / MapPlotter._disconnect() — internal event wiring

End of module documentation.