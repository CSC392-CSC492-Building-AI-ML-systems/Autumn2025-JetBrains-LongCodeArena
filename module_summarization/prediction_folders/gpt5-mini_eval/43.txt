Config
======

Overview
--------
ConfigParser is an enhanced drop-in replacement for Python's configparser.ConfigParser used to manage application configuration. It provides:

- Built-in default values for common sections (general, logging, housekeeping, etc.).
- Environment-variable driven defaults (e.g. ASAB_CONFIG, ASAB_ZOOKEEPER_SERVERS).
- Include support (globbing and recursive includes).
- Optional integration with Zookeeper (include from zookeeper:...).
- Password lookup via a dedicated [passwords] section and ${passwords:key} substitution.
- Convenient helper to merge additional default values programmatically.
- Careful handling of includes to avoid infinite loops and duplicate includes.
- Platform-aware defaults for syslog sockets and pidfile handling.

Quick start
-----------
Create and use the parser like a normal ConfigParser:

from path.to.module import ConfigParser

cfg = ConfigParser()        # instance inherits configparser API
cfg.read("myapp.conf")     # or call read_file / read_string as usual
value = cfg.get("section", "option", fallback="default")

Defaults and environment-driven values
--------------------------------------
ConfigParser ships with a set of built-in default values (see notable ones below). Some defaults are taken from environment variables:

- ASAB_CONFIG: If set, used as the default path for the configuration file.
- ASAB_VERBOSE: influences logging.verbose default.
- ASAB_ZOOKEEPER_SERVERS: if present, a default [zookeeper] servers key is added.

Notable default sections/keys (examples)
- [general]
  - config_file: from ASAB_CONFIG or empty
  - tick_period: 1
  - var_dir: ~/.<program-name>
  - pidfile: '!' (special marker — transformed into platform-specific pidfile location)
  - working_dir, uid, gid, changelog, manifest

- [logging]
  - app_name: basename of the running program
  - level: NOTICE
  - sd_id, levels, verbose

- [logging:console], [logging:file], [logging:syslog]
  - format, datefmt, file path, rotation defaults, syslog address/format (platform-aware)

- [asab:metrics], [asab:doc], [library], [housekeeping], [passwords] (empty by default)

Adding or overriding defaults programmatically
----------------------------------------------
To inject or merge additional default values into the parser programmatically:

extra = {
    "mysection": {
        "key1": "value1",
        "path": "${HOME}/data"
    }
}
cfg.add_defaults(extra)

Behavior:
- add_defaults will create missing sections and only set keys that do not already exist.
- Values containing "$" are expanded with os.path.expandvars before being set.

Include support (files and globbing)
------------------------------------
- The configuration supports an include mechanism via the "include" key in the [general] section.
- Includes may be space-separated or newline-separated lists of globs/paths.
- Globs are expanded with glob.glob(); each matched path is read.
- Includes are resolved against any current load-directory stack so nested includes work.
- The parser prevents including the same absolute path more than once — a warning is emitted if a file would be included multiple times.
- After including a file, includes declared inside that file are processed recursively.

Example in config file:
[general]
include = conf.d/*.conf other.conf

Zookeeper includes
------------------
- If an include entry starts with "zookeeper", the parser will attempt to include data from Zookeeper (e.g. connection string or path). This integrates with the project's Zookeeper helper code; the exact syntax is "zookeeper..." (see project helper utilities).
- When ASAB_ZOOKEEPER_SERVERS is set, a sensible default [zookeeper] servers key is available.

Passwords and secure values
---------------------------
- The [passwords] section is intended to store secrets.
- Other sections can reference a password using the ${passwords:key} substitution syntax:

[connection:KafkaConnection]
password=${passwords:kafka_password}

[passwords]
kafka_password=supersecret

The parser does not automatically expose passwords differently; this pattern centralizes secret storage in the config file.

Value handling and expansions
-----------------------------
- When add_defaults sets a default value and it contains "$", environment variable expansion is performed (os.path.expandvars).
- For values read directly from files, standard configparser parsing rules apply; use getboolean, getint, getfloat when appropriate.

Include processing notes
------------------------
- Include lists may be separated by spaces or newlines (the parser detects which was used).
- The parser keeps an internal set of already-included absolute paths to avoid re-including the same file.
- When a file is included, the current working include-directory is pushed on an internal stack so relative includes inside included files resolve properly.

Logging and syslog platform defaults
-----------------------------------
- Default syslog socket path and format are platform-aware; e.g. Darwin uses /var/run/syslog and a particular format code.
- See [logging:syslog] defaults for address and format.

Special values
--------------
- pidfile = '!' is a sentinel value meaning "use platform-specific pidfile location". The parser (or higher-level runtime) interprets and transforms this sentinel into an actual path.

Examples
--------
Simple usage:

cfg = ConfigParser()
cfg.read("myapp.conf")
host = cfg.get("http", "host", fallback="127.0.0.1")
port = cfg.getint("http", "port", fallback=8080)

Merging programmatic defaults:

cfg.add_defaults({
    "http": {"host": "0.0.0.0", "port": "8080"},
})

Include example in file:

[general]
include = conf.d/*.conf
config_file = /etc/myapp/myapp.conf

Password reference example:

[connection:db]
user = admin
password = ${passwords:db_password}

[passwords]
db_password = change-me

Notes and implementation details
-------------------------------
- ConfigParser is a subclass of configparser.ConfigParser and supports the same public API (read, read_file, read_string, get, items, sections, etc.).
- Some behaviors (include traversal, zookeeper integration, pidfile sentinel) are specific to this enhanced implementation.
- Warnings about duplicate includes are logged via the module logger.

If you need to rely on Zookeeper include syntax or password resolution behavior, refer to the project's utilities and runtime integration for exact semantics.