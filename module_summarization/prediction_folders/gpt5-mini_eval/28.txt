w_multi_west
=============

Summary
-------
w_multi_west is a WESTPA utility that combines multiple WESTPA simulations into a single HDF5 file while accounting for reweighting. It merges trajectory / summary data across simulations, optionally combining auxiliary datasets and ibstates, and writes a consolidated output file (default: multi.h5).

Synopsis
--------
w_multi_west [OPTIONS] SIMS_YAML

Description
-----------
This tool is designed to combine the results of multiple independent WESTPA simulations. It:

- Opens each simulation directory listed in a simulation list (see "Input") and reads the main WESTPA HDF5 files (by default named "west.h5" or as specified).
- Attempts to preserve and merge relevant datasets, including per-iteration walker counts and auxiliary datasets.
- Looks up binning topologies stored under /bin_topologies in each HDF5 file (using the stored hash and pickled mapper objects) when required.
- Converts and normalizes istate arrays to the current WESTPA istate_dtype when combining states.
- Computes the total number of walkers per iteration by summing the 'n_particles' field from each simulation's summary dataset (ignoring the final, in-progress summary row).
- Provides an option to disable reweighting if the user prefers a simple concatenation.

Options
-------
Common options (available via command-line arguments):

- -o, --output-file
  Name of the output HDF5 file to store results in (default: multi.h5).

- -W, --west, --WEST_H5FILE
  Name of the main WESTPA HDF5 file within each simulation directory (default: west.h5).

- -a, --aux
  Append one or more auxiliary dataset names to be combined from each simulation. Use this option multiple times to list multiple auxiliary datasets.

- -aa, --auxall
  Combine all auxiliary datasets found in the simulations (default: False).

- -nr, --no-reweight
  Do not perform reweighting when combining datasets; instead combine without reweighting adjustments (default: False).

- -ib, --ibstates
  Attempt to combine the ibstates dataset (default: False).

- Progress options
  The tool uses a progress indicator component; standard progress-related command-line options are exposed through that component (see usage or --help for available progress options).

Input / Simulation list
-----------------------
w_multi_west expects a list of simulation directories to combine. The code includes a convention for a YAML file containing the paths:

---
PATHS:
  - /path/to/simulation/1
  - /path/to/simulation/2
  - ...
  - /path/to/simulation/n

Pass the path to that YAML file (SIMS_YAML) or supply simulation locations in whatever form the surrounding WESTMultiTool wrapper expects. Each listed simulation directory should contain the per-simulation WESTPA HDF5 file (default name: west.h5).

Output
------
The tool writes a single consolidated WESTPA-format HDF5 file (default name: multi.h5). The output file is created with creator/stamp metadata. Combined datasets include merged summaries and any requested auxiliary datasets and ibstates, subject to consistency across runs.

Behavioral notes and assumptions
------------------------------
- The tool assumes istates are compatible across simulations; during merging, istate arrays are converted to the current istate_dtype and missing/aux fields (e.g., 'basis_auxref') are initialized appropriately.
- Binning mapper objects are retrieved from the /bin_topologies group inside each WESTPA HDF5 file; the tool unpickles stored mapper pickles to reconstitute bin mappers. A KeyError is raised if requested binning information is not present.
- Total walker counts per iteration are computed by summing 'n_particles' from each simulation's summary dataset (excluding the final in-progress entry).
- An inner Segment helper structure is used to represent individual trajectory segments during processing (fields: weight, iteration, simid, recycled_in).
- The tool is conservative about loading data in chunks when looking up pickled binning entries to limit memory usage.

Examples
--------
Combine simulations listed in sims.yaml (YAML with PATHS: [...]) producing multi.h5 (default behavior):

  w_multi_west sims.yaml

Combine and include a named auxiliary dataset "aux/traj":

  w_multi_west -a aux/traj sims.yaml

Combine all auxiliary datasets and include ibstates:

  w_multi_west -aa -ib sims.yaml

Combine but skip reweighting:

  w_multi_west -nr sims.yaml

Limitations and troubleshooting
-------------------------------
- If binning topologies or pickles are missing from a simulation's HDF5 file, the tool will raise an error when it attempts to retrieve the mapper.
- If simulations differ in iteration counts or structure, the tool will attempt to align data but may raise ValueError when shapes are incompatible; ensure simulations are comparable before combining.
- The tool currently assumes a common istate structure across simulations; mismatches may require preprocessing to normalize istate fields.

See also
--------
- The WESTPA project documentation for WESTPA HDF5 layout and binning topology conventions.
- The underlying WESTMultiTool and WESTTool classes for shared multi-simulation handling and options.