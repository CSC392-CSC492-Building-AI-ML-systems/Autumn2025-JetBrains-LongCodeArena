nvidia.dali.auto_aug.rand_augment module
=======================================

Overview
--------
Utilities to apply the RandAugment augmentation scheme to image and video batches.
This module provides a high-level rand_augment helper implementing the RandAugment
policy (Cubuk et al., 2019) and helpers to apply a custom list of augmentations.
RandAugment samples a fixed number of augmentation operations per sample and
applies them with a fixed magnitude bin.

References
----------
RandAugment: https://arxiv.org/abs/1909.13719

Functions
---------

rand_augment
~~~~~~~~~~~~
Signature
    nvidia.dali.auto_aug.rand_augment.rand_augment(
        data,
        n,
        m,
        num_magnitude_bins=31,
        shape=None,
        fill_value=128,
        interp_type=None,
        max_translate_abs=None,
        max_translate_rel=None,
        seed=None,
        monotonic_mag=True,
        excluded=None
    )

Description
    Apply the RandAugment augmentation scheme to a batch of samples.

Parameters
    data (nvidia.dali.data_node.DataNode)
        A batch of samples to process. Supported inputs are images with HWC layout
        or videos with FHWC layout. Supported dtype: uint8.
    n (int)
        Number of randomly sampled operations to apply to each sample.
    m (int)
        Magnitude (strength) of each operation. Integer in [0, num_magnitude_bins - 1].
    num_magnitude_bins (int, optional)
        Number of magnitude bins used to quantize operation strengths. Default: 31.
    shape (DataNode or tuple(int, int), optional)
        Image/frame size (height, width). If provided, translation magnitudes are
        interpreted relative to the image shape and scaled up to max_translate_rel * shape.
        If omitted, translation magnitudes use absolute pixels limited by max_translate_abs.
    fill_value (int or None, optional)
        Value used to fill areas exposed by geometric transforms (warp_affine: rotate,
        translate, shear). If None, the border is clamped (edge-pixel replication).
        Default: 128.
    interp_type (nvidia.dali.types.DALIInterpType, optional)
        Interpolation used by warp_affine operations. Supported values include
        types.INTERP_LINEAR and types.INTERP_NN.
    max_translate_abs (int or (int,int), optional)
        If shape is not provided, maximal translation (in pixels) used to compute
        translation operation magnitudes. If a tuple is given, it constrains
        (max_height_shift, max_width_shift). Defaults to a reasonable pixel value
        (e.g., 100) when not specified by the user.
    max_translate_rel (float or (float,float), optional)
        If shape is provided, maximal translation as fraction of image shape used
        to compute translation magnitudes. If a tuple is given, it constrains
        (max_height_rel, max_width_rel). Defaults to approximately 0.45 (100/224).
    seed (int, optional)
        Seed used to sample random operations (and for random sign/negation of
        some magnitudes).
    monotonic_mag (bool, optional)
        If True (default), magnitudes of operations that accept bins increase
        monotonically with bin index. If False, a non-monotonic suite is used
        where the magnitude interpretation for some color operations differs:
        - posterize and solarize strength can decrease with increasing bins;
        - enhance-like operations (brightness, contrast, color, sharpness) use
          a (0.1, 1.9) range centered such that magnitudes nearer the center
          decrease the enhancement.
        Use this flag to reproduce other frameworks' RandAugment variants.
    excluded (list[str], optional)
        Names of augmentations to exclude from the default RandAugment suite.
        If you need custom augmentations or tweaks beyond exclusion, use
        apply_rand_augment directly (it accepts a list of augmentation objects).

Returns
    DataNode
        The transformed batch.

Raises
    Exception
        If any name in excluded is not present in the default augmentation suite.

Notes
    - The function builds a suite of available augmentations (monotonic or non-monotonic
      depending on monotonic_mag) and randomly samples `n` operations for each sample,
      applying them at magnitude bin `m`.
    - If `shape` is provided, translation magnitudes are derived from image/frame size;
      otherwise, absolute pixel-based translations governed by max_translate_abs are used.

Example
    ::
        from nvidia.dali.auto_aug import rand_augment
        from nvidia.dali import types
        # data is a DataNode representing a batch of images (HWC) or videos (FHWC)
        out = rand_augment(data, n=2, m=10, num_magnitude_bins=31,
                           shape=(224, 224), fill_value=128,
                           interp_type=types.INTERP_LINEAR, seed=42)

apply_rand_augment
~~~~~~~~~~~~~~~~~~
Signature (conceptual)
    apply_rand_augment(augmentations, data, n, m, num_magnitude_bins=31, seed=None, **aug_kwargs)

Description
    Apply a user-specified list of augmentation descriptors to the input batch using
    the RandAugment sampling policy: for each sample, randomly choose `n` augmentations
    from the provided list and apply them with magnitude `m` (quantized by
    `num_magnitude_bins`).

Parameters
    augmentations (list of augmentations)
        A list of augmentation descriptor objects (instances implementing the
        auto-augmentation interface used by DALI). Each augmentation object must
        expose a `name` attribute and be usable by the augmentation application flow.
    data (DataNode)
        Input batch (same requirements as for rand_augment).
    n, m, num_magnitude_bins, seed
        See rand_augment for meanings.
    **aug_kwargs
        Per-augmentation keyword arguments propagated to augmentations that accept
        configuration such as shape, fill_value, interp_type, max_translate_abs,
        max_translate_rel, etc.

Returns
    DataNode
        The transformed batch.

Notes
    - Use this function when you want to supply a custom ordered or customized list
      of augmentation descriptors (instead of using the built-in RandAugment suites).

get_rand_augment_suite and get_rand_augment_non_monotonic_suite
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Description
    Helpers that construct the default suite of augmentation descriptor objects used
    by rand_augment. The monotonic suite produces augmentations whose magnitude
    interpretation increases monotonically with the magnitude bin index. The
    non-monotonic suite uses alternative magnitude mappings for some color/enhance
    operations to match different RandAugment variants found in other frameworks.

Parameters
    use_shape (bool)
        If True, returned augmentations will expect a per-sample image/frame shape
        (so translation operations compute magnitudes relative to shape).
    max_translate_abs, max_translate_rel
        Default translation bounds used by the translation augmentations when shape
        is absent or present, respectively.

Returns
    list of augmentation descriptors
        Each augmentation descriptor includes a `name` attribute and encapsulates
        the augmentation parameters and magnitude mapping logic.

Common augmentation behavior and parameters
-------------------------------------------
- Geometric transforms (translate, shear, rotate) accept:
    - shape or absolute translation bounds,
    - fill_value to pad exposed regions,
    - interp_type for interpolation method.
- Color and enhancement transforms accept a magnitude that is converted from
  the selected magnitude bin to the operation's native parameter range.
- Some augmentations may randomly flip signs of their magnitude (e.g., translate left/right)
  according to the RandAugment policy.

Errors and validation
---------------------
- rand_augment validates that any provided `excluded` names exist in the selected
  augmentation suite and raises an Exception otherwise.
- Users should ensure the provided `m` is a valid bin index in [0, num_magnitude_bins - 1].

Examples
--------
Basic usage
    ::
        # Apply 2 random augmentations per image with magnitude bin 12
        transformed = rand_augment(data, n=2, m=12, shape=(256, 256), seed=123)

Exclude some augmentations
    ::
        # Exclude 'solarize' and 'posterize' from the default suite
        transformed = rand_augment(data, n=3, m=15, excluded=['solarize', 'posterize'])

Custom augmentation list
    ::
        # Build or obtain a list of augmentation descriptors and apply RandAugment sampling
        custom_augs = [aug1, aug2, aug3, ...]  # augmentation descriptor objects
        transformed = apply_rand_augment(custom_augs, data, n=2, m=8, num_magnitude_bins=31)

See also
--------
- nvidia.dali.auto_aug.augmentations (available augmentation implementations and their parameters)
- nvidia.dali.auto_aug.core (internal augmentation core utilities used to create and apply augmentations)

License
-------
This module is distributed under the Apache License, Version 2.0.