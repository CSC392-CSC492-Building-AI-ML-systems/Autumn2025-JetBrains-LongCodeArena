w_red — RED-corrected rate estimation
====================================

Synopsis
--------
w_red direct.h5 ISTATE FSTATE [OPTIONS]

Purpose
-------
Compute rate constants between two Markov states (ISTATE -> FSTATE) from a WESTPA
"direct" kinetics HDF5 file. Optionally apply the RED (residence-time
distribution) correction to account for censoring of event durations and obtain
a corrected estimate of the rate constant.

Requirements
------------
The provided HDF5 file (direct.h5) must contain the following datasets:

- ``durations`` — a table of event records with fields at least:
  - ``istate`` (source state index)
  - ``fstate`` (target state index)
  - ``duration`` (duration of the event, in units of tau)
  - ``weight`` (statistical weight of the event)
- ``rate_evolution`` — an array keyed by iteration and state pairs that contains
  an ``expected`` field giving the (raw) estimated rate vs iteration.

Description
-----------
w_red reads the raw rate estimates from the ``rate_evolution`` dataset and
optionally computes a RED-correction factor derived from the distribution of
observed event durations. The RED correction compensates for censoring because
events observed late in a finite-length simulation cannot have arbitrarily long
durations.

Key behaviour implemented:

- get_raw_rates(directh5, istate, fstate, n_iters=None)
  - Returns the array of raw expected rates vs iteration taken from
    ``direct.h5['rate_evolution'][:n_iters, istate, fstate]['expected']``.

- DurationCorrector
  - Builds a histogram of event durations (binned with spacing dtau).
  - Computes a normalized effective event-duration probability density
    f_tilde(tau) proportional to the sum of event weights in the bin divided
    by (theta - tau), where theta is the observation window (maxduration).
  - Integrates f_tilde once to get the cumulative distribution, integrates
    the cumulative distribution over tau, and computes the correction factor
    as theta / (double integral). If the double integral is zero the
    correction returns 0.0.
  - The bin width dtau defaults to report_interval / n_steps_iter if not
    provided explicitly.

- calc_avg_rate(directh5_path, istate, fstate, ...)
  - Returns the raw or RED-corrected scalar rate constant at the last
    iteration (or at iteration ``n_iters`` if given).
  - Parameters accepted (keyword args):
    - ``n_iters``: number of iterations to use from the file (default: all).
    - ``report_interval`` (ntpr): reporting interval, default 20.
    - ``n_steps_iter`` (nstiter): number of steps per iteration, default 1000.
    - ``red``: boolean flag; if True, compute and apply the RED correction.
  - The correction factor is computed from durations filtered to events with
    positive weight and matching ``istate`` and ``fstate``.
  - The returned scalar is the raw expected rate multiplied by the correction
    factor (or unchanged if ``red`` is False or correction unavailable).

Algorithm / mathematics (summary)
---------------------------------
- Construct a tau grid from 0 to maxduration with spacing dtau.
- Bin event durations into that grid and form binned weight sums.
- For an observation window theta (= maxduration), define
  f_tilde(tau) = [sum of weights in bin at tau] / (theta - tau), normalized
  so that integral f_tilde(tau) dtau = 1.
- Compute integral1(t) = integral_0^t f_tilde(tau) dtau and integral2 =
  integral_0^{theta} integral1(t) dt.
- The RED correction factor is theta / integral2.

Notes and edge cases
--------------------
- If there are no relevant durations (no events with positive weight between
  istate and fstate) or the integrals vanish, the correction may be zero.
- dtau is inferred from the simulation reporting cadence:
  dtau = report_interval / n_steps_iter (units of tau).
- The code treats iteration indices and durations in consistent units of tau;
  ensure ntpr and nstiter reflect the simulation settings.

Examples
--------
Compute the raw (uncorrected) rate constant at the final iteration:

:: 
  w_red direct.h5 0 1

Compute the RED-corrected rate constant using 100 iterations and explicit
reporting settings:

:: 
  w_red direct.h5 0 1 --n-iters 100 --report-interval 20 --n-steps-iter 1000 --red

Output
------
The command reports the raw expected rate and, if requested, the RED-corrected
rate (scalar). Internally, calc_rates (when used) can produce rate evolution
arrays vs iteration for plotting or analysis.

Implementation details
----------------------
This command relies on the DurationCorrector class and routines that:

- Read the last (or specified) iteration's expected rate value from
  ``rate_evolution``.
- Optionally build the duration histogram from ``durations`` and compute the
  RED correction using the dtau inferred from ``report_interval`` and
  ``n_steps_iter``.
- Multiply the raw expected rate by the correction factor and return the
  corrected scalar.

See also
--------
- WESTPA user guide sections on kinetics analyses and direct (parallel) rate
  estimation for background on the ``rate_evolution`` and duration datasets.