Understanding sessions
======================

Overview
--------
A Session represents an isolated connection and interaction context for an ftrack
server. It encapsulates server URL and credentials, request authentication,
caching, plugin discovery, event hub handling and operation recording.

Key features
- Isolated interaction with a single ftrack server.
- Request authentication via API key and user.
- Configurable caching and cache key generation.
- Plugin discovery and argument passing to plugin register functions.
- Embedded event hub that can be connected automatically (in a background
  thread).
- Automatic attribute population on entities (when enabled).
- Recording of operations performed during the lifetime of the session.

Authentication
--------------
SessionAuthentication is a small requests auth helper used by the session to
attach required ftrack authentication headers to HTTP requests:

- Headers added:
  - ftrack-api-key: <api_key>
  - ftrack-user: <api_user>

Initialization and required values
----------------------------------
To create a Session you must provide or have available:
- server_url: URL of the ftrack server (including port if required).
  - If not passed, the value is taken from the environment variable
    FTRACK_SERVER.
- api_key: API key for authentication.
  - If not passed, the value is taken from FTRACK_API_KEY (or legacy
    FTRACK_APIKEY).
- api_user: Username to record operations against.
  - If not passed, the value is taken from FTRACK_API_USER. If still missing,
    the system username is attempted via getpass.getuser().

If any of server_url, api_key or api_user is missing after these lookups the
Session constructor raises a TypeError.

Constructor options (high-level)
--------------------------------
- server_url (str)
- api_key (str)
- api_user (str)
- auto_populate (bool, default True)
  - When True, accessing entity attributes will automatically fetch missing
    attributes from the server.
- plugin_paths (list[str])
  - Paths to search for plugins. By default the environment variable
    FTRACK_EVENT_PLUGIN_PATH can be used.
- cache (ftrack_api.cache.Cache | callable(session) -> Cache | None)
  - A cache instance or factory callable used to configure the session cache.
  - The session will add the configured cache into a layered cache whose top
    level is always a MemoryCache (so a memory cache is always present).
- cache_key_maker (ftrack_api.cache.KeyMaker)
  - Key maker used to generate cache keys. Defaults to
    ftrack_api.cache.StringKeyMaker when not provided.
- auto_connect_event_hub (bool)
  - When True the embedded EventHub is connected to the server automatically.
    The connection is performed in a background thread. Subscribing to events
    does not require the hub to be connected, but publishing/subscribing to
    non-local events does.
- schema_cache_path (str | False)
  - Path to use for schema caching. If None, FTRACK_API_SCHEMA_CACHE_PATH or a
    temporary directory will be used. Set to False to disable schema caching.
- plugin_arguments (dict)
  - Mapping of keyword arguments to pass to discovered plugin register
    functions. If a plugin does not accept the full set of arguments the
    discovery mechanism will try to reduce the arguments to those accepted and
    log a warning.

Caching behavior
----------------
- The session enforces a layered caching approach with a top-level in-memory
  cache. This ensures a consistent memory cache is always present. Providing
  additional caches via the `cache` parameter will be layered beneath the
  memory cache.
- The default cache key maker is a StringKeyMaker unless explicitly supplied.
- The cache parameter may be a callable that receives the session and returns a
  cache instance or None if a suitable cache cannot be configured.

Event hub and plugins
---------------------
- The EventHub may be connected automatically (configurable). Connection is
  performed in a background thread to reduce session startup latency.
- Plugins discovered in plugin_paths (or via environment defaults) are invoked
  with the provided plugin_arguments. If a plugin's signature is incompatible
  with the provided arguments, arguments are reduced where possible and a
  warning is logged.
- Plugins that require an already connected event hub should explicitly check
  the hub connection status; subscription to events itself does not require a
  connected hub.

Operation recording
-------------------
- Sessions maintain a recorded_operations collection (ftrack_api.operation.Operations)
  and a togglable flag record_operations (default True).
- Operations performed via the session are accumulated for potential later
  commit or inspection.

Other notes
-----------
- The session exposes a logger and an internal _closed flag to reflect state.
- The constructor and docstrings document expected behavior and defaults;
  missing required parameters raise TypeError with a descriptive message.