FleurXMLModifier
================

Summary
-------
FleurXMLModifier is a helper class to collect, organize and apply a sequence of changes to a FLEUR inp.xml file in a robust, batched way. Instead of immediately modifying XML files, it records modification "tasks" (calls to low-level XML setter functions) and can apply them in one operation. It provides a facade over the available xml-setting functions collected from the masci_tools.util.xml modules.

Key concepts
------------
- Tasks:
  - Individual modifications are recorded as tasks. Internally tasks are stored as ModifierTask namedtuples: (name, args, kwargs).
- Facade setters:
  - The public methods exposed on a FleurXMLModifier instance correspond to the low-level XML setter functions collected from the masci_tools.util.xml modules (xpath-based setters, schema-dict based setters and nmmpmat setters). Calling one of these facade methods does not change any file immediately; it only records the requested change as a task.
- Batch application:
  - All recorded tasks can be applied at once to an inp.xml file (see modify_xmlfile in the usage example below).
- Extensibility:
  - The class merges its internal function maps with any extra functions provided via the class-level _extra_functions mapping. This allows adding or overriding available setter actions before instantiation.

Important attributes
--------------------
- _xpath_functions, _schema_dict_functions, _nmmpmat_functions
  - Class-level mappings from action name (string) to callable implementing the change. These are populated from:
    - XPATH_SETTERS (xpath-based setter functions),
    - SCHEMA_DICT_SETTERS (schema-dict based setter functions),
    - NMMPMAT_SETTERS (nmmpmat-related setters).
- _extra_functions
  - A class-level dictionary allowing addition of extra action mappings for each category: keys 'xpath', 'schema_dict', 'nmmpmat'.
- xpath_functions, schema_dict_functions, nmmpmat_functions
  - At first construction a combined view of the built-in and extra functions is created (done in __new__). These mappings are used to resolve an action name to the underlying setter callable.
- _tasks
  - Instance-level list of ModifierTask objects recording the queued modifications.
- validate_signatures (bool)
  - Controls whether argument validation is performed for added tasks. Default True.

ModifierTask
------------
A small NamedTuple used to record actions:
- name: str — action name (must match a facade method / setter function name)
- args: tuple — positional arguments to pass to the setter when executing the task (default empty)
- kwargs: dict[str, Any] — keyword arguments to pass to the setter when executing the task (default {})

Primary operations
------------------
- Construction
  - FleurXMLModifier(validate_signatures: bool = True)
    - Create an empty modifier. If validate_signatures is True the modifier will perform signature/argument checking when tasks are added.

- fromList
  - FleurXMLModifier.fromList(task_list, *args, **kwargs) -> FleurXMLModifier
    - Create a new modifier and immediately add the tasks given in task_list.
    - task_list should be a list of tuples (name, kwargs_dict). Each tuple's first item is the name of the modifier method (a facade setter name) and the second item is a dict of keyword arguments to pass to that setter.
    - Other positional/keyword args are forwarded to __init__.

- add_task_list
  - add_task_list(task_list: list[tuple[str, dict[str, Any]]]) -> None
    - Add multiple tasks in one call. Each element of task_list is (name, kwargs_dict) like in fromList.
    - For each name the method resolves the corresponding facade method and calls it with the provided kwargs to record the task.
    - Raises ValueError if an unknown modification method is requested.

- Undo / task removal (referenced in class docs)
  - The class documentation and examples reference an undo() method and an undo(revert_all=True) mode to revert the last change(s). (This is part of the class API surface used in examples; ensure the installed masci-tools version provides undo if you rely on it.)

Internal helpers
----------------
- _get_setter_function_and_prefix(name) -> (callable, prefix_tuple)
  - Resolve an action name to the underlying setter function and return a prefix tuple describing which context arguments will be supplied at execution time (for example ('xmltree',) for xpath-based setters or ('xmltree','schema_dict') for schema-dict setters). This internal mapping is used to determine how to call the underlying setter when applying tasks.

- _validate_signature (deprecated)
  - Provided for backward compatibility. Emits a DeprecationWarning and forwards to the newer _validate_arguments mechanism. Prefer using the newer validation helper.

Behavior notes
--------------
- The public facade methods are auto-created from the collected xml setter modules. The method names match the names of the low-level setter functions in masci_tools.util.xml.* modules.
- The docstrings for the individual setter facade methods are generated from the actual setter implementations in masci_tools.util.xml by a pre-commit hook. Manual edits to those generated docstrings here will be overwritten.
- When applying tasks to an input file, typical return values (from the modify_xmlfile workflow described in examples) include the modified XML tree and any additional files required by the modifications (e.g., separate nmmpmat files). See the provided example below.

Usage example
-------------
Basic usage from the class docstring:

from masci_tools.io.fleurxmlmodifier import FleurXMLModifier

fmode = FleurXMLModifier()

# Add changes (these do not modify files immediately)
fmode.set_inpchanges({'Kmax': 4.0})          # Set Kmax to 4.0
fmode.shift_value({'Gmax': 5.0})             # Add 5.0 to current Gmax
fmode.set_species('all-Fe', {'lo': [         # Set local orbitals on all Fe atoms
    {'n': 3, 'l': 's', 'type': 'SCLO'},
    {'n': 3, 'l': 'p', 'type': 'SCLO'}]})

# Undo last change
# fmode.undo()
# Or revert all staged tasks
# fmode.undo(revert_all=True)

# Apply changes to an inp.xml file:
new_xmltree, additional_files = fmode.modify_xmlfile('/path/to/input/file/inp.xml')

Advanced notes
--------------
- Extending available actions:
  - Add mappings to FleurXMLModifier._extra_functions before creating instances to provide additional facade actions or override defaults.
- Integration:
  - The modifier uses utilities from masci_tools.util.xml (collectors and setters), from masci_tools.util.schema_dict_util, and the Fleur XML loader utility load_inpxml to manage XML/schema context during modifications.
- Validation:
  - When validate_signatures is enabled, argument checking helps catch incorrect task invocations early.

See also
--------
- masci_tools.util.xml.collect_xml_setters — where the available setters are collected from.
- masci_tools.util.xml.xml_setters_names and other xml_setters modules — implementations of the individual setter functions surfaced by the FleurXMLModifier facade.

License / Notes
----------------
- The class is part of the masci-tools package. The module header includes copyright and licensing references; consult the masci-tools repository for full license text.