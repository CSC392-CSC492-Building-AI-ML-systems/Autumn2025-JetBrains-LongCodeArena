Publishing for web review
========================

Overview
--------
This document describes how to publish media for web review using an ftrack session. It covers authenticating HTTP requests (so uploads are attributed to an ftrack user), preparing a session, basic upload flow, and considerations around caching and event notification.

Prerequisites
-------------
- An ftrack server URL, API key and API user available as environment variables or provided to the session:
  - FTRACK_SERVER
  - FTRACK_API_KEY (or FTRACK_APIKEY)
  - FTRACK_API_USER
- requests installed for performing HTTP uploads.
- A media file or review package prepared for upload (movie, image sequence archive, etc.).

Authentication
--------------
The SessionAuthentication helper attaches ftrack credentials to HTTP requests by adding the headers:
- ftrack-api-key
- ftrack-user

Use this with requests.Session to authenticate upload requests.

Creating a session
------------------
Create an ftrack Session to manage configuration, caching and optional event hub connectivity. The Session initialiser accepts (among others):

- server_url: ftrack server URL (required if FTRACK_SERVER not set)
- api_key, api_user: required unless set in environment
- auto_populate: whether entities auto-fetch missing attributes
- plugin_paths / plugin_arguments: plugin discovery and init options
- cache / cache_key_maker: cache instance or callable to set up caching
- auto_connect_event_hub: if True, the embedded event hub will be connected
- schema_cache_path: folder path to enable schema caching (False to disable)

Example:

:: 
    from ftrack_api import Session
    session = Session(
        server_url='https://ftrack.example.com',
        api_key='YOUR_API_KEY',
        api_user='username',
        auto_connect_event_hub=False
    )

HTTP upload example
-------------------
Authenticate HTTP requests by using SessionAuthentication and then POST the file data to the appropriate review publishing endpoint on your ftrack server. Replace the endpoint path and form fields to match your server API.

:: 
    import requests
    from ftrack_api import Session
    from ftrack_api.session import SessionAuthentication  # module path may vary

    # Create ftrack session
    session = Session(server_url='https://ftrack.example.com', api_key='KEY', api_user='user')

    # Prepare authenticated requests session
    auth = SessionAuthentication(session._api_key, session._api_user)
    http = requests.Session()
    http.auth = auth

    # Upload file (example endpoint and fields)
    with open('shot_review.mov', 'rb') as fh:
        response = http.post(
            session._server_url + '/review/publish',  # adjust to your API endpoint
            files={'file': ('shot_review.mov', fh, 'video/quicktime')},
            data={
                'project_id': 'PROJECT_ID',
                'asset_name': 'Shot Review',
                'description': 'Submitted for review'
            }
        )
    response.raise_for_status()

Notes:
- The actual review publishing endpoint and required form/data fields are server-specific. Consult your ftrack server API or review plugin documentation for exact paths and parameters.
- Use chunked uploads or resume-capable upload endpoints for large assets if supported by your server.

Recording operations
--------------------
Session tracks pending operations in session.recorded_operations and recording can be toggled with session.record_operations. When publishing programmatically as part of a workflow, operations can be recorded and later inspected or committed according to your integration needs.

Event hub and notifications
---------------------------
- If the session is configured with auto_connect_event_hub=True, the embedded event hub may be connected in a background thread. This enables publishing and subscribing to non-local events.
- Plugins that require an active event hub should explicitly check hub connection status.
- Use the event hub or server-side review notification endpoints to notify users once a review is published.

Caching and schema cache
------------------------
- The Session supports a layered cache. If you supply a cache, it will be added beneath a built-in memory cache layer unless you override behaviour.
- Provide cache_key_maker to customise cache keys; otherwise a StringKeyMaker is used.
- Enable schema caching by setting schema_cache_path to a folder path or via FTRACK_API_SCHEMA_CACHE_PATH. Set to False to disable schema caching.

Background threads and cleanup
------------------------------
- Event hub connection and some plugin initialisation may run in background threads to improve startup performance.
- Ensure long-running processes join or clean up background threads where appropriate.
- The session object tracks state (for example, self._closed); follow your integration's shutdown flow to close or release resources as required.

Best practices
--------------
- Avoid embedding user credentials in code; prefer environment variables or secrets management.
- Use resume/chunked upload mechanisms for large files.
- Validate upload responses and surface informative errors to users.
- Notify reviewers after successful publishing via events or server-side notification endpoints.
- Test publishing against a staging instance before production.

Further information
-------------------
Refer to your ftrack server API or review plugin documentation for the exact upload endpoints, required parameters and server-side behaviour. The Session and SessionAuthentication classes provide the basic building blocks for authenticated publishing flows and integration with ftrack features (plugins, cache, event hub).