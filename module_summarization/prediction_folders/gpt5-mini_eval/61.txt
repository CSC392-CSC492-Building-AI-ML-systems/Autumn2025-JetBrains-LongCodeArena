Instrumentation module
======================

Synopsis
--------
This module implements SQLAlchemy's class instrumentation system used by the ORM
to track per-class and per-instance state, manage instrumented attributes, and
wire ORM event dispatching for Python user classes. The system is normally
opaque to most application code, but it is central to how ORM state tracking,
lazy-loading/expiration and attribute events are implemented. The instrumentation
system is extensible and may be customized per-class or globally via the
sqlalchemy.ext.instrumentation extension.

Overview
--------
The core responsibility of this module is to register and manage user classes so
that instances are associated with an InstanceState and their mapped attributes
are instrumented. Instrumentation tracks attribute access, supports expired /
deferred attribute loading, collection adaptation, and integration with the
ORM event system.

Key concepts
- Class manager: a per-class manager that tracks instrumented attributes and
  coordinates class-level behavior, event dispatch, and initialization wiring.
- Instance state: per-instance state objects (defined in state.py) that hold
  loaded/expired flags, identity, and history.
- Attribute implementations: attribute-level instrumentation objects (from
  attributes.py) that implement getter/setter logic, collection handling, and
  persistence integration.
- Event dispatch: instrumentation participates in the ORM event system to
  allow listeners on instance and attribute events.

ClassManager
------------
ClassManager is the primary class exported by this module for managing
instrumentation for a specific Python class.

Purpose
  - Track instrumented attributes for the class.
  - Maintain references to related managers from base classes.
  - Provide a dispatch target for ORM events associated with the class.
  - Wire instance initialization and attach the per-instance state
    attribute (STATE_ATTR) and manager attribute (MANAGER_ATTR) on instances.
  - Coordinate expired/deferred attribute loading.

Important attributes
  - MANAGER_ATTR: name of the attribute placed on instances that references
    the ClassManager (derived from base.DEFAULT_MANAGER_ATTR).
  - STATE_ATTR: name of the attribute placed on instances that references the
    InstanceState (derived from base.DEFAULT_STATE_ATTR).
  - class_: the Python class being managed.
  - dispatch: an event dispatcher used to send ORM events to listeners.
  - info: mapping for arbitrary user-facing info associated with the class.
  - local_attrs: dict of attribute names to AttributeImpl / QueryableAttribute
    objects representing instrumented attributes local to this class.
  - originals: mapping used internally to keep original attribute descriptors
    before instrumentation replaces them.
  - _bases: list of ClassManager instances for instrumented base classes.
  - registry: optional registry reference used by declarative systems.
  - expired_attribute_loader: callable invoked to load expired/deferred scalar
    attributes for a given InstanceState and set of names.
  - init_method: optional replacement init callable to be called for new
    instances instead of or in addition to the class' __init__.
  - original_init: the original __init__ implementation retained during
    instrumentation.
  - factory: optional callable used to construct ClassManager instances.
  - declarative_scan: weak reference to declarative mapper configuration when
    applicable.

Lifecycle and methods
  - __init__(class_):
      Build the ClassManager for class_, inherit and merge information from
      instrumented base classes, call event hooks to let the ORM and extensions
      perform additional setup, and call manage() to perform instrumentation
      of attributes and instance initialization wiring. Emits a warning when
      a __del__ method is defined on the class because instrumentation can
      create reference cycles that make such destructors problematic.

  - _update_state(finalize=False, mapper=None, registry=None,
                  declarative_scan=None, expired_attribute_loader=None,
                  init_method=None):
      Used by ORM internals to update the manager with mapping and registry
      references, set the expired attribute loader, or install an init method.
      If finalize is requested, finalizes instrumentation for the class.

  - _finalize():
      Finalizes manager setup, ensuring that initialization instrumentation and
      any remaining wiring are established. Multiple calls are no-ops after the
      first finalization.

  - manage() (internal):
      Perform or refresh attribute instrumentation for the managed class.
      (Note: implementation details are internal; the public API is the manager
      object and its attributes/events.)

Event integration
-----------------
ClassManager is an EventTarget and exposes a typed dispatcher attribute.
When a ClassManager is constructed it integrates dispatchers from base-class
managers and emits class-manager creation events used by the ORM to attach
mappers and other declarative logic. Instance-level events (InstanceEvents)
are emitted by the dispatchers and are used pervasively by the ORM and by
extension code to intercept attribute set/get/expire/load and lifecycle
transitions.

Customization points
--------------------
- The expired_attribute_loader callable can be supplied/overridden to provide
  alternate deferred/expired-load behavior for scalar attributes.
- The instrumentation factory and registry hooks allow extensions such as
  sqlalchemy.ext.instrumentation to provide alternative instrumentation
  strategies or manager construction logic.
- init_method may be provided to override or wrap instance creation behavior so
  that state initialization occurs as needed by custom frameworks.

Deprecated aliases
------------------
- deferred_scalar_loader: the attribute formerly used to name the expired
  attribute loader. It remains available as a deprecated alias and forwards to
  expired_attribute_loader for backward compatibility.

Usage example
-------------
Basic (conceptual) usage illustrating the role of the ClassManager in
instrumentation:

  - A ClassManager is created for a user class.
  - Instrumented attributes (Column-mapped attributes, relationship
    collections, etc.) are registered on the manager's local_attrs.
  - On instance creation, the manager ensures the instance has a STATE_ATTR
    InstanceState and that attribute access is intercepted by the attribute
    implementation objects.
  - When attributes are accessed and found expired, the ClassManager's
    expired_attribute_loader is invoked to load values from the persistent
    store.

Notes and warnings
------------------
- The module intentionally exposes internals used by the ORM and its extension
  ecosystem. Public customization points exist, but most application code will
  not need to interact with ClassManager directly.
- Defining a __del__ method on an instrumented class is discouraged: SQLAlchemy's
  instrumentation can form reference cycles that make such methods produce
  unreachable cycles and memory leaks.

See also
--------
- sqlalchemy.ext.instrumentation — extension package for alternative and more
  comprehensive instrumentation resolution and customization.
- sqlalchemy.orm.state — per-instance state management used in conjunction
  with ClassManager.
- sqlalchemy.orm.attributes — attribute implementation details for how
  individual attributes are instrumented and how collection behaviors are
  implemented.