BestEffortCallback
==================

Overview
--------
BestEffortCallback is a convenience callback intended for interactive use with a streaming, document-oriented experiment loop (start / descriptor / event / etc.).  It attempts to render a compact live summary of a running plan:

- prints a run heading (scan id, time, uid),
- prints hinted table rows from the "primary" stream,
- prints hinted baseline fields from the "baseline" stream,
- creates/updates live matplotlib plots (LivePlot, LiveGrid, LiveScatter) for hinted fields.

It is decorated with make_class_safe and inherits QtAwareness from QtAwareCallback so it is resilient to exceptions during callback handling and integrates with a Qt event loop when plotting.

Location of related tests
-------------------------
See the module docstring hint and tests for usage examples:
tests/interactive/best_effort_cb.py

Initialization
--------------
BestEffortCallback(*, fig_factory=None, table_enabled=True, **kwargs)

Parameters
- fig_factory: optional callable or factory used to create matplotlib Figure/axes for live plots. If None, internal defaults are used.
- table_enabled (bool): enable or disable printing of the LiveTable summary for the primary stream.
- **kwargs: passed to the parent QtAwareCallback initializer.

Public options (tweakable attributes)
-------------------------------------
- overplot (bool, default: True)
    If True, successive updates are overplotted on the same axes where possible.

- noplot_streams (list of str, default: ['baseline'])
    Stream names for which plotting is suppressed.

- omit_single_point_plot (bool, default: True)
    If True, avoid creating a plot when the plan promises only a single point on the dimensional stream.

Public data / attributes
------------------------
These attributes are intended for inspection or moderate external manipulation:

- peaks
    Holds peak-related results. (Constructed as PeakResults() in the callback; integrates with the PeakStats/fitting utilities.)

- plan_hints (dict)
    Hints dict from the start document; used to choose dimensions, fields, and plotting configuration.

- dim_fields (list of str)
    Fields chosen as independent variables (one per hinted dimension).

- all_dim_fields (list of str)
    Flattened list of all fields participating as independent variables.

- _start_doc, _descriptors
    Internal storage of the start document and any descriptors seen in the run.

- _stream_names_seen
    Set of stream names that have been encountered (useful for printing "New stream: ...").

Public methods
--------------
- enable_heading()
    Enable printing the run heading (timestamp and uids) at the start of a run.

- disable_heading()
    Disable heading printing.

- enable_table()
    Enable printing the hinted LiveTable rows for the primary stream.

- disable_table()
    Disable the LiveTable output.

- enable_baseline()
    Enable printing of hinted fields from the baseline stream.

- disable_baseline()
    Disable baseline outputs.

- enable_plots()
    Enable plotting of hinted fields from streams that are not in noplot_streams.

- disable_plots()
    Disable plotting entirely.

- __call__(name, doc, *args, **kwargs)
    Entry point invoked by the dispatcher for any document (start, descriptor, event, stop, etc.). If tables, baseline, and plots are all disabled then the call is a no-op. Otherwise it forwards to the base class handler and processes documents.

- start(doc)
    Handle the start document:
      - clear internal state,
      - store start doc and hints,
      - guess dimensions/motors if hints are absent,
      - choose dim_fields and all_dim_fields,
      - print the run heading if enabled.

    Behavior notes:
      - If no hint about dimensions is supplied, BestEffortCallback will attempt a heuristic based on the 'motors' key or fall back to a 'time' dimension.
      - If the plan hints specify dimensions spanning multiple streams, the callback falls back to its guess (it cannot combine streams for plotting without resampling) and emits a warning.

- descriptor(doc)
    Handle a descriptor document:
      - records the descriptor,
      - extracts hinted fields (columns) for printing/plotting,
      - applies compatibility/cleanup for older-style documents (resolving object names to fields when a motor-heuristic was used),
      - removes independent variables from candidate dependent columns,
      - determines whether plotting should be attempted for the stream given the configured options and the hinting information.

Integration with plotting and tables
------------------------------------
- When enabled, BestEffortCallback will create/maintain:
    - LiveTable instances to print a running, hinted summary of the chosen primary fields,
    - LivePlot / LiveGrid / LiveScatter instances to update live matplotlib visualizations,
    - PeakStats/PeakResults to record and expose basic peak analysis across live data.

- The callback respects a small decision tree before creating plots:
    - global plots_enabled flag must be True,
    - the stream is not in noplot_streams,
    - there must be dependent fields after removing independent variables,
    - omit_single_point_plot prevents plotting if the plan promises only one point on the primary dimensional stream.

Hints handling
--------------
BestEffortCallback uses the standard "hints" convention to decide which fields are independent (dimensions) and which are dependent (to be plotted and summarized). It supports older document formats by resolving object names found in an initial heuristic into actual field names at descriptor time.

Notes and implementation details
--------------------------------
- The callback keeps some internal bookkeeping (maps of live plot objects keyed by descriptor uid and data field) so that multiple streams and descriptors can be handled concurrently and separately.
- It prints a "New stream: 'name'" message the first time a stream name appears if the table is enabled.
- The callback aims to be conservative: if required hint information is missing or inconsistent across streams, it falls back to simple defaults rather than attempting expensive resampling/combination of streams.
- The decorator make_class_safe(logger=logger) wraps the class so that exceptions arising during callback handling are logged rather than crashing the dispatcher.

Quick usage example
-------------------
Instantiate and attach to a document stream dispatcher (example pseudocode):

.. code-block:: python

    cb = BestEffortCallback(fig_factory=my_fig_factory, table_enabled=True)
    # toggle behavior
    cb.disable_baseline()
    cb.noplot_streams.append('aux')

    # Typical dispatcher will call:
    cb('start', start_doc)
    cb('descriptor', descriptor_doc)
    cb('event', event_doc)
    cb('stop', stop_doc)

Further information
-------------------
- See tests/interactive/best_effort_cb.py for interactive examples and testing recipes.
- The callback relies on LiveTable, LivePlot, LiveGrid, LiveScatter, QtAwareCallback and PeakStats/PeakResults for plotting, table rendering and peak analysis. Refer to those modules for finer-grained configuration and behavior.