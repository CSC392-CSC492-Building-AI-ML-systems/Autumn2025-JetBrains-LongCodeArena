Querying
========

Overview
--------
Querying is the primary mechanism for retrieving entities from an ftrack server.
All queries are executed using a Session instance which provides a query factory
and helpers for retrieving single entities by id.

Typical workflow:
- Create a Session.
- Build a query using Session.query.
- Execute the query and iterate or retrieve results using the Query API.

Creating a Session
------------------
A session is required to query the API:

.. code-block:: python

    import ftrack_api
    session = ftrack_api.Session(
        server_url='https://your.ftrack.server',
        api_key='YOUR_API_KEY',
        api_user='your.username'
    )

Constructing a Query
--------------------
Use Session.query(...) to construct a Query. The most common input is a query
string describing the entity type and filter conditions. Example forms include
entity-expression style or explicit select statements:

.. code-block:: python

    # Entity-style filter
    query = session.query('Task where project.name is "My Project"')

    # Select-style (return specific attributes)
    query = session.query('select id, name from Task where status.name is "done"')

The Query object returned by Session.query represents the server-side query and
provides execution and convenience methods.

Filtering and expressions
-------------------------
Query filters use the ftrack query expression syntax. Common points:

- Attribute access uses dot notation for related entities (for example
  project.name or status.name).
- String literals are quoted.
- Comparisons, membership tests and boolean combinations can be used to
  express constraints.
- Filters should target indexed attributes where possible for performance.

Executing queries
-----------------
The Query object supports multiple ways to obtain results:

.. code-block:: python

    q = session.query('Task where project.id is "123"')

    # Iterate results
    for task in q:
        print(task['name'])

    # Return a list of all entities
    tasks = q.all()

    # First result or None
    first = q.first()

    # Expect exactly one result (may raise if 0 or >1)
    single = q.one()

    # Get number of matching rows without fetching all entities
    total = q.count()

Pagination and ordering
-----------------------
Queries can be limited and ordered to control result sets and paging:

.. code-block:: python

    q = session.query('Task where project.id is "123"').order_by('created_at desc').limit(50).offset(100)

Selecting attributes
--------------------
Selecting a subset of attributes reduces data transferred and can improve
performance. Use a select clause where supported:

.. code-block:: python

    q = session.query('select id, name, status.name from Task where project.id is "123"')

Accessing attributes
--------------------
- Accessing an attribute on an entity may trigger a lazy fetch from the server
  if the attribute is not present locally. This behaviour is controlled by the
  session.auto_populate flag.
- Use entity.get('attribute_name') or mapping access entity['attribute_name']
  to read values.

Fetching by id
--------------
To fetch a single entity by type and id, use Session.get:

.. code-block:: python

    task = session.get('Task', '12345678-1234-1234-1234-1234567890ab')

Caching and sessions
--------------------
- Sessions may be configured with a layered cache; a memory cache is used at
  the top level to speed repeated access.
- Querying results are subject to caching semantics provided by the session's
  configured cache and key maker. Be mindful that caching can return stale
  data if external modifications occur.

Best practices
--------------
- Use select to limit returned attributes for large result sets.
- Filter on indexed attributes when possible.
- Use count() for totals instead of fetching full result sets.
- Prefer ordering and limiting queries for pagination to reduce memory and
  network usage.
- Be aware of session.auto_populate and cache configuration which affect
  attribute population and subsequent requests.

Further reading
---------------
Refer to the Session, Query and Collection API documentation for details on the
available Query methods and the complete query expression syntax.