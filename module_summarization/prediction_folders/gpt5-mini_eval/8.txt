Using review sessions
=====================

Overview
--------
A review session is an isolated connection to an ftrack server used for reading and manipulating ftrack data programmatically. The Session object encapsulates authentication, caching, plugin discovery and the embedded event hub used for publishing and subscribing to events.

Creating a session
------------------
Create a session by constructing ftrack_api.Session with the server URL, API key and API user:

Example
::
    import ftrack_api
    session = ftrack_api.Session(
        server_url='https://my.ftrack.server',
        api_key='0123456789abcdef',
        api_user='alice'
    )

Environment variables
---------------------
If you prefer not to pass credentials explicitly, the Session constructor will look up values from environment variables:

- FTRACK_SERVER — server URL (required if not passed)
- FTRACK_API_KEY (or FTRACK_APIKEY) — API key (required if not passed)
- FTRACK_API_USER — API username; if not set the system user from getpass.getuser() will be used

Errors
------
If server_url, api_key or api_user cannot be determined, Session construction raises TypeError describing the missing requirement.

Constructor options
-------------------
The Session constructor accepts several options to control behaviour:

- server_url (str)
  - Full URL of the ftrack server (required if not in FTRACK_SERVER)
- api_key (str)
  - API key for authentication (required if not in FTRACK_API_KEY)
- api_user (str)
  - Username to record operations against (required if not in FTRACK_API_USER)
- auto_populate (bool, default True)
  - If True, accessing an entity attribute fetches it automatically from the server when missing. Can be toggled on the session instance at any time (e.g. session.auto_populate = False).
- plugin_paths (list)
  - List of filesystem paths to search for plugins. If not provided, the environment variable FTRACK_EVENT_PLUGIN_PATH is used as a fallback.
- cache (ftrack_api.cache.Cache or callable)
  - A cache instance or a callable(session) that returns a cache instance (or None if unable to configure one). The session always places a memory cache at the top of a layered cache stack, so you do not normally need to provide a memory cache yourself.
- cache_key_maker (ftrack_api.cache.KeyMaker)
  - Key maker used to create cache keys. If not provided, a StringKeyMaker is used.
- auto_connect_event_hub (bool)
  - If True, the embedded EventHub will be connected automatically to the event server allowing non-local publish/subscribe. If False only local events are available until you call EventHub.connect.
- schema_cache_path (str or False)
  - Path to store schema cache. If not set, FTRACK_API_SCHEMA_CACHE_PATH is used or a temporary directory is chosen. Set to False to disable schema caching.
- plugin_arguments (dict)
  - Mapping of keyword arguments passed into discovered plugin registration functions. If a plugin signature does not accept all provided args, the discovery mechanism will try to reduce arguments to those accepted (a warning is logged).

Authentication for HTTP requests
--------------------------------
When using requests directly, use the SessionAuthentication helper to attach ftrack authentication headers:

Example
::
    from ftrack_api import SessionAuthentication
    auth = SessionAuthentication(api_key='0123', api_user='alice')
    import requests
    requests.get('https://my.ftrack.server/some/api', auth=auth)

This attaches the headers:
- ftrack-api-key
- ftrack-user

Event hub and background connection
-----------------------------------
If auto_connect_event_hub is enabled, the event hub connection is performed in a background thread to avoid slowing session startup. Plugins that require a connected event hub should check the hub connection status explicitly. Subscribing to events does not require a connected hub. You can connect the hub manually with EventHub.connect if needed.

Caching and schema cache notes
------------------------------
- The session composes a layered cache with a MemoryCache at the top level. Adding a cache via the cache argument places it into that layered arrangement.
- The cache_key_maker argument controls how cache keys are produced.
- Schema caching is enabled by providing schema_cache_path (or via FTRACK_API_SCHEMA_CACHE_PATH); set to False to disable it.

Recording operations
--------------------
The session tracks pending operations in session.recorded_operations and will record operations by default (session.record_operations is True). This can be used by higher-level workflows to collect and commit changes.

Additional notes
----------------
- The Session class logs messages via the ftrack_api logging facilities; heavy operations, warnings and compatibility fallbacks are logged.
- Plugin discovery may reduce plugin_arguments to match a plugin's signature; incompatible arguments generate a warning.