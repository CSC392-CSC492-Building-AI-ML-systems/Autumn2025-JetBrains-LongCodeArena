FileNode â€” A file interface to nodes for PyTables databases
==========================================================

Synopsis
--------
The FileNode module provides a file-like binary I/O interface for data stored
inside PyTables HDF5 files. It implements a Raw I/O layer that is compatible
with the interfaces defined in the standard library io module (io.RawIOBase).
Use the helper functions new_node() and open_node() (provided elsewhere in this
package) to create or open a file node; the returned node object can then be
wrapped/used via the classes in this module.

Only binary I/O is supported. Read access is always available. Write access is
restricted: new nodes and nodes opened with append/update modes (for example
'a+') accept writes; writes are append-only (no in-place overwrite).

See also the users guide: :ref:`filenode_usersguide`.

Requirements
------------
- Python io compatibility (implements RawIOBase semantics)
- numpy
- PyTables (imported as tables / tb)

Module attributes
-----------------
NODE_TYPE
    Constant string value denoting node type used as a node system attribute:
    ``'file'``.

NODE_TYPE_VERSION
    Supported versions are listed in NodeTypeVersions: ``[1, 2]``.
    Version-specific behaviour:
    - Version 1: shape mapping function -> (length, 1)
    - Version 2: shape mapping function -> (length,)

Classes
-------
RawPyTablesIO
    Base class implementing raw binary I/O on HDF5 nodes accessed via
    PyTables. It subclasses io.RawIOBase and provides an interface that
    mirrors a low-level file descriptor positioned at byte offsets within a
    PyTables array-like node.

    Constructor
    ^^^^^^^^^^^
    RawPyTablesIO(node, mode=None)

    - node: a PyTables node (expected to expose attributes used by this class,
      such as .attrs.NODE_TYPE_VERSION, .atom.dtype, .nrows, .read(), .flush(),
      ._v_file, etc.).
    - mode: optional file mode string. If omitted, the host PyTables file mode
      (node._v_file.mode) is used. Modes follow the conventions used by this
      module: read-only, append, update (presence of 'r', 'a', 'w', '+').

    Attributes
    ^^^^^^^^^^
    - .mode (read-only)
      The mode string the object was opened with.
    - ._node
      The underlying PyTables node instance (set to None after close).
    - ._pos
      Current stream position in bytes (non-negative integer).
    - ._version
      NODE_TYPE_VERSION read from node.attrs (int).
    - ._vshape
      Version-specific shape mapping callable selected from
      internal _size_to_shape table.
    - ._vtype
      Numpy scalar type inferred from node.atom.dtype.base.type.

    Behavior and notes
    ^^^^^^^^^^^^^^^^^^
    - The class enforces node compatibility and checks the node's attributes
      at construction.
    - If a mode is provided it is validated and cross-checked with the host
      PyTables file mode.
    - The implementation maps size/length to node shapes according to
      NODE_TYPE_VERSION.

    Methods
    ^^^^^^^
    - tell() -> int
      Return the current stream position.

    - seek(pos, whence=0) -> int
      Change the stream position. whence semantics match the standard:
      0=start, 1=current, 2=end. Negative resulting positions are clamped to 0.
      pos must be an integer (objects implementing __index__ accepted).

    - seekable() -> bool
      Returns True (random access is supported).

    - fileno() -> int
      Returns the underlying file descriptor via node._v_file.fileno().
      Raises if the underlying file descriptor is unavailable.

    - close()
      Flushes and closes the IO object. If the host PyTables file is already
      closed, a warning is emitted. After closing the internal node reference
      is released.

    - flush()
      Flushes write buffers by calling node.flush(). Raises if closed.

    - truncate(pos=None) -> int
      Truncate the file to the given size (in bytes). If pos is None, the
      current stream position is used. Only growing truncation is supported:
      if pos < node.nrows an OSError is raised. Returns the new absolute
      position after seek(pos).

    - readable() -> bool
      Returns whether the stream was opened for reading (True if 'r' or '+'
      is in the mode string).

    - writable() -> bool
      Returns whether the stream was opened for writing (True if 'w', 'a' or
      '+' is in the mode string).

    - readinto(b) -> int
      Reads up to len(b) bytes into the writable buffer/object b and returns
      the number of bytes read (0 for EOF). If the internal position is at or
      beyond the node length, returns 0. The implementation reads from the
      underlying node via node.read(start, stop) and copies the bytes into b.
      The stream position is advanced by the number of bytes read.

    - readline(limit=-1) -> bytes
      Read and return a single line from the stream (up to an optional limit).
      (Implementation follows RawIOBase semantics; see source for details.)

Usage examples
--------------
Create/open a file-like node (helpers implemented elsewhere) and use RawPyTablesIO
(or an io.BufferedReader/Writer wrapper) to perform binary I/O:

    node = new_node(...)           # see package helpers
    raw = RawPyTablesIO(node, mode='a+')
    raw.write(b'hello\n')
    raw.seek(0)
    data = raw.read(6)             # b'hello\n'
    raw.close()

Notes and limitations
---------------------
- Only binary I/O is supported; no text encoding/decoding is performed.
- Writes are append-only: data already written cannot be overwritten.
- Truncate only supports growing a node (to append zeroed bytes).
- The module expects the underlying node to follow the file-node contract
  used by this package (attributes, .read(), .nrows, etc.).
- The implementation relies on numpy arrays for intermediate buffering
  and on PyTables for storage access.

Version notes
-------------
.. versionchanged:: 3.0
   The module was rewritten to be fully compliant with the interfaces defined
   in the Python standard library io module.

See also
--------
- PyTables documentation
- Python io module documentation
- Package-specific user guide: :ref:`filenode_usersguide`