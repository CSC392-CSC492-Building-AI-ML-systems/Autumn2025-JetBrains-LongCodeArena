filters module
==============

Overview
--------
This module provides utilities and Filter classes for creating and monitoring Ethereum
filters via a web3 provider. Filters are implemented as gevent.Greenlet subclasses
that poll the provider for changes and dispatch matching entries to registered
callbacks.

The module depends on helper functions from other modules:
- from.types: is_string, is_array
- from.events: construct_event_topic_set, construct_event_data_set

Constants
---------
ZERO_32BYTES
    A regular expression fragment that matches 32 bytes in hexadecimal:
    '[a-f0-9]{64}'


Functions
---------

.. function:: construct_event_filter_params(event_abi, contract_address=None, argument_filters=None, topics=None, fromBlock=None, toBlock=None, address=None)

    Build filter parameters and corresponding event data filter set for a given
    event ABI and optional filter options.

    Parameters
    - event_abi: ABI entry for the event used to construct topic/data filters.
    - contract_address (optional): contract address to include in the address filter.
    - argument_filters (optional): argument-based filters passed to topic/data constructors.
    - topics (optional): explicit additional topics to include; when provided it is
      prepended to the constructed topic set.
    - fromBlock (optional): starting block number or tag to include in the filter params.
    - toBlock (optional): ending block number or tag to include in the filter params.
    - address (optional): address or list of addresses to include; when combined with
      contract_address both are included in the resulting address field.

    Returns
    - (data_filters_set, filter_params)
      - data_filters_set: result of construct_event_data_set(event_abi, argument_filters).
      - filter_params: dict compatible with web3.eth.filter parameters; may contain
        'topics', 'address', 'fromBlock', and 'toBlock'.

    Behavior notes
    - If topics is None the function builds topics via construct_event_topic_set.
      Otherwise topics is inserted as the first element of the topic set.
    - Address parameter handling supports string or array; unsupported types raise ValueError.


.. function:: construct_data_filter_regex(data_filter_set)

    Construct and return a compiled regular expression that matches the 0x-prefixed
    hex data string for any member of data_filter_set. Each data filter is a sequence
    of 32-byte hex segments; None entries are treated as wildcards (matched by
    ZERO_32BYTES). The produced regex anchors the match from start to end.

    Parameters
    - data_filter_set: iterable of data filter sequences (each sequence is iterable;
      each element is either None or a '0x'-prefixed hex string of 32 bytes).

    Returns
    - compiled re.Pattern


Classes
-------

Filter
~~~~~~
.. class:: Filter(web3, filter_id)

    Base class for all filters. Implements gevent-based polling and callback
    dispatching.

    Attributes
    - web3: web3 provider instance used to query filter changes.
    - filter_id: identifier returned by web3 when the filter was created.
    - callbacks: list of callables registered via .watch().
    - running: boolean indicating active polling state.
    - stopped: boolean indicating whether the filter has been stopped permanently.
    - poll_interval: optional numeric seconds; when None a random small sleep is used.

    Methods
    - __init__(web3, filter_id)
      Initialize the Filter and its callback list.

    - __str__()
      Human-readable representation: "Filter for {filter_id}".

    - _run()
      Main polling loop executed by the Greenlet. While running, repeatedly calls
      web3.eth.getFilterChanges(filter_id) and, for each returned entry, if
      is_valid_entry(entry) returns True, calls each registered callback with
      format_entry(entry). Sleeps between polls using poll_interval or a random
      duration. Raises ValueError if attempting to restart a stopped Filter.

    - format_entry(entry)
      Hook to transform/format the raw entry before delivering to callbacks.
      Default returns the entry unchanged. Subclasses override to adjust formatting.

    - is_valid_entry(entry)
      Hook to apply additional runtime filtering on entries. Default returns True.

    - watch(*callbacks)
      Register one or more callbacks. Starts the Greenlet if not already running.
      Raises ValueError if the filter has been stopped.

    - stop_watching(timeout=0) / stopWatching
      Stop polling, mark the filter as stopped, uninstall the filter via
      web3.eth.uninstallFilter(filter_id), and join the Greenlet (optionally with
      a timeout). Alias stopWatching provided for backward compatibility.


BlockFilter
~~~~~~~~~~~
.. class:: BlockFilter(web3, filter_id)

    Specialized Filter for block notifications. Inherits behavior from Filter
    without modification.


TransactionFilter
~~~~~~~~~~~~~~~~~
.. class:: TransactionFilter(web3, filter_id)

    Specialized Filter for transaction notifications. Inherits behavior from Filter
    without modification.


LogFilter
~~~~~~~~~
.. class:: LogFilter(web3, filter_id, log_entry_formatter=None, data_filter_set=None)

    Filter specialized for log entries. Supports optional data field filtering
    via a set of data filters and optional log entry formatting via a callable.

    Additional attributes
    - data_filter_set: the original set of data filters (list/iterable).
    - data_filter_set_regex: compiled regex created from data_filter_set via
      construct_data_filter_regex, set only when any data filter is present.
    - log_entry_formatter: optional callable(entry) used by format_entry.

    Constructor keyword arguments
    - log_entry_formatter: override the formatter used by format_entry.
    - data_filter_set: if provided, set_data_filters() is invoked during init.

    Methods
    - get(only_changes=True)
      Retrieve log entries from the provider. Raises ValueError when called while
      the Filter is actively watching (running True).

      Parameters
      - only_changes (bool): when True call web3.eth.getFilterChanges(filter_id);
        otherwise call web3.eth.getFilterLogs(filter_id) to retrieve all matching
        logs for the filter.

      Returns
      - list of formatted log entries (each passed through format_entry).

      Notes: If the provider returns None it is treated as an empty list.

    - format_entry(entry)
      Returns log_entry_formatter(entry) if a formatter is configured, otherwise
      returns the raw entry.

    - set_data_filters(data_filter_set)
      Store the provided data_filter_set and, if any member is truthy, create a
      compiled regex from it and store it on data_filter_set_regex.

    - is_valid_entry(entry)
      If data_filter_set_regex is not set, returns True. Otherwise returns True
      only if the regex matches entry['data'] (the log data field).


PastLogFilter
~~~~~~~~~~~~~
.. class:: PastLogFilter(web3, filter_id, **kwargs)

    A LogFilter variant that, when run, fetches past logs matching the filter once
    and dispatches them to callbacks, then stops.

    Behavior
    - _run(): raises ValueError if restarting a stopped Filter. Calls
      web3.eth.getFilterLogs(filter_id) to retrieve previous_logs; for each entry
      that passes is_valid_entry, calls callbacks with format_entry(entry). Sets
      running to False when complete (does not loop).


ShhFilter
~~~~~~~~~
.. class:: ShhFilter(web3, filter_id)

    Filter implementation targeting Whisper (shh) filters instead of eth filters.
    Behavior mirrors Filter but uses web3.shh.getFilterChanges() and in
    stop_watching calls web3.shh.uninstallFilter(filter_id).

    Methods override
    - _run(): identical loop to Filter._run but queries web3.shh.getFilterChanges.
    - stop_watching(timeout=0) / stopWatching: uninstall via web3.shh.uninstallFilter.


Usage notes
-----------
- Filters are Greenlets; to receive asynchronous callbacks, register functions with
  .watch() and ensure the gevent event loop is running.
- For synchronous retrieval of matching logs, use LogFilter.get(only_changes=False).
- Data filters produced by construct_event_data_set are intended to be passed
  into LogFilter (via set_data_filters or constructor) and are matched against
  the 0x-prefixed data string of log entries using the regex built by
  construct_data_filter_regex.

Examples
--------
(Conceptual â€” assumes web3 and event ABI helpers are available.)

- Create filter params for an event:
  data_filters_set, filter_params = construct_event_filter_params(event_abi, contract_address='0x...', argument_filters={'_value': 123})

- Create and watch a log filter:
  filter_id = web3.eth.filter(filter_params)
  lf = LogFilter(web3, filter_id, log_entry_formatter=my_formatter)
  lf.set_data_filters(data_filters_set)
  lf.watch(callback_fn)
  ...
  lf.stop_watching()

(End of module documentation)