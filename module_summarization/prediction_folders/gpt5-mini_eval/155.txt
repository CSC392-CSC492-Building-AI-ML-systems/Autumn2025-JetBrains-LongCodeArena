Getting Started
===============

Overview
--------
This package contains common utilities used by master and parent processes and the
code sent to child contexts that become parents. It provides helpers for:
- detecting platform capabilities (PTYs, SELinux),
- safe child process setup (pre-exec hooks, sys.executable fallback),
- determining runtime configuration (open file limits, logging),
- small compatibility shims between Python versions,
- extracting/minifying core source sent to child contexts.

Prerequisites
-------------
- Python (2.7+ or 3.x supported by the library variants included).
- Appropriate OS support for PTYs when using interactive child sessions.
- If SELinux is enabled on Linux, socketpair() usage is avoided automatically.

Quick start
-----------

Basic checks
~~~~~~~~~~~~
- Get the effective log level used by the module:
::
    from <package> import get_log_level
    level = get_log_level()

- Determine the Python interpreter that will be used to spawn children:
::
    from <package> import get_sys_executable
    python = get_sys_executable()
If sys.executable is unset, get_sys_executable() returns "/usr/bin/python" and
logs a single warning indicating the fallback.

Pre-exec hook
~~~~~~~~~~~~~
A single module-level hook may be set and is invoked in child processes just
prior to exec(). It is intended for low-level process configuration such as
cpu affinity or scheduler policies:
::
    # inside library code:
    _preexec_hook = my_hook_function

Core source for child bootstrap
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The module exposes helpers that obtain and (when running in master context)
prepare a minified version of the library core that is shipped to children.
Use get_core_source_partial() to obtain the compressed/minified core payload
that will be transmitted to child contexts.

PTY handling
------------
- The code detects whether PTY creation fails due to system limits and exposes
  OPENPTY_MSG which suggests tuning system PTY limits (e.g. kern.tty.ptmx_max on
  OS X or kernel.pty.max on Linux).
- On SELinux-enabled hosts (detected by reading /sys/fs/selinux/enforce) the
  code avoids use of socketpairs to stay compatible with SELinux policies.

Platform and compatibility notes
--------------------------------
- Python 2 / 3 compatibility shims are present: e.g. fallback for next(), an
  xrange alias for Python 3, and attributes for bound method and closure
  differences (IM_SELF_ATTR, closure_attr).
- SC_OPEN_MAX is read via os.sysconf('SC_OPEN_MAX'); if unavailable a default
  of 1024 is used.
- Some ioctl constants are adjusted for very old Pythons (pre-2.5) where C
  signed/unsigned differences exist.

Signals and shutdown
--------------------
- SIGNAL_BY_NUM maps the numeric signal value to the canonical name.
- BROKER_SHUTDOWN_MSG is the canonical message used when a connection is
  cancelled because the broker is shutting down; client code can compare
  error text against this value to detect that condition.

Errors and helpful messages
---------------------------
- OPENPTY_MSG: Guidance when PTY creation fails due to system limits.
- SYS_EXECUTABLE_MSG: Logged once when sys.executable is empty and a fallback
  is required.
- BROKER_SHUTDOWN_MSG: Standard text indicating a broker-initiated shutdown.

Troubleshooting
---------------
- If you see the OPENPTY_MSG frequently, increase the kernel PTY limits or
  reduce concurrent PTY usage.
- If a child starts with a different Python than expected, verify sys.executable
  in the environment and the value returned by get_sys_executable().
- On SELinux-enabled systems some IPC approaches (socketpair) may not be used;
  this behavior is automatic to maintain compatibility.

API summary
-----------
- get_log_level() -> int
- get_sys_executable() -> str
- get_core_source_partial() -> compressed/minified core payload
- _preexec_hook (callable or None) â€” invoked in children before exec()
- Constants: OPENPTY_MSG, SYS_EXECUTABLE_MSG, BROKER_SHUTDOWN_MSG,
  SC_OPEN_MAX, SIGNAL_BY_NUM

Further reading
---------------
Refer to the module source for implementation details and to other package
modules for examples of creating and managing child contexts and brokers.