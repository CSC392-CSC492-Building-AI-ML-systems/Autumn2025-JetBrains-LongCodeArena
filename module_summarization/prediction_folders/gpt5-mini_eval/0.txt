Working with assignments and allocations
=====================================

This document describes common patterns for creating, querying, updating and
removing assignments and allocations using the ftrack API, and provides tips
for working with them efficiently.

Overview
--------

- Assignment: links a resource (typically a user or a group) to an entity
  (typically a Task) with a role. Use assignments to indicate who is
  responsible for or working on a task.
- Allocation: represents a scheduled or time-based piece of work tied to an
  assignment. Use allocations to record when work will happen and how many
  hours are allocated.

Common patterns
---------------

Acquire a session (examples assume a Session instance called ``session``).

Get entities
~~~~~~~~~~~~
- By identifier:
  .. code-block:: python

    task = session.get('Task', 'taskId')
    user = session.get('User', 'userId')

- By query:
  .. code-block:: python

    user = session.query("User where username is 'alice'").one()
    tasks = session.query("Task where project.id is 'projectId'").all()

Create an assignment
~~~~~~~~~~~~~~~~~~~~
- Create by passing entity objects or IDs as attributes. After creating,
  call ``session.commit()`` to persist.

  .. code-block:: python

    # Using entity objects
    assignment = session.create(
        'Assignment', {
            'task': task,
            'resource': user,
            'role': 'Artist'
        }
    )
    session.commit()

    # Using IDs (string attributes)
    assignment = session.create(
        'Assignment', {
            'task_id': task.get('id'),
            'resource_id': user.get('id'),
            'role': 'Artist'
        }
    )
    session.commit()

Inspect an assignment
~~~~~~~~~~~~~~~~~~~~~
- Access common fields (names vary by project schema; check your server schema):

  .. code-block:: python

    assignment.get('id')
    assignment.get('task')       # Task entity or task id
    assignment.get('resource')   # User / Group entity or id
    assignment.get('role')       # Role string (e.g. 'Artist', 'Lead')

Update or remove an assignment
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- Modify fields and commit, or delete and commit.

  .. code-block:: python

    assignment['role'] = 'Lead'
    session.commit()

    # Remove assignment
    session.delete(assignment)
    session.commit()

Query assignments
~~~~~~~~~~~~~~~~~
- Use the query language to find assignments:

  .. code-block:: python

    # Assignments for a specific task
    session.query("Assignment where task.id is 'taskId'").all()

    # Assignments for a user
    session.query("Assignment where resource.id is 'userId'").all()

    # Join queries, filtering by role or task name
    session.query("Assignment where role is 'Artist' and task.name is 'Comp'").all()

Working with allocations
------------------------

Create an allocation
~~~~~~~~~~~~~~~~~~~~~
- Allocations are typically created referencing an assignment. Use ISO-8601
  datetimes for start/end values (libraries such as arrow are helpful).

  .. code-block:: python

    import arrow

    start = arrow.get('2025-12-01T09:00:00Z').naive
    end = arrow.get('2025-12-01T17:00:00Z').naive

    allocation = session.create(
        'Allocation', {
            'assignment': assignment,
            'start': start,           # or 'start_date' depending on schema
            'end': end,               # or 'end_date'
            'hours': 8                # or 'allocated_hours' depending on schema
        }
    )
    session.commit()

- If your schema uses different attribute names (for example ``start_date``,
  ``end_date`` or ``allocated_hours``) use those. Inspect your server schema
  or an existing allocation entity to confirm field names.

Update and remove allocations
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- Update and commit:

  .. code-block:: python

    allocation['hours'] = 6
    allocation['start'] = arrow.get('2025-12-02T09:00:00Z').naive
    session.commit()

- Delete and commit:

  .. code-block:: python

    session.delete(allocation)
    session.commit()

Query allocations
~~~~~~~~~~~~~~~~~
- Find allocations for an assignment, a resource or a date range:

  .. code-block:: python

    session.query("Allocation where assignment.id is 'assignmentId'").all()

    # Allocations within a date range (adjust field names for your schema)
    session.query(
        "Allocation where start >= '2025-12-01T00:00:00Z' and end <= '2025-12-31T23:59:59Z'"
    ).all()

Best practices and tips
-----------------------

- Confirm schema field names
  - Server implementations may use different attribute names (for example
    ``start`` vs ``start_date`` or ``hours`` vs ``allocated_hours``). Use
    existing entities or the schema inspection utilities to determine exact
    attribute names.

- Use entity objects whenever possible
  - Passing entity objects to ``session.create(...)`` makes intent clear and
    lets the API handle ID resolution.

- Commit in logical batches
  - Group related changes and call ``session.commit()`` once to minimize
    round-trips.

- Turn off operation recording for large bulk changes
  - The session records operations by default. For large, temporary bulk
    updates you may disable recording to reduce memory usage:

    .. code-block:: python

      session.record_operations = False
      # Perform many changes...
      session.commit()
      session.record_operations = True

  - Note: recorded operations are useful for audit/history workflows; only
    disable if you understand consequences.

- Use queries carefully for performance
  - Restrict queries (project/task filters) to avoid retrieving large result
    sets. Use pagination where available.

- Use the event system to react to assignment/ allocation changes
  - The event hub can be used to listen for assignment/ allocation events and
    respond in real time (for example to update schedules or notify users).
  - Subscribing to events does not require the hub to be connected; publishing
    or receiving non-local events requires an active connection.

- Work with dates and timezones
  - Store and query allocations using a consistent timezone (UTC recommended).
  - Use datetime-aware helpers such as arrow when constructing start/end
    values.

Common pitfalls
---------------

- Wrong attribute names
  - The most frequent source of errors is using an attribute name that does
    not exist on the server schema. Inspect examples or the schema if unsure.

- Forgetting to commit
  - Changes made to entities are local until ``session.commit()`` is called.

- Confusing assignments and allocations
  - Assignments represent a person/role relationship to a task. Allocations
    represent scheduled hours/time ranges tied to an assignment.

Examples summary
----------------

Create an assignment and an allocation tied to it:

.. code-block:: python

  # Get task and user
  task = session.get('Task', 'taskId')
  user = session.query("User where username is 'alice'").one()

  # Create assignment
  assignment = session.create('Assignment', {'task': task, 'resource': user, 'role': 'Artist'})
  session.commit()

  # Create allocation for the assignment
  import arrow
  start = arrow.get('2025-12-01T09:00:00Z').naive
  end = arrow.get('2025-12-01T17:00:00Z').naive
  allocation = session.create('Allocation', {'assignment': assignment, 'start': start, 'end': end, 'hours': 8})
  session.commit()

Where to look next
------------------

- Inspect your server schema to confirm attribute names for Assignment and
  Allocation entities.
- Review the event hub documentation for reacting to assignment and allocation
  changes in real time.
- Use query language docs to build efficient filters for assignments and
  allocations.