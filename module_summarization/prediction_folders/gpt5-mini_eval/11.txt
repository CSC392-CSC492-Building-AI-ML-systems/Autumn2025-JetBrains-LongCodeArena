Working with entities
=====================

Overview
--------
The ftrack API models data as entities (projects, tasks, assets, versions, etc.).
A Session provides an isolated connection to an ftrack server and is the primary
entry point for creating, querying and modifying entities. Entities are lightweight
Python objects that lazily fetch data from the server and participate in the
session's caching and operation-recording systems.

Creating a Session
------------------
A Session encapsulates connection configuration and behavior such as lazy
attribute population, caching and operation recording.

Example
    >>> import ftrack_api
    >>> session = ftrack_api.Session(
    ...     server_url='https://ftrack.example.com',
    ...     api_key='YOUR_API_KEY',
    ...     api_user='username'
    ... )

Authentication
--------------
Requests issued by the Session include authentication headers. Internally the
Session uses a requests auth helper that injects:

- ftrack-api-key
- ftrack-user

These are provided from the api_key and api_user you pass when creating the
Session (or read from environment variables).

Finding and fetching entities
-----------------------------
Typical operations to obtain entities:

- session.get(<entity_type>, <id>) — fetch a single entity by identifier.
- session.query(<query_string>) — run an ftrack query returning a collection
  of entities.
- Collection objects returned by queries behave as iterable containers.

Lazy attribute population (auto_populate)
-----------------------------------------
By default the Session uses auto-population: accessing an attribute on an entity
that has not yet been populated triggers an automatic fetch from the server.
This behaviour can be toggled on the session:

    session.auto_populate = False

Turning off auto-populate can reduce network usage in some workflows, but
requires explicit fetching of attributes where needed.

Creating and updating entities
------------------------------
Entities are created and modified using the Session API. Typical workflow:

1. Create a new entity (specify type and attributes).
2. Modify attributes on the entity object.
3. Persist changes via the session (commit/persist call).

Example
    >>> # Create
    >>> task = session.create('Task', {'name': 'New task', 'parent_id': some_id})
    >>> # Update
    >>> task['name'] = 'Updated name'
    >>> # Persist changes
    >>> session.commit()

Note: the exact creation and persistence methods are provided by the Session
API. The session keeps track of pending/recorded operations (see below).

Caching and cache key makers
----------------------------
The Session integrates with a layered caching system. By default a memory cache
is present at the top layer. When creating a Session you may supply:

- cache — an instance or callable that returns a cache instance complying with
  ftrack_api.cache.Cache.
- cache_key_maker — an instance implementing the KeyMaker interface
  (defaults to StringKeyMaker).

The cache is consulted for entity retrieval to minimize network traffic and
improve performance. The Session may also use a schema cache (controlled by
schema_cache_path) to reduce schema lookups.

Recording operations
--------------------
The Session records operations performed during the lifetime of the session.
Key attributes:

- session.recorded_operations — object holding pending operations.
- session.record_operations — boolean flag to enable/disable recording.

Recorded operations represent the changes that will be or have been sent to
the server. The Session API exposes methods to persist or roll back these
operations (commit/rollback-style methods available on Session).

Queries and collections
-----------------------
Use the query subsystem to locate entities with ftrack query language strings:

    >>> for task in session.query("Task where project.name is \"My Project\""):
    ...     print(task['name'])

Query results are returned as collection objects which can be iterated,
sliced or converted to lists. Collections may be lazy and populated on demand.

Entity identity, locations and origins
--------------------------------------
Entities in ftrack have stable identifiers and associated location/origin
information. The SDK exposes helpers and structures for:

- entity identifiers and their encoding/decoding
- entity location management (accessors for disk/server)
- centralized storage handling scenarios

These pieces are used internally and are also available for advanced usage
(including custom accessors and storage strategies).

Event hub and plugins
---------------------
The Session optionally manages an embedded event hub. When auto_connect_event_hub
is True the hub connects in the background and allows publishing and subscribing
to non-local events. Plugins discovered and registered against the session may
depend on the event hub; plugin discovery can be customized via plugin_paths
and plugin_arguments.

Practical tips
--------------
- Keep auto_populate enabled for convenience; disable when fetching many
  entities but only some attributes.
- Provide a suitable cache and key maker for production deployments to
  minimize latency and server load.
- Make use of recorded operations to batch and review changes before commit.
- Use queries to fetch collections rather than iterating over entire projects.

Examples
--------
Creating a session and basic operations:

    >>> import ftrack_api
    >>> session = ftrack_api.Session(
    ...     server_url='https://ftrack.example.com',
    ...     api_key='API_KEY',
    ...     api_user='user'
    ... )
    >>> # Fetch an entity
    >>> task = session.get('Task', 'task-id')
    >>> print(task['name'])
    >>> # Create and persist
    >>> new_task = session.create('Task', {'name': 'My Task', 'parent_id': task['parent_id']})
    >>> session.commit()

Further reading
---------------
See the API modules for more detail:
- ftrack_api.entity.* (entity classes, factory, base, location)
- ftrack_api.cache (cache implementations and key makers)
- ftrack_api.query and ftrack_api.collection (query language and collections)
- ftrack_api.operation (operation recording and management)
- ftrack_api.event.hub (event hub usage and connection)