baseuser module
===============

A User model, used for authentication.

Summary
-------
Provides a basic user table with authentication helpers, password hashing and
login/update routines. Intended for use with Piccolo ORM tables.

Classes
-------

BaseUser
^^^^^^^^
Provides a basic user, with authentication support.

Columns / Attributes
- id (Serial)
- username (Varchar(length=100, unique=True))
- password (Secret(length=255)) — stored as a PBKDF2-SHA256 hashed string
- first_name (Varchar, null=True)
- last_name (Varchar, null=True)
- email (Varchar(length=255, unique=True))
- active (Boolean, default=False)
- admin (Boolean, default=False) — can log into the Piccolo admin GUI
- superuser (Boolean, default=False) — can manage other users' passwords
- last_login (Timestamp, null=True, default=None) — last login time

Class-level configuration
- _min_password_length (int) — default 6
- _max_password_length (int) — default 128
- _pbkdf2_iteration_count (int) — default 600_000 (OWASP recommended)

Constructor
- __init__(**kwargs)
  - If a plain-text password is passed via kwargs["password"], it will be
    hashed on initialization unless it already appears to be a hashed string
    (starts with "pbkdf2_sha256").

Utility / Readability
- get_salt() -> str
  - Generate a random salt (hex token).

- get_readable() -> Readable
  - Return a Readable template for representing a user row (uses username).

Password validation and storage
- _validate_password(password: str)
  - Validate raw password against presence, minimum/maximum lengths and that
    it is not already a hashed string.
  - Raises ValueError on validation failure.

- hash_password(password: str, salt: str = "", iterations: Optional[int] = None) -> str
  - Hash a raw password with PBKDF2-HMAC-SHA256 and return a string in the
    format: "pbkdf2_sha256$<iterations>$<salt>$<hex-hash>".
  - If salt is omitted, a new random salt is generated.
  - If iterations is omitted, uses _pbkdf2_iteration_count.
  - Raises ValueError for excessively long passwords.

- split_stored_password(password: str) -> List[str]
  - Split a stored hashed password into its 4 components:
    algorithm, iterations, salt, hash.
  - Raises ValueError if the expected format is not met.

Attribute behavior
- __setattr__(self, name: str, value: Any)
  - Ensures any assignment to "password" stores a hashed value; if the value
    does not begin with "pbkdf2_sha256" it will be hashed automatically.

Password update helpers
- update_password_sync(user: Union[str, int], password: str)
  - Synchronous wrapper around update_password.

- update_password(user: Union[str, int], password: str) -> coroutine
  - Async method. Accepts either a username (str) or id (int) to identify the
    user. Validates the raw password, hashes it, and updates the stored value
    in the database.
  - Raises ValueError if the user argument is not int or str, or if password
    validation fails.

Login helpers
- login_sync(username: str, password: str) -> Optional[int]
  - Synchronous wrapper around login.

- login(username: str, password: str) -> coroutine returning Optional[int]
  - Async method. Verifies the provided username and password:
    - Performs length checks on username and password.
    - Loads the stored password for the username.
    - Splits the stored password and re-hashes the provided password with the
      stored salt/iterations for comparison.
    - If successful, updates last_login in the database and returns the
      user's id. Returns None on failure or if no match is found.

Exceptions and logging
- Validation and format errors raise ValueError.
- Warnings are logged for suspicious inputs (excessively long username/password,
  attempting to set a pre-hashed password, or excessively long provided
  password).

Examples
--------
(Note: these snippets assume an active Piccolo DB session / event loop.)

- Create a user (constructor hashes password):
  user = BaseUser(username="alice", password="secret123", email="a@e.com")
  await user.save()  # or .run() depending on session usage

- Update a password (async):
  await BaseUser.update_password("alice", "newpass456")

- Login (async):
  user_id = await BaseUser.login("alice", "newpass456")
  if user_id is not None:
      # authenticated

See Also
--------
This class integrates with Piccolo Table machinery; methods that modify the
database are implemented as async coroutines and sync wrappers that use
run_sync.