w_fork
======

Synopsis
--------
w_fork [OPTIONS]

Description
-----------
Create a new WESTPA HDF5 simulation file by "forking" an existing simulation at a
particular iteration. A new HDF5 file is generated containing:

- target states copied from the original simulation at the chosen iteration,
- basis states copied from the original simulation,
- a set of initial states (one per old segment) prepared to restart propagation,
- a corresponding set of prepared segments for iteration 1 that reflect the old
  final p-coordinates and weights.

When using executable propagation, w_fork does not manage filesystem restart
files; the user is responsible for preparing any restart data in the new
simulation directory (or otherwise making restart data available) consistent
with the mapping produced by w_fork.

Options
-------
--input, -i INPUT_H5FILE
    Use INPUT_H5FILE as the source HDF5 file. If omitted, the file is taken
    from the WESTPA configuration.

--iteration, -I N_ITER
    Take the initial distribution from iteration N_ITER of the input
    simulation. Default: the last complete iteration of the input file.

--output, -o OUTPUT_H5FILE
    Write the new simulation HDF5 file as OUTPUT_H5FILE. Default: forked.h5

--istate-map PATH
    Write a flat text mapping (old segment -> new initial state) to PATH.
    Default: istate_map.txt

--no-headers
    Do not write header lines to the istate-map text file.

Behavior and details
--------------------
- The new HDF5 file is prepared and opened; target states are copied from the
  old file for the chosen iteration and saved into the new file (for
  n_iter matching the chosen iteration). Basis states are copied into the new
  file (created under the initial/basis state group).

- For each segment present in the chosen iteration of the old simulation:
  - One initial state is created in the new simulation with:
    - iter_created = 0
    - iter_used = 1
    - istate_type = ISTATE_TYPE_RESTART
    - istate_status = ISTATE_STATUS_PREPARED
    - pcoord set to the old segment's final p-coordinate
  - One prepared segment is created for new iteration 1 with:
    - n_iter = 1
    - seg_id assigned sequentially starting at 0
    - weight copied from the old segment weight
    - parent_id and wtg_parent_ids set to a negative sentinel that encodes the
      originating initial state: parent_id = -(istate_id + 1)
    - status = SEG_STATUS_PREPARED
    - pcoord array created with the first frame set to the old final p-coordinate

- The new simulation's current iteration is set to 1.

istate-map (text) file format
-----------------------------
- By default a small header is written (can be suppressed with --no-headers).
- Columns (whitespace separated):
  1. old simulation n_iter (integer)
  2. old simulation seg_id (integer)
  3. new simulation initial state ID (integer)

Example output lines:
    <old_n_iter>    <old_seg_id>    <new_istate_id>

Notes and caveats
-----------------
- w_fork copies target and basis states into the new HDF5 file; however, any
  filesystem restart files or external state needed by the propagation
  executables must be handled by the user. w_fork only creates the HDF5-level
  mapping and prepared objects.
- The mapping between old segments and new initial states is provided to help
  the user reconstruct or relocate restart data for the new simulation.
- The new simulation begins at iteration 1 with segments prepared from the
  chosen old iteration. Further weighting or binning adjustments should be
  performed with normal WESTPA tools (e.g., w_binning) if desired.

Examples
--------
Fork the default simulation at its last completed iteration and write forked.h5:
    w_fork

Fork iteration 42 of a specific HDF5 file and write mapping to map.txt:
    w_fork -i old_sim.h5 -I 42 -o new_sim.h5 --istate-map map.txt

Generate the istate map without header lines:
    w_fork --no-headers