Less frequently used FITS data structures
=======================================

This document summarizes FITS data structures and features that are encountered
less often than the common Primary HDU / Image HDU and BinaryTable/AsciiTable
extensions. It also documents some internal utilities used for verification and
notification that are relevant when working with these structures.

Random Groups (GROUPS)
----------------------

Random groups were introduced in early FITS to store a collection of grouped
arrays. They are largely deprecated and uncommon in modern FITS files. Key
points:

- Represented as a special kind of IMAGE extension with a small header that
  describes the number of groups and the vector (parameter) size.
- Each group contains a parameter vector followed by a multidimensional data
  array. The layout and interpretation are historical and not standardized like
  modern table formats.
- Many FITS readers do not support random groups, and conversion to modern
  Binary Table or Image extensions is recommended when possible.

When you encounter random groups:
- Treat them as legacy data requiring special handling.
- Prefer converting to BinaryTable/IMAGE forms for robust interoperability.

ASCII Tables (OLD ASCII)
------------------------

ASCII tables (fixed-width text tables in headers and data) are an older FITS
table format. They are readable and portable but have significant limitations:

- Limited to text encoding and fixed column widths.
- Inefficient for large datasets.
- Superseded by BinaryTable extensions (BINTABLE) which support typed columns,
  variable-length arrays, and better I/O performance.

Use ASCII tables only for simple, small, or legacy files. For modern work,
prefer BinaryTable extensions.

Variable-length array columns (P/T types)
-----------------------------------------

Binary tables support variable-length array columns using the P (array) and
Q (64-bit variant) data descriptors. These allow columns to store arrays whose
lengths vary row-by-row.

- Data are stored in a heap following the main table data; the table contains
  descriptors (offset,length) that reference the heap.
- Useful for irregular or nested data where fixed-size columns are inefficient.

Caveats:
- Not all FITS tools fully support variable-length columns.
- Careful handling is required when copying or slicing tables to preserve heap
  integrity.

Hierarchical and Extended Keywords
----------------------------------

Some FITS files use extended keyword conventions to represent structured or
long metadata:

- HIERARCH and similar conventions allow longer keyword names and "namespaced"
  metadata.
- These are not part of the original FITS standard but are widely used in
  practice (notably in some observatory pipelines).

When reading/writing such files, prefer libraries that expose these keywords
transparently and preserve their semantics.

Compressed IMAGE extensions
---------------------------

Compression conventions (e.g., tiled image compression) encode image data in
compressed IMAGE extensions. These extensions are sometimes less directly
accessible than uncompressed images:

- They store a header describing the compression (tile size, algorithm).
- Libraries typically present a transparent interface that decompresses on
  read, but not all tools support every compression convention.

Be mindful of compression conventions when moving or archiving FITS files.

Group/Hierarchy-like and other specialized extensions
-----------------------------------------------------

Beyond the standard table and image extensions, FITS has been extended in
various ways for domain-specific storage (e.g., grouped exposures, instrument
metadata blocks, custom binary blobs). These extensions often follow local
conventions and may require custom code to interpret.

Verification and reporting of FITS structure issues
---------------------------------------------------

When validating FITS structures, it's common to use a verification framework
that reports or attempts to fix issues. Typical verification behaviors include:

- Options to control behavior: "ignore", "warn", "exception", "fix",
  "silentfix" and combinations such as "fix+warn".
- Reported issues may be classified as fixable or unfixable; fixable issues
  may be automatically corrected when a "fix" option is used.
- Verification results are collected into a nested list/structure of messages
  with context for each HDU/element; this structure can be iterated to obtain
  human-readable lines with indentation that reflects nesting.

Common verification outcomes:
- Silent fixes: issues fixed without user notification.
- Warnings: issues reported but not raised as exceptions.
- Exceptions: verification failures raised when strict validation is requested.

Error aggregation structure
---------------------------

Verification messages are often aggregated into a nested error list structure
that:

- Supports nesting to represent hierarchical verification across HDUs and
  substructures.
- Provides iteration that yields (fixable_flag, message) pairs, with nested
  blocks indented for readability.
- Can be converted to a single string representation for error reporting.

Notification/observer support for mutable FITS objects
-----------------------------------------------------

Internal utilities sometimes provide a notifier mixin that allows objects to
register listeners that are notified on changes. Key aspects:

- Listeners are typically held by weak reference so they do not prevent garbage
  collection.
- Notifications are dispatched by name: _notify('change_type', *args, **kwargs)
  will call listener._update_change_type(*args, **kwargs) if the method exists.
- This pattern is used internally to keep dependent structures (e.g., an HDU
  and its representation in an HDUList) synchronized when one is modified.

Practical guidance
------------------

- Legacy structures (random groups, ASCII tables) are best treated as
  candidates for conversion to modern equivalents (BinaryTable, Image).
- When encountering compressed or specialized extensions, prefer libraries
  that provide transparent access or conversion utilities.
- Use verification facilities with the appropriate option for your workflow;
  for bulk automated processing "silentfix" or "fix+warn" may be appropriate,
  while for archival or publication use strict "exception" validation.
- For complex, nested, or custom formats, inspect verification messages and
  nested error lists to locate and resolve issues.

References
----------

- The FITS standard and its extensions (see the official FITS documents).
- Conventions for compressed images, variable-length arrays, and hierarchical
  keywords used by major observatories and instrument teams.