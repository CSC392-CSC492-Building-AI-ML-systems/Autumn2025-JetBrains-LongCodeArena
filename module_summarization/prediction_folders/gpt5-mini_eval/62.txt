sql.visitors — Visitor / traversal interface and helpers
=======================================================

Synopsis
--------
This module provides the visitor/traversal abstraction used by SQLAlchemy's
SQL compiler and internal traversal utilities. It defines:

- the Visitable base class and related compiler-dispatch machinery used by the
  SQL compiler;
- the InternalTraversal symbols used to declare how an object's internal
  state should be traversed;
- helper traversal functions and anonymous-mapping utilities used by various
  traversal and cloning operations.

Overview
--------
The visitor pattern in this module is split into two related concerns:

- Compiler dispatch (Visitable): a simple protocol that looks up a method on a
  "visitor" object named visit_<visit_name> and calls it.  This is the core
  mechanism used by SQL compiler visitors.
- Internal traversal (InternalTraversal and related helpers): a small set of
  traversal symbols used by objects that expose internal state collections
  (via a _traverse_internals-style mapping) so that generic traversal,
  copying and cache-key generation can be automated.

Key concepts
------------
Visitable
  - A lightweight base class for objects that can be compiled by visitors.
  - Subclasses declare a class-level __visit_name__ string. When present, a
    _compiler_dispatch method is generated automatically that looks for a
    visitor method named visit_<__visit_name__> and calls it.
  - If a class already defines its own _compiler_dispatch, it is preserved
    as _original_compiler_dispatch so extensions can override/restore behavior.
  - Example:
    ::
      class MyThing(Visitable):
          __visit_name__ = "mything"
      # Visitor should implement visit_mything(self, mything, **kw)

InternalTraversal
  - An Enum of traversal symbols used to describe how attributes of an
    object should be traversed for the purposes of copying, cache-key
    generation, or other internal traversals.
  - Typical use: a class exposes a _traverse_internals collection such as:
    ::
      _traverse_internals = [
        ("value", InternalTraversal.dp_clauseelement),
        ("whens", InternalTraversal.dp_clauseelement_tuples),
        ("else_", InternalTraversal.dp_clauseelement),
      ]
    The traversal machinery then knows how to iterate into those attributes.
  - Common enum members (selected):
    - dp_has_cache_key
      Visit a HasCacheKey object.
    - dp_has_cache_key_list
      Visit a list of HasCacheKey objects.
    - dp_clauseelement
      Visit a ClauseElement object (expression element).
    - dp_fromclause_canonical_column_collection
      Visit a FromClause in the context of its canonical "columns" collection
      (used when a column collection is the original/defining location of
      ColumnClause objects, e.g. Table or TableClause).
    - dp_clauseelement_tuples
      Visit a list of tuples containing ClauseElement objects.

anon_map / prefix_anon_map
--------------------------
The module exposes helpers used for anonymous-name mapping and memoization
during cloning/traversal operations:

- anon_map: a cache/mapper utility used to map objects to their cloned or
  canonical counterparts; a C-extension implementation is used when available
  with a Python fallback otherwise.
- prefix_anon_map: a helper to generate prefixed anonymous names for cloned
  constructs (also available as a C-extension when installed).

Public API (high-level)
-----------------------
Functions (helpers — brief)
  - iterate(...)
    Generic iterator helper used by traversal utilities (yields items and
    their paths; used internally across traversal functions).
  - traverse_using(...)
    Apply a given traversal routine using a visitor-like callable over an
    object graph.
  - traverse(...)
    Generic external traversal entrypoint for walking a visitable object
    structure.
  - cloned_traverse(...)
    Traverse a structure and produce a cloned copy, using anonymous mapping
    for consistent identity preservation.
  - replacement_traverse(...)
    Traverse and replace elements according to a replacements mapping or
    callable.

Classes
  - Visitable
    Base class for compiler-visitables. See above.
  - ExternalTraversal
    Symbolic helper used to indicate traversal behavior for external-facing
    traversal routines (see the module's traversal helpers).
  - InternalTraversal
    Enum of internal traversal symbols. See above.

Notes and examples
------------------
- The Visitable/_compiler_dispatch mechanism fosters a simple convention:
  compiler visitors implement visit_<name> methods and the visited objects
  provide __visit_name__ to indicate which method to call.
- The InternalTraversal enum is intended to be used in the class-level
  _traverse_internals declaration on objects that carry nested SQL expression
  objects; generic implementations of get_children, _copy_internals and
  cache-key generation can then be derived from that declaration.
- anon_map and prefix_anon_map are provided via a small C-extension for
  performance when available, with equivalent Python fallbacks in plain
  environments.

See Also
--------
- The SQL compiler visitor implementations (classes which implement
  visit_<...> methods) that consume Visitable instances.
- The "HasTraverseInternals" and "HasCacheKey" mixins, which integrate with
  InternalTraversal to automate traversal, copying and cache-key generation.

Module exports
--------------
The module exports the following public names:
iterate, traverse_using, traverse, cloned_traverse, replacement_traverse,
Visitable, ExternalTraversal, InternalTraversal, anon_map

(End of visitors module documentation)