Generate â€” Getting Started
=========================

Overview
--------
This module implements common utilities used by master and parent processes in the Generate/mitogen runtime. It centralizes:
- environment and platform detection (SELinux, Linux/UNIX specifics),
- safe defaults (sys.executable handling),
- small convenience helpers (log level access, ioctl casting),
- constants and messages used across processes,
- a thread-safe mechanism to obtain compressed source of the mitogen.core module for shipping into child contexts.

Requirements
------------
- Python (2.7+ or 3.x as supported by the package)
- Standard library modules: codecs, errno, fcntl, getpass, heapq, inspect, logging, os, re, signal, socket, struct, subprocess, sys, termios, textwrap, threading, zlib, select
- The mitogen.core package must be importable.

Quick start
-----------
Import the module and use the small helpers to adapt to the runtime environment and prepare child contexts.

Example: basic checks and info
.. code-block:: python

    import logging
    import mitogen.utils as utils  # or the actual module path

    # Effective log level (falls back to INFO if not set)
    level = utils.get_log_level()

    # Check whether SELinux enforcement is enabled (affects socketpair use)
    if utils.SELINUX_ENABLED:
        logger.info("SELinux is enabled; avoid socketpair() usage.")

    # Platform flag
    if utils.IS_LINUX:
        logger.debug("Running on Linux.")

Example: safe sys.executable handling
.. code-block:: python

    exe = utils.get_sys_executable()
    # get_sys_executable() returns sys.executable when available,
    # otherwise logs a warning and returns '/usr/bin/python'.

Example: obtaining the compressed mitogen.core source
.. code-block:: python

    # get_core_source_partial() returns a cached PartialZlib object
    # representing the mitogen.core source (encoded/compressed bytes).
    core_partial = utils.get_core_source_partial()

    # PartialZlib API is provided by the package; use its methods to
    # access or stream the source for embedding into child contexts.

Primitive helpers
-----------------
- _ioctl_cast(n)
  - Adjusts ioctl request integers so they work on older Python versions
    where ioctl arguments were treated as signed. Use when making low-level
    ioctl calls that must be portable across older interpreters.

- get_log_level()
  - Returns the effective log level for the module logger, falling back to
    logging.INFO when no level is configured.

- get_sys_executable()
  - Returns sys.executable if set. If unset, logs a single warning and returns
    "/usr/bin/python" as the fallback. Useful when spawning child contexts that
    need a Python interpreter path.

Threading and concurrency
-------------------------
- _core_source_lock and get_core_source_partial()
  - Obtaining the compressed mitogen.core source is expensive. The module
    provides a thread-safe cache guarded by _core_source_lock so concurrent
    callers do not duplicate expensive work. Use get_core_source_partial()
    rather than calling inspect.getsource(mitogen.core) directly when the
    intent is to ship the module source to child processes.

Signals and constants
---------------------
- SIGNAL_BY_NUM: mapping of numeric signal values to their constant names.
  Useful for human-readable logging of signal events.

- Common messages:
  - BROKER_SHUTDOWN_MSG: message used when a broker shuts down and cancels
    an associated connection.
  - OPENPTY_MSG: user-friendly explanation emitted when PTY creation fails.
  - SYS_EXECUTABLE_MSG: message logged when sys.executable is unset.

PTY and ioctl constants (Linux-specific)
----------------------------------------
- LINUX_TIOCGPTN, LINUX_TIOCSPTLCK
  - ioctl numbers for obtaining PTY number and locking/unlocking PTY slave
    on Linux. They are pre-cast via _ioctl_cast to remain portable.

- SC_OPEN_MAX
  - System limit for open file descriptors (obtained via os.sysconf or a
    conservative default).

- Note: the module sets IS_LINUX for runtime branching based on os.uname().

Pre-exec hook
-------------
- _preexec_hook
  - If set, this callable is invoked just prior to exec() of any new child
    process. The hook allows callers to adjust process attributes (for
    example, resetting CPU affinity) before exec.

Best practices
--------------
- Use get_sys_executable() when launching children to avoid surprises on
  environments where sys.executable is not populated.
- Avoid socketpair() on SELinux-enabled systems; check SELINUX_ENABLED first.
- Acquire core source via get_core_source_partial() to minimize overhead and
  to reuse cached compressed data across threads.
- Rely on the preexec hook to perform safe, per-process adjustments rather
  than trying to mutate parent process state from child threads.

Troubleshooting
---------------
- "Failed to create a PTY" messages often indicate hitting the system PTY
  limit; the module exposes OPENPTY_MSG with guidance about system tunables.
- If child processes are launched with an unexpected interpreter path,
  verify sys.executable in the parent and consult the warning logged by
  get_sys_executable().

API summary
-----------
- Constants:
  - SELINUX_ENABLED, IS_LINUX, SC_OPEN_MAX
  - BROKER_SHUTDOWN_MSG, OPENPTY_MSG, SYS_EXECUTABLE_MSG
  - LINUX_TIOCGPTN, LINUX_TIOCSPTLCK
  - SIGNAL_BY_NUM

- Functions:
  - get_log_level() -> int
  - get_sys_executable() -> str
  - _ioctl_cast(n) -> int
  - get_core_source_partial() -> PartialZlib-like object

Further reading
---------------
Refer to the package's API reference for the PartialZlib type and other
helpers not fully documented here. This module is intended to be internal
infrastructure: prefer higher-level public APIs when available.