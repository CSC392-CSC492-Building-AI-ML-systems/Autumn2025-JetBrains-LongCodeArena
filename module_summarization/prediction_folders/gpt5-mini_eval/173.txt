Fitting SESANS Data
===================

Synopsis
--------
This page describes practical steps for fitting Spin-Echo Small Angle Neutron Scattering
(SESANS) data to physical models. It covers data format, common models and parameters,
fitting strategies, example code, and tips for robust parameter estimation.

Data format
-----------
SESANS data are typically provided as a table with one row per measured
spin-echo length z (often in nm or μm):

- z: spin-echo length (independent variable)
- S(z): normalized spin-echo polarization (dependent variable)
- sigma (optional): experimental uncertainty on S(z)

Acceptable file formats: plain text tables (ASCII), CSV, or whitespace-separated
columns. If uncertainties are not supplied, estimate them from counting statistics or
use uniform weighting.

Preprocessing
-------------
- Remove or mask obviously corrupted points (e.g., outliers, zero counts).
- Ensure S(z) is properly normalized (S(z)->1 at z->0 for dilute samples).
- Convert units consistently (z and model length parameters must match).
- If needed, bin the data to increase signal-to-noise (careful with resolution loss).

Models and common parameters
----------------------------
SESANS models relate the measured polarization S(z) to the projected pair-correlation
function of the sample. Typical model types (and representative parameters) include:

- Sphere (monodisperse)
  - radius (R)
  - scale (intensity prefactor)
  - background (baseline offset)
  - sld (scattering length density of particle)
  - sld_solvent (solvent SLD)
  - polydispersity (relative width, optional)

- Cylinder
  - radius (R)
  - length (L)
  - orientation / orientation distribution
  - scale, background, sld, sld_solvent, polydispersity

- Core–Shell / Hollow Sphere
  - core_radius, shell_thickness (or outer_radius)
  - core_sld, shell_sld, solvent_sld
  - scale, background

- Gaussian/Exponential correlation (modeling domain structures)
  - correlation_length (xi)
  - exponent/shape parameter
  - scale, background

- Structure factor / interacting particles
  - volume_fraction
  - effective_interaction_parameters (e.g. hard-sphere radius)
  - Use form-factor × structure-factor approaches where appropriate.

Common generic parameters
- scale: multiplicative intensity scaling (often correlated with volume fraction).
- background: additive offset to S(z).
- polydispersity: width of size distribution (log-normal, Gaussian).
- sld, sld_solvent: contrast parameters required for absolute scattering magnitude.

Instrumental effects
- Resolution smearing: finite instrumental resolution in z (or related variables)
  can broaden features. Convolution of the model with the resolution kernel
  (often approximated by a Gaussian in z) is often required.
- Beam polarization and transmission corrections may affect absolute S(z).

Fitting procedure
-----------------
1. Choose a physically appropriate model.
2. Provide reasonable initial guesses for key parameters (size, scale).
3. Fix parameters that are well known (e.g., solvent SLD) to reduce correlations.
4. Select a fitting metric:
   - Weighted least squares with provided sigma.
   - If sigma absent, use uniform weights or Poisson-based weights.
5. Include instrumental resolution convolution if required by the dataset.
6. Run nonlinear optimization (e.g., Levenberg–Marquardt, trust region).
7. Inspect fit residuals, χ², reduced χ² and parameter uncertainties.
8. Explore multi-starts or global optimization if many local minima are suspected.
9. Bootstrap or Markov Chain Monte Carlo (MCMC) to validate uncertainties and
   parameter correlations when necessary.

Example (Python-like pseudocode)
--------------------------------
Load data, define model, fit, and plot results:

.. code-block:: python

    # Pseudocode — adapt to your fitting library / package
    from sesans import load_data, models, fit_model, plot_fit

    # Load experimental data (z, S, sigma optional)
    z, S, sigma = load_data('sample.ses')

    # Define model (e.g. polydisperse spheres)
    model = models.Sphere(polydispersity=0.1,
                          sld=2.0e-6,        # 1/Angstrom^2 or package units
                          sld_solvent=1.0e-6,
                          scale=0.01,
                          background=0.0)

    # Set which parameters to vary and bounds
    vary = {'radius': True, 'scale': True, 'background': False}
    bounds = {'radius': (1.0, 1000.0), 'scale': (1e-6, 1.0)}

    # Optionally include instrument resolution (sigma_z)
    resolution = {'type': 'gaussian', 'sigma_z': 0.02}  # same units as z

    result = fit_model(z, S, sigma, model,
                       vary=vary, bounds=bounds, resolution=resolution)

    # Inspect results
    print(result.params)          # fitted values and uncertainties
    print('reduced chi2:', result.redchi2)

    # Plot data, fit and residuals
    plot_fit(z, S, sigma, model, result)

Estimating uncertainties and correlations
-----------------------------------------
- Use the covariance matrix from the fit to obtain parameter standard errors.
- For nonlinear models with strong parameter correlations, the covariance
  estimate may be optimistic. Use bootstrap resampling or MCMC to better
  assess uncertainties and parameter correlations.
- Report parameter correlations and confidence intervals.

Model selection and validation
------------------------------
- Compare alternative models using goodness-of-fit metrics (reduced χ²,
  Akaike Information Criterion) and by inspecting residuals.
- Physically unrealistic parameter values indicate a poor model choice or
  unconstrained fit (e.g., negative radii, unphysically large polydispersity).
- Use complementary measurements (SANS, SAXS, microscopy) to constrain fits.

Practical tips
--------------
- Fit scale and background first with fixed structural parameters to get
  correct normalization, then release shape parameters.
- Work in log-space for parameters spanning many orders of magnitude (e.g.,
  scale) to improve numerical stability.
- Keep as few free parameters as possible consistent with physical knowledge.
- If S(z) is close to 1 across z-range, sensitivity to size may be low — extend
  z-range or combine with other techniques.
- Document units and normalization carefully.

Interpreting fitted parameters
-----------------------------
- Radius, length and thickness map directly to particle dimensions.
- Scale is proportional to particle contrast × volume fraction; absolute
  volume fraction requires calibrated instrument factors or independent
  concentration knowledge.
- Polydispersity broadens structure in S(z); large fitted polydispersity
  may reflect model mismatch rather than true sample heterogeneity.

References and further reading
------------------------------
- P. K. King et al., "Spin-echo small-angle neutron scattering (SESANS): Theory and applications" — for theoretical background.
- R. Pynn, "Neutron Scattering — Elastic and Inelastic" — instrumentation and resolution discussions.
- Standard data-analysis texts on small-angle scattering for model forms and polydispersity treatments.

Acknowledgements
----------------
This document summarizes practical guidance for SESANS data fitting. Adapt
examples to the specific API of the software package you are using and verify
units and normalization conventions before interpreting fitted parameters.