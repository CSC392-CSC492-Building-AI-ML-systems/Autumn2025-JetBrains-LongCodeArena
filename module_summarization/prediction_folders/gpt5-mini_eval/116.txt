Search utilities for ASDF trees
==============================

Summary
-------
Utilities for searching and operating on nodes inside an ASDF tree. The primary
API is the AsdfSearchResult class, which represents the result of a search on
an ASDF tree and supports incremental narrowing, rendering options, and in-place
replacement of matched leaf nodes.

Highlights
- Chainable, incremental search by key, type, value, or arbitrary predicate.
- Support for string regular-expression queries or exact-value matching.
- Type queries may be a builtins.type or a fully-qualified name pattern.
- Safe equality testing that protects against exceptions from custom types.
- Formatting controls for tree rendering (max rows, max columns, show values).
- In-place replacement of matched leaf nodes.

API
---

AsdfSearchResult
~~~~~~~~~~~~~~~~
Represents the result of a search performed on an ASDF tree. Instances are
returned by initial search operations and by subsequent .search(...) calls,
allowing further narrowing of the result set. The object is immutable-like:
formatting changes and additional filters return a new AsdfSearchResult.

Constructor
    AsdfSearchResult(identifiers, node, filters=None, parent_node=None,
                     max_rows=DEFAULT_MAX_ROWS, max_cols=DEFAULT_MAX_COLS,
                     show_values=DEFAULT_SHOW_VALUES)

Parameters
- identifiers
  - Path/identifier information used to walk the tree from the root to the
    current node(s).
- node
  - The root node (subtree) on which searches and operations are performed.
- filters
  - Optional list of predicate callables used to pre-filter nodes.
- parent_node
  - Optional parent node reference used for replacement operations.
- max_rows, max_cols, show_values
  - Formatting controls used when rendering matched subtrees. Default values
    come from DEFAULT_MAX_ROWS, DEFAULT_MAX_COLS, DEFAULT_SHOW_VALUES.

Methods
- format(max_rows=NotSet, max_cols=NotSet, show_values=NotSet) -> AsdfSearchResult
  - Return a new AsdfSearchResult with updated rendering options.
  - Arguments accept NotSet to retain the current value. max_rows accepts an
    int, a tuple (per-depth limits), None (unlimited), or NotSet. max_cols
    accepts an int, None (unlimited), or NotSet. show_values controls display
    of primitive values.

- search(key=NotSet, type=NotSet, value=NotSet, filter=None) -> AsdfSearchResult
  - Narrow the current search result using one or more criteria; returns a new
    AsdfSearchResult with the new filter appended.
  - key:
    - NotSet: unconstrained.
    - str: treated as a regular expression and matched against keys/indexes.
    - other: tested for equality against node keys/indexes.
  - type:
    - NotSet: unconstrained.
    - str or compiled regex: matched against the fully-qualified type name
      (module + class).
    - builtins.type: isinstance(node, type) check.
  - value:
    - NotSet: unconstrained.
    - str: treated as a regular expression matched against the string
      representation of the value (containers are excluded).
    - other: tested for equality against node values.
  - filter:
    - Callable that accepts (node, identifier) or (node) and returns True to
      keep the node. Arbitrary predicates can be used to implement custom
      selection logic.
  - The method wraps/combines the new filter with existing filters; pattern
    arguments are compiled automatically when a string is provided.

- replace(value)
  - Replace in-place all matched leaf nodes with the provided value.
  - The implementation collects matches (identifiers + parent) by performing
    a breadth-first traversal restricted to the current search results and
    applies assignment parent[identifier] = value for each match.

- node (property)
  - Convenience accessor to retrieve the leaf node when the search result
    corresponds to a single node. (Used to obtain the matched node for direct
    inspection; typically raises or is undefined for non-singleton results.)

Internal helpers
- _maybe_compile_pattern(query)
  - If query is a str, returns a compiled regular expression; otherwise returns
    the input unchanged. Used to normalize key/type/value string queries.

- _safe_equals(a, b)
  - Performs equality testing with exception safety. If a == b yields a boolean
    result, returns it; if equality raises or returns a non-bool, returns False.

- _get_fully_qualified_type(value)
  - Returns a type identifier suitable for pattern matching:
    - For builtin types, returns the type name (e.g., "int").
    - For other types, returns "module.ClassName".

Integration and rendering
- Formatting defaults are imported from the module display helpers:
  DEFAULT_MAX_ROWS, DEFAULT_MAX_COLS, DEFAULT_SHOW_VALUES.
- The AsdfSearchResult carries formatting options to control rendered tree
  output produced by the renderer utilities (e.g., render_tree).

Example usage
--------------
Simple chained search and replacement::

    # Narrow by dict key matching a regex, then by value equality, then replace
    result = AsdfSearchResult(identifiers, root_node)
    result2 = result.search(key=r"^meta_", value="obsolete").replace(None)

    # Adjust rendering options before displaying
    formatted = result.search(type="numpy.ndarray").format(max_rows=(10, 5), show_values=False)

Notes
-----
- Regular-expression queries may be provided as either strings (compiled
  automatically) or precompiled typing.Pattern instances.
- Type queries provided as strings are matched against the fully-qualified
  type name ("module.ClassName") except for builtins where only the class name
  is used.
- Container nodes are excluded from value-regular-expression matches to avoid
  matching on string representations that include child contents.