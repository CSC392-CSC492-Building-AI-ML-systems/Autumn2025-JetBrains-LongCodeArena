Config Usage
============

Overview
--------
This module provides a high-level configuration layer for constructing fv3config
dictionaries used in prognostic FV3 runs. It combines runtime configuration
(UserConfig) and fv3config overlays, supports convenient initial-condition
specification, duration handling, and optional machine-learning emulation
settings.

Public constants
----------------
- PROGNOSTIC_DIAG_TABLE
- SUPPRESS_RANGE_WARNINGS

- default_coupler_nml()
  - Returns a minimal default coupler namelist overlay: {"coupler_nml": {"dt_atmos": 900}}

Utilities
---------
instantiate_dataclass_from(cls, instance)
- Create an instance of dataclass class `cls` using values pulled from
  another dataclass-like `instance`. Useful to instantiate a parent dataclass
  from a child instance.

Dataclasses / Core objects
--------------------------

FV3Config
~~~~~~~~~
A dataclass representation of fv3config fields not overridden by
HighLevelConfig.

Attributes (not exhaustive)
- namelist: default coupler namelist overlay (via default_coupler_nml)
- experiment_name
- data_table
- field_table
- forcing
- orographic_forcing
- gfs_analysis_data

Methods
- asdict(): return a dict of non-None fields suitable for merging into fv3config.

InitialCondition
~~~~~~~~~~~~~~~~
Represents an initial condition specified as {base_url}/{timestep}.

Attributes
- base_url (str): base location (GCS or local) where restarts are stored
- timestep (str): timestamp in YYYYMMDD.HHMMSS format
- restart_categories (RestartCategoriesConfig): mapping of source restart
  category names (default from fv3kube.RestartCategoriesConfig)

Properties
- overlay: returns an fv3kube overlay constructed via
  fv3kube.c48_initial_conditions_overlay(base_url, timestep, restart_categories=...)

HighLevelConfig
~~~~~~~~~~~~~~~
High-level configuration that combines UserConfig (runtime) and FV3Config
(fv3 overlays) and provides convenience helpers.

Attributes
- base_version (str): base physics / fv3config version to start from (default "v0.5")
- initial_conditions (InitialCondition | Any): initial condition specification.
  If an InitialCondition instance is provided, its overlay is used.
- duration (str): segment duration (e.g. "3h"); if provided, overrides
  namelist.coupler_nml.dt_atmos-derived durations
- zhao_carr_emulation (emulation.EmulationConfig): machine-learning emulation config

Key methods
- to_runtime_config() -> UserConfig
  - Returns a UserConfig instance with runtime-only fields extracted from the
    HighLevelConfig.
- _physics_timestep() -> timedelta
  - Determine the physics timestep (dt_atmos) from the merged fv3config.
- to_fv3config() -> dict
  - Build the final fv3config dictionary by merging:
    - base fv3config from fv3kube.get_base_fv3config(base_version)
    - initial-condition overlay (if any)
    - SUPPRESS_RANGE_WARNINGS
    - runtime dataclass values
    - fv3config-specific fields from FV3Config.asdict()
    - diagnostic overlays and namelist settings derived from Fortran diagnostic configs
    - zhao_carr_emulation converted to a dict
  - If `duration` is provided, the run duration is applied via fv3config.set_run_duration.

Command-line usage
------------------
A simple argument parser is provided by _create_arg_parser():

Positional arguments
- user_config (str)
  - Path to a YAML file describing updates to apply to the base fv3config
    (runtime updates, namelist overrides, diag_table, etc.)

Optional arguments
- --model_url
  - Can be provided multiple times (action="append"). Remote URL(s) to trained
    ML model(s) to use for emulation. If omitted and no model specified in
    the YAML, ML updating is not performed.

Example
-------
Example: constructing and converting to fv3config in Python:

:: 
    from pathlib import Path
    import yaml
    from runtime.config_highlevel import HighLevelConfig, InitialCondition

    # create HighLevelConfig directly
    cfg = HighLevelConfig(
        base_version="v0.5",
        initial_conditions=InitialCondition(
            base_url="gs://my-bucket/restarts",
            timestep="20200101.000000"
        ),
        duration="3h",
    )
    fv3cfg = cfg.to_fv3config()
    # fv3cfg is a dict ready to be consumed by fv3config utilities

Example YAML user_config (user_config.yaml)
-------------------------------------------
This YAML can be passed as the positional `user_config` to a CLI that uses
_create_arg_parser(). Fields correspond to attributes on HighLevelConfig /
UserConfig and FV3Config overlays.

:: 
    base_version: "v0.5"
    initial_conditions:
      base_url: "gs://my-bucket/restarts"
      timestep: "20200101.000000"
    duration: "3h"
    namelist:
      coupler_nml:
        dt_atmos: 900
    data_table: "/path/to/diag_table"
    # runtime-specific fields (from UserConfig) can be included here
    # fortran_diagnostics: ...
    # zhao_carr_emulation: { ... }

Running the CLI
---------------
Assuming a wrapper script that loads the YAML and constructs a HighLevelConfig,
example invocation:

:: 
    python run_prognostic.py user_config.yaml --model_url gs://models/model1.pkl

Notes and behavior details
--------------------------
- HighLevelConfig builds a final fv3config by merging overlays. The physics
  timestep and namelist dt_atmos are resolved against the chosen base version.
- If duration is provided, fv3config.set_run_duration is used to set the
  runtime segments.
- InitialCondition.overlay uses fv3kube helper functions to produce the
  correct restart overlays (including restart category mapping).
- instantiate_dataclass_from is provided for converting a subclass/dataclass
  instance into an instance of a parent dataclass type while preserving common
  fields.

See Also
--------
- fv3kube.get_base_fv3config
- fv3config.set_run_duration
- Fortran diagnostics helpers used in this module (file_configs_to_namelist_settings,
  runtime.diagnostics.manager.FortranFileConfig)