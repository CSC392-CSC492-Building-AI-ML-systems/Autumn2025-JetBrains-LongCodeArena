Operations module
=================

This module defines the core operation objects used by the migration
framework to represent and manipulate schema-change commands.  These
objects form the basis of the operation extensibility API and provide
the canonical representation used when recording, reversing, and
autogenerating migrations.

Overview
--------

Key responsibilities provided by this module:

- Represent individual migration actions (add/drop constraints, etc.)
  as first-class objects.
- Provide a unified API for converting operation objects to a diff
  tuple representation used by autogeneration.
- Provide reversal semantics for operations so that a migration can be
  inverted when necessary.
- Integrate with the framework's dispatcher and batch operation
  mechanisms.

Primary imports referenced
- schemaobj (module-local)
- BatchOperations, Operations (operation registration/invocation)
- util, util.sqla_compat (helper utilities and SQLAlchemy compatibility)

MigrateOperation
-----------------

.. class:: MigrateOperation

Base class for migration command and organization objects.  All concrete
operation types derive from this class.

Attributes and behavior

- info (property)
  A memoized dictionary available for storing arbitrary metadata on an
  operation instance.

Methods

- reverse() -> MigrateOperation
  Return an operation that reverses the current operation.  Concrete
  subclasses must implement this.

- to_diff_tuple() -> Tuple[Any, ...]
  Return a tuple representation of the operation suitable for use by the
  autogeneration/revision machinery.  Concrete subclasses must implement
  this.

See also
- :ref:`operation_objects`
- :ref:`operation_plugins`
- :ref:`customizing_revision`

AddConstraintOp
---------------

.. class:: AddConstraintOp(MigrateOperation)

Represents an "add constraint" operation.  This class provides the
mechanism to register and dispatch concrete implementations based on
SQLAlchemy constraint types.

Attributes and behavior

- add_constraint_ops (util.Dispatcher)
  Dispatcher used to select a concrete AddConstraintOp implementation for
  a given SQLAlchemy Constraint based on its visit name.

- constraint_type (property)
  The human-readable type name of the constraint (implemented by
  subclasses).

Class & factory methods

- register_add_constraint(type_: str) -> Callable
  Class decorator used by concrete AddConstraintOp implementations to
  register themselves for a specific SQLAlchemy constraint type name.
  The decorated class will be associated with the dispatcher for
  creation from a SQLAlchemy Constraint.

- from_constraint(constraint: Constraint) -> AddConstraintOp
  Create an AddConstraintOp instance by dispatching on the constraint's
  visit name.

Instance methods

- to_constraint(migration_context: Optional[MigrationContext] = None) -> Constraint
  Produce a SQLAlchemy Constraint instance that corresponds to this
  AddConstraintOp.  This is an abstract method that must be implemented
  by concrete subclasses.

- reverse() -> DropConstraintOp
  Return a DropConstraintOp that removes the constraint produced by
  to_constraint().

- to_diff_tuple() -> Tuple[str, Constraint]
  Convert this operation into a diff tuple of the form
  ("add_constraint", <Constraint>).

DropConstraintOp
----------------

.. class:: DropConstraintOp(MigrateOperation)

Represents a "drop constraint" operation and is registered as the core
implementation for both normal and batch drop constraint invocations.

Registration
- Registered with the operation registry via the decorators:
  Operations.register_operation("drop_constraint")
  BatchOperations.register_operation("drop_constraint", "batch_drop_constraint")

Constructor signature

: DropConstraintOp(
      constraint_name: Optional[sqla_compat._ConstraintNameDefined],
      table_name: str,
      type_: Optional[str] = None,
      *,
      schema: Optional[str] = None,
      _reverse: Optional[AddConstraintOp] = None,
  )

Attributes

- constraint_name
  The name of the constraint being dropped or None when not defined.

- table_name
  Name of the table the constraint belongs to.

- constraint_type
  Optional type string such as "foreignkey", "primary", "unique", or
  "check".  This may influence how the operation is represented or
  executed by dialects (MySQL requires a type).

- schema
  Optional schema name where the table resides.

- _reverse
  Optional cached AddConstraintOp instance representing the original
  constraint; used to re-create a full Constraint object in to_constraint().

Instance methods

- reverse() -> AddConstraintOp
  Return an AddConstraintOp that recreates the dropped constraint.

- to_diff_tuple() -> Tuple[str, SchemaItem]
  Convert this operation to a diff tuple.  If the constraint type is
  "foreignkey", the returned tuple will be ("remove_fk", <Constraint>);
  otherwise it will be ("remove_constraint", <Constraint>).

- to_constraint() -> Constraint
  Produce a SQLAlchemy Constraint instance for the dropped constraint.
  If the operation was constructed with a cached _reverse (an
  AddConstraintOp), that object's to_constraint() is used and the
  constraint's name/table/schema attributes are set from this operation.
  If no reverse is available, a ValueError is raised since the full
  constraint object cannot be reconstructed.

Class & factory methods

- from_constraint(constraint: Constraint) -> DropConstraintOp
  Create a DropConstraintOp from an existing SQLAlchemy Constraint by
  mapping the constraint's visit name to one of the module's canonical
  type names and locating the table/schema.  The mapping includes:

  - "unique_constraint" -> "unique"
  - "foreign_key_constraint" -> "foreignkey"
  - "primary_key_constraint" -> "primary"
  - "check_constraint", "column_check_constraint", "table_or_column_check_constraint" -> "check"

  The created DropConstraintOp will carry a cached _reverse that points
  at the corresponding AddConstraintOp for later reconstruction.

- drop_constraint(
      operations: Operations,
      constraint_name: str,
      table_name: str,
      type_: Optional[str] = None,
      *,
      schema: Optional[str] = None,
  ) -> None
  Class-level convenience method used to construct and invoke a
  DropConstraintOp via an Operations instance.  Parameters:

  - constraint_name: name of the constraint to drop.
  - table_name: table containing the constraint.
  - type_: optional constraint type string; required for some dialects.
  - schema: optional schema in which the table resides.  Use
    sqlalchemy.sql.elements.quoted_name to control quoting if necessary.

  Example usage:
  ::
      op = DropConstraintOp("fk_user_address", "user", type_="foreignkey", schema="public")
      operations.invoke(op)

- batch_drop_constraint(
      operations: BatchOperations,
      constraint_name: str,
      type_: Optional[str] = None,
  ) -> None
  Batch-mode convenience method used within a BatchOperations context to
  record a drop constraint instruction.  The batch form omits table and
  schema arguments, assuming the batch context already targets a table.

Examples
--------

Record a drop constraint operation:

::
    DropConstraintOp.drop_constraint(operations, "uq_user_email", "user", type_="unique")

Use a previously-constructed operation:

::
    operations.invoke(DropConstraintOp("fk_order_user", "order", type_="foreignkey"))

Autogeneration and diffs
------------------------

Operations in this module implement to_diff_tuple() to produce a
standardized tuple representation consumed by the autogeneration engine.
- AddConstraintOp instances emit ("add_constraint", <Constraint>).
- DropConstraintOp instances emit ("remove_constraint", <Constraint>) or
  ("remove_fk", <Constraint>) for foreign keys.

Notes
-----

- Concrete AddConstraintOp implementations are registered via the
  add_constraint_ops dispatcher; this allows the system to produce the
  correct operation type for any SQLAlchemy Constraint subtype.
- DropConstraintOp is the canonical operation used by the public
  operations API for removing constraints, and has both a direct and
  batch invocation path.

See also
- util.Dispatcher (operation dispatch mechanism)
- util.sqla_compat (SQLAlchemy compatibility helpers)
- :ref:`operation_objects` and :ref:`autogenerate` for how these objects
  interact with the rest of the migration system.