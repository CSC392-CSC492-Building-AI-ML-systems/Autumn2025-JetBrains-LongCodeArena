PostgreSQL Engine Module
==========================

Overview
--------
The `postgres_engine` module provides a comprehensive set of classes and functions to facilitate interaction with a PostgreSQL database using asynchronous programming paradigms. It includes transaction management, batching, savepoints, and connection handling, all designed to work seamlessly with the asyncpg library.

Classes and Functions
---------------------

AsyncBatch
----------
Represents a batch of query results fetched asynchronously from the database.

- Attributes:
  - `connection`: The asyncpg connection object.
  - `query`: The query to execute.
  - `batch_size`: Number of records to fetch per batch.
  - `_transaction`: Internal transaction object.
  - `_cursor`: Optional cursor for fetching data.

- Methods:
  - `cursor`: Property to access the current cursor; raises error if not set.
  - `next()`: Fetches the next batch of data.
  - `__aiter__()`: Returns the iterator object.
  - `__anext__()`: Retrieves the next batch or stops iteration.
  - `__aenter__()`: Starts a transaction and initializes the cursor.
  - `__aexit__()`: Commits or rolls back the transaction based on exceptions and closes the connection.

Atomic
------
Allows building and executing a series of queries as a single transaction programmatically.

- Attributes:
  - `engine`: The `PostgresEngine` instance.
  - `queries`: List of queries added to the transaction.

- Methods:
  - `add()`: Adds queries to the transaction.
  - `run()`: Executes all queries within a transaction asynchronously.
  - `run_sync()`: Executes the transaction synchronously.
  - `__await__()`: Enables awaiting the transaction execution.

Savepoint
---------
Represents a savepoint within a transaction, allowing partial rollbacks.

- Attributes:
  - `name`: Savepoint name.
  - `transaction`: The associated `PostgresTransaction`.

- Methods:
  - `rollback_to()`: Rolls back to this savepoint.
  - `release()`: Releases the savepoint.

PostgresTransaction
-------------------
Manages database transactions, supporting nested transactions and savepoints.

- Attributes:
  - `engine`: The `PostgresEngine` instance.
  - `transaction`: The current transaction object.
  - `connection`: The database connection.
  - `context`: Context variable for current transaction.
  - `_savepoint_id`: Counter for generating savepoint names.
  - `_parent`: Parent transaction if nested.
  - `_committed`: Flag indicating if committed.
  - `_rolled_back`: Flag indicating if rolled back.

- Methods:
  - `__aenter__()`: Begins a transaction or returns parent if nested.
  - `get_connection()`: Acquires a new or pooled connection.
  - `begin()`: Starts the transaction.
  - `commit()`: Commits the transaction.
  - `rollback()`: Rolls back the transaction.
  - `rollback_to()`: Rolls back to a specific savepoint.
  - `get_savepoint_id()`: Generates a unique savepoint ID.
  - `savepoint()`: Creates a new savepoint.
  - `__aexit__()`: Commits or rolls back based on exceptions and releases resources.

PostgresEngine
----------------
Main class for establishing and managing connections to a PostgreSQL database.

- Usage:
  - Instantiate with connection parameters.
  - Use context managers or direct method calls to execute queries.
  - Supports transaction management, connection pooling, and query execution.

Notes
-----
- The module leverages `asyncpg` for asynchronous database interactions.
- Supports nested transactions and savepoints for complex transaction workflows.
- Designed to integrate seamlessly with the Piccolo ORM framework.
- Provides utility functions for running synchronous code in an async context.

This documentation provides an overview of the core classes and their functionalities within the `postgres_engine` module, enabling efficient and reliable database operations in asynchronous Python applications.