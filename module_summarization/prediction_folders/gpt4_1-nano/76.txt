Feature Extraction Module
=========================

This module provides tools for creating feature extractors from PyTorch models using FX tracing. It includes custom tracers that allow for detailed control over the tracing process, enabling users to specify which modules should be treated as leaves and to record the hierarchical node names during tracing. These features facilitate precise extraction of intermediate features from complex models.

Classes
-------

### LeafModuleAwareTracer

An FX tracer that allows users to specify a set of leaf modules, which are modules that should not be traced through. Instead, these modules are represented as single nodes referencing their forward methods in the generated graph.

#### Usage Example:

```python
from torch import nn
from feature_extraction import LeafModuleAwareTracer

# Define your model
model = nn.Sequential(
    nn.Conv2d(3, 16, 3),
    nn.ReLU(),
    nn.Linear(16 * 6 * 6, 10)
)

# Specify leaf modules
leaf_modules = {nn.ReLU}

# Create tracer with leaf modules
tracer = LeafModuleAwareTracer(leaf_modules=leaf_modules)

# Trace the model
graph = tracer.trace(model)
```

### NodePathTracer

Extends `LeafModuleAwareTracer` to record the hierarchical path names of nodes during tracing. Each node is assigned a name representing its position in the module hierarchy, which aids in identifying and extracting specific features.

#### Usage Example:

```python
from torch import nn
from feature_extraction import NodePathTracer

# Define your model
model = nn.Sequential(
    nn.Conv2d(3, 16, 3),
    nn.ReLU(),
    nn.Linear(16 * 6 * 6, 10)
)

# Initialize tracer
tracer = NodePathTracer()

# Trace the model
traced_graph = tracer.trace(model)

# Access node to qualified name mapping
node_names = tracer.node_to_qualname
print(node_names)
```

Functions
---------

### create_feature_extractor

Creates a feature extractor from a traced model, allowing users to specify which nodes' outputs to capture.

### get_graph_node_names

Returns the list of node names in the traced graph, useful for identifying nodes for feature extraction.

Usage Example for Creating a Feature Extractor:

```python
from torchvision.models import resnet18
from feature_extraction import create_feature_extractor

# Load a pretrained model
model = resnet18(pretrained=True)

# Trace the model
tracer = NodePathTracer()
traced = tracer.trace(model)

# Specify nodes to extract features from
return_nodes = {
    'layer1.0.relu': 'layer1_relu_output',
    'avgpool': 'avgpool_output'
}

# Create feature extractor
feature_extractor = create_feature_extractor(traced, return_nodes=return_nodes)

# Forward pass with input
inputs = torch.randn(1, 3, 224, 224)
outputs = feature_extractor(inputs)

# Access extracted features
layer1_relu_feat = outputs['layer1_relu_output']
avgpool_feat = outputs['avgpool_output']
```

This module simplifies the process of extracting intermediate features from complex models, enabling detailed analysis and visualization of model internals.