storage.rst

Storage Module
==============

Overview
--------
This module provides a storage service implementation for MongoDB, utilizing both `pymongo` and `motor` for asynchronous operations. It includes classes for managing MongoDB connections, performing CRUD operations, and upserting documents with version control and webhook support.

Classes
-------

StorageService
--------------
The `StorageService` class implements the `StorageServiceABC` interface to facilitate interaction with a MongoDB database.

Initialization:
- Connects to MongoDB using the URI specified in the configuration.
- Sets up the database with timezone-aware BSON codec options.

Methods:
- `upsertor(collection: str, obj_id=None, version=0)`: Returns an instance of `MongoDBUpsertor` for upserting documents.
- `get(collection: str, obj_id, decrypt=None) -> dict`: Retrieves a document by its `_id`. Supports optional decryption of specified fields.
- `get_by(collection: str, key: str, value, decrypt=None) -> dict`: Retrieves a document by a specified key-value pair. Supports optional decryption.
- `collection(collection: str) -> motor.motor_asyncio.AsyncIOMotorCollection`: Provides direct access to a collection for custom operations.
- `delete(collection: str, obj_id)`: Deletes a document by its `_id` and returns the deleted document's `_id`.

Attributes:
- `Client`: The asynchronous MongoDB client.
- `Database`: The database instance used for operations.

Usage Example:
```python
storage = StorageService(app, "MyStorage")
collection = await storage.collection("my_collection")
document = await storage.get("my_collection", "some_id")
```

MongoDBUpsertor
----------------
The `MongoDBUpsertor` class extends `UpsertorABC` to handle document upsert operations with version control and optional webhook notifications.

Methods:
- `generate_id()`: Generates a new ObjectId for a document.
- `execute(custom_data=None, event_type=None)`: Performs the upsert operation, applying modifications, increments, pushes, and unsets as specified. Handles duplicate key errors and updates the internal object ID and version.

Features:
- Supports `$set`, `$inc`, `$push`, and `$unset` modifications.
- Ensures atomicity of updates with `find_one_and_update`.
- Handles duplicate key errors gracefully.
- Can trigger webhooks with detailed data about the operation.

Configuration
-------------
Default configuration parameters are added via `asab.Config`:
- `mongodb_uri`: The URI for connecting to MongoDB (`mongodb://localhost:27017` by default).
- `mongodb_database`: The name of the database (`asabdb` by default).

Dependencies
------------
- `motor`: Asynchronous MongoDB driver.
- `pymongo`: MongoDB driver used for certain operations.
- `bson`: BSON library for ObjectId and codec options.
- `asab`: Framework providing configuration management.
- Custom exceptions and base classes from local modules.

Notes
-----
- The module assumes a running MongoDB instance accessible via the configured URI.
- Supports timezone-aware datetime handling.
- Designed for asynchronous operation within an `asab` application context.
- Webhook notifications are configurable and can be integrated into the upsert process.

This documentation provides an overview of the storage module's classes, methods, and usage patterns for effective integration and extension within your application.