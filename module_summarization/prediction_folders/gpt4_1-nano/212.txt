# Linear Mixed Effects Models

Linear mixed effects models are regression models designed for dependent data, allowing for the estimation of relationships involving both means and variances. These models are also known as multilevel linear models or hierarchical linear models.

## Overview

The `MixedLM` class fits linear mixed effects models to data and supports common post-estimation tasks. It is optimized for models where data can be partitioned into independent groups, although some models with crossed effects can be handled by specifying a single group.

## Model Specification

The data are partitioned into disjoint groups. The probability model for each group \(i\) is:

\[
Y = X \beta + Z \gamma + \epsilon
\]

where:

- \( n_i \): Number of observations in group \(i\)
- \( Y \): Response vector (endog in `MixedLM`)
- \( X \): Design matrix for fixed effects (`exog`)
- \( \beta \): Fixed effects parameters (`fe_params`)
- \( Z \): Design matrix for random effects (`exog_re`)
- \( \gamma \): Random effects vector, with mean zero and covariance structure (`cov_re`)
- \( \epsilon \): IID normal errors with mean zero and variance \(\sigma^2\)

The response \(Y\), and design matrices \(X\) and \(Z\), must be fully observed. Parameters such as \(\beta\), \(\Psi\) (covariance of random effects), and \(\sigma^2\) are estimated via maximum likelihood (ML) or restricted maximum likelihood (REML). The random effects \(\gamma\) and errors \(\epsilon\) are modeled as random variables.

## Covariance Structure

The marginal mean of the response is:

\[
E[Y | X, Z] = X \beta
\]

The covariance matrix of \(Y\) given the fixed effects is:

\[
\text{Cov}(Y) = \sigma^2 I + Z \, \text{cov\_re} \, Z'
\]

where `cov_re` is the covariance matrix of the random effects.

## Random Effects

Two types of random effects are supported:

- **Standard random effects**: Correlated with each other, with the same number \(k_{re}\) across groups, sharing a joint distribution.
- **Variance components**: Uncorrelated with each other and with standard effects, with each variance component having mean zero and a shared variance parameter across groups.

## Parameterizations

Three parameterizations are used:

1. **User parameterization**: \(\text{Cov}(Y) = \text{scale} \times I + Z \, \text{cov\_re} \, Z'\)
2. **Profile parameterization**: \(\text{Cov}(Y) = I + Z \, \text{cov\_re1} \, Z'\), with the user covariance scaled by \(\text{scale}\)
3. **Square root parameterization**: Uses the Cholesky factor of \(\text{cov\_re1}\)

Parameters are packed into vectors, combining fixed effects, dependence structures, and variance components.

## Estimation and Optimization

The model uses generalized least squares (GLS) to profile out fixed effects during likelihood maximization. The likelihood is profiled over the scale parameter and fixed effects, making the Hessian of the profiled likelihood difficult to compute. Consequently, optimization algorithms requiring the Hessian, such as Newton-Raphson, are not used.

Two score methods are implemented:

- Score with respect to the random effects covariance matrix
- Score with respect to the Cholesky factor of the covariance matrix

## Implementation Details

The implementation follows the methodology described by Lindstrom and Bates (1988), with adaptations for variance components. The likelihood, gradient, and Hessian calculations are based on their work.

## References

- MJ Lindstrom, DM Bates (1988). "Newton Raphson and EM algorithms for linear mixed effects models for repeated measures data." *Journal of the American Statistical Association*, 83(404), 1014-1022.
- [Additional recent document](http://econ.ucsb.edu/~doug/245a/Papers/Mixed%20Effects%20Implement.pdf)
- User-oriented documents:
  - [LME4 documentation](http://lme4.r-forge.r-project.org/lMMwR/lrgprt.pdf)
  - [Longitudinal data analysis slides](http://lme4.r-forge.r-project.org/slides/2009-07-07-Rennes/3Longitudinal-4.pdf)

## Notation

- `cov_re`: Random effects covariance matrix (`Psi`)
- `scale`: Scalar error variance
- The marginal covariance matrix of \(Y\) given \(X\) is:

\[
\text{scale} \times I + Z \, \text{cov\_re} \, Z'
\]

- `vcomp`: Vector of variance parameters, determined by variance component formulas or `vc_formula`.

## Additional Notes

- The model supports different parameterizations, which must be handled carefully during estimation.
- Profiling likelihood over fixed effects and scale simplifies optimization but complicates the calculation of the Hessian.
- The implementation emphasizes efficiency for models with independent groups, with some support for crossed effects.

