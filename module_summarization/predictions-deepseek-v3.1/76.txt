`feature_extraction` Module
============================

.. currentmodule:: torchvision

The `feature_extraction` module provides utilities for extracting intermediate
features from PyTorch models using FX tracing.

Functions
---------

.. autofunction:: create_feature_extractor
.. autofunction:: get_graph_node_names

Core Classes
------------

LeafModuleAwareTracer
^^^^^^^^^^^^^^^^^^^^^
An FX Tracer that allows specifying leaf modules that should not be traced through.

.. autoclass:: LeafModuleAwareTracer
   :members:
   :special-members: __init__

NodePathTracer
^^^^^^^^^^^^^^
An enhanced tracer that records qualified node names along with operation tracing.

.. autoclass:: NodePathTracer
   :members:
   :special-members: __init__

Example Usage
-------------

Basic feature extraction from a ResNet model:

.. code-block:: python

    import torch
    import torchvision
    from torchvision import feature_extraction
    
    # Load a pretrained model
    model = torchvision.models.resnet50(weights='IMAGENET1K_V2')
    
    # Get available node names
    train_nodes, eval_nodes = feature_extraction.get_graph_node_names(model)
    print("Train nodes:", train_nodes)
    print("Eval nodes:", eval_nodes)
    
    # Create feature extractor for specific layers
    return_nodes = {'layer1.0.relu': 'feature1', 'layer4.2.conv3': 'feature2'}
    extractor = feature_extraction.create_feature_extractor(
        model, 
        return_nodes=return_nodes
    )
    
    # Extract features
    x = torch.randn(1, 3, 224, 224)
    features = extractor(x)
    print(features.keys())  # ['feature1', 'feature2']

Working with Custom Leaf Modules
--------------------------------

You can specify modules that should be treated as leaves (not traced through):

.. code-block:: python

    class CustomModule(nn.Module):
        def forward(self, x):
            return x * 2
    
    model = YourModelWithCustomModules()
    leaf_modules = (CustomModule, nn.BatchNorm2d)
    
    extractor = create_feature_extractor(
        model, 
        return_nodes={'custom.output': 'output'},
        leaf_modules=leaf_modules
    )

Notes
-----

- The module handles both training and evaluation mode tracing automatically
- Node names follow a hierarchical naming convention (e.g., 'layer1.0.relu')
- Duplicate node names are automatically suffixed with _1, _2, etc.
- Warning messages are generated if train and eval graphs differ significantly

See Also
--------

- :mod:`torch.fx` - The underlying FX framework for graph tracing
- :mod:`torchvision.models` - Pre-trained models compatible with feature extraction