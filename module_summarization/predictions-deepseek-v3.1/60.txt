===================
Collection API
===================

.. module:: sqlalchemy.orm.collections

The collections package provides instrumentation support for collections of mapped entities in SQLAlchemy ORM. It uses a decoration-based approach to track membership changes without requiring inheritance from base classes.

Core Components
---------------

.. autoclass:: collection
   :members:
   :undoc-members:

   Decorator class for entity collection classes. Provides both annotation decorators (appender, remover, iterator, converter, internally_instrumented) and recipe decorators (adds, removes_return) for instrumenting collection methods.

.. autofunction:: collection_adapter

   Retrieves the collection adapter object for explicit control over append and remove events within custom collection methods.

Collection Types
----------------

.. autofunction:: keyfunc_mapping
.. autofunction:: column_keyed_dict
.. autofunction:: attribute_keyed_dict

.. autoclass:: MappedCollection
   :members:
   :undoc-members:

.. autoclass:: KeyFuncDict
   :members:
   :undoc-members:

Protocols
---------

.. autoclass:: _AdaptedCollectionProtocol
   :members:
   :undoc-members:

.. autoclass:: _CollectionConverterProtocol
   :members:
   :undoc-members:

Instrumentation Process
-----------------------

The collection instrumentation system:

1. Substitutes built-in types with trivial subclasses when needed
2. Checks for existing instrumentation
3. Adds generic decorators
4. Identifies collection interface through duck typing
5. Applies targeted decoration to undecorated interface methods

The system handles both built-in types (list, set, dict) and custom collection classes, automatically instrumenting standard mutation methods while allowing for custom event management through explicit adapter access.

Usage Notes
-----------

- Built-in collection types are automatically instrumented when used in relationships
- Custom collection classes should delegate to already-instrumented methods when possible to avoid duplicate events
- For advanced event control, use ``collection_adapter(self)`` within methods to manage append/remove events explicitly
- Bulk operations like ``extend`` and ``update`` are broken down into atomic append/remove operations

The module provides sophisticated collection management while maintaining compatibility with standard Python collection interfaces.