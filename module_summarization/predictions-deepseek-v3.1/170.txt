Handling Large Datasets
=======================

The spectral cube library provides several strategies for computing moment maps that are optimized for different data sizes and memory constraints. These methods allow efficient processing of large datasets by controlling memory usage and iteration patterns.

Moment Calculation Strategies
-----------------------------

There are three primary strategies for computing moments:

1. **Cubewise**
   - Processes the entire data array at once
   - Fastest but most memory-intensive
   - Best for small to moderately sized cubes that fit in memory
   - Uses vectorized numpy operations for maximum performance

2. **Slicewise** 
   - Processes data one slice at a time along the specified axis
   - Moderate memory usage (stores one plane at a time)
   - Good balance between memory efficiency and speed
   - Accumulates results incrementally

3. **Raywise**
   - Processes data one ray (line of sight) at a time
   - Most memory-efficient but slowest
   - Essential for very large datasets that don't fit in memory
   - Processes each spatial position independently

Automatic Strategy Selection
----------------------------

The `moment_auto` function automatically selects the appropriate strategy based on the cube size and available memory:

```python
def moment_auto(cube, order, axis):
    """
    Build a moment map, choosing a strategy to balance speed and memory.
    """
```

This function uses `iterator_strategy()` to determine whether to use cubewise, slicewise, or raywise computation based on the cube's characteristics.

Memory Optimization Features
----------------------------

- **Lazy data loading**: The cube methods use `_get_filled_data()` to load only necessary portions of data
- **Incremental processing**: Slicewise and raywise methods process data in chunks
- **NaN handling**: Proper handling of missing/invalid data throughout computations
- **Memory-mapped data**: Compatible with memory-mapped arrays for out-of-core processing

Best Practices
--------------

- Use `moment_auto()` for general-purpose moment calculations
- For very large datasets, consider using the raywise method directly
- Monitor memory usage when working with large cubes
- Use appropriate data types to minimize memory footprint

The library's flexible architecture allows handling datasets ranging from small in-memory cubes to very large datasets that exceed available RAM through careful memory management and iterative processing strategies.