Understanding Sessions
=====================

A session in the ftrack API represents an isolated context for interacting with an ftrack server. It manages authentication, caching, event handling, and entity operations.

Session Initialization
----------------------

To create a session, instantiate the ``Session`` class with appropriate parameters:

.. code-block:: python

    session = Session(
        server_url='https://your-ftrack-server',
        api_key='your-api-key',
        api_user='your-username'
    )

Required Parameters
~~~~~~~~~~~~~~~~~~~

- **server_url**: The URL of the ftrack server including port number. Can also be set via ``FTRACK_SERVER`` environment variable.
- **api_key**: Authentication key for the ftrack API. Can also be set via ``FTRACK_API_KEY`` environment variable.
- **api_user**: Username to record operations against. Can also be set via ``FTRACK_API_USER`` environment variable or derived from system user.

Optional Parameters
~~~~~~~~~~~~~~~~~~~

- **auto_populate**: (Default: True) Automatically fetch entity attributes from server when accessed.
- **plugin_paths**: List of paths to search for plugins. Defaults to ``FTRACK_EVENT_PLUGIN_PATH`` environment variable.
- **cache**: Custom cache implementation following ``ftrack_api.cache.Cache`` interface.
- **cache_key_maker**: Custom key maker for cache operations. Defaults to ``StringKeyMaker``.
- **auto_connect_event_hub**: (Default: None) Automatically connect to event server for non-local events.
- **schema_cache_path**: Path for schema caching. Uses ``FTRACK_API_SCHEMA_CACHE_PATH`` environment variable if not specified.
- **plugin_arguments**: Additional arguments to pass to plugin register functions.

Authentication
--------------

The session uses ``SessionAuthentication`` to attach authentication headers to all requests:

- ``ftrack-api-key``: The provided API key
- ``ftrack-user``: The provided API user

Caching
-------

Sessions use a layered caching system with a memory cache at the top level. Custom caches can be provided but will be wrapped with the default memory cache for optimal performance.

Event Handling
--------------

The session includes an embedded event hub that can:
- Publish and subscribe to local events immediately
- Connect to the event server for non-local events (optional)
- Event hub connection occurs in a background thread to improve startup performance

Operation Tracking
------------------

The session maintains:
- ``recorded_operations``: Collection of pending operations
- ``record_operations``: Flag to enable/disable operation recording

Best Practices
--------------

1. Always close sessions when finished using ``session.close()``
2. Check event hub connection status if plugins require connected hub
3. Use environment variables for consistent configuration across environments
4. Consider schema caching for improved performance in production environments

Environment Variables
--------------------

- ``FTRACK_SERVER``: Server URL
- ``FTRACK_API_KEY`` / ``FTRACK_APIKEY``: API key (backwards compatible)
- ``FTRACK_API_USER``: API username
- ``FTRACK_EVENT_PLUGIN_PATH``: Plugin search paths
- ``FTRACK_API_SCHEMA_CACHE_PATH``: Schema cache location

The session provides a robust foundation for all interactions with the ftrack API, handling authentication, caching, and event management transparently.