w_fork
=====

The ``w_fork`` command prepares a new weighted ensemble simulation from an existing one at a particular iteration, generating a new HDF5 file and associated initial state mapping.

Description
-----------
This tool creates a new WESTPA simulation by forking from an existing simulation at a specified iteration. It generates:

- A new HDF5 file containing the forked simulation data
- Target states and basis states copied from the original simulation
- Initial states created from the segments of the specified iteration
- A text file mapping original segments to new initial state IDs

For executable propagation, users must manually prepare the new simulation directory, particularly ensuring that restart data from the appropriate iteration is available as initial state data for the new simulation.

Command Line Options
-------------------

.. program:: w_fork

.. option:: -i INPUT_H5FILE, --input INPUT_H5FILE

    Use INPUT_H5FILE as the source simulation HDF5 file. If not specified, uses the file from the configuration.

.. option:: -I N_ITER, --iteration N_ITER

    Take the initial distribution for the new simulation from iteration N_ITER. Defaults to the last complete iteration.

.. option:: -o OUTPUT, --output OUTPUT

    Save the new simulation HDF5 file as OUTPUT. Default: ``forked.h5``

.. option:: --istate-map ISTATE_MAP

    Write the initial state mapping text file to ISTATE_MAP. Default: ``istate_map.txt``

.. option:: --no-headers

    Do not write headers to the initial state mapping file.

Output Files
------------

- **Output HDF5 file**: Contains the forked simulation with:
  - Copied target states from the original simulation
  - Copied basis states from the original simulation  
  - New initial states created from original segments
  - New segments ready for propagation

- **Initial state mapping file**: Text file with columns:
  - Column 0: Old simulation iteration number
  - Column 1: Old simulation segment ID
  - Column 2: New simulation initial state ID

Usage Notes
-----------
The tool creates one initial state and one corresponding new segment for each segment in the original iteration. Further adjustment of the initial state distribution can be accomplished using ``w_binning``.

The initial state mapping file provides the correspondence between segments in the original simulation and initial states in the new simulation, which is essential for preparing restart data when using executable propagation.

Example
-------
::

    w_fork -i west.h5 -I 100 -o forked_sim.h5 --istate-map mapping.txt

This command creates a new simulation ``forked_sim.h5`` forked from iteration 100 of ``west.h5``, with the initial state mapping saved to ``mapping.txt``.