=========================
PostgresEngine Documentation
=========================

Overview
========
The `PostgresEngine` module provides an asynchronous PostgreSQL database engine implementation for the Piccolo ORM. It includes transaction management, batch operations, and connection pooling support.

Classes
=======

AsyncBatch
----------
A dataclass for handling batch operations asynchronously.

**Attributes:**
- `connection`: The asyncpg connection object.
- `query`: The query to execute in batches.
- `batch_size`: Number of records to fetch per batch.

**Methods:**
- `next()`: Asynchronously fetches the next batch of results.
- `__aiter__()`: Returns the async iterator.
- `__anext__()`: Fetches the next batch; raises `StopAsyncIteration` when done.
- `__aenter__()`: Starts a transaction and initializes the cursor.
- `__aexit__()`: Commits or rolls back the transaction and closes the connection.

Atomic
------
Manages atomic transactions by programmatically adding queries.

**Methods:**
- `add(*query)`: Adds one or more queries to the transaction.
- `run()`: Asynchronously executes all added queries in a transaction.
- `run_sync()`: Synchronous wrapper for `run()`.
- `__await__()`: Allows awaiting the transaction directly.

Savepoint
---------
Represents a transaction savepoint.

**Methods:**
- `rollback_to()`: Rolls back to this savepoint.
- `release()`: Releases the savepoint.

PostgresTransaction
-------------------
Context manager for wrapping queries in a transaction.

**Attributes:**
- `engine`: The associated `PostgresEngine` instance.
- `transaction`: The underlying asyncpg transaction.
- `connection`: The database connection.

**Methods:**
- `begin()`: Starts the transaction.
- `commit()`: Commits the transaction.
- `rollback()`: Rolls back the transaction.
- `rollback_to(savepoint_name)`: Rolls back to a specific savepoint.
- `savepoint(name=None)`: Creates a new savepoint.
- `__aenter__()`: Enters the transaction context.
- `__aexit__()`: Exits the transaction context, handling commit/rollback.

PostgresEngine
--------------
Main engine class for PostgreSQL connections.

**Inherits from:** `Engine[t.Optional[PostgresTransaction]]`

**Key Features:**
- Supports connection pooling via asyncpg.
- Manages current transaction context using contextvars.
- Provides atomic transaction support.
- Handles batch queries efficiently.

**Usage Example:**
```python
engine = PostgresEngine(config)
async with engine.transaction():
    results = await MyTable.select().run()
```

Notes
=====
- This module requires `asyncpg` for PostgreSQL connectivity.
- All operations are asynchronous and should be awaited appropriately.
- Transactions can be nested if `allow_nested=True` (default).