==========================
Configuration Usage
==========================

This document describes the configuration classes and utilities used for setting up and running prognostic simulations with the FV3GFS model.

Overview
--------

The configuration system combines fv3config and runtime configurations with conveniences for commonly used initial conditions and configurations. The main classes are:

- ``HighLevelConfig``: Combines fV3Config and UserConfig with additional features
- ``FV3Config``: Dataclass representation of fv3config fields
- ``InitialCondition``: Specification for model initial conditions

Main Classes
------------

HighLevelConfig
~~~~~~~~~~~~~~~

A high-level configuration object for prognostic runs that combines fv3config and runtime configurations.

**Attributes**:
- ``base_version`` (str): Default physics configuration version (default: "v0.5")
- ``initial_conditions`` (Union[InitialCondition, Any]): Specification for initial conditions
- ``duration`` (str): Duration of each segment (overrides namelist.coupler_nml settings)
- ``zhao_carr_emulation``: Emulation configuration

**Methods**:
- ``to_runtime_config()``: Extract just the python runtime configurations
- ``to_fv3config()``: Translate into a fv3config dictionary

FV3Config
~~~~~~~~~

Dataclass representation of all fv3config fields not overridden by HighLevelConfig.

**Attributes**:
- ``namelist``: Namelist configuration
- ``experiment_name``: Experiment name
- ``data_table``: Data table configuration
- ``field_table``: Field table configuration
- ``forcing``: Forcing configuration
- ``orographic_forcing``: Orographic forcing configuration
- ``gfs_analysis_data``: GFS analysis data

**Methods**:
- ``asdict()``: Convert to dictionary, excluding None values

InitialCondition
~~~~~~~~~~~~~~~~

Represents an initial condition with the format ``{base_url}/{timestep}``.

**Attributes**:
- ``base_url`` (str): Location in GCS or local storage
- ``timestep`` (str): YYYYMMDD.HHMMSS timestamp
- ``restart_categories``: Mapping from FV3GFS restart categories to disk names

**Properties**:
- ``overlay``: Returns fv3kube initial conditions overlay

Utilities
---------

instantiate_dataclass_from
~~~~~~~~~~~~~~~~~~~~~~~~~~

``instantiate_dataclass_from(cls: Callable[..., T], instance: Any) -> T``

Create an instance of ``cls`` with the same attributes as ``instance``. Useful for instantiating parent classes from child classes. ``cls`` must be a dataclass.

Configuration Generation
------------------------

The system uses a layered approach to build the final configuration:

1. Base fv3config from specified version
2. Initial condition overlays
3. Runtime configuration settings
4. Fortran diagnostics configuration
5. Zhao-Carr emulation settings
6. Duration settings (if specified)

The configuration can be exported to a fv3config-compatible dictionary using the ``to_fv3config()`` method.

Example Usage
-------------

.. code-block:: python

    from your_module import HighLevelConfig, InitialCondition
    
    # Create configuration
    config = HighLevelConfig(
        base_version="v0.5",
        initial_conditions=InitialCondition(
            base_url="gs://my-bucket/initial-conditions",
            timestep="20230101.000000"
        ),
        duration="3h"
    )
    
    # Convert to fv3config format
    fv3config_dict = config.to_fv3config()

Command Line Interface
----------------------

The module includes argument parsing utilities for configuration:

- ``user_config``: Path to YAML config file specifying changes from base configuration
- ``--model_url``: Remote URL to trained ML model (optional, can be specified multiple times)

Constants
---------

- ``PROGNOSTIC_DIAG_TABLE``: Default diagnostic table path
- ``SUPPRESS_RANGE_WARNINGS``: Configuration to suppress range warnings
- ``default_coupler_nml()``: Returns default coupler namelist settings

See Also
--------

- :py:class:`runtime.config.UserConfig` for runtime configuration details
- :py:class:`fv3kube.RestartCategoriesConfig` for restart category configuration
- :py:class:`runtime.steppers.machine_learning.MachineLearningConfig` for ML configuration