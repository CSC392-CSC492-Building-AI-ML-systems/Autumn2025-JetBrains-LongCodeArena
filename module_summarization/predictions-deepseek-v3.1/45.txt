.. _log:

Logging
=======

This module provides a comprehensive logging system for the application, supporting multiple output handlers including console, file, and syslog with various configuration options.

Constants
---------

.. py:data:: LOG_NOTICE

   Custom log level (25) that is visible in non-verbose mode. Should not be used for warnings and errors.

   .. note:: This level is registered with the logging system as "NOTICE".

Level Mapping
-------------

The module provides a mapping of various string representations to standard logging levels:

.. code-block:: python

   _NAME_TO_LEVEL = {
       "NOTSET": logging.NOTSET,
       "NOT SET": logging.NOTSET,
       "NOT_SET": logging.NOTSET,
       "DEBUG": logging.DEBUG,
       "INFO": logging.INFO,
       "NOTICE": LOG_NOTICE,
       "LOG_NOTICE": LOG_NOTICE,
       "LOG NOTICE": LOG_NOTICE,
       "WARNING": logging.WARNING,
       "WARN": logging.WARNING,
       "ERROR": logging.ERROR,
       "FATAL": logging.CRITICAL,
       "CRITICAL": logging.CRITICAL,
   }

Logging Class
-------------

.. py:class:: Logging(app)

   Main logging class that configures and manages logging handlers.

   .. py:attribute:: RootLogger
      :type: logging.Logger

      The root logger instance for the application.

   .. py:attribute:: ConsoleHandler
      :type: logging.Handler or None

      Handler for console output if configured.

   .. py:attribute:: FileHandler
      :type: logging.Handler or None

      Handler for file output if configured.

   .. py:attribute:: SyslogHandler
      :type: logging.Handler or None

      Handler for syslog output if configured.

   .. py:method:: __init__(app)
      
      Initializes the logging system with configuration from the provided app.

      Configuration is read from the following sections:
      
      - ``logging:file`` - File logging configuration
        - ``path``: File path for logs
        - ``backup_count``: Number of backup files to keep
        - ``backup_max_bytes``: Maximum file size before rotation
        - ``format``: Log format string
        - ``datefmt``: Date format string
        - ``rotate_every``: Rotation interval (e.g., "1d", "12H", "30M")
      
      - ``logging:syslog`` - Syslog configuration
        - ``enabled``: Boolean to enable/disable syslog
        - ``address``: Syslog server address (supports TCP, UDP, Unix sockets)
        - ``format``: Syslog format ('m' for macOS, '5' for RFC5424, '5micro' for RFC5424 with microseconds, default RFC3164)
      
      - ``logging`` - General logging configuration
        - ``sd_id``: Structured data ID for syslog messages

      The initialization process:
      
      1. Configures console logging if running in TTY or when forced by environment variable ``ASABFORCECONSOLE``
      2. Sets up file logging with rotation based on size and/or time intervals
      3. Configures syslog handler with support for multiple transport protocols and formats

Features
--------

- **Automatic console detection**: Logs to console when running in terminal or when explicitly forced
- **File rotation**: Supports both size-based and time-based log rotation
- **Multiple syslog formats**: RFC3164, RFC5424, RFC5424 with microseconds, and macOS format
- **Protocol support**: TCP, UDP, and Unix socket connections for syslog
- **Structured data**: Support for structured data in syslog messages
- **Async support**: Uses asynchronous I/O for syslog operations

Environment Variables
---------------------

- ``ASABFORCECONSOLE``: When set to any value other than '0', forces console logging even when not running in terminal

Dependencies
------------

- :ref:`config` - For reading logging configuration
- :ref:`timer` - For scheduled log rotation
- :ref:`utils` - For container environment detection

Note: This documentation is based on the provided code snippet and may not cover all features of the complete module.