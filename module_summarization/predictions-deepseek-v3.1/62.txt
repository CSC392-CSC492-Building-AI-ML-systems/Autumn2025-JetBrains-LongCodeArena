visitors
========

.. module:: sqlalchemy.sql.visitors

The ``sql.visitors`` module provides the visitor/traversal interface and library functions for SQLAlchemy's SQL expression tree traversal and compilation.

Overview
--------

This module contains the core infrastructure for:

- Implementing the visitor pattern for SQL expression compilation
- Internal traversal for cache key generation and object copying
- Generic traversal utilities for SQL expression trees

Main Components
---------------

Visitable
~~~~~~~~~

.. class:: Visitable

   Base class for visitable objects that implement SQL compiler dispatch functions.

   .. attribute:: __visit_name__
      :type: str

      The name used to dispatch to the appropriate visitor method

   .. method:: _compiler_dispatch(visitor, **kw)
      :classmethod:

      Looks for an attribute named "visit_<visit_name>" on the visitor and calls it with the given keyword parameters.

   .. versionchanged:: 2.0
      Renamed from ``Traversible`` back to ``Visitable`` (the name used prior to 1.4)

InternalTraversal
~~~~~~~~~~~~~~~~~

.. class:: InternalTraversal(enum.Enum)

   Defines visitor symbols used for internal traversal operations including cache key generation and object copying.

   The enumeration values represent different types of data structures found in SQL expression objects:

   .. attribute:: dp_has_cache_key
      :type: str

      Visit a :class:`.HasCacheKey` object

   .. attribute:: dp_has_cache_key_list
      :type: str

      Visit a list of :class:`.HasCacheKey` objects

   .. attribute:: dp_clauseelement
      :type: str

      Visit a :class:`_expression.ClauseElement` object

   .. attribute:: dp_fromclause_canonical_column_collection
      :type: str

      Visit a :class:`_expression.FromClause` object in the context of the ``columns`` attribute (canonical column collection)

   .. attribute:: dp_clauseelement_tuples
      :type: str

      Visit a list of tuples containing clause elements

   Objects implementing the :class:`.HasTraverseInternals` interface use these symbols in their ``_traverse_internals`` collection to define their internal structure for automatic implementation of:

   - :meth:`.HasTraverseInternals.get_children`
   - :meth:`.HasTraverseInternals._copy_internals`
   - :meth:`.HasCacheKey._gen_cache_key`

   .. versionadded:: 1.4

Utility Functions
-----------------

The module also provides several utility functions for traversal:

.. function:: iterate(obj, **kw)

   Iterate through all elements in the expression tree

.. function:: traverse_using(iterator, obj, visitors, **kw)

   Traverse using the given iterator with visitors

.. function:: traverse(obj, visitors, **kw)

   Traverse the expression tree with visitors

.. function:: cloned_traverse(obj, visitors, **kw)

   Traverse and clone the expression tree with visitors

.. function:: replacement_traverse(obj, visitors, **kw)

   Traverse and replace elements in the expression tree with visitors

.. data:: anon_map

   Anonymous mapping utility for traversal

ExternalTraversal
-----------------

.. class:: ExternalTraversal

   Base class for external traversal implementations (implementation details not shown in provided code)

Type Definitions
----------------

The module uses several type definitions and protocols for type checking:

- :class:`_CompilerDispatchType`: Protocol for compiler dispatch callables
- Various generic type variables for traversal operations

The module supports both pure Python and Cython implementations where available, with automatic fallback to Python implementation when C extensions are not present.