Feature Extraction for Model Inspection
=====================================

The ``torchvision.models.feature_extraction`` module provides utilities for extracting intermediate features from PyTorch models. This is particularly useful for model inspection, feature visualization, and transfer learning applications.

Overview
--------

Feature extraction allows users to access intermediate activations from a model without modifying its source code. The module provides two main functions:

1. ``get_graph_node_names`` - Returns the names of all graph nodes in the model
2. ``create_feature_extractor`` - Creates a new model that returns specified intermediate features

Key Components
--------------

LeafModuleAwareTracer
~~~~~~~~~~~~~~~~~~~~~
A custom FX tracer that allows specifying leaf modules that should not be traced through. These modules appear as single nodes in the computation graph.

NodePathTracer
~~~~~~~~~~~~~~
An extended tracer that records qualified names for each operation in the format of dot-separated paths representing the module hierarchy. Key features:

- Records node names in execution order
- Handles duplicate node names by adding ``_{index}`` suffixes
- Maintains mapping between nodes and their qualified names
- Preserves module hierarchy information in node naming

Functions
---------

get_graph_node_names(model, tracer_kwargs=None)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Returns the names of all nodes in the model's computation graph.

Parameters:
- ``model`` (nn.Module): The model to trace
- ``tracer_kwargs`` (dict, optional): Additional arguments for the tracer

Returns:
- Tuple of (train_nodes, eval_nodes): Node names for train and eval modes

create_feature_extractor(model, return_nodes, tracer_kwargs=None, train_return_nodes=None, eval_return_nodes=None)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Creates a feature extractor that returns intermediate features from specified nodes.

Parameters:
- ``model`` (nn.Module): The model to extract features from
- ``return_nodes`` (list or dict): Nodes to return features from
- ``tracer_kwargs`` (dict, optional): Additional tracer arguments
- ``train_return_nodes`` (list or dict): Separate return nodes for train mode
- ``eval_return_nodes`` (list or dict): Separate return nodes for eval mode

Returns:
- ``nn.Module``: A feature extractor model that returns specified features

Usage Example
-------------

.. code-block:: python

    import torch
    import torchvision
    from torchvision.models.feature_extraction import get_graph_node_names, create_feature_extractor
    
    # Get node names
    model = torchvision.models.resnet18()
    train_nodes, eval_nodes = get_graph_node_names(model)
    
    # Create feature extractor
    return_nodes = {'layer1.0.relu': 'feature1', 'layer4.1.conv2': 'feature2'}
    extractor = create_feature_extractor(model, return_nodes)
    
    # Extract features
    x = torch.rand(1, 3, 224, 224)
    features = extractor(x)

Important Notes
---------------

- The module handles differences between train and eval mode graphs automatically
- When graphs differ between modes, you may need to specify separate return nodes
- Leaf modules can be specified via tracer kwargs to prevent tracing through specific modules
- Node names follow the module hierarchy with dot-separated paths
- Duplicate node names are automatically disambiguated with numeric suffixes

The feature extraction utilities provide a powerful way to inspect and utilize intermediate model features without modifying the original model architecture.