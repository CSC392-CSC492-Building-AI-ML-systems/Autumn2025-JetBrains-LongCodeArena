.. _query_usage:

QuerySet Usage
==============

The QuerySet class provides a powerful and flexible way to build database queries in Tortoise ORM. It allows you to construct complex SQL queries using a Pythonic interface.

Basic Query Operations
----------------------

Filtering
~~~~~~~~~

Use the ``filter()`` method to apply conditions to your query:

.. code-block:: python

    # Simple equality filter
    await User.filter(name="John")
    
    # Multiple conditions
    await User.filter(name="John", age=25)
    
    # Using Q objects for complex queries
    await User.filter(Q(name="John") | Q(name="Jane"))

Ordering
~~~~~~~~

Apply sorting to your results using the ``order_by()`` method:

.. code-block:: python

    # Ascending order
    await User.all().order_by("name")
    
    # Descending order
    await User.all().order_by("-created_at")
    
    # Multiple fields
    await User.all().order_by("name", "-age")

Limiting and Offsetting
~~~~~~~~~~~~~~~~~~~~~~~

Control the number of results and pagination:

.. code-block:: python

    # Limit results
    await User.all().limit(10)
    
    # Offset results (pagination)
    await User.all().offset(5).limit(10)

Advanced Query Features
-----------------------

Annotations
~~~~~~~~~~~

Add computed fields to your results:

.. code-block:: python

    from tortoise.functions import Count
    
    # Count related objects
    await User.annotate(post_count=Count('posts'))

Prefetch Related
~~~~~~~~~~~~~~~~

Eager load related objects to avoid N+1 queries:

.. code-block:: python

    # Prefetch single relation
    await User.all().prefetch_related("posts")
    
    # Prefetch multiple relations
    await User.all().prefetch_related("posts", "comments")
    
    # Nested prefetching
    await User.all().prefetch_related("posts__comments")

Field Selection
~~~~~~~~~~~~~~~

Optimize queries by selecting specific fields:

.. code-block:: python

    # Select only specific fields
    await User.all().only("name", "email")
    
    # Get values as dictionaries
    await User.all().values("name", "email")
    
    # Get values as tuples
    await User.all().values_list("name", "email")

Aggregation
-----------

Perform aggregate operations:

.. code-block:: python

    from tortoise.functions import Count, Avg, Sum
    
    # Count all records
    count = await User.all().count()
    
    # Average value
    avg_age = await User.all().avg("age")
    
    # Sum of values
    total = await User.all().sum("score")

Single Object Operations
------------------------

Retrieve single objects with error handling:

.. code-block:: python

    # Get single object or None
    user = await User.filter(name="John").first()
    
    # Get single object or raise exception
    user = await User.get(name="John")
    
    # Get or create pattern
    user, created = await User.get_or_create(name="John", defaults={"age": 25})

Query Execution
---------------

All QuerySet methods return awaitable objects that need to be awaited:

.. code-block:: python

    # Execute query and get results
    users = await User.filter(active=True)
    
    # Iterate through results
    async for user in User.filter(active=True):
        print(user.name)

Chaining Methods
----------------

QuerySet methods can be chained to build complex queries:

.. code-block:: python

    query = (
        User.filter(active=True)
        .order_by("-created_at")
        .limit(10)
        .prefetch_related("posts")
        .annotate(post_count=Count('posts'))
    )
    
    results = await query

Note: The QuerySet is lazy and only executes the query when results are actually needed (when awaited).