How Mitogen Works
==================

Mitogen is a Python library for writing distributed programs. It enables seamless execution of Python code across multiple machines or processes, while maintaining the illusion of a single, shared execution environment. The core of Mitogen is implemented in a bootstrap module that is transmitted to every new slave context, ensuring minimal overhead and maximum compatibility.

Core Concepts
-------------

**Bootstrap Module**
The bootstrap module (this code) contains essential functionality required for inter-process communication and remote execution. It is designed to be compact since it is transmitted to every new slave context. It handles low-level details like message serialization, socket communication, and module loading.

**Message Types**
Mitogen uses a set of predefined message types to coordinate between contexts:

- ``GET_MODULE``: Request to fetch a module.
- ``CALL_FUNCTION``: Request to execute a function remotely.
- ``FORWARD_LOG``: Forward log messages to the master.
- ``ADD_ROUTE``: Add a message route.
- ``DEL_ROUTE``: Remove a message route.
- ``ALLOCATE_ID``: Allocate a unique context ID.
- ``SHUTDOWN``: Shut down a context.
- ``LOAD_MODULE``: Load a module into a context.
- ``FORWARD_MODULE``: Forward a module to another context.
- ``DETACHING``: Notify that a context is detaching.
- ``CALL_SERVICE``: Call a remote service.
- ``STUB_CALL_SERVICE``: Stub for service calls.

**IS_DEAD Sentinel**
The special value ``IS_DEAD`` (999) is used in the ``reply_to`` field of messages to signal disconnection or the inability to route a message. This typically results in a ``ChannelError`` and is used during teardown or when routes are unavailable.

Communication and Serialization
-------------------------------

Mitogen uses pickling for serialization of Python objects, with fallbacks for different Python versions (e.g., ``cPickle`` for Python 2, ``pickle`` for Python 3). It also employs compression (zlib) and efficient string encoding (latin-1, utf-8) to minimize network traffic.

The library manages socket communication using non-blocking I/O and select-based event loops. The default buffer size for I/O operations is 128 KiB, chosen as a balance between performance and resource usage.

Compatibility
-------------

Mitogen is designed to work across a wide range of Python versions (from 2.4 to 3.x). It includes compatibility shims for differences between Python versions, such as:

- Handling the deprecated ``imp`` module.
- Adapting to changes in exception hierarchy (``BaseException``).
- Managing string and bytes types across Python 2 and 3.
- Supporting older constructs like ``buffer`` in Python 2 and ``memoryview`` in Python 3.

Execution Model
---------------

When a remote context is created, the bootstrap module is sent to it. This module sets up the necessary infrastructure for receiving and executing messages. The master context can then send messages to load modules, call functions, or manage routes. Log messages and exceptions are propagated back to the master, providing a unified view of execution.

The use of efficient serialization and direct socket communication minimizes latency and overhead, making Mitogen suitable for high-performance distributed applications.