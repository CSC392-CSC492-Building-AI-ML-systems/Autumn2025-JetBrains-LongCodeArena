# FleurXMLModifier

## Overview

The `FleurXMLModifier` class provides a robust way to organize and group changes to FLEUR input files (inp.xml). It serves as a low-level version of the FleurinpModifier in aiida_fleur, allowing users to collect multiple modification tasks and apply them to an XML file in a single operation.

## Key Features

- **Task Collection**: Collect multiple modification operations before applying them
- **Undo Functionality**: Revert the last change or all changes
- **Multiple Setter Types**: Support for xpath, schema_dict, and nmmpmat setter functions
- **Validation**: Optional validation of method signatures

## Usage

### Basic Usage

```python
from masci_tools.io.fleurxmlmodifier import FleurXMLModifier

# Create modifier instance
fmod = FleurXMLModifier()

# Add modification tasks
fmod.set_inpchanges({'Kmax': 4.0})  # Set Kmax to 4.0
fmod.shift_value({'Gmax': 5.0})  # Add 5 to current Gmax value

# Set local orbital configuration on all iron atoms
fmod.set_species('all-Fe', {'lo': [{'n':3, 'l': 's', 'type': 'SCLO'},
                                   {'n':3, 'l': 'p', 'type': 'SCLO'}]})

# Apply changes to XML file
new_xmltree, additional_files = fmod.modify_xmlfile('/path/to/input/file/inp.xml')
```

### Undo Operations

```python
# Undo the last change
fmod.undo()

# Revert all changes
fmod.undo(revert_all=True)
```

### Instantiate from Task List

```python
task_list = [
    ('set_inpchanges', {'changes': {'Kmax': 4.0}}),
    ('shift_value', {'changes': {'Gmax': 5.0}})
]

fmod = FleurXMLModifier.fromList(task_list)
```

## Class Structure

### Attributes

- `xpath_functions`: Dictionary of xpath setter functions
- `schema_dict_functions`: Dictionary of schema_dict setter functions  
- `nmmpmat_functions`: Dictionary of nmmpmat setter functions
- `validate_signatures`: Boolean flag for signature validation

### Methods

#### `__init__(validate_signatures=True)`
Initialize the FleurXMLModifier instance.

**Parameters:**
- `validate_signatures`: If True, validate method signatures (default: True)

#### `fromList(task_list, *args, **kwargs)`
Class method to instantiate FleurXMLModifier from a list of tasks.

**Parameters:**
- `task_list`: List of tuples where first element is method name, second is kwargs dict
- `*args`, `**kwargs`: Additional arguments passed to `__init__`

**Returns:** FleurXMLModifier instance with tasks added

#### `add_task_list(task_list)`
Add a list of tasks to be executed.

**Parameters:**
- `task_list`: List of tuples (method_name, kwargs_dict)

#### `undo(revert_all=False)`
Revert the last change or all changes.

**Parameters:**
- `revert_all`: If True, revert all changes (default: False)

#### `modify_xmlfile(xmlfile, schema_dict=None, **kwargs)`
Apply all collected modifications to an XML file.

**Parameters:**
- `xmlfile`: Path to XML file or file-like object
- `schema_dict`: Schema dictionary for validation
- `**kwargs`: Additional arguments for XML processing

**Returns:** Tuple of (modified_xmltree, additional_files)

#### `get_avail_actions()`
Get dictionary of available modification methods.

**Returns:** Dictionary mapping method names to callable functions

## Internal Methods

### `_validate_arguments(name, args, kwargs)`
Validate arguments for a given method name.

### `_get_setter_function_and_prefix(name)`
Get the setter function and argument prefix for a method.

**Returns:** Tuple of (function, prefix_tuple)

## Note on Documentation

The docstrings for the setter methods are automatically generated from their implementations in the `masci_tools.util.xml` modules via a pre-commit hook. Manual changes to these docstrings will be overwritten.

## Dependencies

- `lxml.etree`: XML processing
- `masci_tools.util.xml`: XML setter functions
- `masci_tools.io.fleur_xml`: XML file loading
- `typing_extensions`: For Literal type support (Python <3.8)

## Source

The code is hosted on GitHub at: https://github.com/judftteam/masci-tools

For license information, see the LICENSE.txt file in the package.