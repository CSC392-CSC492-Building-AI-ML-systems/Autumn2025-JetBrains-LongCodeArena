.. _storage:

Storage Module
==============

The Storage module provides an interface for MongoDB operations using `pymongo` and `motor` libraries. It includes a service class for database interactions and an upsertor class for handling document modifications.

Configuration
-------------

The module uses the following configuration defaults:

.. code-block:: ini

    [asab:storage]
    mongodb_uri = mongodb://localhost:27017
    mongodb_database = asabdb

Classes
-------

StorageService
~~~~~~~~~~~~~~

.. autoclass:: StorageService
   :members:
   :special-members: __init__

   **Methods:**

   .. automethod:: __init__
   .. automethod:: upsertor
   .. automethod:: get
   .. automethod:: get_by
   .. automethod:: collection
   .. automethod:: delete

MongoDBUpsertor
~~~~~~~~~~~~~~~

.. autoclass:: MongoDBUpsertor
   :members:
   :inherited-members:

   **Class Methods:**

   .. automethod:: generate_id

   **Methods:**

   .. automethod:: execute

Exceptions
----------

DuplicateError
~~~~~~~~~~~~~~

Raised when a duplicate key error occurs during database operations.

.. autoexception:: DuplicateError

Example Usage
-------------

Basic storage operations:

.. code-block:: python

    # Initialize storage service
    storage = StorageService(app, "my_storage_service")
    
    # Get a document
    document = await storage.get("my_collection", "document_id")
    
    # Create an upsertor
    upsertor = storage.upsertor("my_collection", "document_id")
    upsertor.set("field", "value")
    await upsertor.execute()
    
    # Get collection for custom operations
    coll = await storage.collection("my_collection")
    cursor = coll.find({})
    while await cursor.fetch_next:
        obj = cursor.next_object()

Dependencies
------------

- motor
- pymongo
- bson
- asab

Note: The module requires MongoDB connection and proper configuration of the database URI and name.