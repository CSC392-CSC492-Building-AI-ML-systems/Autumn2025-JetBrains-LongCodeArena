# General Plotting Routines (Bokeh)

Overview
The plotting module provides general helpers and high-level plotting routines for interactive Bokeh visualizations. It centrally uses a BokehPlotter instance to ensure consistent defaults, figure setup, and styling across plots. It also offers utilities to load, save, and inspect plotting defaults.

Defaults management
- set_bokeh_plot_defaults(**kwargs)
  - Set default parameters for the Bokeh backend. All supported defaults are exposed by BokehPlotter.
- reset_bokeh_plot_defaults()
  - Reset defaults to the hardcoded defaults defined in the codebase.
- show_bokeh_plot_defaults()
  - Print the currently active default settings (as a dictionary) to help inspect configuration.
- get_bokeh_help(key)
  - Print the description of a specific Bokeh default option (by key).
- load_bokeh_defaults(filename='plot_bokeh_defaults.json')
  - Load defaults for the Bokeh backend from a JSON file.
- save_bokeh_defaults(filename='plot_bokeh_defaults.json', save_complete=False)
  - Save the current Bokeh defaults to a JSON file.
  - If save_complete is True, also saves the unmodified hardcoded defaults.

General plotting routines
- The plotting utilities are built around a single plotter instance:
  - plot_params = BokehPlotter()
- A decorator ensures the plotter is in a consistent state before plotting.

Primary plotting functions
- bokeh_scatter(x, y=None, *, xlabel='x', ylabel='y', title='', figure=None, data=None, saveas='scatter', copy_data=False, **kwargs)
  - Create an interactive scatter plot with Bokeh.
  - x and y can be array-like data or keys in a data source. The data argument can be a pandas DataFrame or similar data source.
  - If the first argument resembles a data source (dict, DataFrame, or ColumnDataSource) or is None, a deprecation warning is issued, and data/x/y are reinterpreted from kwargs.
  - Data handling is performed via process_data_arguments to produce a plot data entry and a ColumnDataSource.
  - Internals:
    - The plotter is configured with defaults for this function (default_type='function', name=entry.y).
    - A figure is prepared with the given title and axis labels (or an existing figure if provided).
    - Plot-specific keyword arguments are gathered from the plotter (plot_kwargs for a 'scatter' plot).
    - The scatter is drawn with p.scatter(x=entry.x, y=entry.y, source=source, ...).
    - Tooltips are added, and optional styling is applied (e.g., line level, straight lines, and axis limits).
    - The final plot is saved with the given saveas name (e.g., 'scatter') if requested.
  - Returns the Bokeh figure.

- bokeh_multi_scatter(x, y=None, *, data=None, figure=None, xlabel='x', ylabel='y', title='', saveas='scatter', copy_data=False, set_default_legend=True, **kwargs)
  - Create an interactive scatter plot that can display multiple data sets.
  - Similar to bokeh_scatter, but supports multiple series. Data can be provided in a combined data source, and legends can be generated automatically from data names when set_default_legend is True.
  - This routine also relies on process_data_arguments to create appropriate sources and entry mappings for the multiple series.
  - Warnings are issued if the first argument is a data source, to discourage passing a source as the first positional argument (consistent with the single-scatter routine).
  - Returns the Bokeh figure.

Data handling and conventions
- Data sources can be provided as:
  - A pandas DataFrame
  - A dictionary
  - A Bokeh ColumnDataSource
- The code uses process_data_arguments to unify x/y data extraction, copying behavior, and source creation.
- For bokeh_scatter, a single data entry is plotted, with x and y taken from entry.x and entry.y and the corresponding source.
- For bokeh_multi_scatter, multiple data entries and their sources are managed to render several series in one plot.
- The plotting flow includes:
  - Preparing the figure
  - Gathering plot keyword arguments
  - Executing the actual Bokeh plotting call
  - Adding tooltips
  - Optional level adjustments
  - Drawing straight reference lines and applying axis limits
  - Saving the final plot

Usage notes
- Defaults are stored in (and loaded from) a JSON file by default: plot_bokeh_defaults.json.
- The plotting utilities rely on the BokehPlotter class to provide a consistent API for figure creation, parameter handling, and rendering.
- The ensure_plotter_consistency decorator helps prevent misconfiguration of the global plotter between calls.

Example (conceptual)
- Set a custom default:
  - set_bokeh_plot_defaults(theme='dark', tools='hover,pan,box_select')
- Create a single scatter plot:
  - bokeh_scatter(x=data['k'], y=data['energy'], data=data, xlabel='k-path', ylabel='Energy', title='Band Structure')
- Create a multi-series scatter plot:
  - bokeh_multi_scatter(x=data['k'], y=None, data=data, title='Multiple Datasets', set_default_legend=True)

Notes
- The module also imports helpers and utilities such as get_special_kpoint_ticks, though their usage is outside the scope of the primary general plotting routines described here.
- Documentation strings within the code reference the BokehPlotter API for deeper details on available defaults and their meanings.