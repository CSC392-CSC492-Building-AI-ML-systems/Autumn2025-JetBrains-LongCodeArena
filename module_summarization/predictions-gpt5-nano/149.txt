# FleurXMLModifier

A class for grouping and organizing changes to a Fleur input file (inp.xml) in a robust, low-level manner. It provides a structured way to collect modifications via the XML setter methods and apply them in a single step. This is effectively a low-level alternative to FleurinpModifier used in aiida_fleur.

Note: The docstrings for the setter methods are generated from the actual implementations in the masci_tools.util.xml modules via a pre-commit hook. Changes in those docstrings here will be overwritten.

Overview
- The class aggregates modifications as tasks and applies them later to an input file.
- It delegates to setter functions defined in external modules (XPATH_SETTERS, SCHEMA_DICT_SETTERS, NMMPMAT_SETTERS).
- It supports an extension mechanism (_extra_functions) to inject additional setters under different namespaces (xpath, schema_dict, nmmpmat).

Key Concepts
- ModifierTask: A simple record describing a single modification. It stores:
  - name: The name of the setter method to invoke.
  - args: Positional arguments for the setter.
  - kwargs: Keyword arguments for the setter.
- Available setters are exposed through three dictionaries:
  - _xpath_functions
  - _schema_dict_functions
  - _nmmpmat_functions
- The class combines core setters with any extra functions defined in _extra_functions at runtime (via __new__).

API and Usage

Class attributes
- _xpath_functions: dict[str, Callable] = XPATH_SETTERS
- _schema_dict_functions: dict[str, Callable] = SCHEMA_DICT_SETTERS
- _nmmpmat_functions: dict[str, Callable] = NMMPMAT_SETTERS
- _extra_functions: dict[Literal['xpath', 'schema_dict', 'nmmpmat'], dict[str, Callable]] = {}

Initialization and construction
- __new__(cls, validate_signatures=True)
  - Lazily initializes per-class dictionaries combining core setters with any extra functions.
  - Populates:
    - xpath_functions
    - schema_dict_functions
    - nmmpmat_functions

- __init__(self, validate_signatures: bool = True) -> None
  - Initializes the internal task list and stores the validate_signatures flag.

Factory and task management
- @classmethod fromList(cls, task_list: list[tuple[str, dict[str, Any]]], *args: Any, **kwargs: Any) -> FleurXMLModifier
  - Creates an instance, adds the provided tasks, and returns the instance.
  - Example task_list entry: ("set_inpchanges", {"Kmax": 4.0})

- add_task_list(self, task_list: list[tuple[str, dict[str, Any]]]) -> None
  - Adds a list of tasks to be executed later.
  - For each (name, kwargs) in task_list:
    - Looks up the corresponding setter in the available actions (facade_methods = self.get_avail_actions()) and calls it with the provided kwargs.
    - If the setter name is unknown, raises ValueError("Unknown modification method 'name'").

Internal helpers
- _validate_signature(self, name: str, *args: Any, **kwargs: Any) -> None
  - DEPRECATED: emits a DeprecationWarning and delegates to _validate_arguments(name, args, kwargs).

- _get_setter_function_and_prefix(self, name: str) -> tuple[Callable[[Any], Any], tuple[str, ...]]
  - Determines which setter function should be used for a given modification name.
  - Returns:
    - func: The setter callable.
    - prefix: A tuple describing how arguments are organized for the call (e.g., ('xmltree',) or ('xmltree', 'schema_dict'), etc.)
  - Resolution order:
    - If name in xpath_functions: func = xpath_functions[name], prefix = ('xmltree',)
    - Else if name in schema_dict_functions: func = schema_dict_functions[name], prefix = ('xmltree', 'schema_dict')
    - Else if name in nmmpmat_functions: func = nmmpmat_functions[name], prefix = ('xmltree', 'nmmplines', 'schema_dict')
  - If no function is found, raises ValueError indicating the setter could not be validated.

Notes
- The class is designed to collect and organize changes rather than apply them immediately.
- The actual application of changes to an input file would be performed by other methods (e.g., modify_xmlfile) which are not included in the provided code snippet. The documented interface focuses on task collection and preparation.

Example

Usage snippet (from the class docstring):

- Create a modifier
  - fmode = FleurXMLModifier()

- Add changes (names correspond to setters in the xml_setters modules)
  - fmode.set_inpchanges({'Kmax': 4.0})  # Set Kmax to 4.0
  - fmode.shift_value({'Gmax': 5.0})   # Add 5 to the current value of Gmax

- Configure species (local orbital configuration on atoms)
  - fmode.set_species('all-Fe', {'lo': [{'n':3, 'l': 's', 'type': 'SCLO'},
                                      {'n':3, 'l': 'p', 'type': 'SCLO'}]})

- Undo/Reset (examples, not implemented here)
  - # fmode.undo()
  - # fmode.undo(revert_all=True)

- Apply changes to an input file
  - new_xmltree, additional_files = fmode.modify_xmlfile('/path/to/input/file/inp.xml')

Authors note
- This class builds upon the XML setter interfaces provided by masci_tools.util.xml and related modules, enabling robust, batched modifications to Fleur input data.

