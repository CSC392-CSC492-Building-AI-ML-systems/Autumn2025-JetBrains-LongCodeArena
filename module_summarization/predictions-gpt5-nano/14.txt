Querying
========

Overview
--------

The ftrack_api.query module provides the building blocks for querying data from an
ftrack server. Queries allow you to fetch entities and their attributes (and
related entities) in a single operation, with support for filtering, sorting,
and pagination. The results are returned as Python objects that map to ftrack
entities or as dictionaries, depending on the query configuration.

Getting started
---------------

- Create a query against a target entity type (e.g., Task, Project) or a
  specific path in the entity graph.
- Apply filters to narrow down results.
- Specify which fields to retrieve.
- Optionally sort results and limit the number of returned items.
- Execute the query to obtain results.

Basic usage
------------

.. code-block:: python

    # Example: fetch Tasks with a specific status
    query = Query('Task')
    query.where('status.name' == 'Open')
    query.select('id', 'name', 'status', 'assignee')
    query.order_by('name')
    query.limit(50)
    results = query.execute()

Query construction
------------------

- Target
  - Define the type of entities to query (e.g., Task, Shot, Asset) or a
    path that navigates related entities.
- Filters
  - Use a where-clause to express constraints on fields.
  - Supported operators typically include equality, inequality, membership, and
    comparison operators (==, !=, in, not in, >, <, >=, <=).
- Selection
  - Choose which attributes to return. Returning only needed fields reduces
    payload size and improves performance.
- Sorting
  - Order the results by one or more fields, optionally in ascending or
    descending order.
- Pagination
  - Use limit and offset to page through large result sets.

Filter expressions
------------------

Common examples (illustrative; refer to the API for exact syntax):

.. code-block:: python

    # Simple equality
    query.where('type.name' == 'Task')

    # Membership
    query.where('priority' in ['High', 'Medium'])

    # Date comparisons
    query.where('created_at' >= '2024-01-01')

    # Nested/related fields
    query.where('assignee.username' == 'jdoe')

Selection and expansion
-----------------------

- select(*fields)
  - Specify which fields to include in each result.
- expand(*relations)
  - Request expansion of related entities (e.g., include the Task's Project).

Results
-------

- The execute() method returns a collection of result objects, often mapped to
  ftrack entities or dictionaries containing the requested fields.
- You can iterate over results, access attributes directly, or convert to
  dictionaries if needed.

Advanced features
-----------------

- Chaining queries: Combine multiple filters to form complex constraints.
- Caching: Queries may benefit from server-side or client-side caching where available.
- Error handling: Properly handle cases where entities are missing, permissions are
  insufficient, or the query is invalid.

API reference (high level)
--------------------------

- Query
  - Constructor(target)
  - where(expression)
  - select(*fields)
  - expand(*relations)
  - order_by(field, direction='asc')
  - limit(n)
  - offset(n)
  - execute()
  - all(), first(), count()

Notes
-----

- The Query API is designed to work efficiently with large datasets by pushing
  filtering and projection to the server wherever possible.
- Use selective field retrieval to minimize data transfer and improve performance.
- When expanding related entities, be mindful of the potential for increased data
  size and latency.

Examples
--------

1) Fetch open Tasks assigned to a specific user, returning id, name, and status.

.. code-block:: python

    q = Query('Task')
    q.where('assignee.username' == 'alice')
    q.where('status.name' == 'Open')
    q.select('id', 'name', 'status')
    results = q.execute()

2) Retrieve Projects with their related Tasks, sorted by project name, limited to 20.

.. code-block:: python

    q = Query('Project')
    q.expand('tasks')
    q.select('id', 'name')
    q.order_by('name')
    q.limit(20)
    projects = q.execute()