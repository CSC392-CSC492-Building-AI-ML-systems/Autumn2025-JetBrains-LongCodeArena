ImPACT
======

Image Pixel-wise fit for Atmospheric Cherenkov Telescopes (ImPACT) is a template-based image reconstruction approach for gamma-ray showers. It performs a maximum-likelihood fit between observed camera images and a library of precomputed image templates to estimate the shower axis, energy and height of maximum. The implementation follows the method described in Parsons & Hinton (2014) and is integrated into the ctapipe framework.

Overview
--------

- Purpose: Reconstruct gamma-ray induced atmospheric Cherenkov showers by pixel-wise comparison to a library of template images.
- Basis: Maximum likelihood fitting using templates that depend on telescope type, geometry and shower parameters.
- Efficiency: Fixed internal units (radians for angles, metres for distances, TeV for energies) are used to speed up computations.
- References: Parsons & Hinton, Astroparticle Physics 56 (2014), pages 26–34.

Public API
----------

Functions
- guess_shower_depth(energy)
  - Description: Simple estimate of the depth of shower maximum as a function of energy.
  - Parameters:
    - energy (float): Shower energy in TeV
  - Returns: float, expected depth of shower maximum

- energy_prior(energy, index=-1)
  - Description: Prior on the energy used in the likelihood.
  - Parameters:
    - energy (float)
    - index (float, default -1)
  - Returns: float

- xmax_prior(energy, xmax, width=100)
  - Description: Prior on the shower maximum depth given the energy.
  - Parameters:
    - energy (float)
    - xmax (float): Reconstructed depth of maximum
    - width (float, default 100): Width scale for the prior
  - Returns: float

Class
ImPACTReconstructor
-------------------

Your primary reconstruction class. It encapsulates template loading, preparation and the pixel-wise likelihood fitting workflow.

Constructor
- __init__(self, root_dir=".", minimiser="minuit", prior="", template_scale=1.0, xmax_offset=0, use_time_gradient=False)
  - root_dir: Path to the directory containing template files.
  - minimiser: Choice of minimiser to use (e.g., "minuit").
  - prior: Optional string describing priors to be applied.
  - template_scale: Scaling factor applied to templates.
  - xmax_offset: Offset applied to the reconstructed depth of maximum.
  - use_time_gradient: Enable time-gradient templates for additional information in the fit.

Internal data and attributes
- file_names: Dict mapping telescope type to template file names
  - CHEC: ["GCT_05deg_ada.template.gz", "GCT_05deg_time.template.gz"]
  - LSTCam: ["LST_05deg.template.gz", "LST_05deg_time.template.gz"]
  - NectarCam: ["MST_05deg.template.gz", "MST_05deg_time.template.gz"]
  - FlashCam: ["MST_xm_full.fits"]
- ped_table: Pedestal width per telescope type (used in likelihood)
  - LSTCam: 2.8
  - NectarCam: 2.3
  - FlashCam: 2.3
  - CHEC: 0.5
  - DUMMY: 0
- spe: 0.5
  - Description: Width of single photoelectron distribution (assumed)
- atmosphere profile loading:
  - thickness_profile, altitude_profile obtained via get_atmosphere_profile_functions("paranal", with_units=False)
- pixel and event data:
  - pixel_x, pixel_y: pixel coordinates
  - image, time: per-pixel signal and time
  - tel_types, tel_id: telescope kinds and identifiers
  - tel_pos_x, tel_pos_y: telescope positions
  - peak_x, peak_y, peak_amp: per-telescope image peak information
  - hillas_parameters: per-telescope Hillas parameters
  - ped: pedestal estimates
- reconstruction state:
  - prediction: dict of per-telescope image template predictions
  - time_prediction: dict of per-telescope time-gradient predictions (if enabled)
  - array_direction, array_return, nominal_frame: array-related state
- template control:
  - template_scale, xmax_offset, use_time_gradient

Template handling
- initialise_templates(self, tel_type)
  - Description: Ensure templates for each telescope type present in the event are initialised. Loads a TemplateNetworkInterpolator for each telescope type and optionally a TimeGradientInterpolator if time gradients are enabled.
  - Returns: True when initialisation is performed (or skipped if already present)

Template interpolation components
- TemplateNetworkInterpolator
- TimeGradientInterpolator
  - Used to generate predicted images (and optional time information) for a given telescope type and a given set of shower parameters.

Image analysis workflow (high level)
- Prepare event data: gather per-telescope pixel positions, amplitudes, times, and telescope metadata.
- Load templates: ensure the per-telescope templates are available via initialise_templates.
- Predict images: use the interpolators to generate predicted pixel amplitudes (and optional times) for a given shower hypothesis.
- Likelihood fit: compare observed images to predictions via a likelihood objective (pedestal model and single-p.e. distribution width are part of the likelihood construction).
- Output: predicted geometry and energy, along with per-telescope contributions to the likelihood.

Notes
- Pedestal model: ped_table provides a per-telescope pedestal width used in the likelihood calculation.
- Time information: use_time_gradient toggles the use of time-gradient templates to improve reconstruction in suitable observations.
- Units: The class fixes internal units to speed up computations (angles in radians, distances in metres, energies in TeV).
- Templates: File names are telescope-type specific and loaded from root_dir; templates and time-gradient templates are kept separate in the two files listed per telescope type.

Data and Output Containers
- ReconstructedGeometryContainer
- ReconstructedEnergyContainer
These containers store the results of the reconstruction (geometry/direction, energy, and potentially height of maximum) in ctapipe-consumable structures.

Example usage (high level)
- Create an ImPACTReconstructor with desired configuration.
- For each event, prepare per-telescope data (pixels, amplitudes, times, telescope metadata).
- Call initialise_templates with the event’s telescope types.
- Run the pixel-wise likelihood fit to obtain the reconstructed shower parameters.
- Retrieve the results from the appropriate outputs (geometry, energy).

References
- Parsons, R. D., & Hinton, J. A. (2014). Image-template-based gamma/hadron discrimination and energy reconstruction for IACTs.

This documentation describes the ImPACT reconstruction mechanism and its public interface as implemented in the provided code, including how templates are loaded, how priors are expressed, and how the core object coordinates data, templates, and the fit to yield the final reconstructed shower parameters.