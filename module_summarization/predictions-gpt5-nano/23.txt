W_fork
======

Fork a WestPA simulation at a specified iteration to create a new, independent
weighted-ensemble run.

Description
-----------

Prepare a new weighted ensemble simulation from an existing one at a particular
iteration. A new HDF5 file is generated. In the case of executable propagation, it
is the user’s responsibility to prepare the new simulation directory appropriately,
in particular making the old simulation’s restart data from the chosen iteration
available as the new simulation’s initial-state data. A mapping of old simulation
segments to new initial states is created, both in the new HDF5 file and as a
flat text file, to aid in this. Target states and basis states for the new
simulation are taken from those in the original simulation.

Usage
-----

.. code-block:: console

   w_fork [options]

Options
-------

- -i, --input
  - dest: input_h5file
  - Help: Create simulation from the given INPUT_H5FILE (default: read from configuration file).

- -I, --iteration
  - dest: n_iter
  - type: int
  - Help: Take initial distribution for new simulation from iteration N_ITER
    (default: last complete iteration).

- -o, --output
  - dest: output_h5file
  - Default: forked.h5
  - Help: Save new simulation HDF5 file as OUTPUT (default: %(default)s).

- --istate-map
  - Default: istate_map.txt
  - Help: Write text file describing mapping of existing segments to new initial
    states in ISTATE_MAP (default: %(default)s).

- --no-headers
  - Action: store_true
  - Help: Do not write header to ISTATE_MAP

What it does
-----------

- Open the old HDF5 file and determine the iteration to fork from.
- Create and open a new HDF5 file for the forked simulation.
- Copy target states and basis states from the old simulation.
- Transform each old segment into a new initial state and create a corresponding new
  segment in the forked simulation.
- Record a mapping from old segment IDs to new initial-state IDs in a flat text file.
- Update the new simulation to iteration 1 and close both files.

Outputs
-------

- A new HDF5 file containing the forked simulation data (default: forked.h5).
- A text file mapping old segments to new initial states (default: istate_map.txt).
  - If --no-headers is not specified, the mapping file includes headers describing
    the columns:
    - old_n_iter: old simulation iteration
    - old_seg_id: old simulation segment ID
    - new_istate_id: new simulation initial state ID

Notes
-----

- If -i/--input is not provided, the tool reads the input file path from the WestPA
  configuration.
- The default fork uses the last complete iteration as the source for the new run.
- The mapping file facilitates subsequent data association between the original and
  forked simulations, such as during executable propagation.

Example
-------

.. code-block:: console

   w_fork -i old.h5 -I 5 -o forked.h5 --istate-map mapping.txt

