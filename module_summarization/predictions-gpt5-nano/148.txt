# General HDF5 file reader

Overview
- This documentation describes the collection of predefined transformations used by the HDF5Reader in Masci-tools to process HDF5 datasets.
- Transformations are designed to work with:
  - h5py.Dataset instances
  - NumPy arrays
  - dictionaries mapping keys to datasets (useful for arbitrary or unknown child datasets)
- All transformations are registered on the HDF5Reader class and can be invoked during reading to extract or transform data consistently.

Transformation mechanism
- Each transformation is registered via the hdf5_transformation decorator.
- The decorator adds the transformation function to HDF5Reader._transforms with its function name as the key.
- If a transformation requires the value of a previously processed attribute, the decorator marks it by adding the function name to HDF5Reader._attribute_transforms.
- All transformation calls are guarded; if a transformation raises any exception, it is wrapped in an HDF5TransformationError with a descriptive message.

Supported input types
- h5py.Dataset
- numpy.ndarray
- dict: a mapping of keys to datasets (or arrays), enabling transformation of multiple datasets in parallel
- For some functions (e.g., get_name), non-dataset inputs (like lists) may raise a ValueError to prevent invalid usage

Available transformations

- get_first_element(dataset)
  - Purpose: Get the first element of the dataset.
  - Behavior: Delegates to index_dataset(dataset, 0).
  - Input: h5py.Dataset, numpy.ndarray, or dict of such items.
  - Output: First element (or corresponding first elements per key if a dict).

- index_dataset(dataset, index)
  - Purpose: Get the n-th element of the dataset.
  - Behavior: If dataset is a dict, returns a dict with each key’s value at the given index; otherwise returns dataset[index].
  - Input: dataset (or dict of datasets), index (int or compatible index).
  - Output: The element at the specified index (or dict of elements per key).

- slice_dataset(dataset, slice_arg)
  - Purpose: Slice the dataset with the given slice argument.
  - Behavior: If dataset is a dict, applies the slice to every value; otherwise applies the slice to the dataset.
  - Input: dataset, slice_arg (slice object or compatible indexing).
  - Output: Sliced dataset (or dict of sliced datasets).

- get_shape(dataset)
  - Purpose: Get the shape of the dataset.
  - Behavior: If a dict is provided, returns a dict mapping each key to its respective shape; otherwise returns the dataset’s shape.
  - Input: dataset (or dict of datasets/arrays).
  - Output: Shape (tuple) or dict of shapes.

- get_name(dataset, full_path=False)
  - Purpose: Get the name of the dataset.
  - Behavior:
    - If given a list or numpy array, raises ValueError (requires a dataset).
    - If given a dict, returns a dict mapping each key to its name; with full_path, uses the full name path, otherwise uses only the final path component.
    - If given a single dataset, returns the name; with full_path, returns the full path, otherwise the final component.
  - Input: dataset (or dict of datasets), full_path (bool).
  - Output: Name string or dict of names.

- tile_array(dataset, n_repeats)
  - Purpose: Repeat the dataset using numpy.tile.
  - Behavior: If a dict is provided, applies tiling to each value; otherwise tiles the dataset.
  - Input: dataset, n_repeats (int).
  - Output: Tiled array or dict of tiled arrays.

- repeat_array(dataset, n_repeats)
  - Purpose: Repeat each element in the array using numpy.repeat.
  - Behavior: If a dict is provided, applies repeating to each value; otherwise repeats the dataset.
  - Input: dataset, n_repeats (int).
  - Output: Repeated array or dict of repeated arrays.

- get_all_child_datasets(group, ignore=None, contains=None)
  - Purpose: Retrieve all datasets contained in a given group.
  - Behavior:
    - Scans group.items() and collects datasets.
    - ignore can be a string or an iterable of strings; keys containing any ignore phrase are skipped.
    - contains can be a string or an iterable of strings; only keys containing all specified phrases are kept.
  - Input: group (h5py.File/group-like), ignore (str or iterable, optional), contains (str or iterable, optional).
  - Output: A dict mapping dataset names to the corresponding h5py.Dataset objects.

Usage notes
- Transformations are designed to be composable and robust across the common data representations encountered when reading HDF5 files.
- The HDF5Reader holds a registry of transforms and applies the appropriate one based on the input type and the requested operation.
- Any transformation failure is surfaced as HDF5TransformationError with a descriptive message to aid debugging.

Error handling
- All registered transformation functions are wrapped to catch exceptions and raise HDF5TransformationError, preserving the original exception context for easier troubleshooting.