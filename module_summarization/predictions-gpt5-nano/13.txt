Understanding sessions
======================

Overview
--------

A Session provides an isolated context for interacting with an ftrack server. It manages authentication, caching, optional automatic population of entity data, and (optionally) a background event hub connection for publishing and subscribing to events. The session is configured at creation time and uses a combination of explicit parameters and environment variables to determine how to connect and operate.

SessionAuthentication
---------------------

Purpose
    Attach ftrack session authentication information to HTTP requests.

Details
    - Implemented as a requests.auth.AuthBase subclass.
    - When called with a request, it adds the following HTTP headers:

        - ftrack-api-key: the API key
        - ftrack-user: the API user

Usage
    This class is used internally by the Session to ensure all requests to the server are authenticated.

The Session class
-----------------

Overview
    An isolated session for interaction with an ftrack server. It encapsulates server
    connection details, authentication, caching, event hub integration, and
    optional automatic population of entity data.

Initialization and required information
    The constructor accepts these parameters:

    - server_url: URL of the ftrack server (including port). If not provided, the
      environment variable FTRACK_SERVER is used. If still missing, a TypeError is raised.

    - api_key: API key for authentication. If not provided, the environment variables
      FTRACK_API_KEY or FTRACK_APIKEY are used. If still missing, a TypeError is raised.

    - api_user: API user (username). If not provided, FTRACK_API_USER is used; if not
      available, the current system user is attempted via getpass.getuser(). If still
      unavailable, a TypeError is raised.

    - auto_populate (default: True): Accessing entity attributes will automatically fetch
      missing data from the server. This can be toggled on the session at any time.

    - plugin_paths: List of paths to search for plugins. If not provided, a default
      path from environment configuration is used.

    - cache: A cache instance conforming to the ftrack_api.cache.Cache interface, or a
      callable that returns such a cache when called with the session. If no suitable cache
      is configured, the session can still be instantiated and used safely.

    - cache_key_maker: An object implementing the ftrack_api.cache.KeyMaker interface to
      generate keys for cached objects. If not provided, a StringKeyMaker is used.

    - auto_connect_event_hub: If True, an embedded event hub will be automatically connected
      to the event server to enable publishing and subscribing to non-local events. If False,
      only local events can be published/subscribed until an explicit hub connection is made.

    - schema_cache_path: Path to a directory for schema caching. If unset, FTRACK_API_SCHEMA_CACHE_PATH
      will be consulted. If neither is set, a temporary directory will be used. Set to False to disable
      schema caching entirely.

    - plugin_arguments: Optional mapping of keyword arguments to pass to plugin registration
      methods during discovery. If a discovered plugin has a signature that is incompatible with
      the passed arguments, the discovery mechanism will attempt to reduce the arguments to those
      that the plugin accepts, logging a warning if this occurs.

Behavior and internal state
    - The session stores a logger for diagnostic output.
    - A _closed flag tracks whether the session has been closed.
    - The session exposes recorded_operations and a flag record_operations to control
      operation recording.
    - A top-level MemoryCache is used in a layered cache system; a cache provided by the user
      will be integrated into that layered cache.

Notes
    - The session relies on a combination of explicit parameters and environment
      variables, with sensible fallbacks to ensure a usable default in many
      deployment scenarios.
    - If required information (server_url, api_key, api_user) cannot be determined,
      a TypeError is raised during initialization.

Usage examples
--------------

Basic session creation

.. code-block:: python

   from ftrack_api import Session
   s = Session(
       server_url="http://localhost",
       api_key="your_api_key",
       api_user="your_username"
   )

Optional: enable automatic event hub connection

.. code-block:: python

   s = Session(
       server_url="http://localhost",
       api_key="your_api_key",
       api_user="your_username",
       auto_connect_event_hub=True
   )

Environment variables referenced
------------------------------

- FTRACK_SERVER: default server URL if server_url is not provided.
- FTRACK_API_KEY or FTRACK_APIKEY: API key if api_key is not provided.
- FTRACK_API_USER: API user if api_user is not provided.
- FTRACK_API_SCHEMA_CACHE_PATH: optional path for schema cache if schema_cache_path is not set.
- Any other environment-based defaults for plugin paths, etc., are consulted as applicable.

Key concepts
------------

- Authentication: All requests to the ftrack server are authenticated via the SessionAuthentication mechanism, which injects the API key and user into request headers.
- Auto population: When enabled, entity attributes not yet loaded will be fetched from the server on access.
- Caching: The session supports a layered caching strategy with a memory-based top layer to improve performance and reduce redundant server requests.
- Event hub integration: Optionally, the session can initialize and connect an embedded event hub in a background thread to support non-local event publishing and subscribing.
- Schema caching: Optional caching of server schema information to speed up repeated accesses and reduce server load.
- Plugins: The session can discover and register plugins, with support for passing optional arguments to plugins during discovery.

If you need more detail or a tailored section added to the docs, tell me the focus and I can adjust.