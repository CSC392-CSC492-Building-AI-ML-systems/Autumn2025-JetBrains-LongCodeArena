Executing notebooks
===================

This section documents how code cells in a notebook are executed programmatically using the ExecutePreprocessor, and how language magics are detected for syntax highlighting with HighlightMagicsPreprocessor.

Overview
--------

- ExecutePreprocessor executes all code cells in a notebook and updates their outputs in place. It inherits from Preprocessor and NotebookClient to preserve traitlets behavior.

- HighlightMagicsPreprocessor detects language magics (e.g., %%R, %%bash) and tags cells with magics_language metadata for correct syntax highlighting.

API
---

ExecutePreprocessor
-------------------

- Purpose: Executes all the cells in a notebook.

- Inheritance: Preprocessor, NotebookClient

- Initialization
  - __init__(self, **kw)
  - Accepts nb (NotebookNode). If not provided, a new NotebookNode is created.
  - Calls Preprocessor.__init__(nb=nb, **kw) and NotebookClient.__init__(self, nb, **kw)

- Preprocess method
  - Signature: preprocess(self, nb: NotebookNode, resources: t.Any = None, km: t.Optional[KernelManager] = None) -> t.Tuple[NotebookNode, dict]
  - Behavior:
    - Re-initializes NotebookClient with nb and km
    - Resets execution trackers
    - Assigns resources
    - Within setup_kernel(), ensures a kernel is available and obtains kernel_info to set language_info
    - Iterates over cells and executes each via preprocess_cell
    - Sets widgets metadata
    - Returns (nb, resources)
  - Notes:
    - The input notebook (nb) is modified in place
    - Intended for use within an nbconvert pipeline or direct execution

- preprocess_cell method
  - Signature: preprocess_cell(self, cell, resources, index)
  - Behavior:
    - Calls execute_cell(cell, index, store_history=True)
    - Returns (cell, resources)

- Example usage
  - Basic usage to execute a notebook in memory:
    .. code-block:: python

       import nbformat
       from nbconvert.preprocessors.execute import ExecutePreprocessor

       nb = nbformat.read("notebook.ipynb", as_version=4)
       ep = ExecutePreprocessor(timeout=None, kernel_name="python3")
       resources = {}

       ep.preprocess(nb, resources)

       # The notebook's cells now have updated outputs.

- Returns
  - A tuple: (nb, resources)

Deprecated executenb wrapper
---------------------------

- executenb(*args, **kwargs) is a deprecated wrapper that delegates to nbclient.execute and emits a FutureWarning advising to import nbclient.execute directly.

- Example usage
  - Basic:
    .. code-block:: python

       from nbconvert.preprocessors.execute import executenb
       # Deprecated: use nbclient.execute directly

HighlightMagicsPreprocessor
---------------------------

- Purpose: Detects and tags code cells that use a different language through magic extensions such as %%R or %%octave. The cell metadata is updated with magics_language for appropriate highlighting.

- default_languages
  - A mapping of magic language extensions to pygments lexers, e.g.:
    - "%%R": "r"
    - "%%bash": "bash"
    - "%%cython": "cython"
    - "%%javascript": "javascript"
    - "%%julia": "julia"
    - "%%latex": "latex"
    - "%%octave": "octave"
    - "%%perl": "perl"
    - "%%ruby": "ruby"
    - "%%sh": "sh"
    - "%%sql": "sql"

- languages (trait)
  - User-configurable additional language mappings
  - Tag(config=True)

- Initialization
  - __init__(self, config=None, **kw)
  - Merges user-configured languages into default_languages
  - Builds a regular expression to detect language extensions (self.re_magic_language)

- which_magic_language(self, source)
  - Returns the associated language/lexer if a magic extension is detected, else None

- preprocess_cell
  - Signature: preprocess_cell(self, cell, resources, cell_index)
  - Behavior:
    - If cell.cell_type == "code" and which_magic_language(cell.source) returns a language,
      sets cell["metadata"]["magics_language"] = that language
    - Returns (cell, resources)

Usage example
-------------

- Tag code cells with magics_language for highlighting:
  .. code-block:: python

     from nbconvert.preprocessors.execute import HighlightMagicsPreprocessor
     hp = HighlightMagicsPreprocessor()
     nb = ...
     resources = {}
     hp.preprocess(nb, resources)

Notes
-----

- These preprocessors are typically used in nbconvert pipelines and can be combined with other preprocessors.

- ExecutePreprocessor manages kernel lifecycle via NotebookClient to run code cells and collect outputs.

- Executing a notebook updates cell outputs and metadata, including language information after kernel_info is retrieved.