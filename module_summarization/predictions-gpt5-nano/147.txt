# Fleur input/output parsers

This module provides helpers to extract distinct parts of Fleur XML files for versioning and reuse. It relies on a FleurXMLContext wrapper around the XML tree and a schema dictionary that encodes the Fleur file version.

Functions

- get_fleur_modes(xmltree, schema_dict, logger=None) -> dict[str, Any]

  Purpose
  - Detect the calculation modes used in a Fleur run. These modes influence produced files or outputs in the out.xml.

  Signature
  - xmltree: XMLLike – the Fleur XML tree
  - schema_dict: fleur_schema.InputSchemaDict | fleur_schema.OutputSchemaDict – schema dict for the file version
  - logger: Logger | None – optional logger

  Returns
  - A dictionary with keys describing the calculation modes and their values:
    - jspin: number of spins
    - noco: non-collinear calculation flag
    - soc: spin-orbit coupling flag
    - relax: structure relaxation flag
    - spex: special GW/Spex mode flag (0 if not present)
    - force_theorem: Force theorem calculation flag
    - cf_coeff: presence of cF coefficients (LDA+U related) (boolean)
    - plot: plotting flag (boolean interpretation depends on version)
    - film: film system flag
    - ldau: LDA+U flag (species-level)
    - dos: density of states flag/value
    - band: band structure flag/value
    - bz_integration: Brillouin zone integration mode
    - greensf: Greens function calculation flag (including species-specific checks)
    - ldahia: ldaHIA flag (species-specific)
  
  Notes
  - The function uses FleurXMLContext to read attributes and tags safely according to the provided schema version.
  - greensf and ldahia have version-gated logic:
    - greensf is detected if greensfCalculation exists (species scope); for v0.35+, also torques exist (torqueCalculation); otherwise torgueCalculation (spelling variant) is considered.
    - ldahia is detected if ldaHIA exists (species scope) for version >= 0.32.
  - plot interpretation converts to boolean for versions >= 0.29 when the iplot attribute is present.

  Example (conceptual)
  - Returns a dict like {'jspin': 2, 'noco': False, 'soc': True, 'relax': False, ...}

- get_nkpts(xmltree, schema_dict, logger=None) -> int

  Purpose
  - Retrieve the number of k-points used in the calculation described by the Fleur XML.

  Signature
  - xmltree: XMLLike – the Fleur XML tree
  - schema_dict: fleur_schema.InputSchemaDict | fleur_schema.OutputSchemaDict – schema dict for the file version
  - logger: Logger | None – optional logger

  Returns
  - Integer: the number of k-points

  Behavior
  - Uses the selected k-point list name (listName) and collects all available list names from kPointList elements that contain kPointLists.
  - Validates that the selected list name exists; raises ValueError if not.
  - Looks up the kPointList with the given name and reads its count attribute to obtain nkpts.
  - If nkpts is not an int, raises a ValueError indicating evaluation failure.

  Notes
  - The function is decorated with schema_dict_version_dispatch, indicating version-aware behavior.
  - Warning in the original docstring notes that for file versions before Max5, kPointList or kPointCount tags may be used; kPointCount may not reliably reflect the actual number of k-points.

Usage context

- Both parsers operate on Fleur XML trees and are designed to adapt to multiple Fleur versions via the schema dictionary and version dispatching.
- They are intended for internal tooling that needs stable access to common Fleur run descriptors (calculation modes) and key quantities (nk-points) without parsing raw XML manually.

Error handling

- get_fleur_modes raises no special exceptions beyond those raised by the underlying FleurXMLContext reads, unless structure expectations fail.
- get_nkpts raises ValueError in cases where:
  - The selected k-point list name does not exist among available lists
  - The k-points count cannot be evaluated as an integer

Dependencies

- FleurXMLContext, schema dictionary types, and the version-dispatch decorator are used to adapt behavior across Fleur versions.