Config usage

Overview
This configuration system uses a dedicated ConfigParser subclass that extends the standard ConfigParser with defaults, include support, environment-variable expansion, and optional Zookeeper-based loading. It combines default values with file-based configuration to produce the runtime configuration.

Default configuration
The system defines a rich set of defaults under several sections. The important defaults are:

- general
  - config_file: from ASAB_CONFIG environment variable or empty
  - tick_period: 1 (seconds)
  - var_dir: expanded path in the user’s home based on the script name
  - changelog: ''
  - manifest: ''
  - pidfile: '!' (transforms into a platform-specific pid file location)
  - working_dir: '.'
  - uid: ''
  - gid: ''

- asab:metrics
  - native_metrics: true
  - web_requests_metrics: False (default: not generated)
  - expiration: 60

- asab:doc
  - default_route_tag: module_name

- logging
  - verbose: from ASAB_VERBOSE environment variable (default False)
  - app_name: basename of the current script
  - sd_id: sd (Structured Data ID)
  - level: NOTICE
  - levels: ''

- logging:console
  - format: "%(asctime)s %(levelname)s %(name)s %(struct_data)s%(message)s"
  - datefmt: "%d-%b-%Y %H:%M:%S.%f"

- logging:syslog
  - enabled: false
  - address: platform-specific default (Darwin: /var/run/syslog; others: /dev/log)
  - format: platform-default (e.g. "3")

- logging:file
  - path: ''
  - format: "%(asctime)s %(levelname)s %(name)s %(struct_data)s%(message)s"
  - datefmt: "%d-%b-%Y %H:%M:%S.%f"
  - backup_count: 3
  - backup_max_bytes: 0
  - rotate_every: ''

- library
  - azure_cache: false (path to cache if enabled)

- passwords
  - (empty by default; used to store sensitive passwords securely)

- housekeeping
  - at: 03:00
  - limit: 05:00
  - run_at_startup: no

- zookeeper (added automatically if ASAB_ZOOKEEPER_SERVERS is present)
  - servers: value from ASAB_ZOOKEEPER_SERVERS

Notes
- The default values are designed to be overridden by configuration files or environment variables.
- Values may be expanded or substituted (e.g., via $VAR or environment variables) when loaded.

Configuration file structure and usage
- You may override defaults by supplying a configuration file (general.config_file) or by including additional files.
- The configuration supports sections and keys using the standard INI syntax. Subsections like logging:console, logging:syslog, and logging:file are supported to configure specific log destinations.

Include and file loading
- You can include other configuration files using the include option under the general section.
- Includes can contain:
  - Individual paths
  - Glob patterns
  - Zookeeper references (zookeeper:<path>), which are loaded via a dedicated loader
- Includes are processed in order, and each file is loaded only once to prevent infinite loops.
- The loader maintains a load directory stack to support relative includes and recursive includes.

Zookeeper support
- If ASAB_ZOOKEEPER_SERVERS is set, a zookeeper section is added automatically with a servers entry containing the configured servers.
- The system can read configuration data from Zookeeper as part of the include mechanism.

Environment and dynamic values
- Some defaults reference environment variables:
  - general.config_file from ASAB_CONFIG
  - logging.verbose from ASAB_VERBOSE
- Values can be expanded with environment variables and other variables when the configuration is loaded.

Managing defaults programmatically
- add_defaults(dictionary) can be used to merge a dictionary of defaults into the current configuration.
- Behavior:
  - Creates missing sections if needed.
  - Keeps existing values intact (does not override existing keys).
  - Performs environment-variable expansion where applicable.
  - Normalizes keys (case-insensitive) to the parser’s style.

Example usage
- Basic configuration (example.ini):
  [general]
  config_file = /etc/asab/config.ini
  tick_period = 2
  include = /etc/asab/common.ini

  [logging]
  level = INFO

  [logging:console]
  format = "%(asctime)s %(levelname)s %(name)s %(struct_data)s%(message)s"

  [logging:file]
  path = /var/log/asab.log
  rotate_every = daily

- Secure passwords (example.ini):
  [passwords]
  kafka_password = <MY_SECRET_PASSWORD>

  [connection:KafkaConnection]
  password=${passwords:kafka_password}

- Zookeeper-based loading (when ASAB_ZOOKEEPER_SERVERS is set):
  [zookeeper:example]
  servers = zk1:2181,zk2:2181

- Extending defaults at runtime:
  cp = {
    'general': {'tick_period': 5},
    'logging': {'level': 'INFO'}
  }
  config.add_defaults(cp)

Loading flow (conceptual)
- The parser starts with the built-in defaults.
- It optionally loads a file from general.config_file if provided.
- It processes include directives to load additional files, recursively if needed.
- If ASAB_ZOOKEEPER_SERVERS is set, zookeeper-based configurations are loaded as part of the include process.
- Environment variables are expanded, and any references to variables are resolved during loading.

This documentation describes how to use the configuration system to control runtime behavior, including logging, metrics, housekeeping, and secure password handling, with guidance on how to extend and compose configurations using defaults and includes.