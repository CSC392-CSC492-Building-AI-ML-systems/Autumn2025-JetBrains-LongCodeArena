Annihilation via Alchemical Transformations
===========================================

Overview
--------
Alchemical transformations enable gradual modification of a molecular system along a parameter lambda (0 to 1). In this approach, a HybridTopologyFactory partitions atoms into four classes to support annihilation-type changes where atoms vanish or appear smoothly during a simulation. The four classes describe how each atomâ€™s interactions are treated as lambda is varied.

Atom classes and interaction behavior
-------------------------------------
The hybrid topology represents atoms in four categories, each with its own interaction behavior:

- unique_old_atom
  - Not mapped between old and new systems.
  - Present only in the old system.
  - Interactions are enabled at lambda = 0 and disabled at lambda = 1.

- unique_new_atom
  - Not mapped between old and new systems.
  - Present only in the new system.
  - Interactions are disabled at lambda = 0 and enabled at lambda = 1.

- core_atom
  - Mapped between old and new systems and part of a residue that changes.
  - Interactions follow the old system at lambda = 0 and the new system at lambda = 1.

- environment_atom
  - Mapped between old and new systems but not part of the changing residue.
  - Interactions are always on and are alchemically unmodified.

Key outputs and properties
----------------------------
HybridTopologyFactory exposes several important artifacts used in simulation and analysis:

- hybrid_system
  - The OpenMM System representing the full hybrid topology for simulation.

- new_to_hybrid_atom_map
  - Mapping from atoms in the new system to atoms in the hybrid system.

- old_to_hybrid_atom_map
  - Mapping from atoms in the old system to atoms in the hybrid system.

- hybrid_positions
  - The positions of the hybrid system as an [n, 3] array.

- hybrid_topology
  - The topology of the hybrid system (mdtraj.Topology).

- omm_hybrid_topology
  - OpenMM Topology object corresponding to the hybrid system.

Notes
-----
- This API is experimental and subject to change.
- The hybrid approach typically includes forces such as bonds, angles, torsions, and nonbonded interactions, along with optional barostats.

Forces and lambda scaling
-------------------------
The implementation is aware of a set of common force types and how they may be scaled along lambda:

- Supported force types include:
  - HarmonicBondForce
  - HarmonicAngleForce
  - PeriodicTorsionForce
  - NonbondedForce
  - MonteCarloBarostat

- User-defined alchemical scaling is provided via a functions dictionary. Keys must be strings with a prefix lambda_ and a suffix indicating the force term, for example:
  - lambda_bonds
  - lambda_angles
  - lambda_torsions
  - lambda_sterics
  - lambda_electrostatics

- If functions is provided, all lambda terms must be specified; if not, derivatives with respect to lambda may be unavailable.

Softcore and parameterization
------------------------------
Softcore parameters are used to smoothly soften interactions as atoms are annihilated or created:

- softcore_alpha
  - The alpha parameter for softcore sterics (default 0.5 if not specified).

- softcore_LJ_v2
  - Use the LJ v2 softcore formulation (recommended).

- softcore_LJ_v2_alpha
  - Softcore LJ alpha parameter (default ~0.85).

- softcore_electrostatics
  - Use softcore electrostatics (default enabled).

- softcore_electrostatics_alpha
  - Softcore electrostatics alpha parameter (default ~0.3).

- softcore_sigma_Q
  - Softcore sigma parameter for electrostatics.

Lambda protocol and end states
------------------------------
- The HybridTopologyFactory expects endstate to be None. An explicit endstate value (0 or 1) is not supported for this API and will raise an exception if provided.

- Typical usage involves annealing interactions for unique_old and unique_new atoms as lambda progresses from 0 to 1, while core and environment atoms are treated according to their roles described above.

Workflow outline
----------------
1. Prepare a perses topology proposal describing the old and new states.
2. Provide current (old) positions and new positions.
3. Instantiate HybridTopologyFactory with desired options (dispersion correction, softcore settings, force scaling functions, etc.).
4. Use the resulting hybrid_system, maps, and topology objects to perform simulations, while monitoring lambda as needed for free energy calculations.
5. Access hybrid_positions and topology objects for analysis or downstream workflows.

Example (high-level)
--------------------
- Create a topology proposal from a transformation.
- Initialize HybridTopologyFactory with:
  - topology_proposal
  - current_positions
  - new_positions
  - softcore parameters and force scaling dictionary
- Run equilibration and alchemical sampling using the generated hybrid system and topology.

References
----------
- Hybrid topology and alchemical transformations are designed to support annihilation-type transformations where certain atoms disappear as lambda progresses, while maintaining stable dynamics for the remaining system components.

End of documentation.