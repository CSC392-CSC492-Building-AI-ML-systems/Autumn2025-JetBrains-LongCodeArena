Pydantic Models from Tortoise ORM
==================================

This document describes how to generate Pydantic models from Tortoise ORM models using the utilities provided in the Tortiose Pydantic integration. The core entry point is pydantic_model_creator, which builds a Pydantic model class based on a Tortoise Model, with configurable filtering, computed fields, and recursion control.

PydanticMeta configuration
---------------------------

To customize what fields are exposed in the generated Pydantic model, define a nested PydanticMeta class on your Tortoise model. The meta options control inclusion, exclusion, and computed fields, as well as how relationships are handled and how naming works.

Example

.. code-block:: python

    class MyModel(Model):
        # fields ...

        class PydanticMeta:
            # Only include these fields in the Pydantic model (empty means include all)
            include = ("id", "name", "created_at")

            # Exclude these fields from the Pydantic model
            exclude = ("secret_key",)

            # Include computed properties (callables on the model) by name
            computed = ("full_name",)

            # Use backward relations without explicit annotations (off by default recommended)
            backward_relations = True

            # Limit recursion depth when including related models
            max_recursion = 3

            # Allow cycles in recursive structures (use with care)
            allow_cycles = False

            # Exclude raw relation fields that end with _id
            exclude_raw_fields = True

            # Sort fields in the Pydantic model alphabetically
            sort_alphabetically = False

Generating Pydantic Models
--------------------------

Use pydantic_model_creator to build a Pydantic model class from a Tortoise Model. The generated class subclasses PydanticModel (or PydanticListModel for lists, depending on usage).

Signature (simplified)

.. code-block:: python

    pydantic_model_creator(
        cls: Type[Model],
        *,
        name: Optional[str] = None,
        exclude: Tuple[str, ...] = (),
        include: Tuple[str, ...] = (),
        computed: Tuple[str, ...] = (),
        allow_cycles: Optional[bool] = None,
        sort_alphabetically: Optional[bool] = None,
        _stack: tuple = (),
        exclude_readonly: bool = False,
    ) -> Type[PydanticModel]

Key behaviors

- Naming
  - If you do not customize exclude/include/computed or sorting, and you donâ€™t set allow_cycles, the generated Pydantic model name is the fully qualified Tortoise model name (fqname).
  - If you customize any of the parameters (exclude, include, computed, sort_alphabetically, allow_cycles, etc.), a hash suffix is appended to the generated class name to keep it unique. This helps avoid name collisions when producing multiple variants for the same Tortoise model.

- Recursion and safety
  - The generation process tracks a stack to detect recursive/self-referential structures.
  - If a cycle is detected and allow_cycles is False, generation for that branch is skipped (returns None for that branch). You can enable cycles via allow_cycles to permit them, but be aware of potential infinite/very deep structures.

- Connection to defaults
  - The default behavior for include, exclude, computed, and sort_alphabetically is driven by the PydanticMeta on the model. If you do not specify any of these, the name remains the base fqname with no postfix.

- Raw fields and relations
  - By default, exclude_raw_fields is True, which means fields ending with _id in relations may be omitted from the Pydantic model unless you explicitly include them.

- Readonly fields
  - The exclude_readonly option allows you to build a subset model that excludes fields marked as readonly.

- Documentation helpers (internal)
  - The module contains internal helpers for cleaning docstrings, formatting comments, and managing inline documentation for the generated models.

Example: simple generation
--------------------------

.. code-block:: python

    class User(Model):
        id = fields.IntField(pk=True)
        name = fields.CharField(max_length=50)
        password = fields.CharField(max_length=128, secret=True)

        class PydanticMeta:
            exclude = ("password",)

    UserPydantic = pydantic_model_creator(User)

    # Or with explicit options
    UserPublic = pydantic_model_creator(
        User,
        name="UserPublic",
        exclude=("password",),
        computed=("full_name",),
    )

Notes
-----

- The generated Pydantic model integrates with Pydantic's validation and serialization, making it suitable for FastAPI endpoints, data validation, and OpenAPI schemas.
- If you need a list of generated models, you can combine with PydanticListModel as appropriate for your use case.

API Reference
-------------

- pydantic_model_creator(cls, *, name=None, exclude=..., include=..., computed=..., allow_cycles=..., sort_alphabetically=..., _stack=(), exclude_readonly=False) -> Type[PydanticModel]

  Builds a Pydantic model class based on the provided Tortoise Model, applying the specified filtering, computed fields, and recursion options. The returned class is a subclass of PydanticModel.

Internal helpers (for reference)
--------------------------------

- _pydantic_recursion_protector(cls, *, stack, exclude=..., include=..., computed=..., name=None, allow_cycles=False, sort_alphabetically=None) -> Optional[Type[PydanticModel]]

  Protects against cyclic recursion during model generation. Returns a Pydantic model creator result for safe recursive expansion, or None if recursion is not allowed or exceeds max_recursion.

- _br_it(val: str) and _cleandoc(obj: Any) -> str

  Helpers for formatting and cleaning documentation strings used in generated models.

See also
--------

- PydanticModel (from tortoise.contrib.pydantic.base)
- PydanticListModel (from tortoise.contrib.pydantic.base)

This documentation mirrors the behavior implemented in the code that provides pydantic_model_creator and related utilities for converting Tortoise ORM models into Pydantic models with flexible configuration.