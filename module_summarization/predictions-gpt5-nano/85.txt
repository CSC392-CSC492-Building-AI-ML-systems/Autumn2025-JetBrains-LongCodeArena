piccolo_projects.rst

Module: piccolo_projects
-----------------------

Overview
--------
Provides support utilities for discovering and configuring Piccolo apps, including
migration module definitions, app configuration, table discovery, and a registry
for apps within a project.

Public API
----------

MigrationModule
- Description: A ModuleType subclass used to represent a migration module.
- Attributes:
  - ID: str
  - VERSION: str
  - DESCRIPTION: str
- Methods:
  - forwards() -> None (async): Static method intended to run migrations forward.

PiccoloAppModule
- Description: A ModuleType subclass used to represent a Piccolo app module.
- Attributes:
  - APP_CONFIG: AppConfig

table_finder(modules, include_tags=None, exclude_tags=None, exclude_imported=False) -> List[Type[Table]]
- Purpose: Discover and collect Table subclasses from the given module paths without requiring explicit registration in AppConfig.
- Parameters:
  - modules (Sequence[str]): Module paths to search for Table subclasses (e.g., ['blog.tables']).
  - include_tags (Sequence[str], optional): If provided, only tables with at least one of these tags are imported. '__all__' imports all found subclasses.
  - exclude_tags (Sequence[str], optional): If provided, any table with any of these tags will be skipped. Takes precedence over include_tags.
  - exclude_imported (bool, optional): If True, only tables defined in the specified modules are used; imported tables are ignored.
- Behavior:
  - Imports each specified module.
  - Scans for classes that are subclasses of Table (excluding Table itself).
  - Applies tag-based filtering and optional exclusion of imported tables.
  - Returns a list of matching Table subclasses.

Command
- Description: Simple container for a command callable with optional aliases.
- Attributes:
  - callable: t.Callable
  - aliases: List[str] (default_factory=list)

AppConfig
- Description: Central configuration for a Piccolo app.
- Parameters:
  - app_name (str): The name of the app (e.g., 'article').
  - migrations_folder_path (str): Path to the folder containing the app's migrations.
  - table_classes (List[Type[Table]], optional): Table classes registered for this app.
  - migration_dependencies (List[str], optional): Other apps this app depends on for migrations.
  - commands (List[Union[Callable, Command]], optional): Functions or coroutines to register as CLI commands.
- Attributes:
  - app_name
  - migrations_folder_path
  - table_classes
  - migration_dependencies
  - commands
  - _migration_dependency_app_configs (Optional[List[AppConfig]]): Cached list of AppConfig objects for dependencies.
- Methods:
  - __post_init__():
    - Normalizes commands to a list of Command instances.
    - Converts migrations_folder_path to str if given as a pathlib.Path.
  - register_table(table_class):
    - Adds a Table subclass to table_classes and returns the class.
  - migration_dependency_app_configs (property):
    - Returns AppConfig instances for each app listed in migration_dependencies.
    - Caches the result for efficiency and easier unit testing.
  - get_table_with_name(table_class_name):
    - Returns a Table subclass from table_classes by matching __name__.
    - Raises ValueError if no matching table exists.

AppRegistry
- Description: Keeps track of all Piccolo apps in a project (typically defined in piccolo_conf.py).
- Parameters:
  - apps (List[str], optional): Paths to Piccolo apps (e.g., ['blog.piccolo_app']).
- Attributes (inferred from implementation):
  - apps: List[str]
  - app_configs: Dict[str, AppConfig] (type hinted in code)
- Notes:
  - This class collects and exposes AppConfig instances for registered apps, enabling centralized management of app configurations.

Usage overview
- Use table_finder to automatically discover Table subclasses from specified modules, optionally filtering by tags.
- Define AppConfig instances to register app metadata, including migrations path, table registrations, migration dependencies, and CLI commands.
- Access migration dependency configurations via AppConfig.migration_dependency_app_configs to resolve dependent app configurations.
- Use AppRegistry to keep track of all apps in a project and their configurations.

See Also
- Piccolo Engine and Table base facilities for interacting with migrations and ORM mappings.
- Tag-based filtering for selective table discovery.