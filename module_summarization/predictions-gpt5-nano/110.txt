BestEffortCallback
==================

Overview
--------

BestEffortCallback is a Bluesky RunEngine callback that generates on-the-fly visualizations and a summary table to assist in exploratory data collection. It integrates with LivePlot, LiveGrid, LiveScatter, and LiveTable to present hints from the start document (dimensions) and per-descriptor data as they arrive. It supports plotting, tabular display, and peak statistics collection in a best-effort manner.

Initialization and options
--------------------------

.. code-block:: python

   BestEffortCallback(*, fig_factory=None, table_enabled=True, **kwargs)

Parameters
----------

- fig_factory: Optional callable that creates a Matplotlib figure. If not provided, a default figure factory is used.
- table_enabled: Boolean, default True. Enable printing a LiveTable of primary stream readings.
- **kwargs: Additional keyword arguments forwarded to the base QtAwareCallback.

Public options
--------------

- overplot: bool, default True. Plot data from all streams unless explicitly disabled.
- noplot_streams: list, default ['baseline']. Streams listed here are not plotted.
- omit_single_point_plot: bool, default True. If a stream provides only a single point, suppress plotting for that stream.

Public data
-----------

- peaks: PeakResults() — container for peak statistics collected during the run.

Internal state
--------------

- _start_doc: The run's start document.
- _descriptors: Dict mapping descriptor UID to descriptor documents.
- _table: LiveTable instance (when table output is enabled).
- _heading_enabled: Whether to print a header with timestamp and IDs at the start of a run.
- _table_enabled: Whether to emit a LiveTable.
- _baseline_enabled: Whether to include baseline fields in output.
- _plots_enabled: Whether to generate plots.
- _fig_factory: Figure factory provided by the user.
- _live_plots / _live_grids / _live_scatters: Mappings from descriptor UID to corresponding live visualization objects.
- _peak_stats: Per-descriptor peak statistics data (same structure as _live_plots).
- _cleanup_motor_heuristic: Internal flag used to determine whether to re-resolve dimension fields from hints.
- _stream_names_seen: Set of stream names encountered so far.
- _buffer: StringIO buffer used to manage the bottom border of the table.
- _baseline_toggle: Internal toggle used for baseline display management.

Lifecycle and usage
-------------------

- start(doc): Initialize run state, extract hints about dimensions, and determine dimensional fields. If hints are missing or inconsistent across streams, a fallback “GUESS” is used. If enabled, prints a header with the transient scan ID, time, and persistent scan ID.

- descriptor(doc): Store descriptor information, determine the available plotting capabilities for the current stream, and update internal state accordingly. If the stream is new and table output is enabled, a “New stream” message may be printed. Handles dimension field resolution, including a fallback path when motor hints are not usable.

- __call__(name, doc, *args, **kwargs): Process incoming documents. If all output options are disabled (table, baseline, and plots), the callback is a no-op. Otherwise, it defers to the base class for standard processing.

- Notes on behavior:
  - Plotting decisions are driven by:
    - _plots_enabled
    - stream name not in noplot_streams
    - existence of plotable columns (derived from hinted fields)
    - whether the run has more than one data point (unless omit_single_point_plot is False)
  - The class is designed to work with multiple streams and dimensional hints, resolving dimension fields for plotting against primary fields.

Implementation details (high level)
-------------------------------

- The callback maintains per-descriptor live visualizations (LivePlot, LiveGrid, LiveScatter) and a per-descriptor peak statistics container.
- It prints progress and stream changes when the table output is active.
- It leverages hinted_fields from the descriptor to determine which fields are available for plotting and tabulation.
- A guardrail in __call__ ensures that if output is disabled for all channels, no work is done for that document.

Related components
------------------

- LivePlot, LiveGrid, LiveScatter: Visualization primitives used by the callback to render plots and grids.
- LiveTable: Tabular display of data from the primary stream.
- PeakStats / PeakResults: Structures used to collect and store peak statistics for streams.
- hints and hinted_fields: Helpers used to infer dimensional structure from the start document.

Testing and examples
--------------------

For testing in a simulated environment, see:
- tests/interactive/best_effort_cb.py

Notes
-----

- The code contains a deliberate mechanism to handle cases where dimensional hints are unavailable or inconsistent across streams by falling back to a default guess and optionally warning about the incompatibility.
- The BestEffortCallback is intended to be a lightweight, user-friendly visualization aid during data collection, rather than a fully-featured plotting engine. Further customization can be achieved by supplying a custom fig_factory and by toggling the public options described above.