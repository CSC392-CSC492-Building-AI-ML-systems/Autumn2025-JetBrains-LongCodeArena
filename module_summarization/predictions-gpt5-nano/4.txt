Sync LDAP Users with ftrack
============================

Overview
--------
This document describes how to synchronize users from an LDAP directory into the ftrack server using the ftrack API. The synchronization relies on the ftrack Session and its authentication mechanism to perform authenticated operations against the ftrack REST API.

Prerequisites
-------------
- An LDAP directory containing user accounts (and optional groups) to synchronize.
- Access to the ftrack server (URL) and valid API credentials.
- Network access from the synchronization environment to both the LDAP server and the ftrack server.
- Python environment with LDAP and ftrack API client libraries available (as appropriate for your setup).
- Optional: mapping configuration to translate LDAP attributes and groups to ftrack user attributes and groups/roles.

Configuration
-------------
LDAP configuration (typical fields):
- ldap_url: LDAP server URL
- bind_dn / bind_password: credentials used to bind to LDAP
- user_base_dn: base DN for user search
- user_filter: LDAP filter to identify user entries
- mappings:
  - ldap_uid -> ftrack login
  - mail -> email
  - cn / displayName -> name
- group_mappings (optional): LDAP groups to ftrack groups/roles

ftrack connection configuration:
- server_url: ftrack server URL (can be provided via FTRACK_SERVER)
- api_key: ftrack API key (can be provided via FTRACK_API_KEY)
- api_user: ftrack API user (can be provided via FTRACK_API_USER)

Environment variables (fallbacks used by Session):
- FTRACK_SERVER: ftrack server URL
- FTRACK_API_KEY: API key for authentication
- FTRACK_API_USER: API user name

Notes on authentication
- The SessionAuthentication class attaches authentication headers to requests:
  - ftrack-api-key
  - ftrack-user
- If you instantiate Session without explicit credentials, the session will attempt to read FTRACK_SERVER, FTRACK_API_KEY, and FTRACK_API_USER from the environment.

Workflow
--------
1. Connect to LDAP and retrieve the list of users (and their attributes) to be synchronized.
2. For each LDAP user:
   - Create a corresponding ftrack user if one does not exist.
   - Update user attributes in ftrack (e.g., login, email, name) to reflect LDAP data.
   - Ensure the user has appropriate roles/permissions based on LDAP group membership.
3. Synchronize LDAP groups to ftrack groups/roles:
   - Map LDAP groups to corresponding ftrack groups or project roles.
   - Add or remove memberships to reflect the LDAP directory state.
4. Optional deprovisioning:
   - Disable or deactivate ftrack users who are no longer present in LDAP, according to your policy.
5. Logging and error handling:
   - The process should log successful operations and any errors encountered.
   - Implement idempotent behavior to allow repeated runs without duplicating users.

Implementation notes
--------------------
- The core API interaction relies on the ftrack Session class:
  - server_url, api_key, and api_user can be supplied directly or sourced from environment variables (FTRACK_SERVER, FTRACK_API_KEY, FTRACK_API_USER).
  - The session handles authentication via the SessionAuthentication wrapper, attaching the appropriate headers to each request.
  - The Session class supports caching and optional event hub integration, which can be leveraged by plugins involved in LDAP synchronization.
- The synchronization logic should be implemented in a dedicated script/module that uses the Session to perform CRUD operations on ftrack users and group memberships.

Usage examples
--------------
Minimal usage (credentials from environment variables):
.. code-block:: python

   from ftrack_api import Session

   # If FTRACK_SERVER, FTRACK_API_KEY and FTRACK_API_USER are set in the environment,
   # you can instantiate with no arguments.
   session = Session()

   # Implement LDAP sync logic here using the session to create/update users
   # and map LDAP groups to ftrack permissions.

Explicit credentials:
.. code-block:: python

   from ftrack_api import Session

   session = Session(
       server_url='https://ftrack.example.com',
       api_key='YOUR_API_KEY',
       api_user='YOUR_API_USER'
   )

Notes
-----
- Ensure that the user running the sync has sufficient permissions on the ftrack server to create and modify users and group memberships.
- When mapping LDAP attributes to ftrack fields, be mindful of data validation (e.g., unique logins, valid email formats).
- Consider running the LDAP sync as a scheduled task (cron, systemd timer, or similar) to keep ftrack in sync with LDAP directory changes.

See also
--------
- ftrack_api.Session documentation
- ftrack_api.SessionAuthentication details
- LDAP integration guidelines in your organizationâ€™s identity management documentation