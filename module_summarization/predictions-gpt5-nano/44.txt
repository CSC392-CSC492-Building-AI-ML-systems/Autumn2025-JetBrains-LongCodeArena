Azure Storage Library Provider
==============================

Overview
--------
AzureStorageLibraryProvider is a library provider that reads from a Microsoft Azure Storage container. It is capable of listing and reading blobs from a container via the Azure Blob Storage HTTP API.

Configuration
-------------
- azure URL
  Configure by using a path that starts with azure+ and points to the Azure Storage container:
  azure+https://ACCOUNT-NAME.blob.core.windows.net/BLOB-CONTAINER

- Caching (optional)
  The cache behavior is controlled by the library.azure_cache configuration option:
  - If set to 'false' (the default in some setups), caching is disabled.
  - If set to 'true', a temporary directory is created for caching (name derived from the path).
  - If set to any other string, that string is treated as the directory path to use for caching (the directory is created if needed).

  Example:
  [library]
  azure_cache = true
  or
  [library]
  azure_cache = /path/to/cache/dir

  When caching is enabled, etags are stored alongside cached blobs to support conditional requests.

Usage
-----
- Instantiate the provider in a library that uses providers:
  AzureStorageLibraryProvider(library, path, layer)

- Path must begin with "azure+" and be a valid Azure container URL. If the container is not public, you should provide a SAS token in the URL (for example, ?sv=...&si=...&sr=c&sig=...).

- On construction, the provider schedules asynchronous startup that loads the container listing metadata and initializes its in-memory model.

API Reference
-------------

AzureStorageLibraryProvider
- Inherits: LibraryProviderABC

- __init__(self, library, path, layer)
  - Purpose: Initialize the provider with the target Azure container URL and prepare internal state.
  - Parameters:
    - library: reference to the parent library object.
    - path: string starting with "azure+" followed by the Azure container URL.
    - layer: reference to the layer in the hosting application.
  - Behavior:
    - Validates path begins with "azure+".
    - Parses the URL after the prefix and stores it as self.URL.
    - Initializes an in-memory model (self.Model) to None; will be populated by _load_model.
    - Determines a local cache directory (self.CacheDir) from the configuration:
      - 'false' -> caching disabled (None)
      - 'true' -> ephemeral cache directory under the system temp path
      - other string -> use as cache directory path
    - Ensures the cache directory exists if enabled.
    - Schedules the asynchronous startup via self.App.TaskService.schedule(self._start()).
  - Returns: None

- async _start(self)
  - Purpose: Kick off model loading and mark the provider ready when loaded.
  - Behavior:
    - Awaits _load_model().
    - If a model was successfully built (self.Model is not None), awaits _set_ready() (to indicate readiness to the framework).
  - Returns: None

- async _load_model(self)
  - Purpose: Load the container listing and build an in-memory hierarchical model of directories and items.
  - Behavior:
    - Builds a URL to list the container with REST API parameters (restype=container&comp=list).
    - Fetches the listing via HTTP (aiohttp).
    - On HTTP 200, parses the XML response and constructs an internal model using AzureDirectory and AzureItem nodes.
    - The resulting model is stored in self.Model.
  - On error (non-200), logs a warning and leaves the model as None.
  - Returns: None

- async list(self, path: str) -> list
  - Purpose: List directory contents at the given path.
  - Parameters:
    - path: string path starting with '/' and representing a directory within the container.
  - Behavior:
    - Validates path formatting (must start with '/' and not contain consecutive slashes).
    - Traverses the in-memory model self.Model according to the path.
    - If the path does not exist or does not refer to a directory, raises KeyError.
    - Constructs a list of LibraryItem entries for each child (name, type, layer, providers).
  - Returns: list of LibraryItem objects representing directory contents.

- async read(self, path: str) -> typing.IO
  - Purpose: Retrieve a blob as a stream, with optional caching.
  - Parameters:
    - path: absolute path to a blob within the container (starting with '/').
  - Behavior:
    - Validates path formatting.
    - Computes a cache key (SHA-256 of the path) and a corresponding cache file name if caching is enabled.
    - If a cached etag exists, uses If-None-Match to perform conditional requests.
    - Builds the full blob URL and performs an HTTP GET.
    - On HTTP 200:
      - If caching is enabled and the response contains an ETag, stores the blob to the cache and updates the .etag file.
      - Returns a file-like object (IO) for reading the blob content.
    - Other HTTP responses are handled according to the framework expectations (logging and error handling may apply).
  - Returns: a file-like object (typing.IO) for the blob data.

Notes
-----
- The provider relies on:
  - aiohttp for HTTP requests
  - xml.dom.minidom for parsing the container listing XML
  - A local in-memory model using AzureDirectory and AzureItem nodes (defined elsewhere in the project)
- The initial loading of the model is asynchronous; the provider can be marked as ready after _load_model completes successfully.
- The design includes a TODO for periodic model refresh to reflect container changes automatically.

Examples
--------
- Basic public container:
  azure+https://myaccount.blob.core.windows.net/mycontainer

- Private container with SAS token:
  azure+https://myaccount.blob.core.windows.net/mycontainer?sv=2020-10-02&si=XXXX&sr=c&sig=XXXX

See Also
--------
- LibraryProviderABC: base class for library providers
- LibraryItem: representation of items returned by list()
- AzureDirectory / AzureItem: internal model nodes used to build the in-memory structure

This provider enables integration with Azure Blob Storage containers as a source of library items, supporting listing and reading with optional caching to improve performance.