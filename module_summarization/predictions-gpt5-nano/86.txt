postgres_engine.rst
===================


Overview
--------
This module provides the PostgreSQL-specific engine implementation used by Piccolo. It includes support for asynchronous transactions, savepoints, batch processing of query results, and an API to compose and run atomic transactions. The engine integrates with asyncpg (lazily loaded) and exposes both asynchronous and synchronous entry points for running queries and transactions.

Key components
--------------

AsyncBatch
--------
A helper for streaming large query results in batches within a transaction.

- Attributes
  - connection: The underlying asyncpg Connection.
  - query: The Piccolo Query being executed.
  - batch_size: Number of rows to fetch per batch.
  - _transaction: Internal transaction object (initialized in enter).
  - _cursor: Internal cursor used to fetch data (initialized in enter).

- Properties
  - cursor: Returns the underlying cursor; raises if not yet set.

- Methods
  - next(): Fetches the next batch of rows and processes them via the query’s result processor.
  - __aiter__(): Returns self for asynchronous iteration.
  - __anext__(): Retrieves the next batch, stopping iteration when empty.
  - __aenter__(): Starts a transaction, prepares the query, and opens a cursor.
  - __aexit__(exception_type, exception, traceback): Commits or rolls back the transaction based on exceptions, then closes the connection.

Usage
-----
AsyncBatch is used when you want to iterate over large results lazily, in batches, within a single transaction.

Atomic
------
A small helper to build and run a collection of queries inside a single transaction programmatically.

- Attributes
  - engine: The PostgresEngine instance this atomic transaction belongs to.
  - queries: A list of Query objects to execute atomically.

- Methods
  - add(*query): Add one or more Query objects to be executed.
  - run(): Async execution of all added queries inside a single transaction. Supports only Query, DDL, Create, GetOrCreate; raises on unrecognised types. Clears the queue after running.
  - run_sync(): Convenience to run the atomic transaction synchronously.
  - __await__(): Awaitable entry for use with await.

Usage
-----
transaction = engine.atomic()
transaction.add(Foo.create_table())
await transaction.run()
# or synchronously: transaction.run_sync()

Savepoint
---------
Represents a savepoint inside a running transaction, enabling partial rollback.

- Attributes
  - name: Savepoint name.
  - transaction: The PostgresTransaction this savepoint belongs to.

- Methods
  - rollback_to(): Roll back to this savepoint.
  - release(): Release the savepoint.

Usage
-----
savepoint = await transaction.savepoint()
await savepoint.rollback_to()
await savepoint.release()

PostgresTransaction
-------------------
Core transaction management for PostgreSQL within Piccolo.

- Slots
  - engine: The PostgresEngine instance managing this transaction.
  - transaction: The underlying asyncpg transaction object.
  - context: Context holder for the current transaction (used to support nesting).
  - connection: Active database connection for the transaction.
  - _savepoint_id: Counter for generating savepoint names.
  - _parent: Optional parent transaction when nesting is allowed.
  - _committed: Flag indicating if a commit has occurred.
  - _rolled_back: Flag indicating if a rollback has occurred.

- Initialization
  - __init__(engine, allow_nested: bool = True)
    - If a transaction is already active:
      - allow_nested = True makes the new transaction a no-op wrapper around the parent.
      - allow_nested = False raises TransactionError to disallow nesting.

- Context management
  - __aenter__(): If a parent exists, returns the parent (no-op). Otherwise obtains a connection, creates a transaction, begins it, and stores the current transaction in the engine’s context.
  - get_connection(): Uses a pool if available, otherwise creates a new connection.
  - begin(): Starts the transaction.
  - __aexit__(exception_type, exception, traceback): If there is a parent, defers to the parent. Otherwise commits or rolls back depending on exceptions, releases/closess the connection, and resets the engine’s current transaction context.

- Core operations
  - get_connection(): Acquire a connection from the pool or create a new one.
  - begin(): Begin the underlying transaction.
  - commit(): Commit the transaction and mark as committed.
  - rollback(): Rollback the transaction and mark as rolled back.
  - rollback_to(savepoint_name): Roll back to a named savepoint via a helper Savepoint instance.
  - get_savepoint_id(): Internal helper to generate unique savepoint names.
  - savepoint(name: Optional[str] = None): Create a new savepoint with a generated or provided name.
  - __aexit__(exception_type, exception, traceback): If nested, return whether exception is None. Otherwise commit or rollback as required, release the connection back to the pool (or close it), and reset the current transaction context.

- Notes
  - Nested transactions: By default, nesting is allowed and acts as a logical wrapper around the active parent transaction. To disallow nesting, set allow_nested to False when entering a new PostgresTransaction.
  - Savepoints: Used to implement partial rollbacks within a transaction.

Usage
-----
async with engine.transaction():
    # Run queries within a single transaction
    await Band.select().run()

Nested usage
------------
If a transaction is already active and allow_nested is True (default), entering another transaction returns the parent, effectively making nested blocks no-ops. If allow_nested is False, attempting to start a second level raises TransactionError.

PostgresEngine
--------------
The concrete engine for PostgreSQL, implementing the generic Engine interface with support for PostgreSQL-specific transaction mechanics.

- Inheritance
  - Inherits from Engine with a type parameter of Optional[PostgresTransaction], indicating that transactions are optional and may be None where appropriate.

- Purpose
  - Central entry point to create and manage PostgreSQL connections, transactions, and related utilities for executing queries using the asyncpg backend (lazily loaded).

- Typical usage
  - Acquire a transaction via engine.transaction() and use the various transaction and savepoint APIs to manage complex operations across multiple queries.

Dependency notes
----------------
- Asyncpg is loaded lazily via LazyLoader to avoid importing the dependency at import time when not needed.
- This module interacts with Piccolo’s core Engine base class, Query and DDL types, and helper utilities for running sync code and emitting warnings.

Examples (quick references)
----------------------------
- Streaming results in batches:
  async with engine.transaction() as txn:
      batch = AsyncBatch(connection=conn, query=query, batch_size=100)
      async for rows in batch:
          process(rows)

- Building and running an atomic set of queries:
  atomic = Atomic(engine)
  atomic.add(Foo.create_table())
  atomic.run()  # or await atomic.run()

- Using a savepoint:
  async with engine.transaction() as txn:
      sp = await txn.savepoint()
      # Do work
      await sp.rollback_to()
      # or
      await sp.release()

Notes
-----
This module is designed to work with Piccolo’s overall architecture for query building, execution, and transaction management, providing a PostgreSQL-specific implementation with async capabilities and savepoint support.