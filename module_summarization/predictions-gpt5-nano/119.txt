Configuration usage
===================

This document describes how the high-level configuration defined in the code is organized, how it translates into the underlying fv3config structures, and how to use it to drive prognostic FV3 runs.

Key concepts
------------

- FV3Config: Dataclass representation of the fv3config fields that are not overridden by HighLevelConfig.
  - namelist: Default coupler_nml with a small default (e.g. dt_atmos = 900).
  - experiment_name, data_table, field_table, forcing, orographic_forcing, gfs_analysis_data
  - asdict() can be used to obtain a plain dictionary, omitting None values.

- InitialCondition: Encapsulates a single initial condition in the form base_url/timestep.
  - base_url: Location (URL or local path) to the initial condition data.
  - timestep: Timestamp in the format YYYYMMDD.HHMMSS.
  - restart_categories: Mapping for restart category names (core, surface, tracer, surface_wind).

  - overlay: Convenience property returning the overlay for this initial condition to be merged into fv3config.

- HighLevelConfig: Combines fv3config with runtime configurations and conveniences for initial conditions and duration.
  - base_version: Default physics config version (e.g., "v0.5").
  - initial_conditions: Either an InitialCondition instance or a raw specification (e.g., a dict); used to compute overlays for initial conditions.
  - duration: Duration of the run (string parsable by pandas.to_timedelta, e.g. "3h"). If provided, overrides namelist.coupler_nml.dt_atmos.
  - zhao_carr_emulation: Emulation configuration for Zhao-Carr physics (default is a default EmulationConfig).

  Core methods and properties:
  - _initial_condition_overlay(): Returns the overlay for initial conditions (from InitialCondition.overlay or a direct dict).
  - _to_fv3config_specific(): Produces an FV3Config populated with the current HighLevelConfig fields.
  - to_runtime_config(): Returns a UserConfig instance built from this HighLevelConfig (runtime-only config).
  - _physics_timestep(): Computes the base timestep in seconds for dt_atmos by merging the base config and overlays.
  - _duration: Parsed duration as a Python timedelta if provided.
  - to_fv3config(): Produces the complete fv3config dictionary by merging base config, overlays, and diagnostics settings.

Generating fv3config from HighLevelConfig
----------------------------------------

HighLevelConfig.to_fv3config() merges multiple overlays into a single fv3config dictionary. Overlays include:

- Base base_version configuration from fv3kube.get_base_fv3config(base_version).
- Initial condition overlays (_initial_condition_overlay()).
- Diagnostic tables (through _diag_table_overlay and file_configs_to_namelist_settings).
- Runtime-specific overlays from to_runtime_config().
- Specific FV3Config fields (_to_fv3config_specific()) as a dict.
- Zhao-Carr emulation settings.
- Optional suppression of range warnings (SUPPRESS_RANGE_WARNINGS).

If duration is provided, the resulting dictionary is further modified with run duration metadata via fv3config.set_run_duration.

Extracting runtime configuration
--------------------------------

- to_runtime_config(): Returns a dataclass instance of UserConfig containing only the runtime-related fields. This is useful when you want to separate the core FV3 configuration from runtime knobs.

Initial conditions and overlays
------------------------------

- InitialCondition.overlay uses fv3kube.c48_initial_conditions_overlay(base_url, timestep, restart_categories=...). This produces a configuration snippet that can be merged into the full fv3config.

- SUPPRESS_RANGE_WARNINGS disables certain range warnings when setting namelist fields.
- default_coupler_nml(): Provides a minimal default for namelist.coupler_nml (e.g., dt_atmos=900) when no explicit namelist is provided.

Emulation and diagnostics
-------------------------

- zhao_carr_emulation: Emulation configuration for Zhao-Carr physics. Stored as a dataclass, merged into the final configuration as {"zhao_carr_emulation": ...}.

- Diagnostic table handling: The code references PROGNOSTIC_DIAG_TABLE and _diag_table_overlay(self.fortran_diagnostics) to integrate diagnostic tables into the fv3config. It also uses file_configs_to_namelist_settings(self.fortran_diagnostics, self._physics_timestep()) to translate diagnostics file configurations into namelist settings.

Working with the code: example usage
------------------------------------

- Create an InitialCondition:
  - ic = InitialCondition(base_url="gs://bucket/path/to/initials", timestep="20240101.000000")

- Create a HighLevelConfig:
  - hl = HighLevelConfig(
      base_version="v0.5",
      initial_conditions=ic,
      duration="6h",
      zhao_carr_emulation=emulation.EmulationConfig(...)
    )

- Generate fv3config dictionary:
  - config = hl.to_fv3config()

- Retrieve runtime config:
  - rt_config = hl.to_runtime_config()

- Optional: obtain a fully formed FV3 run dictionary (with potential dataclass fields consolidated as a plain dict):
  - fv3_dict = hl.to_fv3config()

CLI usage (conceptual)
----------------------

- The argument parser function shows a typical pattern:
  - A positional argument user_config points to a YAML file describing changes from the base fv3config.
  - Optional --model_url can be supplied to point to a trained ML model.

Notes
-----

- The code uses dataclasses, typing, and runtime configuration utilities from fv3config and fv3kube.
- Implied dependencies include pandas, dacite, and Fortran diagnostic tooling.

Example snippets
---------------

- Basic HighLevelConfig construction (Python):

  from fv3kube import RestartCategoriesConfig
  ic = InitialCondition(base_url="gs://bucket/initials", timestep="20240101.000000")
  hl = HighLevelConfig(
      base_version="v0.5",
      initial_conditions=ic,
      duration="3h",
  )
  fv3 = hl.to_fv3config()

- Runtime config extraction:

  rt = hl.to_runtime_config()

- Duration handling:

  dur = hl._duration  # -> datetime.timedelta(0, 10800)

References
----------

- HighLevelConfig, FV3Config, InitialCondition: internal configuration models used to compose fv3config overlays.
- Overlay mechanism: how to combine base config, initial conditions, diagnostics, and runtime settings into a final configuration dictionary suitable for FV3 runs.