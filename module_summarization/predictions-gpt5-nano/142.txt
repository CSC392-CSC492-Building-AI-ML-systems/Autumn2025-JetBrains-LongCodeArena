delayed API
===========

Overview
--------
The dask.delayed interface provides a lightweight, lazy interface for building
task graphs. A Delayed object represents a single task (or a collection of tasks)
whose execution is deferred until you request computation. The public API is
exposed via Delayed objects and the delayed constructor function.

Public API
----------

Delayed
-------
Represents a lazy computation node in a Dask graph.

- Key concepts
  - Each Delayed wraps a primary key and a Dask graph describing how to compute it.
  - Internal helpers are used to inspect and manipulate the underlying graph, such as:
    - __dask_keys__() – returns the keys for this Delayed in its graph.
    - __dask_graph__() – returns the HighLevelGraph representing the task.
    - __dask_postcompute__() – returns a finalizer and extra arguments to run after compute.
    - __dask_optimize__() – optional graph optimization hook.
  - The Delayed type supports operator overloading and composition through mixins (OperatorMethodMixin and DaskMethodsMixin), enabling natural construction of new delayed tasks from existing ones (e.g., arithmetic, attribute access, and function calls).

- Creation and usage
  - Delayed objects are created via the delayed constructor (see below). They can wrap a Python value, a function, or an existing Delayed object.
  - All Delayed instances participate in graph assembly and can be passed to dask.compute or to the dask scheduler to execute.

- Internal helpers
  - finalize(collection) constructs a Delayed finalizer for a given dask collection.
  - unpack_collections(expr) is used to normalize a Python object containing Delayed objects, extracting a task (the normalized form) and a tuple of involved Delayed collections.
  - to_task_dask(expr) (deprecated) previously performed normalization and graph extraction; it now emits a deprecation warning and delegates to unpack_collections.
  - unzip(ls, nout) is a utility for splitting a list of outputs into per-output components.

delayed (constructor)
---------------------
The delayed constructor creates a Delayed object from a Python object or function, enabling lazy graph construction. The function is demonstrated in examples such as:

- Example
  - a = delayed(1, 'a')
  - b = delayed(2, 'b')

  These calls create Delayed objects whose eventual values will be 1 and 2, respectively, with keys 'a' and 'b' in the graph.

- Unpacking and graph extraction
  - task, collections = unpack_collections([a, b, 3])
  - task        -> ['a', 'b', 3]
  - collections -> (Delayed('a'), Delayed('b'))

  - task, collections = unpack_collections({a: 1, b: 2})
  - task        -> (dict, [['a', 1], ['b', 2]])
  - collections -> (Delayed('a'), Delayed('b'))

- Advanced handling
  - unpack_collections supports nested Python structures (lists, tuples, dicts, sets, dataclasses, namedtuples) and converts them into a normalized task representation along with a collection of involved Delayed objects.

Notes on internals
------------------
- DEFAULT_GET defines the default scheduler used to retrieve values for Delayed computations. It typically selects a thread-based scheduler, with a fallback to sync if needed:
  - DEFAULT_GET = named_schedulers.get("threads", named_schedulers["sync"])
- The interface relies on internal dask mechanisms such as tokenize for unique key generation, and it uses HighLevelGraph to represent the computation.
- Special handling for dataclasses and namedtuples is supported via unpack_collections, extracting field values and reconstructing the original dataclass or namedtuple as needed.

Deprecations and deprecation notices
------------------------------------
- to_task_dask(expr) is deprecated in favor of unpack_collections. It emits a warning indicating the deprecation and points to unpack_collections as the recommended replacement.

Examples
--------
Basic usage:

>>> import dask
>>> a = delayed(1, 'a')
>>> b = delayed(2, 'b')
>>> task, collections = unpack_collections([a, b, 3])
>>> task
['a', 'b', 3]
>>> collections
(Delayed('a'), Delayed('b'))

Advanced usage with dicts:

>>> task, collections = unpack_collections({a: 1, b: 2})
>>> task
(<class 'dict'>, [['a', 1], ['b', 2]])
>>> collections
(Delayed('a'), Delayed('b'))

Note
----
- The documentation and examples use doctest-like snippets; actual behavior depends on the execution environment and the scheduler in use.

Public API summary
------------------
- Delayed: class representing a lazy task in a Dask graph.
- delayed: function to create Delayed objects from Python objects or functions.
- unpack_collections: utility to normalize objects containing Delayed objects and extract the underlying task and involved collections.
- to_task_dask: deprecated; use unpack_collections instead.
- finalize: create a Delayed finalizer for a collection.
- unzip: helper to unzip a list of outputs.
- DEFAULT_GET: default scheduler used for obtaining results.