Less Frequently Used FITS Data Structures

This document covers internal data structures used by the FITS handling code that are not commonly accessed directly by end users. The structures described here are primarily for internal verification, error reporting, and change notification within the FITS I/O subsystem.

Nested Verification Error List (_ErrList)

Overview
- _ErrList is a specialized list used to accumulate verification errors in a hierarchical (nested) fashion.
- It stores messages as a nested structure that can represent multiple levels of detail (e.g., elements, records, fields) and is designed to be printed in a readable, indented form.
- Each non-list item in the top level is a tuple where the first element is a boolean flag (fixable) and the second element is the message text. Nested levels are represented by additional _ErrList instances.

Key API
- __init__(val=(), unit="Element")
  - Create a new error list. The unit is used when rendering headers for nested levels (e.g., “Element 0:”, “Record 1:”, etc.).
- __str__()
  - Return a human-readable, newline-separated string of messages. It is built from iter_lines().
- iter_lines(filter=None, shift=0)
  - Iterate through the nested error structure as (header, indented_text) pairs.
  - The filter can be used to select which lines to yield based on the underlying tuple data.
  - shift applies indentation depth for nested levels.
- Construction and usage
  - Top-level entries are tuples: (fixable_flag, message_text).
  - Nested levels are _ErrList instances. When a nested level contains items, a header line such as "<unit> <index>:" is emitted, followed by its content.

Notes
- The first element of each top-level entry is a boolean indicating whether the corresponding issue is fixable.
- The nested structure allows grouping related messages under a common header (e.g., a specific element or record).
- This structure is commonly used to aggregate verification errors produced by the verification system and print them in a readable, hierarchical form.

Verification utilities (VerifyError, VerifyWarning, _Verify)

Overview
- These utilities support validating values in FITS-related objects and optionally reporting or fixing issues.
- They provide a standardized mechanism for communicating problems encountered during verification and for controlling how those problems are handled.

Important components
- VerifyError and VerifyWarning
  - Exception and warning classes used by the verification system to signal problems and to emit diagnostic messages.
- VERIFY_OPTIONS
  - A list of supported option strings that control verification behavior, such as "ignore", "warn", "exception", "fix", "silentfix", and combinations like "fix+warn" or "silentfix+ignore".
- _Verify
  - Shared methods for verification across classes.
  - run_option(option="warn", err_text="", fix_text="Fixed.", fix=None, fixable=True)
    - Execute the verification for a given option.
    - Returns a tuple (fixable, text) indicating whether the issue remained fixable and the text to report.
  - verify(option="warn")
    - Verify all values in the instance under the given option.
    - Parses the option, dispatches to the underlying verification logic, and handles reporting or raising errors according to the option semantics.

Usage notes
- The verification system can be directed to fix issues, report them as warnings, or raise errors, with combinations such as "fix+warn" or "fix+exception".
- If "ignore" is specified, verification does nothing.
- When issues are not fixable, messages can be prefixed with “Unfixable error:” to indicate non-fixable problems.

Notifier pattern (NotifierMixin)

Overview
- NotifierMixin is a mixin providing a lightweight observer/listener pattern.
- It allows objects to register listeners (subscribers) that should be notified when the object changes.
- Listeners are stored using weak references to avoid preventing garbage collection.

Key concepts
- _add_listener (internal usage)
  - Register a listener object that will be notified of changes.
  - Listeners must provide appropriate update methods (e.g., _update_change_type) corresponding to the events emitted.
- _notify(change_type, *args, **kwargs)
  - Notify all registered listeners of a change, invoking the corresponding update method on each listener if present.
- Intended usage
  - Used internally to propagate changes between components in the FITS I/O system without requiring users to manage the notification mechanics.
  - Implementations should use underscored methods, signaling that this is internal plumbing rather than part of the public API.

Notes
- The NotifierMixin emphasizes weak references for listeners to prevent memory leaks.
- It is designed for internal communication between classes rather than for direct user interaction.

Additional context

- These structures illustrate patterns used in the FITS I/O ecosystem for robust diagnostics (via nested error reporting) and for internal event handling (via the notifier mechanism).
- While not typical user-facing data structures, understanding them can aid in debugging and extending internal FITS handling code.

See also
- Documentation on verification flow and error handling in the FITS subsystem.
- Astropy troubleshooting and internal debugging guides for verification and event-driven patterns.