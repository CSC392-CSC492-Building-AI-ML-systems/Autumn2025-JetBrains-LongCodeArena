Storage (MongoDB backend)
==========================

Overview
--------
This module provides a MongoDB-backed storage service for ASAB. It depends on
pymongo and motor and uses a asynchronous MongoDB client to perform CRUD and
upsert operations. The storage configuration is read from the ASAB config under
the asab:storage section.

Configuration
-------------
Default configuration (added by asab.Config.add_defaults):

- asab:storage.mongodb_uri: mongodb://localhost:27017
- asab:storage.mongodb_database: asabdb

Notes:
- The database connection uses tz-aware codec options (tz_aware) with UTC tzinfo.

Classes
-------

StorageService(StorageServiceABC)
--------------------------------
MongoDB-backed implementation of the ASAB storage service.

Purpose:
- Provide access to MongoDB collections and simple get/delete operations.
- Create upsert handlers for object changes via MongoDBUpsertor.

Initialization:
- __init__(self, app, service_name, config_section_name='asab:storage')
  - Creates an AsyncIOMotorClient from the configured MongoDB URI.
  - Obtains the configured database with tz-aware codec options.
  - The Database object is stored as self.Database.

Key methods:
- upsertor(self, collection: str, obj_id=None, version=0) -> MongoDBUpsertor
  - Returns a MongoDBUpsertor instance configured for the given collection.

- get(self, collection: str, obj_id, decrypt=None) -> dict
  - Fetches a document by its _id from the specified collection.
  - Raises KeyError("NOT-FOUND") if not found.
  - If decrypt is provided, decrypts listed fields using aes_decrypt.

- get_by(self, collection: str, key: str, value, decrypt=None) -> dict
  - Fetches a document where the field key equals value.
  - Raises KeyError("NOT-FOUND") if not found.
  - If decrypt is provided, decrypts listed fields using aes_decrypt.

- collection(self, collection: str) -> motor.motor_asyncio.AsyncIOMotorCollection
  - Returns the underlying AsyncIOMotorCollection for custom operations.

- delete(self, collection: str, obj_id)
  - Deletes a document by _id.
  - Raises KeyError("NOT-FOUND") if no matching document exists.
  - Returns the deleted document's _id.

Usage example:
- storage = StorageService(app, "StorageService")
- coll = await storage.collection("test-collection")
- await storage.delete("test-collection", some_id)

MongoDBUpsertor(UpsertorABC)
-----------------------------
Upsert helper for atomic updates and upserts in MongoDB.

Purpose:
- Build and execute upsert/update operations against a MongoDB collection.
- Integrates with ASAB’s UpsertorABC base class (ModSet, ModInc, ModPush, ModUnset, etc.).

Key methods:
- generate_id() -> bson.objectid.ObjectId
  - Classmethod to generate a new ObjectId for insertion.

- execute(self, custom_data: Optional[dict] = None, event_type: Optional[str] = None)
  - Core method performing the upsert logic.
  - Builds update payloads from:
    - ModSet -> $set
    - ModInc -> $inc
    - ModPush -> $push with $each
    - ModUnset -> $unset
  - Determines the filter (filtr) based on ObjId and id_name, and applies versioning via _v.
  - If there are updates to apply, performs find_one_and_update with upsert behavior:
    - Upsert is true when Version is 0 or None.
    - Returns the document after update.
  - Handles DuplicateKeyError by raising DuplicateError with details when available.
  - If the operation returns None, raises KeyError("NOT-FOUND").
  - Updates self.ObjId with the resulting id on success.
  - If webhook integration is configured (Storage.WebhookURIs), publishes an upsertor_data payload containing:
    - collection, custom data, event_type
    - id_field_name, id, _v
    - set and inc fields, excluding internal keys (starting with "__")

Notes:
- The execute method relies on fields provided by UpsertorABC (ModSet, ModInc, ModPush, ModUnset, ObjId, Collection, Version, etc.).
- Decryption is handled in StorageService.get/get_by via aes_decrypt when requested.

Exceptions
----------
- KeyError("NOT-FOUND"): Raised when a document is not found for get/get_by/delete.
- DuplicateError: Raised when a duplicate key error occurs during upsert.

Dependencies
------------
- motor (Async I/O MongoDB driver)
- pymongo
- bson (ObjectId and codec options)

Related concepts
----------------
- decrypt parameter: If provided as a list of field names, those fields in the returned
  document are decrypted using the StorageService’s aes_decrypt method.
- Webhook integration: Optional notification payloads are sent when Storage.WebhookURIs is configured.

Examples
--------
- Retrieve a document by _id with selective decryption:
  ret = await storage.get("users", user_id, decrypt=["password"])

- Upsert a document into a collection:
  up = storage.upsertor("users", obj_id=current_id, version=0)
  up.ModSet = {"name": "Alice"}
  up.execute()

- Access a collection for custom operations:
  coll = await storage.collection("logs")
  cursor = coll.find({})

Notes on behavior
-----------------
- All operations interact with the configured MongoDB database and collections.
- Timezone-aware datetime handling is enabled via codec_options(tz_aware=True, tzinfo=datetime.timezone.utc).
- The module expects a base ASAB storage and upsert framework (StorageServiceABC, UpsertorABC) to be present.