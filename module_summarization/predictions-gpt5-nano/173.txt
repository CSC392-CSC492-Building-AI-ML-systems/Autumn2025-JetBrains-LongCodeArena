Fitting SESANS Data
====================

This section describes how to fit SESANS (Spin Echo Small-Angle Neutron Scattering) data using sasmodels. It covers the data representation, available models and parameters, fitting workflow, and basic guidance for diagnostics and interpretation.

Data representation
-------------------

SESANS data consist of measurements of the SESANS polarization (or related SESANS signal) as a function of spin-echo length z. Typical inputs are:

- z: spin-echo length (units commonly in nanometers or angstroms; ensure consistent units throughout the fit)
- P(z): measured SESANS polarization or the corresponding SESANS signal
- dP(z): uncertainties in P(z) (optional; used for weighting in the fit)

Data should be provided in a form suitable for fitting routines, with z and P(z) values and optional uncertainties. When using sasmodels, you generally supply the SESANS data along with a chosen model that predicts the SESANS signal as a function of z and model parameters.

Models and parameters
----------------------

SESANS fitting uses kernel-based models that describe the scattering length density distribution(s) of the system. Each model exposes a set of kernel parameters that control the shape and composition of the structure being modeled. Typical parameter kinds include:

- volume parameters (e.g., geometric dimensions, volume fractions)
- orientation parameters (e.g., orientational distributions)
- sld parameters (scattering length density)

Parameter handling in sasmodels
- The models expose a parameter table. Each parameter has a name and a kind (e.g., volume, orientation, sld).
- You can inspect the available parameters and their associated models with tools such as:
  - list_pars (to list parameters; use -v to show which models use each parameter)
  - load_model_info to inspect model details
- Example usage:
  - sasmodels.list_pars
  - sasmodels.list_pars -v

Fitting workflow
--------------

1. Prepare data
   - Load SESANS data: z, P(z), and uncertainties dP(z) if available.
   - Ensure units are consistent with the model expectations.

2. Choose a model
   - Select a SESANS-appropriate model that captures the structural features of the sample (e.g., core–shell, multilayer, or distribution-based representations).
   - Review the kernel parameters for the chosen model.

3. Configure parameters
   - Identify which parameters to fit (and which to fix). Typical fits vary geometric or contrast-related parameters while keeping certain physical quantities fixed if justified.
   - Set bounds and initial guesses for parameters to be optimized.

4. Run the fit
   - Use a fitting routine to minimize the discrepancy between the measured P(z) and the model-predicted SESANS signal.
   - Weigh data by uncertainties if provided.

5. Assess fit quality
   - Examine chi-squared, reduced chi-squared, residuals, and parameter uncertainties (covariance matrix).
   - Plot data vs. model predictions and residuals to evaluate fit adequacy.

6. Interpret results
   - Translate best-fit parameters into physical quantities (dimensions, contrasts, volume fractions, etc.).
   - Consider parameter correlations and potential model limitations.

Diagnostics and best practices
------------------------------

- Data coverage: Ensure adequate z-range coverage to constrain the chosen model (low-z and high-z information improve robustness).
- Parameter correlations: Be aware that some parameters may be strongly correlated; use bounds or fixed values when appropriate.
- Model selection: Start with simple models and progressively add complexity only if justified by significant improvement in fit quality.
- Uncertainty assessment: Use the covariance information or bootstrap techniques to gauge parameter uncertainties.
- Documentation: Record model choice, fixed/fitted parameters, units, and data preparation steps for reproducibility.

Example workflow (conceptual)

- Load SESANS data: z, P, dP
- Select model: e.g., core–shell sphere
- Inspect parameters: identify those to fit (e.g., core radius, shell thickness, contrasts)
- Set initial guesses and bounds
- Run fit to minimize residuals between P(z) and model(P(z); parameters)
- Analyze results: best-fit values, uncertainties, goodness-of-fit
- Plot P(z) data with the fitted model and residuals

Notes
- The parameter-space exploration and model inspection helpers (such as list_pars and load_model_info) are useful for preparing and validating fits.
- Ensure consistent units throughout the fitting process (length, SLD, etc.).