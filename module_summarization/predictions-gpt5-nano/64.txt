MigrateOperation and Constraint Operations
==========================================

This module defines the base migration operation class and concrete operation classes used to represent and manipulate schema constraint changes during migrations. It provides a small extensibility surface for adding and dropping constraints, and for converting these operations to a diff representation.

MigrateOperation
----------------

Base class for migration command and organization objects. This system is part of the operation extensibility API.

- Attributes
  - info: A memoized dictionary for storing arbitrary information alongside a MigrateOperation instance.
  - _mutations: A frozen set of Rewriter objects representing possible mutations.

- Methods
  - reverse(): Abstract. Return the operation that would reverse this operation.
  - to_diff_tuple(): Abstract. Return a serializable tuple representing this operation for diffs.

AddConstraintOp
---------------

Represents an add-constraint operation. Subclasses should implement the specifics of the constraint being added.

- Class attributes
  - add_constraint_ops: A dispatcher used to map constraint visit names to concrete implementations.

- Properties
  - constraint_type: Abstract. The type of constraint (e.g., "foreignkey", "unique", etc.).

- Class methods
  - register_add_constraint(type_: str) -> Callable: Decorator to register a concrete subclass for a given constraint visit name.
  - from_constraint(cls, constraint: Constraint) -> AddConstraintOp: Create an AddConstraintOp instance from a given constraint by dispatching on the constraint type.

- Instance methods
  - to_constraint(self, migration_context: Optional[MigrationContext] = None) -> Constraint: Abstract. Produce the runtime Constraint object representing this operation.
  - reverse(self) -> DropConstraintOp: Return the corresponding drop operation for this add operation.
  - to_diff_tuple(self) -> Tuple[str, Constraint]: Return a diff representation of this operation.

DropConstraintOp
----------------

Represents a drop-constraint operation. This class is registered as a runtime operation and a batch operation.

- Decorators
  - Operations.register_operation("drop_constraint")
  - BatchOperations.register_operation("drop_constraint", "batch_drop_constraint")

- Constructor
  - __init__(self, constraint_name: Optional[sqla_compat._ConstraintNameDefined], table_name: str, type_: Optional[str] = None, *, schema: Optional[str] = None, _reverse: Optional[AddConstraintOp] = None)

- Methods
  - reverse(self) -> AddConstraintOp: Return the corresponding add operation for this drop operation.
  - to_diff_tuple(self) -> Tuple[str, SchemaItem]: Produce a diff representation. For foreign keys, returns ("remove_fk", ...); otherwise returns ("remove_constraint", ...).
  - to_constraint(self) -> Constraint: Reconstruct the Constraint object from the stored reverse operation if available, applying the stored names and schema. Raises ValueError if the original constraint is not present.

- Class methods
  - from_constraint(cls, constraint: Constraint) -> DropConstraintOp: Create a DropConstraintOp from a Constraint, mapping SQLAlchemy visit names to internal type strings (e.g., "unique_constraint" -> "unique", "foreign_key_constraint" -> "foreignkey", etc.). Stores the corresponding AddConstraintOp as _reverse.

  - drop_constraint(cls, operations: Operations, constraint_name: str, table_name: str, type_: Optional[str] = None, *, schema: Optional[str] = None) -> None: Convenience to create and invoke a drop operation via an Operations context.

  - batch_drop_constraint(cls, operations: BatchOperations, constraint_name: str, type_: Optional[str] = None) -> None: Batch version of dropping a constraint, omitting table_name and schema as appropriate for batch operations.

Notes
- The AddConstraintOp and DropConstraintOp classes form a small framework to represent and reverse constraint changes during schema autogeneration and migration.
- The to_diff_tuple methods provide a way to serialize operations for representation in diffs.
- The from_constraint and to_constraint paths rely on sqla_compat helpers to map between SQLAlchemy constraint objects and internal representations.
- TYPE_CHECKING imports reveal the types used for static typing (e.g., Insert, Update, Constraint, Table, MigrationContext), but are not required at runtime.