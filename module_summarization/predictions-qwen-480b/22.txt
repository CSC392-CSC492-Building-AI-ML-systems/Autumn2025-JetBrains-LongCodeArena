.. _w_fluxanl:

``w_fluxanl``: Flux Analysis Tool
=================================

Overview
--------

The ``w_fluxanl`` tool extracts fluxes into pre-defined target states from WESTPA simulation data, computes averages, and constructs confidence intervals using Monte Carlo bootstrapping to account for correlated and possibly non-Gaussian statistical errors in flux measurements.

All non-graphical output assumes that the propagation/resampling period ``tau`` is equal to unity. To obtain results in familiar units, divide all fluxes and multiply all correlation lengths by the true value of ``tau``.

Usage
-----

.. code-block:: bash

    w_fluxanl [options]

Options
-------

Input/Output Options
~~~~~~~~~~~~~~~~~~~~

- ``-o FILE``, ``--output FILE``: Save output to HDF5 file ``FILE``.

Iteration Selection Options
~~~~~~~~~~~~~~~~~~~~~~~~~~~

- ``--first-iter N``: Begin analysis at iteration ``N`` (default: 1).
- ``--last-iter N``: Conclude analysis at iteration ``N`` (default: current iteration).

Analysis Options
~~~~~~~~~~~~~~~~

- ``--alpha ALPHA``: Set the confidence interval width to ``1 - ALPHA`` (default: 0.05, i.e., 95% CI).
- ``--autocorrel-alpha AUTOCORREL_ALPHA``: Set the significance level for autocorrelation analysis (default: 0.05).
- ``--n-sets N``: Use ``N`` bootstrap samples for Monte Carlo estimation (default: 1000).
- ``--evol``: Enable time evolution analysis.
- ``--evol-step N``: Set the step size for time evolution analysis (default: 1).

Description
-----------

``w_fluxanl`` reads WESTPA HDF5 files and extracts flux data associated with transitions into target states. It supports multiple file versions and handles differences in data storage formats accordingly.

The tool performs the following steps:

1. **Data Extraction**: Reads flux data from WESTPA HDF5 files for the specified iteration range.
2. **Flux Averaging**: Computes average flux values for each target state.
3. **Confidence Intervals**: Constructs confidence intervals using Monte Carlo bootstrapping to account for statistical uncertainties.
4. **Autocorrelation Analysis**: Estimates the correlation length of the flux time series.
5. **Optional Evolution Analysis**: If enabled, performs time-resolved flux analysis over the iteration range.

Output
------

Terminal Output
~~~~~~~~~~~~~~~

By default, ``w_fluxanl`` outputs a summary of flux statistics for each target state, including:

- Mean flux
- Confidence interval bounds
- Correlation length

HDF5 Output
~~~~~~~~~~~

If the ``-o`` option is specified, detailed results are saved to an HDF5 file with the following structure:

- ``/avg_fluxes``: Dataset containing averaged flux data for each target state.
- ``/flux_evolution`` (if ``--evol`` is enabled): Time-resolved flux data.
- Metadata attributes indicating analysis parameters and version information.

Data Format
-----------

The output data uses the following structured NumPy dtypes:

- ``fluxentry_dtype``: Contains fields for iteration number, flux value, and count.
- ``target_index_dtype``: Contains fields for target label, mean flux, confidence interval bounds, and correlation length.

Examples
--------

Basic flux analysis:

.. code-block:: bash

    w_fluxanl --first-iter 100 --last-iter 500

Flux analysis with custom output and evolution:

.. code-block:: bash

    w_fluxanl --first-iter 100 --last-iter 500 -o flux_results.h5 --evol --evol-step 5

Notes
-----

- The tool automatically detects the HDF5 file version and adapts the data extraction method accordingly.
- For file versions prior to version 7, flux data is extracted from the ``recycling`` table within iteration groups.
- For file version 7 and later, flux data is extracted from the ``new_weights`` group in the following iteration.
- Bootstrapping is used to estimate statistical uncertainties, which is particularly important for correlated data.
- The correlation length is estimated to help assess the effective sample size and guide interpretation of uncertainties.