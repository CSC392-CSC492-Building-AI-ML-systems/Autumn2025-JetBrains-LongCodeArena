Working with Entities
=====================

In the ftrack API, entities represent objects within the ftrack system such as projects, tasks, assets, and users. These entities are instances of classes that inherit from :class:`ftrack_api.entity.base.Entity`, and they provide a structured way to interact with data stored in ftrack.

Each entity is associated with a specific schema type (e.g., `Project`, `Task`, `User`) and contains attributes that correspond to fields in the ftrack database. You can access and modify these attributes directly, and changes will be tracked by the session for later commit to the server.

Creating Entities
-----------------

To create a new entity, use the :meth:`Session.create <ftrack_api.Session.create>` method. This method requires the schema type of the entity and an optional dictionary of initial attribute values.

Example:

.. code-block:: python

    session = ftrack_api.Session()
    project = session.create('Project', {
        'name': 'My New Project',
        'full_name': 'My New Project Full Name'
    })

This creates a new project entity in memory but does not immediately save it to the server. To persist the entity, you must commit the changes using the session.

Accessing Entities
------------------

You can retrieve existing entities from the server using the :meth:`Session.query <ftrack_api.Session.query>` method. This method accepts a query string that specifies the type of entity and any filtering criteria.

Example:

.. code-block:: python

    projects = session.query('Project where name is "My New Project"')

The result is a collection of entities matching the query. You can access individual entities from this collection or iterate over them.

Lazy Loading
~~~~~~~~~~~~

By default, entity attributes are loaded lazily. This means that when you access an attribute that has not yet been fetched from the server, the session will automatically retrieve it. This behavior can be controlled via the `auto_populate` parameter when creating the session.

Modifying Entities
------------------

Once you have an entity, you can modify its attributes by simply assigning new values. These changes are tracked by the session and will be sent to the server when you call :meth:`Session.commit <ftrack_api.Session.commit>`.

Example:

.. code-block:: python

    project['name'] = 'Updated Project Name'
    session.commit()

Deleting Entities
-----------------

To delete an entity, use the :meth:`Session.delete <ftrack_api.Session.delete>` method. Like other operations, the deletion is not applied until you commit the session.

Example:

.. code-block:: python

    session.delete(project)
    session.commit()

Entity Relationships
--------------------

Entities often have relationships with other entities. For example, a task belongs to a project, and an asset version is linked to a task. These relationships are represented as attributes on the entity and can be accessed just like other attributes.

Example:

.. code-block:: python

    task = session.query('Task where name is "Render Scene"').one()
    project = task['project']

In this example, accessing `task['project']` retrieves the project entity associated with the task.

Collections
~~~~~~~~~~~

Some relationships are one-to-many and are represented as collections. A collection behaves like a list and allows you to access related entities.

Example:

.. code-block:: python

    tasks = project['tasks']
    for task in tasks:
        print(task['name'])

Committing Changes
------------------

All changes made during a session—whether creating, updating, or deleting entities—are batched and not sent to the server until you explicitly commit them. Use the :meth:`Session.commit <ftrack_api.Session.commit>` method to send all pending operations to the server.

Example:

.. code-block:: python

    session.commit()

If there are any errors during the commit, an exception will be raised, and you can inspect the recorded operations to understand what went wrong.

Rolling Back Changes
--------------------

If you need to discard all uncommitted changes in a session, you can use the :meth:`Session.rollback <ftrack_api.Session.rollback>` method. This clears the list of pending operations and resets any modified entities to their original state.

Example:

.. code-block:: python

    session.rollback()

Closing Sessions
----------------

When you are finished working with a session, it's good practice to close it using the :meth:`Session.close <ftrack_api.Session.close>` method. This ensures that any resources used by the session are properly released.

Example:

.. code-block:: python

    session.close()

Summary
-------

Working with entities in the ftrack API involves creating, querying, modifying, and deleting objects that represent items in the ftrack system. All interactions occur within a session, which tracks changes and manages communication with the server. By understanding how to work with entities and their relationships, you can build powerful integrations and tools that interact with ftrack data efficiently.