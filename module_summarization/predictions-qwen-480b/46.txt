Storage Module
==============

This module provides an implementation of the storage service using MongoDB as the backend. It leverages `motor` for asynchronous operations and `pymongo` for core MongoDB functionalities.

Dependencies
------------
- `motor.motor_asyncio`: For asynchronous MongoDB operations.
- `pymongo`: For MongoDB utilities and exceptions.
- `bson`: For handling BSON data types.

Configuration
-------------
The module uses the following configuration options under the section `asab:storage`:

- `mongodb_uri`: The URI for connecting to the MongoDB instance (default: `mongodb://localhost:27017`).
- `mongodb_database`: The name of the database to use (default: `asabdb`).

Classes
-------

StorageService
~~~~~~~~~~~~~~

.. class:: StorageService(app, service_name, config_section_name='asab:storage')

   Implements the storage service using MongoDB.

   .. method:: upsertor(collection: str, obj_id=None, version=0)

      Creates and returns a MongoDB-specific upsertor object.

      :param collection: The name of the collection.
      :param obj_id: The object ID (optional).
      :param version: The version of the object (default: 0).

   .. method:: get(collection: str, obj_id, decrypt=None) -> dict

      Retrieves a document by its ID.

      :param collection: The name of the collection.
      :param obj_id: The ID of the document.
      :param decrypt: List of fields to decrypt (optional).
      :raises KeyError: If the document is not found.
      :return: The retrieved document.

   .. method:: get_by(collection: str, key: str, value, decrypt=None) -> dict

      Retrieves a document by a specific key-value pair.

      :param collection: The name of the collection.
      :param key: The field name to query.
      :param value: The value of the field.
      :param decrypt: List of fields to decrypt (optional).
      :raises KeyError: If the document is not found.
      :return: The retrieved document.

   .. method:: collection(collection: str) -> motor.motor_asyncio.AsyncIOMotorCollection

      Gets a MongoDB collection object for custom operations.

      :param collection: The name of the collection.
      :return: An `AsyncIOMotorCollection` object.

   .. method:: delete(collection: str, obj_id)

      Deletes a document by its ID.

      :param collection: The name of the collection.
      :param obj_id: The ID of the document.
      :raises KeyError: If the document is not found.
      :return: The ID of the deleted document.

MongoDBUpsertor
~~~~~~~~~~~~~~~

.. class:: MongoDBUpsertor

   Implements upsert operations for MongoDB.

   .. method:: generate_id()

      Generates a new MongoDB ObjectId.

      :return: A new `bson.objectid.ObjectId`.

   .. method:: execute(custom_data: typing.Optional[dict] = None, event_type: typing.Optional[str] = None)

      Executes the upsert operation.

      :param custom_data: Custom data to include in webhooks (optional).
      :param event_type: Type of event for webhooks (optional).
      :raises DuplicateError: If a duplicate key error occurs.
      :raises KeyError: If the object is not found during update.