Encoding Media
==============

Overview
--------

The ftrack API provides functionality for encoding media files, allowing you to manage and process media assets within your ftrack workflow. This documentation covers the core concepts and methods for encoding media using the ftrack API.

Session Management
------------------

To interact with ftrack's media encoding capabilities, you first need to establish a session with the ftrack server. The session handles authentication and provides access to the API's functionality.

Creating a Session
^^^^^^^^^^^^^^^^^^

A session is created using the ``Session`` class, which requires authentication credentials and server information:

.. code-block:: python

    import ftrack_api
    
    session = ftrack_api.Session(
        server_url='https://your-company.ftrackapp.com',
        api_key='your-api-key',
        api_user='your-username'
    )

Authentication
^^^^^^^^^^^^^^

Authentication is handled through API keys and user credentials. These can be provided directly when creating a session or through environment variables:

- ``FTRACK_SERVER``: The ftrack server URL
- ``FTRACK_API_KEY``: Your API key
- ``FTRACK_API_USER``: Your ftrack username

Media Encoding Workflow
-----------------------

The media encoding process involves several steps:

1. **File Registration**: Registering media files with ftrack
2. **Encoding Job Creation**: Creating encoding jobs for registered files
3. **Job Monitoring**: Tracking the progress of encoding jobs
4. **Result Handling**: Managing encoded media files

Registering Media Files
^^^^^^^^^^^^^^^^^^^^^^^

Before encoding media, you need to register the source files with ftrack. This typically involves creating a location and registering the file components.

.. code-block:: python

    # Create a location for the media files
    location = session.query('Location where name is "ftrack.server"').one()
    
    # Register a component with the location
    component = session.create_component(
        path='/path/to/your/media/file.mp4',
        location=location
    )

Creating Encoding Jobs
^^^^^^^^^^^^^^^^^^^^^^

Once files are registered, you can create encoding jobs to process them:

.. code-block:: python

    # Create an encoding job
    job = session.create('Job', {
        'type': 'encode',
        'status': 'queued',
        'data': json.dumps({
            'component_id': component['id'],
            'output_format': 'mp4',
            'preset': 'high_quality'
        })
    })
    
    session.commit()

Monitoring Encoding Jobs
^^^^^^^^^^^^^^^^^^^^^^^^

You can monitor the status of encoding jobs by querying job entities:

.. code-block:: python

    # Query job status
    job = session.query(
        'Job where id is "{0}"'.format(job['id'])
    ).one()
    
    print('Job status:', job['status'])

Supported Formats and Presets
-----------------------------

ftrack supports various media formats and encoding presets. Common formats include:

- MP4
- MOV
- AVI
- WebM

Encoding presets define the quality and compression settings for the output media. Available presets typically include:

- ``high_quality``: High quality output with larger file sizes
- ``medium_quality``: Balanced quality and file size
- ``low_quality``: Lower quality with smaller file sizes
- ``web_optimized``: Optimized for web streaming

Best Practices
--------------

1. **Error Handling**: Always implement proper error handling when working with media encoding:

.. code-block:: python

    try:
        # Encoding operations
        session.commit()
    except ftrack_api.exception.NotUniqueError:
        session.rollback()
        # Handle duplicate error
    except Exception as e:
        session.rollback()
        # Handle other errors

2. **Resource Management**: Close sessions when done to free up resources:

.. code-block:: python

    session.close()

3. **Batch Processing**: For multiple files, consider batch processing to optimize performance:

.. code-block:: python

    with session.auto_populating(False):
        # Process multiple files
        for file_path in file_paths:
            # Create components and jobs
            pass
        session.commit()

Troubleshooting
---------------

Common issues when encoding media include:

1. **Authentication Errors**: Verify your API credentials and server URL
2. **File Access Issues**: Ensure ftrack can access the source media files
3. **Format Compatibility**: Check that your source format is supported
4. **Storage Limitations**: Verify sufficient storage space for encoded files

For detailed error information, check the job logs in ftrack or enable debug logging in your API session.