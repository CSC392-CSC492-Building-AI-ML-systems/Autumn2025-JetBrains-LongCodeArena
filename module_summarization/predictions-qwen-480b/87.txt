# Running Migrations Backwards

This module provides functionality to reverse/undo database migrations in Piccolo applications.

## Overview

The backwards migration system allows you to undo previously applied migrations, either for a specific app or across all apps. It includes safety features like user confirmation prompts and preview modes.

## Main Functions

### `backwards()`

The primary entry point for running backwards migrations.

**Parameters:**
- `app_name` (str): The app to reverse migrations for. Use 'all' to reverse migrations for all apps.
- `migration_id` (str, default='1'): Migrations will be reversed up to and including this migration_id. Use 'all' to undo all migrations or '1' to undo the most recent migration.
- `auto_agree` (bool, default=False): If True, automatically agree to any input prompts.
- `clean` (bool, default=False): If True, delete migration files from disk after running backwards.
- `preview` (bool, default=False): If True, print SQL queries without actually running the migration.

### `run_backwards()`

Async function that performs the backwards migration logic and returns a `MigrationResult`.

**Parameters:**
- `app_name` (str): The app to reverse migrations for.
- `migration_id` (str, default='1'): The target migration ID to reverse to.
- `auto_agree` (bool, default=False): Skip user confirmation prompts.
- `clean` (bool, default=False): Delete migration files after completion.
- `preview` (bool, default=False): Preview mode without executing.

## Classes

### `BackwardsMigrationManager`

Manages the backwards migration process for a specific app.

**Methods:**
- `run_migrations_backwards(app_config)`: Executes the backwards migration process.
- `run()`: Main execution method that creates migration table and runs backwards migrations.

### `CheckMigrationManager`

Used to check the status of migrations (inherited from BaseMigrationManager).

### `MigrationStatus`

Data class representing the status of a migration:
- `app_name`: Name of the application
- `migration_id`: Unique identifier for the migration
- `description`: Description of the migration
- `has_ran`: Boolean indicating if the migration has been executed

## Usage Examples

```python
# Reverse the most recent migration for a specific app
await backwards(app_name="my_app")

# Reverse all migrations for all apps (with auto-confirmation)
await backwards(app_name="all", migration_id="all", auto_agree=True)

# Preview what would happen without actually running
await backwards(app_name="my_app", preview=True)

# Reverse migrations and clean up migration files
await backwards(app_name="my_app", clean=True)
```

## Safety Features

- **User Confirmation**: By default, the system prompts for confirmation before reversing migrations
- **Preview Mode**: Allows you to see the SQL that would be executed without actually running it
- **Error Handling**: Graceful handling of cases where no migrations exist or invalid migration IDs are provided
- **Clean Option**: Optional deletion of migration files after successful reversal

## Return Values

Functions return `MigrationResult` objects containing:
- `success`: Boolean indicating if the operation succeeded
- `message`: Descriptive message about the operation result