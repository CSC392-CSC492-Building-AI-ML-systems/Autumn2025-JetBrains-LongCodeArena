A Quick Dive into Using the API
===============================

The ftrack API provides a powerful and flexible way to interact with your ftrack server programmatically. This tutorial will guide you through the basics of setting up a session and performing common operations.

Setting Up a Session
--------------------

To begin interacting with the ftrack API, you first need to create a session. The session handles authentication, caching, and communication with the server.

Here's how to create a basic session:

.. code-block:: python

    import ftrack_api

    session = ftrack_api.Session(
        server_url='https://your-company.ftrackapp.com',
        api_key='your-api-key',
        api_user='your-username'
    )

If you have the appropriate environment variables set (``FTRACK_SERVER``, ``FTRACK_API_KEY``, and ``FTRACK_API_USER``), you can create a session without passing these parameters:

.. code-block:: python

    session = ftrack_api.Session()

Environment variables provide a convenient way to configure your connection without hardcoding credentials in your scripts.

Authentication
--------------

The ftrack API uses API keys for authentication. You can generate API keys for your user account through the ftrack web interface under System Settings > Security.

When creating a session, you can either pass the ``api_key`` and ``api_user`` directly or rely on environment variables:

.. code-block:: python

    # Using environment variables
    session = ftrack_api.Session()

    # Passing credentials explicitly
    session = ftrack_api.Session(
        server_url='https://your-company.ftrackapp.com',
        api_key='your-api-key',
        api_user='your-username'
    )

Querying Data
-------------

Once you have a session, you can start querying data from ftrack. The query method allows you to retrieve entities using ftrack's query language:

.. code-block:: python

    # Query a single project by name
    project = session.query(
        'Project where name is "My Project"'
    ).one()

    # Query multiple tasks
    tasks = session.query(
        'Task where project.name is "My Project" and status.name is "Approved"'
    ).all()

    # Query with sorting and limiting
    recent_assets = session.query(
        'AssetVersion order by date desc limit 10'
    ).all()

Creating Entities
-----------------

Creating new entities is straightforward with the create method:

.. code-block:: python

    # Create a new project
    project = session.create('Project', {
        'name': 'New Project',
        'full_name': 'Our new exciting project',
        'project_schema': session.query('ProjectSchema').first()
    })

    # Create a task
    task = session.create('Task', {
        'name': 'Animation',
        'parent': project,
        'task_type': session.query('Type where name is "Animation"').one()
    })

    # Commit the changes to the server
    session.commit()

Modifying Entities
------------------

To modify existing entities, simply change their attributes and commit the changes:

.. code-block:: python

    # Query an existing task
    task = session.query('Task where name is "Animation"').one()
    
    # Modify attributes
    task['name'] = 'New Animation Task'
    task['description'] = 'This is our animation task'
    
    # Commit changes
    session.commit()

Deleting Entities
-----------------

Deleting entities is done using the delete method:

.. code-block:: python

    # Query the entity to delete
    task = session.query('Task where name is "Old Task"').one()
    
    # Delete the entity
    session.delete(task)
    
    # Commit the deletion
    session.commit()

Working with Relationships
--------------------------

ftrack entities are connected through relationships. You can navigate these relationships easily:

.. code-block:: python

    # Get a project
    project = session.query('Project where name is "My Project"').one()
    
    # Access related entities
    tasks = project['tasks']
    sequences = project['sequences']
    
    # Navigate backwards
    task = session.query('Task').first()
    parent = task['parent']
    project = task['project']

Caching
-------

The session includes built-in caching to improve performance. By default, a memory cache is used, but you can configure custom caching strategies:

.. code-block:: python

    # Create session with custom cache
    custom_cache = ftrack_api.cache.MemoryCache()
    session = ftrack_api.Session(
        cache=custom_cache
    )

Event System
------------

ftrack's event system allows you to subscribe to and publish events:

.. code-block:: python

    # Subscribe to an event
    def my_callback(event):
        print("Received event:", event)
    
    session.event_hub.subscribe('topic=example.topic', my_callback)
    
    # Publish an event
    event = ftrack_api.event.base.Event(
        topic='example.topic',
        data={'message': 'Hello world'}
    )
    session.event_hub.publish(event)

Best Practices
--------------

1. **Always commit your changes**: Remember to call ``session.commit()`` after making changes to ensure they're saved to the server.

2. **Handle exceptions**: Wrap your API calls in try-except blocks to handle potential errors gracefully.

3. **Use environment variables**: Store your credentials in environment variables rather than hardcoding them.

4. **Close sessions**: Although sessions are automatically cleaned up, it's good practice to explicitly close them when done:

.. code-block:: python

    session.close()

This quick dive covers the fundamentals of using the ftrack API. For more detailed information about specific features, refer to the complete API documentation.