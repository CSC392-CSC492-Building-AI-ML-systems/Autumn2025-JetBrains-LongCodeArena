Querying
========

The ftrack API provides a powerful querying mechanism to retrieve entities from the ftrack server. Queries are performed through the :class:`ftrack_api.Session` object, which acts as the main interface for interacting with the ftrack server.

Basic Querying
--------------

To query entities, use the :meth:`Session.query<ftrack_api.Session.query>` method. This method accepts a query string that specifies the type of entity to retrieve and any filtering criteria.

Example:

.. code-block:: python

    import ftrack_api

    session = ftrack_api.Session()
    projects = session.query('Project')

This example retrieves all Project entities from the server.

Filtering Results
-----------------

You can filter query results by adding conditions to the query string. Conditions are specified using attribute names and comparison operators.

Example:

.. code-block:: python

    project = session.query('Project where name is "MyProject"').one()

This example retrieves a single Project entity where the name attribute matches "MyProject".

Supported operators include:

- ``is`` or ``=``: Equality
- ``is_not`` or ``!=``: Inequality
- ``<``, ``<=``, ``>``, ``>=``: Comparison operators
- ``in``: Membership
- ``like``: Pattern matching (SQL LIKE operator)

Sorting Results
---------------

To sort query results, use the ``order by`` clause in your query string.

Example:

.. code-block:: python

    tasks = session.query('Task order by created_at')

This example retrieves all Task entities sorted by their creation date in ascending order. To sort in descending order, use ``order by -created_at``.

Limiting Results
----------------

To limit the number of results returned by a query, use the ``limit`` clause.

Example:

.. code-block:: python

    tasks = session.query('Task limit 10')

This example retrieves the first 10 Task entities.

Combining Clauses
-----------------

You can combine multiple clauses in a single query.

Example:

.. code-block:: python

    tasks = session.query(
        'Task where status.name is "Approved" order by created_at limit 5'
    )

This example retrieves the first 5 Task entities with an "Approved" status, sorted by creation date.

Accessing Related Entities
--------------------------

The ftrack API supports querying related entities through relationships. You can access related entities by specifying the relationship in the query.

Example:

.. code-block:: python

    project = session.query('Project where name is "MyProject"').one()
    tasks = session.query(
        'Task where project.id is "{0}"'.format(project['id'])
    )

This example first retrieves a Project entity, then queries for all Task entities related to that project.

Query Methods
-------------

The :meth:`Session.query<ftrack_api.Session.query>` method returns a :class:`ftrack_api.QueryResult` object, which provides several methods for handling the results:

- ``all()``: Returns all results as a list
- ``one()``: Returns exactly one result, raising an exception if zero or more than one result is found
- ``first()``: Returns the first result or None if no results are found
- ``one_or_none()``: Returns one result or None if no results are found, raising an exception if more than one result is found

Example:

.. code-block:: python

    # Get all results
    all_projects = session.query('Project').all()

    # Get exactly one result
    project = session.query('Project where name is "MyProject"').one()

    # Get the first result
    first_task = session.query('Task').first()

    # Get one or no result
    project = session.query(
        'Project where name is "NonExistentProject"'
    ).one_or_none()

Performance Considerations
--------------------------

When querying large datasets, consider the following performance tips:

1. Use specific filters to reduce the number of results returned from the server
2. Limit the number of results when you don't need all entities
3. Use projections to fetch only the attributes you need
4. Enable caching when appropriate to reduce server requests

Projections
-----------

To optimize performance, you can specify which attributes to fetch using projections. This reduces the amount of data transferred from the server.

Example:

.. code-block:: python

    projects = session.query('select id, name from Project')

This example retrieves only the id and name attributes for all Project entities.

Error Handling
--------------

Query operations may raise exceptions in case of errors:

- :class:`ftrack_api.exception.QueryError`: Raised when there's an error in the query syntax
- :class:`ftrack_api.exception.NoResultFoundError`: Raised when no results are found for a ``one()`` query
- :class:`ftrack_api.exception.MultipleResultsFoundError`: Raised when multiple results are found for a ``one()`` query

Always handle these exceptions appropriately in your code to ensure robust applications.