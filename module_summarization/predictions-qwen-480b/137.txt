ImPACT - Image Pixel-wise fit for Atmospheric Cherenkov Telescopes
==================================================================

Overview
--------

ImPACT (Image Pixel-wise fit for Atmospheric Cherenkov Telescopes) is a reconstruction algorithm used in the analysis of data from Imaging Atmospheric Cherenkov Telescopes (IACTs). It implements a Monte Carlo template-based image fitting method originally described in [parsons14]_. This approach compares observed shower images with a library of pre-simulated templates to perform a maximum likelihood fit for key shower parameters such as the shower axis, energy, and depth of maximum.

The method is computationally intensive but provides accurate reconstruction by leveraging detailed simulations of the atmospheric shower development and detector response.

Key Features
------------

- **Template-based fitting**: Uses pre-computed libraries of simulated shower images.
- **Maximum likelihood estimation**: Performs fits by maximizing the likelihood of observed data given the model predictions.
- **Shower geometry and energy reconstruction**: Simultaneously reconstructs shower direction, core position, energy, and depth of maximum.
- **Support for multiple telescope types**: Handles different camera types through dedicated template interpolators.

Algorithm Description
---------------------

The ImPACT algorithm works by comparing the measured image in each telescope with predictions generated from a library of simulated templates. These templates are functions of:

- Shower energy
- Depth of maximum (:math:`X_\max`)
- Impact distance and angle
- Telescope pointing and atmospheric conditions

For a given set of shower parameters, the expected image in each pixel is computed by interpolating within the template library. A likelihood function is then constructed based on the difference between the predicted and observed images. This likelihood is minimized to find the best-fit shower parameters.

The likelihood function used is based on a Poisson likelihood with Gaussian approximations for computational efficiency:

.. math::

   \log \mathcal{L} = \sum_{i} \left( \mu_i - n_i + n_i \log \left( \frac{n_i}{\mu_i} \right) \right)

where :math:`\mu_i` is the predicted signal in pixel :math:`i` and :math:`n_i` is the observed signal.

Priors
------

To improve the stability and accuracy of the reconstruction, optional priors can be applied on:

- **Energy**: A power-law prior based on the expected spectral index.
- **Depth of Maximum (:math:`X_\max`)**: A Gaussian prior centered on the expected :math:`X_\max` for a given energy, based on the Gaisser-Hillas parametrization.

These priors are configurable and can be enabled or customized depending on the analysis requirements.

Implementation Details
----------------------

The implementation avoids the use of `astropy` units internally for performance reasons. Instead, fixed units are used throughout the class:

- Angular units: radians
- Distance units: meters
- Energy units: TeV

Template Interpolation
----------------------

Templates are stored for different telescope types and interpolated at runtime to predict the expected image for a given set of shower parameters. The interpolation is handled by the `TemplateNetworkInterpolator` class, which supports efficient lookup and interpolation in multi-dimensional parameter space.

Time Gradient Support
---------------------

In addition to the image amplitude templates, the algorithm can also use time gradient information if available. This is handled by the `TimeGradientInterpolator` class, which provides predictions for the expected time gradients across the image.

Configuration
-------------

The `ImPACTReconstructor` class can be configured with the following options:

- `root_dir`: Directory containing the template files.
- `minimiser`: Choice of minimisation algorithm (`minuit` or `scipy`).
- `prior`: Enable or disable the use of priors.
- `template_scale`: Scaling factor for the templates (to correct for discrepancies).
- `xmax_offset`: Offset applied to the :math:`X_\max` prediction.
- `use_time_gradient`: Enable or disable the use of time gradient information.

References
----------

.. [parsons14] Parsons & Hinton, Astroparticle Physics 56 (2014), pp. 26-34

See Also
--------

- :py:class:`~ctapipe.image.TemplateNetworkInterpolator`
- :py:class:`~ctapipe.image.TimeGradientInterpolator`
- :py:func:`ctapipe.utils.fitshistogram.FITSHistogram`