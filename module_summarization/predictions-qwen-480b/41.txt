How to Use QuerySet to Build Your Queries
=========================================

Tortoise ORM provides a powerful and flexible QuerySet interface for building database queries. QuerySets allow you to retrieve, filter, and manipulate data from your database in a Pythonic way.

Creating a QuerySet
-------------------

To create a QuerySet, you typically start with a model class:

.. code-block:: python

    from tortoise.models import Model
    from tortoise import fields

    class User(Model):
        id = fields.IntField(pk=True)
        name = fields.CharField(max_length=50)
        email = fields.CharField(max_length=100)

    # Create a QuerySet for all users
    users = User.all()

Basic Query Operations
----------------------

Filtering Results
^^^^^^^^^^^^^^^^^

Use ``filter()`` to narrow down your results:

.. code-block:: python

    # Get all users with name 'John'
    johns = User.filter(name='John')

    # Get users with name 'John' and email containing 'gmail'
    johns_gmail = User.filter(name='John', email__contains='gmail')

    # Using Q objects for complex queries
    from tortoise.query_utils import Q
    
    complex_query = User.filter(
        Q(name='John') | Q(name='Jane')
    )

Ordering Results
^^^^^^^^^^^^^^^^

Order your QuerySet results:

.. code-block:: python

    # Order by name ascending
    users_by_name = User.all().order_by('name')

    # Order by name descending
    users_by_name_desc = User.all().order_by('-name')

    # Multiple ordering
    ordered_users = User.all().order_by('name', '-id')

Limiting Results
^^^^^^^^^^^^^^^^

Limit the number of results returned:

.. code-block:: python

    # Get first 10 users
    first_ten = User.all().limit(10)

    # Get 10 users starting from the 6th
    paginated = User.all().offset(5).limit(10)

Selecting Specific Fields
^^^^^^^^^^^^^^^^^^^^^^^^^

Use ``only()`` to select only specific fields:

.. code-block:: python

    # Only fetch name and email fields
    partial_users = User.all().only('name', 'email')

Annotating Queries
^^^^^^^^^^^^^^^^^^

Add computed fields to your QuerySet:

.. code-block:: python

    from tortoise.functions import Count
    
    # Annotate with count of related objects
    users_with_post_count = User.all().annotate(
        post_count=Count('posts')
    )

Prefetching Related Objects
^^^^^^^^^^^^^^^^^^^^^^^^^^^

Optimize queries by prefetching related data:

.. code-block:: python

    # Prefetch related posts
    users_with_posts = User.all().prefetch_related('posts')

    # Prefetch with more control
    from tortoise.query_utils import Prefetch
    
    users_with_filtered_posts = User.all().prefetch_related(
        Prefetch('posts', queryset=Post.filter(published=True))
    )

Executing Queries
-----------------

QuerySets are lazy and are only executed when you access their results:

.. code-block:: python

    # These don't hit the database yet
    queryset = User.filter(name='John')
    ordered_queryset = queryset.order_by('id')

    # These execute the query
    users = await queryset
    user_count = await queryset.count()
    first_user = await queryset.first()
    single_user = await queryset.get()

QuerySet Methods
----------------

Here are the key methods available on QuerySets:

- ``filter(*args, **kwargs)``: Filter results based on conditions
- ``exclude(*args, **kwargs)``: Exclude results based on conditions
- ``order_by(*orderings)``: Order results by fields
- ``limit(limit)``: Limit the number of results
- ``offset(offset)``: Offset the results
- ``distinct()``: Return distinct results
- ``only(*fields)``: Select only specific fields
- ``annotate(**kwargs)``: Add annotations to the QuerySet
- ``prefetch_related(*args)``: Prefetch related objects
- ``first()``: Get the first result or None
- ``get()``: Get exactly one result (raises exception if not found or multiple found)
- ``count()``: Count the number of results
- ``exists()``: Check if any results exist

Advanced Querying
-----------------

Aggregation
^^^^^^^^^^^

Perform aggregations on your data:

.. code-block:: python

    from tortoise.functions import Avg, Sum, Max, Min
    
    # Average age of users
    avg_age = await User.all().annotate(
        avg_age=Avg('age')
    ).first()
    
    # Total sum of all user scores
    total_score = await User.all().annotate(
        total=Sum('score')
    ).first()

Complex Joins
^^^^^^^^^^^^^

Tortoise ORM handles joins automatically when you filter or order by related fields:

.. code-block:: python

    # This automatically joins with the related model
    users_with_published_posts = User.filter(posts__published=True)

Subqueries
^^^^^^^^^^

Use subqueries for more complex operations:

.. code-block:: python

    # Users who have posts
    users_with_posts = User.filter(
        id__in=Post.all().distinct().values_list('author_id', flat=True)
    )

Query Optimization
------------------

To optimize your queries:

1. Use ``only()`` to select only needed fields
2. Use ``prefetch_related()`` to avoid N+1 queries
3. Use ``select_related()`` for foreign key relationships
4. Limit results with ``limit()`` when possible
5. Use annotations instead of fetching all related data

.. code-block:: python

    # Optimized query
    optimized = User.all().only(
        'id', 'name'
    ).prefetch_related(
        'posts'
    ).limit(20)

This documentation covers the basics of using QuerySets in Tortoise ORM. For more detailed information about specific methods and advanced features, refer to the API documentation.