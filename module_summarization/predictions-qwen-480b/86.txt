PostgreSQL Engine
=================

The PostgreSQL engine provides asynchronous database connectivity for Piccolo applications using the `asyncpg` library. It supports transactions, batching, and connection pooling.

Engine
------

.. autoclass:: piccolo.engine.postgres.PostgresEngine
   :members:
   :undoc-members:
   :show-inheritance:

   .. automethod:: __init__

Transaction Management
----------------------

PostgreSQL transactions provide ACID compliance and support nested transactions through savepoints.

.. autoclass:: piccolo.engine.postgres.PostgresTransaction
   :members:
   :undoc-members:
   :show-inheritance:

   .. automethod:: __init__
   .. automethod:: __aenter__
   .. automethod:: __aexit__

Savepoints
----------

Savepoints allow for partial rollbacks within a transaction.

.. autoclass:: piccolo.engine.postgres.Savepoint
   :members:
   :undoc-members:
   :show-inheritance:

   .. automethod:: __init__

Atomic Operations
-----------------

The Atomic class allows building transactions programmatically by adding queries.

.. autoclass:: piccolo.engine.postgres.Atomic
   :members:
   :undoc-members:
   :show-inheritance:

   .. automethod:: __init__
   .. automethod:: __await__

Batch Operations
----------------

Batch processing allows for efficient retrieval of large datasets in chunks.

.. autoclass:: piccolo.engine.postgres.AsyncBatch
   :members:
   :undoc-members:
   :show-inheritance:

   .. automethod:: __init__
   .. automethod:: __aiter__
   .. automethod:: __anext__
   .. automethod:: __aenter__
   .. automethod:: __aexit__

Usage Examples
--------------

Basic Transaction
~~~~~~~~~~~~~~~~~

.. code-block:: python

    async with engine.transaction():
        # Run some queries:
        await Band.select().run()

Atomic Transactions
~~~~~~~~~~~~~~~~~~~

.. code-block:: python

    transaction = engine.atomic()
    transaction.add(Foo.create_table())

    # Either:
    transaction.run_sync()
    await transaction.run()

Batch Processing
~~~~~~~~~~~~~~~~

.. code-block:: python

    async with engine.batch(query, batch_size=100) as batch:
        async for batch_data in batch:
            # Process batch_data
            pass