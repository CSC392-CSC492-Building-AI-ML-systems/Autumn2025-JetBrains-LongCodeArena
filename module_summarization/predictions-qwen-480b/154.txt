Connecting Steps Together
=========================

In mflowgen, steps are connected together to form a build graph that defines the flow of data and execution order. Each step can have inputs and outputs, and these are used to establish connections between steps. This section describes how to connect steps together using the mflowgen API.

Step Handles
------------

To connect steps, you first need to obtain handles to their inputs and outputs. A handle is a tuple that uniquely identifies an input or output of a step. Handles are used with the ``connect`` method of the ``Graph`` class to establish connections.

Each step provides methods to retrieve input and output handles:

- ``get_input_handle(name)``: Returns a handle for the specified input.
- ``get_output_handle(name)``: Returns a handle for the specified output.
- ``i(name)``: Syntactic sugar for ``get_input_handle``.
- ``o(name)``: Syntactic sugar for ``get_output_handle``.

For example, if you have a step ``foo`` with an output ``bar.txt``, you can get a handle to that output using:

.. code-block:: python

    foo.o('bar.txt')

Similarly, if another step ``baz`` has an input ``qux.txt``, you can get a handle to that input using:

.. code-block:: python

    baz.i('qux.txt')

Connecting Handles
------------------

Once you have input and output handles, you can connect them using the ``connect`` method of the ``Graph`` class. The ``connect`` method takes two arguments: the source handle (output) and the destination handle (input).

.. code-block:: python

    graph.connect(foo.o('bar.txt'), baz.i('qux.txt'))

This establishes a dependency such that the output ``bar.txt`` from step ``foo`` will be linked to the input ``qux.txt`` of step ``baz``. The graph will ensure that ``foo`` runs before ``baz`` and that the file ``bar.txt`` is available as ``qux.txt`` when ``baz`` executes.

Batch Connections
-----------------

To simplify connecting multiple inputs or outputs by name, steps provide methods to retrieve all input or output handles at once:

- ``all_input_handles()``: Returns a list of handles for all inputs.
- ``all_output_handles()``: Returns a list of handles for all outputs.

These can be used to automate connections when steps have matching input and output names.

.. code-block:: python

    for src, dst in zip(step1.all_output_handles(), step2.all_input_handles()):
        graph.connect(src, dst)

This pattern is useful when you want to connect all outputs of one step to all inputs of another step in a one-to-one mapping.

Extending Inputs and Outputs
----------------------------

Steps can also be dynamically extended with new inputs or outputs using the following methods:

- ``extend_inputs(new_list)``: Adds new inputs to the step.
- ``extend_outputs(new_list)``: Adds new outputs to the step.

This is useful when you need to modify a step's interface at runtime, for example, to add new data dependencies.

.. code-block:: python

    step.extend_inputs(['new_input.txt'])
    step.extend_outputs(['new_output.txt'])

Once extended, these new inputs and outputs can be connected just like any other handles.

Summary
-------

Connecting steps in mflowgen involves:

1. Obtaining handles to step inputs and outputs.
2. Using the ``Graph.connect`` method to link output handles to input handles.
3. Optionally using batch methods or dynamic extensions to simplify or enhance connections.

This mechanism allows you to build complex workflows by connecting simple, reusable steps.