.. _w_fork:

``w_fork``: Fork a Weighted Ensemble Simulation
==============================================

The ``w_fork`` command is used to create a new weighted ensemble (WE) simulation based on an existing one at a specified iteration. This is useful for restarting or branching simulations, such as when exploring new regions of phase space or testing different dynamics while preserving the statistical properties of the original simulation up to a certain point.

The command generates a new HDF5 file containing the initial data for the forked simulation. It also creates a mapping between the segments of the original simulation and the initial states of the new simulation, which can be saved to a text file for reference.

Usage
-----

.. code-block:: bash

    w_fork [-h] [-i INPUT_H5FILE] [-I N_ITER] [-o OUTPUT_H5FILE] [--istate-map ISTATE_MAP] [--no-headers]

Options
-------

- ``-h``, ``--help``: Show help message and exit.
- ``-i INPUT_H5FILE``, ``--input INPUT_H5FILE``: 
    Path to the input HDF5 file from which to fork the simulation. If not provided, the file specified in the WESTPA configuration will be used.
- ``-I N_ITER``, ``--iteration N_ITER``: 
    The iteration number from which to take the initial distribution for the new simulation. By default, the last complete iteration is used.
- ``-o OUTPUT_H5FILE``, ``--output OUTPUT_H5FILE``: 
    Path to the output HDF5 file for the new simulation. Defaults to ``forked.h5``.
- ``--istate-map ISTATE_MAP``: 
    Path to a text file where the mapping of old segments to new initial states will be written. Defaults to ``istate_map.txt``.
- ``--no-headers``: 
    If specified, headers will not be written to the initial state mapping file.

Description
-----------

``w_fork`` prepares a new weighted ensemble simulation by extracting the final states (segments) from a given iteration of an existing simulation and converting them into initial states for a new simulation. The new simulation will begin at iteration 1, with each initial state corresponding to a segment from the original simulation.

The following data is copied or transformed:

- **Target states** and **basis states** from the original simulation are copied to the new HDF5 file.
- Each segment from the selected iteration in the original simulation is converted into:
    - An **initial state** in the new simulation.
    - A **new segment** in iteration 1 of the new simulation, with appropriate weights and parent-child relationships.
- A **state mapping** is written to a text file (by default ``istate_map.txt``), showing how each segment from the original simulation maps to an initial state in the new simulation.

This mapping is particularly useful when using executable propagation, as it allows users to correctly set up restart data for the new simulation by linking old segment data to new initial states.

Example
-------

To fork a simulation from the last complete iteration of the default HDF5 file:

.. code-block:: bash

    w_fork

To fork from a specific iteration of a given HDF5 file and save to a custom output file:

.. code-block:: bash

    w_fork -i old_simulation.h5 -I 50 -o new_simulation.h5 --istate-map segment_to_istate.map

This will:

- Use ``old_simulation.h5`` as the source.
- Fork from iteration 50.
- Save the new simulation data to ``new_simulation.h5``.
- Write the segment-to-initial-state mapping to ``segment_to_istate.map``.

Notes
-----

- The user is responsible for preparing the new simulation directory, especially ensuring that restart data from the original simulation is accessible as initial state data for the new one.
- The new simulation begins at iteration 1, regardless of the iteration from which it was forked.
- Basis and target states are carried over from the original simulation. If changes are needed, they can be made using other tools such as ``w_assign`` or ``w_binning``.