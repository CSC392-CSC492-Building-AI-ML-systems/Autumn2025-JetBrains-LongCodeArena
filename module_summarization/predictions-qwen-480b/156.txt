How Mitogen Works
=================

Mitogen is a Python library for building distributed systems, with a focus on
efficiency and minimal overhead. It enables Python programs to execute code in
remote processes or machines and communicate with them transparently.

Core Concepts
-------------

At its heart, Mitogen uses a message-passing model to coordinate work between
processes. Each process involved in a Mitogen-based system is referred to as a
"context". Contexts can be local (running on the same machine) or remote
(running on a different machine). Communication between contexts is handled by
a "router", which routes messages between them.

Messages are sent over "streams", which represent a connection to another
context. Streams can be established over various transports such as SSH, local
processes, or Docker containers. Each stream is identified by a unique ID, and
the router uses these IDs to route messages to the correct destination.

When a context wants to execute code in another context, it sends a message
containing the code and any necessary arguments. The receiving context
executes the code and sends back the result. This allows for a high degree of
parallelism and distribution of work.

Key Components
--------------

- **Context**: A process participating in the Mitogen network. Each context
  has a unique ID and can communicate with other contexts through messages.

- **Router**: Manages communication between contexts. It routes messages
  between contexts based on their IDs and handles the establishment and
  teardown of streams.

- **Stream**: A connection between two contexts. Streams can be established
  over various transports and are used to send and receive messages.

- **Message**: The basic unit of communication in Mitogen. Messages contain a
  header with metadata (such as the sender and receiver IDs) and a payload
  with the actual data.

- **Broker**: The event loop that handles IO operations for streams. It
  monitors streams for incoming data and dispatches messages to the
  appropriate handlers.

Bootstrapping
-------------

When a new context is created, Mitogen sends a minimal bootstrap implementation
to it. This bootstrap code is responsible for setting up the necessary
infrastructure to participate in the Mitogen network, including establishing a
connection back to the parent context and starting the message handling loop.

The bootstrap code is kept small to reduce the overhead of starting new
contexts. Non-essential code is kept separate and loaded on-demand.

Message Handling
----------------

Messages in Mitogen are processed by handlers registered with the router. When
a message arrives, the router looks up the appropriate handler based on the
message type and invokes it. Handlers can be registered to handle specific
message types, such as function calls or log messages.

Mitogen supports various message types, including:

- ``CALL_FUNCTION``: Execute a function in the remote context.
- ``FORWARD_LOG``: Forward log messages from the remote context.
- ``ADD_ROUTE``: Add a new route to the routing table.
- ``DEL_ROUTE``: Remove a route from the routing table.
- ``ALLOCATE_ID``: Allocate a new context ID.
- ``SHUTDOWN``: Shut down the context.
- ``LOAD_MODULE``: Load a Python module in the remote context.
- ``FORWARD_MODULE``: Forward a module to the remote context.
- ``DETACHING``: Notify that a context is detaching.
- ``CALL_SERVICE``: Call a service in the remote context.
- ``STUB_CALL_SERVICE``: Call a stub service in the remote context.

Error Handling
--------------

Mitogen uses a special value ``IS_DEAD`` to signal disconnection or the
inability to route a message. When this value appears in the ``reply_to``
field of a message, it indicates that the sender did not know how to process
the message or wishes no further messages to be delivered to it. This can
happen when a remote receiver is disconnected, a message cannot be delivered
due to no route existing for it, or a router is being torn down.

Performance Considerations
--------------------------

Mitogen is designed for high performance and low overhead. It uses a variety
of techniques to achieve this, including:

- Minimizing the size of the bootstrap code sent to new contexts.
- Using efficient message serialization and deserialization.
- Reducing the number of system calls required for IO operations.
- Carefully managing buffer sizes to balance performance and memory usage.

The default buffer size for IO operations is set to 128KiB, which has been
found to be a good balance between CPU usage and throughput. This value can
affect performance depending on the underlying transport and system
configuration.

Mitogen also takes care to avoid deadlocks by managing the import lock and
other shared resources carefully. For example, it avoids calling ``str.encode``
on behalf of a thread that is waiting for a module, which could cause a
deadlock.

Compatibility
-------------

Mitogen is compatible with Python 2.4 and later, including Python 3. It
includes compatibility shims for older Python versions and handles differences
in the standard library between versions.

It also includes workarounds for specific platform issues, such as prehistoric
versions of Windows Subsystem for Linux (WSL) that do not advertise themselves
in ``uname`` output.