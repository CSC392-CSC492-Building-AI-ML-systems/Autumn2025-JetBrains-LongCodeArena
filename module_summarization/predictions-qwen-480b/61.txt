Module: ``sqlalchemy.orm.instrumentation``
=========================================

The ``instrumentation`` module is responsible for SQLAlchemy's class instrumentation system. This system enables the Object Relational Mapper (ORM) to track the state of class instances, manage attribute access, and integrate with SQLAlchemy's event system. While typically not directly manipulated by end-user applications, it forms a core part of the ORM's functionality.

This module works closely with ``state.py`` and ``attributes.py`` to provide comprehensive instrumentation:

- ``state.py`` handles per-instance state tracking.
- ``attributes.py`` manages per-class attribute instrumentation.

Class instrumentation can be customized either globally or on a per-class basis using the ``sqlalchemy.ext.instrumentation`` module, which allows developers to define alternate instrumentation strategies.

.. versionchanged:: 0.8
   The instrumentation extension system was relocated from the ORM into the external ``sqlalchemy.ext.instrumentation`` package. Importing this package integrates it into ``sqlalchemy.orm``, enabling more advanced resolution mechanics.

Key Components
--------------

``ClassManager``
~~~~~~~~~~~~~~~

The ``ClassManager`` class is a central component of the instrumentation system. It maintains class-level state information and manages the instrumentation process for a given class. It inherits from ``HasMemoized``, ``dict``, and ``EventTarget``, allowing it to store attribute information, memoize computed values, and participate in SQLAlchemy's event system.

- Tracks class-level information and state.
- Manages attribute instrumentation for ORM-enabled classes.
- Integrates with the event system via its ``dispatch`` attribute.
- Handles class initialization instrumentation to support ORM features.

``_ExpiredAttributeLoaderProto``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A protocol defining the interface for loading expired attributes. This is used internally to reload attributes that have been marked as expired, ensuring that the most current data is fetched from the database when needed.

``_ManagerFactory``
~~~~~~~~~~~~~~~~~~~

A protocol that defines a callable interface for creating ``ClassManager`` instances. This supports customization of how class managers are instantiated, particularly useful in advanced instrumentation scenarios.

Instrumentation Process
-----------------------

The instrumentation process involves:

1. **Registration**: Classes are registered with the instrumentation system, typically when a mapper is configured.
2. **State Tracking**: ``ClassManager`` instances are created to manage class-level state, including attribute definitions and event listeners.
3. **Attribute Instrumentation**: Class attributes are replaced with instrumented versions that can track changes and interact with the ORM.
4. **Initialization Wrapping**: The class's ``__init__`` method is wrapped to ensure ORM-specific initialization logic is executed when instances are created.

Customization
-------------

The default instrumentation behavior can be extended or replaced using the ``sqlalchemy.ext.instrumentation`` module. This allows for advanced use cases such as:

- Implementing custom attribute access patterns.
- Integrating with external frameworks or libraries.
- Optimizing instrumentation for specific application needs.

Deprecations
------------

- **Version 1.4**: The ``deferred_scalar_loader`` attribute in ``ClassManager`` was renamed to ``expired_attribute_loader``. The old name is deprecated but still functional for backward compatibility.