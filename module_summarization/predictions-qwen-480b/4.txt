Sync LDAP Users
===============

Overview
--------

The ``sync_ldap_users`` functionality allows administrators to synchronize user accounts between an LDAP directory and the ftrack system. This ensures that user information such as usernames, email addresses, and group memberships are consistent across both systems.

This process is particularly useful in enterprise environments where user management is centralized through LDAP, and changes such as new hires, departures, or role changes need to be reflected automatically in ftrack.

Configuration
-------------

Before running the synchronization, ensure the following configurations are properly set:

1. **LDAP Connection Settings**:
   - **Server URL**: The URL of the LDAP server (e.g., ``ldap://ldap.example.com``).
   - **Bind DN**: The distinguished name (DN) used to bind to the LDAP server.
   - **Bind Password**: The password for the Bind DN.
   - **Base DN**: The base distinguished name from which to start LDAP searches (e.g., ``ou=users,dc=example,dc=com``).

2. **Attribute Mapping**:
   - Map LDAP attributes to ftrack user fields:
     - ``uid`` → Username
     - ``mail`` → Email
     - ``cn`` → Full Name

3. **ftrack API Credentials**:
   - Ensure that the ftrack API key and user credentials are configured for a user with administrative privileges to create and modify users.

Usage
-----

To synchronize users, execute the ``sync_ldap_users`` script with the appropriate configuration:

.. code-block:: bash

    python sync_ldap_users.py --config config.yaml

Where ``config.yaml`` contains the LDAP and ftrack connection settings.

Example ``config.yaml``:

.. code-block:: yaml

    ldap:
      server_url: "ldap://ldap.example.com"
      bind_dn: "cn=admin,dc=example,dc=com"
      bind_password: "password"
      base_dn: "ou=users,dc=example,dc=com"
    
    ftrack:
      server_url: "https://example.ftrackapp.com"
      api_key: "your-api-key"
      api_user: "admin"

    mapping:
      username: "uid"
      email: "mail"
      full_name: "cn"

Synchronization Process
-----------------------

1. **Connect to LDAP**: The script connects to the LDAP server using the provided credentials.
2. **Fetch LDAP Users**: It retrieves a list of users from the LDAP directory based on the configured base DN.
3. **Connect to ftrack**: Using the ftrack API, the script connects to the ftrack server.
4. **Compare Users**: It compares the list of LDAP users with existing ftrack users.
5. **Create/Update Users**:
   - If a user exists in LDAP but not in ftrack, the user is created in ftrack.
   - If a user exists in both systems, the user's information is updated in ftrack if it has changed in LDAP.
6. **Deactivate Disabled Users**: Optionally, users that are disabled in LDAP can be deactivated in ftrack.

Logging and Monitoring
----------------------

The synchronization process logs detailed information about its operations, including:

- Users created or updated
- Errors encountered during synchronization
- Summary of changes made

Logs are output to the console and can also be directed to a file for auditing purposes.

.. code-block:: bash

    python sync_ldap_users.py --config config.yaml --log-file sync.log

Scheduling
----------

To keep ftrack users synchronized with LDAP automatically, schedule the script to run periodically using a task scheduler such as cron (on Linux) or Task Scheduler (on Windows).

Example cron job to run synchronization daily at 2 AM:

.. code-block:: bash

    0 2 * * * /usr/bin/python /path/to/sync_ldap_users.py --config /path/to/config.yaml --log-file /path/to/sync.log

Security Considerations
-----------------------

- **Secure Storage of Credentials**: Store LDAP and ftrack credentials securely. Use environment variables or secure configuration files with restricted access.
- **Encryption**: Ensure that communication with the LDAP server is encrypted using LDAPS or StartTLS.
- **Least Privilege**: Use an LDAP bind account with the minimum necessary permissions to read user information.

Troubleshooting
---------------

- **Connection Issues**: Verify that the LDAP server URL, bind DN, and password are correct. Ensure network connectivity to the LDAP server.
- **User Mapping Errors**: Check that LDAP attributes are correctly mapped to ftrack user fields.
- **Permission Errors**: Ensure the ftrack API user has sufficient privileges to create and modify users.

For detailed error information, refer to the log output generated during the synchronization process.