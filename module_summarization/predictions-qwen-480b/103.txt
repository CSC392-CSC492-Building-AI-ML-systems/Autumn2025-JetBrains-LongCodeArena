Code Generation (``codegen``)
============================

.. module:: diofant.utilities.codegen

Introduction
------------

The ``codegen`` module provides tools for generating code in various programming
languages from Diofant expressions. It allows users to translate symbolic
mathematical expressions into executable code in languages such as C, C++,
Fortran77, Fortran90, and Octave/Matlab.

Unlike simple printing routines like ``diofant.printing.ccode``, the code
generation framework handles complex programming-related aspects such as:

- Managing input, output, and input-output arguments
- Handling array types (contiguous/non-contiguous)
- Supporting multiple target languages with appropriate syntax and conventions
- Performing common subexpression elimination (CSE) to optimize generated code
- Evaluating constants at compile time for better performance
- Generating necessary header files and interface definitions (e.g., .pyf for f2py)

Basic Concepts
--------------

The code generation system is built around several core concepts:

Routine
~~~~~~~

A ``Routine`` represents a generic description of an evaluation routine for a
set of expressions. It contains information about:

- Input arguments (InputArgument)
- Output arguments (OutputArgument)
- Input-output arguments (InOutArgument)
- Results (Result)
- Local variables
- Global variables

Each CodeGen class can translate instances of Routine into code in a specific
language, raising exceptions when certain features are not supported by the
target language.

CodeGen Classes
~~~~~~~~~~~~~~~

The following CodeGen classes are available for translating routines into
different programming languages:

- ``CCodeGen``: Generates C code
- ``CXXCodeGen``: Generates C++ code
- ``FCodeGen``: Generates Fortran 90 code
- ``F77CodeGen``: Generates Fortran 77 code
- ``OctaveCodeGen``: Generates Octave/Matlab code

Friendly Functions
~~~~~~~~~~~~~~~~~~

For simpler use cases, the module provides high-level functions that abstract
away the complexity of the Routine/CodeGen workflow:

- ``codegen()``: Main function for generating code from expressions
- ``make_routine()``: Helper function for creating Routine objects

Data Types
~~~~~~~~~~

The module includes utilities for handling data types across different
languages:

- ``DataType``: Base class for representing data types
- ``default_datatypes``: Dictionary of default data type mappings
- ``get_default_datatype()``: Function to determine appropriate data types

Usage Examples
--------------

Here's a basic example of how to generate C code from a Diofant expression:

.. code-block:: python

    from diofant import symbols, sin, cos
    from diofant.utilities.codegen import codegen

    x = symbols('x')
    expr = sin(x)**2 + cos(x)**2

    # Generate C code
    [(c_name, c_code), (h_name, c_header)] = codegen(
        ("my_function", expr), "C", "myfile", header=False, empty=False)

    print(c_code)

This would generate compilable C code that evaluates the given expression.

Advanced Features
-----------------

Common Subexpression Elimination
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The code generator can automatically identify and eliminate common
subexpressions to optimize the generated code, reducing redundant calculations.

Constant Evaluation
~~~~~~~~~~~~~~~~~~~

Constants in expressions are evaluated at compile time whenever possible,
improving runtime performance by pre-computing known values.

Array Support
~~~~~~~~~~~~~

The system supports both contiguous and non-contiguous array arguments,
making it suitable for working with matrix expressions and NumPy arrays.

Multiple Language Support
~~~~~~~~~~~~~~~~~~~~~~~~~

Code can be generated for multiple target languages, each with their own
specific features and limitations:

- C: Basic scalar and array operations
- C++: Object-oriented features and standard library integration
- Fortran 77/90: Scientific computing oriented syntax
- Octave/Matlab: High-level mathematical computing environment

Limitations and Future Work
---------------------------

While the code generation module is functional, it is still a work in progress.
Some planned features include:

- Enhanced user-defined comments in generated code
- Support for additional libraries and special functions
- Better handling of complex numbers across all languages
- Extended compiler and library testing
- Improved error handling for non-translatable expressions
- Additional metadata in generated headers (date, user, version info)

The current implementation successfully handles scalar inputs, basic data
types, and simple array operations, with ongoing development focused on
expanding language support and optimization capabilities.