Alchemical Transformations
==========================

Overview
--------

Alchemical transformations are a class of computational methods used in molecular simulations to gradually transform one molecular state into another. These transformations are particularly useful in free energy calculations, where the goal is to compute the difference in free energy between two states, such as a ligand binding to a protein and the ligand in solution.

In the context of molecular dynamics (MD) simulations, alchemical transformations are implemented by introducing a coupling parameter, commonly denoted as λ (lambda), which interpolates between the initial (λ=0) and final (λ=1) states. By performing simulations at different values of λ and integrating the resulting derivatives of the potential energy with respect to λ, one can compute the free energy difference between the two states.

Hybrid Topology
---------------

A key concept in alchemical transformations is the creation of a hybrid topology that combines the topologies of the initial and final states. The hybrid topology contains all atoms from both states, with some atoms being present in only one state (unique atoms) and others being common to both (core atoms). The interactions of these atoms are controlled by the alchemical parameter λ, such that:

- **Unique Old Atoms**: Atoms present only in the initial state. Their interactions are fully active at λ=0 and gradually turned off as λ approaches 1.
- **Unique New Atoms**: Atoms present only in the final state. Their interactions are inactive at λ=0 and gradually turned on as λ approaches 1.
- **Core Atoms**: Atoms common to both states. Their interactions are interpolated between the initial and final states as λ varies from 0 to 1.
- **Environment Atoms**: Atoms that are common to both states but do not undergo any changes. Their interactions remain constant throughout the transformation.

Softcore Potentials
-------------------

A significant challenge in alchemical transformations is the presence of singularities when atoms are fully decoupled from the system. To address this, softcore potentials are employed. These potentials modify the interaction energy between atoms to ensure a smooth transition as λ varies. The softcore approach avoids the divergence of energy and forces when atoms are turned off or on.

The softcore potential is defined by a parameter α (alpha), which controls the softness of the potential. A typical softcore potential for Lennard-Jones (LJ) interactions is given by:

.. math::

   U_{\text{softcore}}(r; \lambda) = \frac{U_{\text{LJ}}(r)}{1 + \left(\frac{\alpha (1 - \lambda)^2}{r^n}\right)}

where :math:`U_{\text{LJ}}(r)` is the standard Lennard-Jones potential, :math:`\alpha` is the softcore parameter, and :math:`n` is an exponent that determines the shape of the softcore potential.

Similarly, softcore electrostatics can be implemented to handle the decoupling of electrostatic interactions.

Lambda Protocol
---------------

The lambda protocol defines how the interactions are scaled with λ. Typically, separate λ parameters are used for different types of interactions, such as bonds, angles, torsions, and nonbonded interactions. This allows for more precise control over the transformation process. The protocol can be linear, where each interaction type is scaled uniformly with λ, or it can be more complex, involving custom functions that define the scaling behavior.

For example, the scaling of bond interactions might be defined as:

.. math::

   k(\lambda) = k_0 (1 - \lambda) + k_1 \lambda

where :math:`k_0` and :math:`k_1` are the force constants for the initial and final states, respectively.

Implementation in HybridTopologyFactory
---------------------------------------

The `HybridTopologyFactory` class is responsible for generating the hybrid topology and managing the alchemical transformation. It takes as input the topologies and positions of the initial and final states, along with various parameters that control the transformation process, such as softcore parameters and the lambda protocol.

The factory creates a hybrid system that includes all atoms from both states, with interactions controlled by λ. It also generates mappings between the atoms of the initial and final states to the hybrid system, allowing for the proper interpolation of interactions.

The resulting hybrid system can be used in MD simulations to perform alchemical transformations, enabling the computation of free energy differences between the initial and final states. The class supports various options for controlling the transformation, such as softcore potentials, bond and angle softening, and the inclusion of restraints.