Controlling Chunking
====================

Dask arrays are divided into chunks, which are essentially smaller NumPy arrays spanning a portion of the original array's dimensions. Chunking is fundamental to Dask's ability to process large datasets that do not fit into memory, as operations are performed on these smaller chunks in parallel or distributed environments.

Chunk shapes are specified when creating a Dask array and can significantly impact performance. Well-chosen chunk sizes can lead to better load balancing, reduced memory usage, and more efficient computation.

Specifying Chunks
-----------------

Chunks can be specified in several ways when creating a Dask array:

1. **Uniform chunk size**: A single integer can be used to specify a uniform chunk size for all dimensions.

   .. code-block:: python

       import dask.array as da
       x = da.random.random((10000, 10000), chunks=(1000, 1000))

2. **Per-dimension chunk size**: A tuple of integers can specify chunk sizes for each dimension.

   .. code-block:: python

       x = da.random.random((10000, 10000), chunks=(5000, 2000))

3. **Automatic chunking**: Dask can automatically determine chunk sizes based on the array's size and the desired chunk size in bytes.

   .. code-block:: python

       x = da.random.random((10000, 10000), chunks="128MB")

4. **Mixed chunking**: A tuple of tuples can specify irregular chunk sizes for each dimension.

   .. code-block:: python

       x = da.random.random((10000, 10000), chunks=((5000, 3000, 2000), (10000,)))

Rechunking
----------

Once an array is created, its chunking can be adjusted using the :meth:`rechunk` method. This is useful when the initial chunking is not optimal for a particular operation.

.. code-block:: python

    x = da.random.random((10000, 10000), chunks=(1000, 1000))
    y = x.rechunk((5000, 5000))

The :meth:`rechunk` method allows you to specify new chunk sizes, which can be uniform or irregular, and can differ from the original chunking.

Best Practices
--------------

- **Avoid very small chunks**: Small chunks can lead to excessive overhead due to the large number of tasks.
- **Avoid very large chunks**: Large chunks can lead to memory issues and poor load balancing.
- **Align chunks with computation**: Choose chunk sizes that align well with the operations you plan to perform. For example, if you are performing reductions along a specific axis, consider chunking along that axis.
- **Consider I/O patterns**: If reading from or writing to disk, align chunks with the storage block size for better I/O performance.

Chunking and Performance
------------------------

Chunking affects performance in several ways:

- **Memory usage**: Smaller chunks reduce memory usage but increase overhead.
- **Parallelism**: More chunks allow for greater parallelism but may increase scheduling overhead.
- **Locality**: Properly sized chunks can improve data locality and reduce communication costs in distributed settings.

Choosing the right chunk size is a trade-off between these factors and depends on the specific use case and computational environment.