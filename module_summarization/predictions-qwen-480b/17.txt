```
w_assign
========

The ``w_assign`` tool assigns walkers to bins and optionally labels trajectories 
by kinetic macrostates. The resulting assignment data is stored in an HDF5 file 
(by default named ``assign.h5``), which can be used in subsequent analysis steps.

This assignment process ensures that the entire dataset is consistently binned, 
which is crucial for analyses that trace trajectories and rely on knowing the 
originating bin of each trajectory.

Usage
-----

.. code-block:: bash

    w_assign [options]

Description
-----------

``w_assign`` performs binning of trajectory data and optionally assigns 
macrostate labels to each trajectory segment. This is a prerequisite for 
kinetic analysis tools such as ``w_kintrace`` and ``w_kinmat``.

Source Data
-----------

Source data can be provided in two ways:

1. **Custom Dataset Construction Function** (``--construct-dataset``):  
   A user-defined function specified in ``MODULE.FUNCTION`` format. This function 
   is called as ``function(n_iter, iter_group)`` and must return data that can be 
   indexed as ``[segment][timepoint][dimension]``.

2. **Dataset Specifications** (``--dsspecs``):  
   A list of dataset specifications in the format:
   
   .. code-block:: text

       NAME[,file=FILENAME,slice=SLICE]

   - ``NAME``: Name of the dataset.
   - ``file`` (optional): HDF5 file containing the dataset (defaults to ``west.h5``).
   - ``slice`` (optional): Python-style slicing expression to select a subset of data.

If neither is specified, the default progress coordinate dataset ``pcoord`` is used.

Specifying Macrostates
----------------------

Macrostates define kinetic states in terms of bins. Each trajectory is labeled 
with the most recently visited macrostate at each timepoint. This labeling is 
required for kinetics analysis.

Macrostates can be defined in three ways:

1. **Command-line States** (``--states``):  
   Define single-bin states as coordinate tuples. Optionally, prepend a label:

   .. code-block:: bash

       w_assign --states bound:1.0 unbound:(2.5,2.5)

   Unlabeled states are named ``stateN``, where ``N`` is the zero-based index.

2. **YAML File** (``--states-from-file``):  
   Define multi-bin states using a YAML file. Example:

   .. code-block:: yaml

       ---
       states:
         - label: unbound
           coords:
             - [9.0, 1.0]
             - [9.0, 2.0]
         - label: bound
           coords:
             - [0.1, 0.0]

3. **Custom Function** (``--states-from-function``):  
   A user-defined function in ``MODULE.FUNCTION`` format. It is called as 
   ``function(mapper)`` and must return a list of dictionaries, each with:

   - ``coords``: A list of coordinate tuples.
   - ``label`` (optional): A name for the state.

Output Format
-------------

The output file (default: ``assign.h5``) contains the following datasets and attributes:

Attributes
~~~~~~~~~~

- ``nbins`` *(Integer)*: Number of valid bins. Bin indices range from 0 to ``nbins - 1``.
- ``nstates`` *(Integer)*: Number of defined macrostates. State indices range from 0 to ``nstates - 1``.

Datasets
~~~~~~~~

- ``/assignments`` [iteration][segment][timepoint]:  
  *(Integer)* Bin index assigned to each timepoint of each segment.

- ``/npts`` [iteration]:  
  *(Integer)* Number of timepoints in each iteration.

- ``/nsegs`` [iteration]:  
  *(Integer)* Number of segments in each iteration.

- ``/labeled_populations`` [iteration][state][bin]:  
  *(Floating-point)* Bin populations labeled by the most recently visited macrostate. 
  The last state index (``nstates``) corresponds to trajectories initiated outside 
  any defined macrostate.

- ``/bin_labels`` [bin]:  
  *(String)* Optional labels for each bin.

Options
-------

.. option:: -h, --help

    Show help message and exit.

.. option:: --output <file>, -o <file>

    Output file name (default: ``assign.h5``).

.. option:: --construct-dataset <module.function>

    Use a custom function to construct the dataset for assignment.

.. option:: --dsspecs <spec> [<spec> ...]

    List of dataset specifications to use as input.

.. option:: --states <coord> [<coord> ...]

    Define single-bin macrostates from coordinate tuples.

.. option:: --states-from-file <file>

    Load macrostate definitions from a YAML file.

.. option:: --states-from-function <module.function>

    Use a custom function to define macrostates.

.. option:: --subsample <n>

    Subsample data by taking every n-th point.

.. option:: --serial

    Run in serial mode (no parallelization).

Examples
--------

Basic usage with default progress coordinate:

.. code-block:: bash

    w_assign

Define macrostates from command line:

.. code-block:: bash

    w_assign --states unbound:10.0 bound:1.0

Use a custom dataset and define states from a YAML file:

.. code-block:: bash

    w_assign --construct-dataset mymodule.get_data --states-from-file states.yaml

See Also
--------

- :doc:`w_kintrace`
- :doc:`w_kinmat`
```