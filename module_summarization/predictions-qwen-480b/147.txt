# Fleur Input/Output Parsers

This documentation provides an overview of the parsers available for extracting information from Fleur XML input and output files. These parsers are designed to facilitate easy access to specific parts of the XML files, enabling version compatibility and reuse across different Fleur versions.

## Overview

The Fleur parser module contains functions that extract distinct parts of Fleur XML files. These functions are particularly useful for:

- Determining calculation modes and parameters
- Extracting k-point information
- Retrieving structural and atomic data
- Accessing electronic structure information
- Handling version-specific XML schema differences

## Available Parsers

### `get_fleur_modes`

Extracts calculation modes from Fleur XML files that affect the produced output files.

**Parameters:**
- `xmltree`: etree representing the Fleur XML file
- `schema_dict`: Schema dictionary corresponding to the file version
- `logger`: Logger object for warnings and errors (optional)

**Returns:** Dictionary containing the following calculation modes:
- `jspin`: Number of spins considered (1 or 2)
- `noco`: Non-collinear calculation flag
- `soc`: Spin-orbit coupling inclusion flag
- `relax`: Structure relaxation calculation flag
- `spex`: GW/Spex calculation mode indicator
- `force_theorem`: Force theorem calculation flag
- `film`: Film system flag
- `ldau`: LDA+U inclusion flag
- `dos`: Density of states calculation flag
- `band`: Bandstructure calculation flag
- `bz_integration`: Brillouin-Zone integration method
- `greensf`: Green's function calculation flag
- `ldahia`: LDA+HIA calculation flag
- `cf_coeff`: Configuration coefficient calculation flag
- `plot`: Plotting mode flag

### `get_nkpts`

Retrieves the number of k-points used in the calculation specified in the Fleur XML file.

**Parameters:**
- `xmltree`: etree representing the Fleur XML file
- `schema_dict`: Schema dictionary corresponding to the file version
- `logger`: Logger object for warnings and errors (optional)

**Returns:** Integer representing the number of k-points

**Warning:** For file versions before Max5, only `kPointList` or `kPointCount` tags are supported. The `kPointCount` tag may not always correspond exactly to the actual number of k-points.

## Usage Examples

```python
from masci_tools.io.parsers.fleur import get_fleur_modes, get_nkpts
from lxml import etree

# Parse XML file
xmltree = etree.parse('inp.xml')

# Get calculation modes
modes = get_fleur_modes(xmltree, schema_dict)

# Get number of k-points
nkpts = get_nkpts(xmltree, schema_dict)
```

## Schema Version Handling

The parsers automatically handle different Fleur XML schema versions through the `schema_dict_version_dispatch` decorator and `FleurXMLContext` manager. This ensures compatibility across different Fleur releases and proper handling of version-specific XML structures.

## Error Handling

All parsers include comprehensive error handling with:
- Proper logging of warnings and errors
- Validation of XML structure and content
- Graceful handling of missing or optional elements
- Clear error messages for invalid configurations

## Dependencies

- `lxml` for XML parsing
- `numpy` for numerical operations
- `masci_tools` for Fleur-specific utilities and schema handling

## Version Compatibility

The parsers are designed to work with multiple Fleur versions by using schema dictionaries that define version-specific XPath expressions and XML structures. This allows for consistent parsing behavior across different Fleur releases.