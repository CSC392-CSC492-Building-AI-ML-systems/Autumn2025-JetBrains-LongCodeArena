Configuration Usage
===================

This module provides utilities for generating and managing FV3 (Finite Volume Cubed-Sphere) model configurations, particularly for prognostic runs. It combines FV3 configuration settings with runtime configurations and offers convenient handling of initial conditions.

Core Components
---------------

HighLevelConfig
~~~~~~~~~~~~~~~

The main configuration class that combines FV3 and runtime configurations:

.. class:: HighLevelConfig

   A high level configuration object for prognostic runs that combines fv3config and runtime configurations with conveniences for commonly used initial conditions and configurations.

   **Attributes:**

   - ``base_version`` (str): The default physics config version (default: "v0.5")
   - ``initial_conditions`` (Union[InitialCondition, Any]): Specification for the initial conditions
   - ``duration`` (str): The duration of each segment. If provided, overrides any settings in ``namelist.coupler_nml``. Must be a valid input to ``pandas.TimeDelta`` (e.g., "3h")
   - ``zhao_carr_emulation`` (emulation.EmulationConfig): Configuration for Zhao-Carr physics emulation

   **Methods:**

   .. method:: to_fv3config() -> Any

      Translate the high-level configuration into a fv3config dictionary.

   .. method:: to_runtime_config() -> UserConfig

      Extract just the python runtime configurations.

FV3Config
~~~~~~~~~

.. class:: FV3Config

   Dataclass representation of all fv3config fields **not** overridden by ``HighLevelConfig``.

   **Attributes:**

   - ``namelist``: Configuration namelist settings
   - ``experiment_name``: Name of the experiment
   - ``data_table``: Data table configuration
   - ``field_table``: Field table configuration
   - ``forcing``: Model forcing configuration
   - ``orographic_forcing``: Orographic forcing configuration
   - ``gfs_analysis_data``: GFS analysis data configuration

InitialCondition
~~~~~~~~~~~~~~~~

.. class:: InitialCondition

   An initial condition with the format ``{base_url}/{timestep}``.

   **Attributes:**

   - ``base_url`` (str): A location in GCS or local storage
   - ``timestep`` (str): A YYYYMMDD.HHMMSS timestamp
   - ``restart_categories`` (RestartCategoriesConfig): An optional mapping from FV3GFS restart categories ('core', 'surface', 'tracer', 'surface_wind') to restart category names as stored on disk

Usage Examples
--------------

Creating a Basic Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: python

   from config import HighLevelConfig, InitialCondition

   # Create initial conditions
   initial_condition = InitialCondition(
       base_url="gs://my-bucket/initial-conditions",
       timestep="20230101.000000"
   )

   # Create configuration
   config = HighLevelConfig(
       base_version="v0.5",
       initial_conditions=initial_condition,
       duration="6h"
   )

   # Generate fv3config
   fv3_config = config.to_fv3config()

Command Line Interface
----------------------

The module includes a command-line interface for generating configurations from YAML files:

.. code-block:: bash

   python config.py <user_config> [--model_url <url>]

**Arguments:**

- ``user_config``: Path to a config update YAML file specifying the changes from the base fv3config (e.g. diag_table, runtime, etc.) for the prognostic run.

- ``--model_url``: Remote URL to a trained ML model. If a model is omitted (and not specified in user_config's scikit-learn model field either), then no ML updating will be done. Also, if an ML model is provided, no nudging will be done.

Configuration Generation
------------------------

The configuration system supports:

1. **Base Configuration**: Starting from a predefined base version
2. **Overlay System**: Applying configuration overlays for customizations
3. **Initial Conditions**: Flexible specification of model starting points
4. **Duration Management**: Automatic handling of run durations
5. **ML Integration**: Support for machine learning model configurations

The ``to_fv3config()`` method handles the merging of all configuration components including:
- Base FV3 configuration from the specified version
- Initial condition overlays
- Warning suppressions
- Runtime configuration settings
- Diagnostic table configurations
- Physics timestep settings
- ML emulation configurations