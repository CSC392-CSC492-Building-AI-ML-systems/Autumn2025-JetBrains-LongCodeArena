.. _w_pdist:

``w_pdist``: Calculate time-resolved, multi-dimensional probability distributions
==================================================================================

The ``w_pdist`` tool calculates time-resolved, multi-dimensional probability distributions from WESTPA datasets. It supports flexible input data specification, customizable histogram binning, and parallelized processing.

Usage
-----

.. code-block:: bash

    w_pdist [options]

Description
-----------

``w_pdist`` computes histograms of specified data across iterations of a WESTPA simulation. The output is a time-resolved probability distribution that can be used for further analysis or visualization.

Source Data
-----------

Source data is provided either by a user-specified function (``--construct-dataset``) or a list of "data set specifications" (``--dsspecs``). If neither is provided, the progress coordinate dataset ``pcoord`` is used.

Custom Dataset Construction
^^^^^^^^^^^^^^^^^^^^^^^^^^^

To use a custom function to extract or calculate data, specify the function in standard Python ``MODULE.FUNCTION`` syntax as the argument to ``--construct-dataset``. This function will be called as ``function(n_iter, iter_group)``, where ``n_iter`` is the iteration whose data are being considered and ``iter_group`` is the corresponding group in the main WEST HDF5 file (``west.h5``). The function must return data which can be indexed as ``[segment][timepoint][dimension]``.

Data Set Specifications
^^^^^^^^^^^^^^^^^^^^^^^

To use a list of data set specifications, specify ``--dsspecs`` and then list the desired datasets one-by-one (space-separated in most shells). These data set specifications are formatted as:

.. code-block:: text

    NAME[,file=FILENAME,slice=SLICE]

This will use the dataset called ``NAME`` in the HDF5 file ``FILENAME`` (defaulting to the main WEST HDF5 file ``west.h5``), and slice it with the Python slice expression ``SLICE`` (as in ``[0:2]`` to select the first two elements of the first axis of the dataset). The ``slice`` option is most useful for selecting one column (or more) from a multi-column dataset, such as arises when using a progress coordinate of multiple dimensions.

Histogram Binning
-----------------

By default, histograms are constructed with 100 bins in each dimension. This can be overridden by specifying ``-b/--bins``, which accepts a number of different kinds of arguments:

1. **Single Integer N**
   ``N`` uniformly spaced bins will be used in each dimension.

2. **Sequence of Integers N1,N2,... (comma-separated)**
   ``N1`` uniformly spaced bins will be used for the first dimension, ``N2`` for the second, and so on.

3. **List of Lists [[B11, B12, B13,...], [B21, B22, B23,...],...]**
   The bin boundaries ``B11, B12, B13,...`` will be used for the first dimension, ``B21, B22, B23,...`` for the second dimension, and so on. These bin boundaries need not be uniformly spaced. These expressions will be evaluated with Python's ``eval`` construct, with ``np`` available for use [e.g. to specify bins using ``np.arange()``].

The first two forms (integer, list of integers) will trigger a scan of all data in each dimension in order to determine the minimum and maximum values, which may be very expensive for large datasets. This can be avoided by explicitly providing bin boundaries using the list-of-lists form.

Note that these bins are *NOT* at all related to the bins used to drive WE sampling.

Output Format
-------------

The output file produced (specified by ``-o/--output``, defaulting to ``"pdist.h5"``) may be fed to ``plothist`` to generate plots (or appropriately processed text or HDF5 files) from this data. In short, the following datasets are created:

- ``histograms``
    Normalized histograms. The first axis corresponds to iteration, and remaining axes correspond to dimensions of the input dataset.

- ``/binbounds_0``
    Vector of bin boundaries for the first (index 0) dimension. Additional datasets similarly named (``/binbounds_1``, ``/binbounds_2``,...) are created for additional dimensions.

- ``/midpoints_0``
    Vector of bin midpoints for the first (index 0) dimension. Additional datasets similarly named are created for additional dimensions.

- ``n_iter``
    Vector of iteration numbers corresponding to the stored histograms (i.e. the first axis of the ``histograms`` dataset).

Subsequent Processing
---------------------

The output generated by this program (``-o/--output``, default ``"pdist.h5"``) may be plotted by the ``plothist`` program. See ``plothist --help`` for more information.

Parallelization
---------------

This tool supports parallelized binning, including reading of input data. Parallel processing is the default. For simple cases (reading pre-computed input data, modest numbers of segments), serial processing (``--serial``) may be more efficient.

Command-line Options
--------------------

.. code-block:: text

    usage: w_pdist [-h] [-r RCFILE] [--quiet] [--verbose] [--debug]
                   [-- west-data-file WEST_DATA_FILE] [--serial]
                   [--construct-dataset CONSTRUCT_DATASET]
                   [--dsspecs DSSPECS [DSSPECS ...]] [--first-iter FIRST_ITER]
                   [--last-iter LAST_ITER] [--bins BINS] [--output OUTPUT]
                   [--ignore-out-of-range]

    optional arguments:
      -h, --help            show this help message and exit
      -r RCFILE, --rcfile RCFILE
                            use RCFILE as the WEST run-time configuration file
      --quiet               emit only critical messages
      --verbose             emit verbose messages
      --debug               enable debugging output
      --west-data-file WEST_DATA_FILE
                            Read WEST data from WEST_DATA_FILE (default: read from
                            the HDF5 file specified in RCFILE)
      --serial              do not use parallel processing
      --construct-dataset CONSTRUCT_DATASET
                            use the given function (MODULE.FUNCTION) to extract or
                            calculate source data
      --dsspecs DSSPECS [DSSPECS ...]
                            use the given dataset specifications as source data
      --first-iter FIRST_ITER
                            begin analysis at iteration FIRST_ITER (default: 1)
      --last-iter LAST_ITER
                            conclude analysis at iteration LAST_ITER (default: last
                            completed iteration)
      --bins BINS           histogram binning (default: 100 bins in each dimension)
      --output OUTPUT       store results in OUTPUT (default: pdist.h5)
      --ignore-out-of-range
                            ignore data points that fall outside the specified bin
                            boundaries

Examples
--------

1. **Basic Usage with Default Settings**

   .. code-block:: bash

       w_pdist

   This will calculate the probability distribution of the default progress coordinate using 100 bins in each dimension.

2. **Specifying Custom Binning**

   .. code-block:: bash

       w_pdist --bins 50,75

   This will use 50 bins for the first dimension and 75 bins for the second dimension.

3. **Using Custom Bin Boundaries**

   .. code-block:: bash

       w_pdist --bins "[[0,1,2,3,4,5],[0,0.5,1.0,1.5,2.0]]"

   This will use custom bin boundaries for a 2D dataset.

4. **Using Custom Dataset Function**

   .. code-block:: bash

       w_pdist --construct-dataset mymodule.myfunction

   This will use ``mymodule.myfunction`` to extract or calculate the source data.

5. **Using Dataset Specifications**

   .. code-block:: bash

       w_pdist --dsspecs pcoord,slice=[0] pcoord,slice=[1]

   This will use the first and second components of the progress coordinate as separate dimensions.

6. **Specifying Iteration Range**

   .. code-block:: bash

       w_pdist --first-iter 10 --last-iter 100

   This will analyze iterations 10 through 100.

7. **Serial Processing**

   .. code-block:: bash

       w_pdist --serial

   This will disable parallel processing.

8. **Custom Output File**

   .. code-block:: bash

       w_pdist --output my_pdist.h5

   This will store the results in ``my_pdist.h5`` instead of the default ``pdist.h5``.